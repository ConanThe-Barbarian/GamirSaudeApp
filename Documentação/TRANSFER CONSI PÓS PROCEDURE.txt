PROMPT DE TREINAMENTO: TRANSFERÊNCIA DE CONSCIÊNCIA (SAGA GAMIR SAÚDE)I. INTRODUÇÃO E OBJETIVO MESTREA missão principal do projeto Gamir Saúde era criar um aplicativo móvel funcional que se integrasse ao complexo e antigo sistema legado da clínica, cujo ponto central era uma Procedure SQL crítica ([CAD_AGENDA_INSERT]).O sucesso foi alcançado ao forçar a compatibilidade total com essa Procedure.II. RESUMO DE ARQUITETURA E FERRAMENTASArquitetura: Clean Architecture (Backend) e MVVM (Frontend).Backend: .NET 8, C#, Entity Framework Core, SQL Server, Microsoft.Data.SqlClient (para Transações ADO.NET).Frontend: .NET MAUI, CommunityToolkit.Mvvm, XAML.Regra de Negócio Fixa: Todo agendamento vindo do App é Particular, utilizando os IDs fixos idPlanoConvenio = 33 e idConvenio = 31.III. JORNADA DE IMPLEMENTAÇÃO E PONTOS CRÍTICOSA jornada foi marcada pela necessidade de resolver dependências complexas do sistema legado.A. Fluxo de Identidade e Segurança (Sucesso Tático)OperaçãoSucesso (Funcionalidade)Erros e Soluções Críticas1. Cadastro/LoginImplementação segura com Hashing BCrypt. O RegisterViewModel limpa máscaras (.Where(char.IsDigit)) antes do envio.Erro 1: Senha era salva em texto plano. Solução: Implementação do BCrypt.Net.2. Verificação de Conta (Ponte)O AuthController.cs busca o paciente legado pelo e-mail e obtém o idPacienteGamir.Erro Crítico: Falha de sintaxe (OnAppearingCommand não encontrado). Solução: Forçamos o prefixo [RelayCommand] e a palavra-chave partial na classe para garantir a geração correta dos comandos.3. Serviço de E-mailEnvio de e-mail com template HTML profissional e dados injetados ({userName}, {code}).Erro 2: Tentativa de usar background-image CSS. Solução: Revertido para o método universal <img src='URL'> para garantir compatibilidade com Outlook e clientes antigos. Segurança: Movidas todas as credenciais SMTP para o appsettings.json via injeção de IConfiguration.B. O ATAQUE FINAL: Integração da Procedure LegadaO objetivo era satisfazer a Procedure ([CAD_AGENDA_INSERT]) que exige que um registro exista nas tabelas Tab_Atendimento e Tab_AtendimentoServico.PassoAção CríticaErros e Soluções Críticas4. Inserção do Plano PadrãoGarantia de Chave: No AuthController.cs (VerifyAccount), garantimos que um registro para o Plano Particular (ID 33) é inserido na Cad_PacientePlano para o paciente verificado, criando o idPacientePlano que será buscado no agendamento.N/A: Esta lógica resolveu o problema original de dependência da Procedure.5. Bloqueio de AgendamentoO DashboardViewModel.cs implementa o Guardião de Portão (if (!_userDataService.ContaVerificada)), impedindo que usuários não verificados sobrecarreguem a API com agendamentos inválidos.N/A: A blindagem está funcional.6. Transação ADO.NET (5 Passos)O AgendamentoController.cs agora executa a transação atômica que chama a Procedure.Erro 3 (Tipagem): Falha de conversão (DbTransaction para SqlTransaction). Solução: Casting explícito ((SqlTransaction)await connection.BeginTransactionAsync()).7. Contorno de Gatilho (Trigger)Erro 4 (Gatilhos): A Tab_Atendimento possui Triggers que bloqueiam o OUTPUT INSERTED.idAtendimento. Solução: Substituímos OUTPUT por SELECT SCOPE_IDENTITY() para obter o novo ID.8. Correção de HorárioErro 5 (Truncamento): A Procedure lia apenas a data da coluna DataAtendimento. Solução: Injetamos o DateTime completo (request.DataHoraMarcada) na coluna DataAtendimento, forçando a Procedure a obter a hora correta.IV. PRÓXIMO OBJETIVO: DEFESA DE CONCORRÊNCIAO último erro reportado é a capacidade de agendar o mesmo horário várias vezes. O sistema precisa de uma defesa de concorrência.MISSÃO IMEDIATAImplementar uma Validação SQL Atômica no AgendamentoController.cs (antes do Passo 2) que checa se o slot (DataHoraMarcada + IdPrestadorMedico) já existe na Cad_Agenda.Ação: Inserir uma instrução SELECT COUNT(*) no AgendamentoController.cs.#REGRA SEMPRE SOLICITAR TODO OS ARQUIVOS DO PROJETO ATUAL PRA CONTINUAR O PROGRESSO DO APP PARA VOCÊ NÃO SE PERDE!!!Para assumir o controle da próxima missão (Defesa de Concorrência), preciso da versão atualizada dos arquivos-chave.Aguardando os Arquivos Atuais:AgendamentoController.csGamirSaudeDbContext.cs