-- *** SqlDbx Personal Edition ***
-- !!! Not licensed for commercial use beyound 90 days evaluation period !!!
-- For version limitations please check http://www.sqldbx.com/personal_edition.htm
-- Number of queries executed: 229, number of rows retrieved: 8502999

ALTER proc [CAD_AGENDA_INSERT] (@idAtendimento int)
-- 30/11/2015 JANDERSON
-- 12/01/2016 JANDERSON
-- 13/03/2017 JANDERSON
-- 01/06/2017 JANDERSON
as begin

declare @numero int
declare @achou bit
set @numero = 0

declare @data date
declare @idprestadormedico int

select @data = DataAtendimento, @idprestadormedico = idMedicoExecutante from Tab_Atendimento where idAtendimento = @idAtendimento
set @achou = 0
while @achou = 0 begin
	set @numero = @numero +1
	if not exists(select * from Cad_Agenda where cast(DataHoraMarcada as date) = @data and idPrestadorMedico = @idPrestadormedico and Desativado = 0 and Numero = @numero)  begin
		set @achou = 1
	end
end

set rowcount 1

insert into Cad_Agenda
(idPaciente, DataHoraMarcada, idProcedimentoTussNomenclatura, idPrestadormedico, idPlanoConvenio,
Minutos, idUsuarioAuto, Encaixe, Paciente, DataHoraInclusao, idAtendimento, idPrestadorMedicoEspecialidade, Numero)
select
a.idPaciente,
case when isnull(PM.EscalaAgenda ,0)  = 0 then
	cast(cast(a.DataAtendimento as date) as datetime)
else
	a.dataAtendimento
end as dataAtendimento,

ss.idProcedimentoTussNomenclatura, a.idMedicoExecutante, pp.idPlanoConvenio,
isnull(isnull(PMEP.Minutos, PM.EscalaAgenda),10) as Minutos , a.idUsuarioInclusao, 1 as Encaixe, p.Paciente, getdate(), a.idAtendimento,
PME.idPrestadorMedicoEspecialidade, @numero
From Tab_Atendimento a
join Tab_AtendimentoServico ss on ss.idatendimento = a.idatendimento
join Cad_Paciente p on p.idPaciente = a.idPaciente
join Cad_PacientePlano pp on pp.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio Pc on pc.idPlanoConvenio = pp.idPlanoConvenio --and pc.AtendimentoAgenda = 1
join Cad_PlanoConvenioProcedimento pcp on pcp.idPlanoConvenio = pc.idPlanoConvenio and pcp.idProcedimentoTabelaValor = ss.idProcedimentoTabelaValor and pcp.ExibeAgenda = 1  and pcp.Desativado=0
join Cad_PrestadorMedicoEspecialidade PME on PME.idPrestadorMedicoEspecialidade = a.idEspecialidadeExecutante
left join Cad_PrestadorMedicoEspecialidadeProcedimento PMEP on PMEP.idPrestadorMedicoEspecialidade = PME.idPrestadorMedicoEspecialidade and PMEP.Desativado =0
and PMEP.idProcedimentoTussNomenclatura = ss.idProcedimentoTussNomenclatura
join Cad_PrestadorMedico PM on PM.idPrestadorMedico = a.idMedicoExecutante
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ss.idProcedimentoTussNomenclatura AND PTN.EnviarAgendaMedica = 1
left join Cad_Agenda Agenda on Agenda.idAgenda = a.idAgenda
where a.idAtendimento = @idatendimento
and Agenda.idAgenda is null

set rowcount 0

declare @idagenda int
set @idagenda = (select isnull(max(idagenda),0) from Cad_Agenda where idAtendimento = @idAtendimento)
if (@idagenda > 0)
	update Tab_Atendimento
	set idAgenda = @idagenda -- @@identity
	where idatendimento = @idatendimento

end
GO

ALTER proc CAD_AUTOFILAtoAGENDA @idAutoFila int
as begin
insert into Cad_Agenda
(DataHoraMarcada, idProcedimentoTussNomenclatura, idPrestadorMedico, idPlanoConvenio, Minutos, idUsuarioAuto,
Paciente, idPrestadorMedicoEspecialidade, DataHoraInclusao, idPlanoConvenioProcedimento, Numero, idAutoFila)
select
CAST(getdate() as DAtetime) as DataHoraMarcada, AF.idprocedimentoTussnomenclatura, AF.idPrestadorMedico, AF.idPlanoConvenio, AF.Minutos, -100 as idUsuarioAuto,
'AUTO ATENDIMENTO' as Paciente, AF.idprestadorMedicoEspecialidade, GETDATE(), AF.idPlanoConvenioProcedimento, AF.Numero, AF.idAutoFila
From Cad_AutoFila AF
left join Cad_Agenda A on A.idAutoFila = AF.idAutoFila
where
AF.idAutoFila = @idAutoFila
and A.idAgenda is null
end

GO

ALTER proc [Cad_FarEstoqueFarmacia_Aplicacao]  (@idEstoqueAplicacao int, @idusuario int)
--essa procedure será executada na compra de mercadoria.
--ela que irá efetivar a entrada da mercadoria no estoque.
as
begin

Begin tran ATUALIZAESTOQUE

-- 1. Tenho que atualizar a tabela Cad_FarEstoqueFarmaciaLote, subtraindo a quantidade usada.
update FEFL
set FEFL.QtdeEstoque = isnull(FEFL.QtdeEstoque,0) - EAL.QtdeAplicada -- case when isnull(EAL.Devolucao,0) = 0 then EAL.QtdeAplicada else EAL.QtdeAplicada * -1 end
from Tab_FarEstoqueAplicacaoLancamento EAL
join Tab_FarEstoqueAplicacao EA on EA.idEstoqueAplicacao = EAL.idEstoqueAplicacao
join Cad_FarEstoqueFarmaciaLote FEFL on FEFL.idEstoqueFarmaciaLote = EAL.idEStoqueFarmaciaLote
where EA.idEstoqueAplicacao  = @idEstoqueAplicacao
and EA.Desativado =0
and EAL.Desativado = 0



-- 1. Tenho que atualizar a tabela Cad_FarEstoqueFarmaciaLote, somando a quantidade devolvida, quando devolucao.
update FEFL
set FEFL.QtdeEstoque = isnull(FEFL.QtdeEstoque,0) + EAL.QtdeAplicada
from Tab_FarEstoqueAplicacaoLancamento EAL

join Tab_FarEstoqueRequisicaoLancamentoLote ERLL
	on ERLL.idEstoqueRequisicaoLancamentoLote = EAL.idEstoqueRequisicaoLancamentoLote
join Tab_FarEstoqueRequisicaoLancamento ERL
	on ERL.idEstoqueRequisicaoLancamento = EAL.idEstoqueRequisicaoLancamento


join Tab_FarEstoqueAplicacao EA on EA.idEstoqueAplicacao = EAL.idEstoqueAplicacao
join Cad_FarEstoqueFarmaciaLote FEFL on FEFL.idEstoqueFarmaciaLote = ERLL.idEStoqueFarmaciaLote
where EA.idEstoqueAplicacao  = @idEstoqueAplicacao
and EA.Desativado =0
and EAL.Desativado = 0
and EAL.Devolucao = 1



declare @idEstoqueAplicacaoLancamento int

DECLARE db_cursor CURSOR FOR
SELECT idEstoqueAplicacaoLancamento from Tab_FarEstoqueAplicacaoLancamento
where idEstoqueAplicacao = @idEstoqueAplicacao

OPEN db_cursor
FETCH NEXT FROM db_cursor INTO @idEstoqueAplicacaoLancamento

WHILE @@FETCH_STATUS = 0
BEGIN

	-- 1. Tenho que atualizar a tabela Cad_FarEstoqueFarmacia, subtraindo a quantidade usada apenas de um lote, pois tenho que atualizar o historico, então não posso subtrair tudo
	update FEF
	set FEF.QtdeEstoque = isnull(FEF.QtdeEstoque,0) - EAL.QtdeAplicada  -- case when isnull(EAL.Devolucao,0) = 0 then EAL.QtdeAplicada else EAL.QtdeAplicada * -1 end
	from Tab_FarEstoqueAplicacaoLancamento EAL
	join Tab_FarEstoqueAplicacao EA on EA.idEstoqueAplicacao = EAL.idEstoqueAplicacao
	join Cad_FarEstoqueFarmaciaLote FEFL on FEFL.idEstoqueFarmaciaLote = EAL.idEStoqueFarmaciaLote
	join Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = FEFL.idEStoqueFarmacia
	where EAL.idEstoqueAplicacaoLancamento  = @idEstoqueAplicacaoLancamento
	and EAL.Desativado =0


	-- 6.Aqui vou incluir o historico de ataalização

	insert into Cad_FarEstoqueFarmaciaHistorico
	(idEstoqueFarmacia, QtdeAntes, QtdeDepois, Descricao, idEstoqueAplicacaoLancamento, idEstoqueAplicacao, DataHora, idUsuario)
	select EAL.idEstoqueFarmacia,
	FEF.QtdeEstoque + EAL.QtdeAplicada as QtdAntes,
	FEF.QtdeEstoque as QtdDepois,
case when isnull(EAL.Devolucao,0) = 0 then 'Aplicação médica Qtd ' else 'Devolução por paciente Qtd ' end

	 + cast( EAL.QtdeAplicada as varchar) +
	'- Lote ' + cast( FEFL.NumeroLote as varchar) +
	'- Fabricação ' + convert(varchar(10), FEFL.DataFabricacao, 103) +
	'- Validade ' + convert(varchar(10), FEFL.DataValidade, 103) as Descricao,
	EAL.idEstoqueAplicacaolancamento, EAL.idEstoqueAplicacao,
	GETDATE(), @idusuario

	from Tab_FarEstoqueAplicacaoLancamento EAL
	join Tab_FarEstoqueAplicacao EA on EA.idEstoqueAplicacao = EAL.idEstoqueAplicacao
	join Cad_FarEstoqueFarmaciaLote FEFL on FEFL.idEstoqueFarmaciaLote = EAL.idEStoqueFarmaciaLote
	join Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = FEFL.idEStoqueFarmacia
	where EAL.idEstoqueAplicacaoLancamento  = @idEstoqueAplicacaoLancamento
	and EAL.Desativado =0


	-- aqui tenho que atualizar a quantidade do estoque central quando devolucao
	update FEF
	set FEF.QtdeEstoque = isnull(FEF.QtdeEstoque,0) + EAL.QtdeAplicada
	from Tab_FarEstoqueAplicacaoLancamento EAL

	join Tab_FarEstoqueRequisicaoLancamentoLote ERLL
			on ERLL.idEstoqueRequisicaoLancamentoLote = EAL.idEstoqueRequisicaoLancamentoLote
	join Tab_FarEstoqueRequisicaoLancamento ERL
			on ERL.idEstoqueRequisicaoLancamento = EAL.idEstoqueRequisicaoLancamento

	join Cad_FarEstoqueFarmaciaLote FEFL on FEFL.idEstoqueFarmaciaLote = ERLL.idEstoqueFarmaciaLote
	join Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = ERL.idEStoqueFarmacia
	where EAL.idEstoqueAplicacaoLancamento  = @idEstoqueAplicacaoLancamento
	and EAL.Desativado =0
	and EAL.Devolucao = 1

	-- aqui tenho que incluir o historico no estoque central quando devolucao

	insert into Cad_FarEstoqueFarmaciaHistorico
	(idEstoqueFarmacia, QtdeAntes, QtdeDepois, Descricao, idEstoqueAplicacaoLancamento, idEstoqueAplicacao, DataHora, idUsuario)
	select FEF.idEstoqueFarmacia,
	FEF.QtdeEstoque - EAL.QtdeAplicada as QtdAntes,
	FEF.QtdeEstoque as QtdDepois,
	case when isnull(EAL.Devolucao,0) = 0 then 'Aplicação médica Qtd ' else 'Devolução por paciente Qtd ' end
	 + cast( EAL.QtdeAplicada as varchar) +
	'- Lote ' + cast( FEFL.NumeroLote as varchar) +
	'- Fabricação ' + convert(varchar(10), FEFL.DataFabricacao, 103) +
	'- Validade ' + convert(varchar(10), FEFL.DataValidade, 103) as Descricao,
	EAL.idEstoqueAplicacaolancamento, EAL.idEstoqueAplicacao, GETDATE(), @idusuario

	from Tab_FarEstoqueAplicacaoLancamento EAL
	join Tab_FarEstoqueRequisicaoLancamentoLote ERLL
			on ERLL.idEstoqueRequisicaoLancamentoLote = EAL.idEstoqueRequisicaoLancamentoLote
	join Tab_FarEstoqueRequisicaoLancamento ERL
			on ERL.idEstoqueRequisicaoLancamento = EAL.idEstoqueRequisicaoLancamento

--	join Tab_FarEstoqueAplicacao EA on EA.idEstoqueAplicacao = EAL.idEstoqueAplicacao
	join Cad_FarEstoqueFarmaciaLote FEFL on FEFL.idEstoqueFarmaciaLote = ERLL.idEstoqueFarmaciaLote
	join Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = ERL.idEStoqueFarmacia
	where EAL.idEstoqueAplicacaoLancamento  = @idEstoqueAplicacaoLancamento
	and EAL.Desativado =0
	and EAL.Devolucao = 1


	FETCH NEXT FROM db_cursor INTO @idEstoqueAplicacaoLancamento
END

CLOSE db_cursor
DEALLOCATE db_cursor


-- aqui vou atualizar a tabela da requisição do lote Tab_FarEstoqueRequisicaoLancamentoLote
-- informando que foi aplicada a quantidade X
update ERLL
set ERLL.QtdeAplicada = isnull(ERLL.QtdeAplicada,0) + EAL.QtdeAplicada  --case when isnull(EAL.Devolucao,0) = 0 then EAL.QtdeAplicada else EAL.QtdeAplicada * -1 end
from Tab_FarEstoqueAplicacaoLancamento EAL
join Tab_FarEstoqueAplicacao EA on EA.idEstoqueAplicacao = EAL.idEstoqueAplicacao
join Cad_FarEstoqueFarmaciaLote FEFL on FEFL.idEstoqueFarmaciaLote = EAL.idEStoqueFarmaciaLote
--join Cad_FarEstoqueFarmacia FEF on FEF.idEStoqueFarmacia = FEFL.idEstoqueFarmacia
--join Cad_FarEstoqueFarmacia FEFO on FEFO.idProdutoFarmacia = FEF.idProdutoFarmacia
--join Cad_FarEstoqueFarmaciaLote FEFLO on FEFLO.idEstoqueFarmacia =  FEFLO.idEstoqueFarmacia
--and FEFLO.NumeroLote = FEFL.NumeroLote and FEFLO.DataValidade = FEFL.DataValidade
join Tab_FarEstoqueRequisicaoLancamentoLote ERLL on ERLL.idEstoqueRequisicaoLancamentoLote = EAL.idEstoqueRequisicaoLancamentoLote
join Tab_FarEstoqueRequisicaoLancamento ERL on ERL.idEstoqueRequisicaoLancamento = ERLL.idEstoqueRequisicaoLancamento
where
EAL.idEstoqueRequisicaoLancamentoLote is not null
and EA.idEstoqueAplicacao  = @idEstoqueAplicacao
and EA.Desativado =0
and EAL.Desativado = 0


-- aqui vou atualizar a tabela da requisição do lote Tab_FarEstoqueRequisicaoLancamento
-- informando que foi aplicada a quantidade X
update ERL
set ERL.QtdeAplicada = isnull(ERL.QtdeAplicada,0) + EAL.QtdeAplicada  -- case when isnull(EAL.Devolucao,0) = 0 then EAL.QtdeAplicada else EAL.QtdeAplicada * -1 end
from Tab_FarEstoqueAplicacaoLancamento EAL
join Tab_FarEstoqueAplicacao EA on EA.idEstoqueAplicacao = EAL.idEstoqueAplicacao
join Cad_FarEstoqueFarmaciaLote FEFL on FEFL.idEstoqueFarmaciaLote = EAL.idEStoqueFarmaciaLote
join Tab_FarEstoqueRequisicaoLancamentoLote ERLL on ERLL.idEstoqueRequisicaoLancamentoLote = EAL.idEstoqueRequisicaoLancamentoLote
join Tab_FarEstoqueRequisicaoLancamento ERL on ERL.idEstoqueRequisicaoLancamento = ERLL.idEstoqueRequisicaoLancamento
where
EAL.idEstoqueRequisicaoLancamentoLote is not null
and EA.idEstoqueAplicacao  = @idEstoqueAplicacao
and EA.Desativado =0
and EAL.Desativado = 0


COMMIT TRAN ATUALIZAESTOQUE

end

GO

ALTER proc [dbo].[Cad_FarEstoqueFarmacia_Devolucao]  (@idMovimentoEstoqueLancamento int, @quantidadeDevolucao int)
--essa procedure será executada na devolução de mercadoria.
--ela que irá efetivar a devolução da mercadoria no estoque.
as 
begin

Begin tran ATUALIZAESTOQUE

-- 1.Agora que tenho todos os lotes na tabela Cad_FarEstoqueFarmaciaLote
-- vou fazer update nos registros atualizando a quantidade em estoque.	
update FEFL
set FEFL.QtdeEstoque = isnull(FEFL.QtdeEstoque,0) - @quantidadeDevolucao
from Tab_FarMovimentoEstoqueLancamento FMEL 
join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque 
left join Cad_FarEstoqueFarmaciaLote FEFL 
	on FEFL.idEstoqueFarmacia = FMEL.idEStoqueFarmacia 
	and FEFL.NumeroLote = FMEL.NumeroLote
where FMEL.idMovimentoEstoqueLancamento = @idMovimentoEstoqueLancamento


-- 2.Agora tenho que atualizar a quantidade da tabela Cad_FarEstoqueFarmacia
update FEF
set FEF.QtdeEstoque = isnull(FEF.QtdeEstoque,0) - @quantidadeDevolucao
from Tab_FarMovimentoEstoqueLancamento FMEL 
join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque
left join Cad_FarEstoqueFarmacia FEF
	on FEF.idEstoqueFarmacia = FMEL.idEStoqueFarmacia 
where FMEL.idMovimentoEstoqueLancamento = @idMovimentoEstoqueLancamento



-- 4.Aqui vou incluir o historico de ataalização 

insert into Cad_FarEstoqueFarmaciaHistorico
(idEstoqueFarmacia, QtdeAntes, QtdeDepois, Descricao, idMovimentoEstoqueLancamento, idMovimentoEstoque)
select FMEL.idEstoqueFarmacia, 
FEF.QtdeEstoque + @quantidadeDevolucao as QtdAntes,
FEF.QtdeEstoque as QtdDepois, 
'Devolução de mercadoria Qtd ' + cast( @quantidadeDevolucao as varchar) +
'- Lote ' + cast( FMEL.NumeroLote as varchar) +
'- Fabricação ' + convert(varchar(10), FMEL.DataFabricacao, 103) +
'- Validade ' + convert(varchar(10), FMEL.DataValidade, 103) as Descricao,
FMEL.idMovimentoEstoqueLancamento, FMEL.idMovimentoEstoque
from Tab_FarMovimentoEstoqueLancamento FMEL 
join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque 
JOIN Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = FMEL.idEstoqueFarmacia
left join Cad_FarEstoqueFarmaciaLote FEFL 
	on FEFL.idEstoqueFarmacia = FMEL.idEStoqueFarmacia 
	and FEFL.NumeroLote = FMEL.NumeroLote
where FMEL.idMovimentoEstoqueLancamento = @idMovimentoEstoqueLancamento

COMMIT TRAN ATUALIZAESTOQUE

end

GO

ALTER proc Cad_FarEstoqueFarmacia_Entrada  (@idMovimentoEstoque int)
--- essa procedure será executada na compra de mercadoria.
--- ela que irá efetivar a entrada da mercadoria no estoque.
--- 13/05/2020 - Atualizacao do valor de Compra no Cadastro de Produto Farmacia
---
as
begin

Begin tran ATUALIZAESTOQUE

-- 1. Fazer insert na tabela Cad_FarEstoqueFarmaciaLote com a quantidade zerada,
-- se o registro do lote já existir então não devo incluir nada, terá um updade depois que fará isso.
insert into Cad_FarEstoqueFarmaciaLote (idEstoqueFarmacia, NumeroLote, DataFabricacao, DataValidade, QtdeEstoque, Desativado)
select FMEL.idEstoqueFarmacia, FMEL.NumeroLote, FMEL.DataFabricacao, FMEL.DataValidade, 0 as QtdeEstoque, 0 as Desativado
from Tab_FarMovimentoEstoqueLancamento FMEL
join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null
left join Cad_FarEstoqueFarmaciaLote FEFL
	on FEFL.idEstoqueFarmacia = FMEL.idEStoqueFarmacia
	and FEFL.NumeroLote = FMEL.NumeroLote
where FMEL.idMovimentoEstoque = @idMovimentoEstoque
and FEFL.idEstoqueFarmaciaLote is null
and FMEL.Desativado =0


	-- 2.Agora que tenho todos os lotes na tabela Cad_FarEstoqueFarmaciaLote
	-- vou fazer update nos registros atualizando a quantidade em estoque.
	update FEFL
	set FEFL.QtdeEstoque = isnull(FEFL.QtdeEstoque,0) + FMEL.QtdeEntrada
	from Tab_FarMovimentoEstoqueLancamento FMEL
	join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null
	left join Cad_FarEstoqueFarmaciaLote FEFL
		on FEFL.idEstoqueFarmacia = FMEL.idEStoqueFarmacia
		and FEFL.NumeroLote = FMEL.NumeroLote
	where FMEL.idMovimentoEstoque = @idMovimentoEstoque
	and	FMEL.Desativado =0


-- aqui eu declaro um cursor.
-- motivo? sem o cursor , quando em uma compra, tem 2 produtos com o mesmo IDESTOQUEFARMACIA a soma fica errada.
-- com o cursor eu pego item a item e vou atualizando o estoque.

declare @idMovimentoEstoqueLancamento int

DECLARE db_cursor CURSOR FOR
SELECT idMovimentoEstoqueLancamento from Tab_FarMovimentoEstoqueLancamento
where idMovimentoEstoque = @idMovimentoEstoque

OPEN db_cursor
FETCH NEXT FROM db_cursor INTO @idMovimentoEstoqueLancamento

WHILE @@FETCH_STATUS = 0
BEGIN

	-- 3.Agora tenho que atualizar a quantidade da tabela Cad_FarEstoqueFarmacia
	update FEF
	set	FEF.QtdeEstoque = isnull(FEF.QtdeEstoque,0) + FMEL.QtdeEntrada
	from Tab_FarMovimentoEstoqueLancamento FMEL
	join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null
	left join Cad_FarEstoqueFarmacia FEF
		on FEF.idEstoqueFarmacia = FMEL.idEStoqueFarmacia
	where FMEL.idMovimentoEstoque = @idMovimentoEstoque
	and FMEL.Desativado =0
	and FMEL.idMovimentoEstoqueLancamento = @idMovimentoEstoqueLancamento


	-- 3.1 agora tenho que gravar no Cad_Far_ProdutoFarmacia o id
	update PF
	set	PF.idMovimentoEstoqueLancamento = FMEL.idMovimentoEstoqueLancamento,
	PF.ValorCompra = FMEL.ValUnitario
	from Tab_FarMovimentoEstoqueLancamento FMEL
	join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null
	join Cad_FarEstoqueFarmacia FEF
		on FEF.idEstoqueFarmacia = FMEL.idEStoqueFarmacia
	join Cad_FarProdutoFarmacia PF on PF.idProdutoFarmacia = FEF.idProdutoFarmacia
	where FMEL.idMovimentoEstoque = @idMovimentoEstoque
	and FMEL.Desativado =0
	and FMEL.idMovimentoEstoqueLancamento = @idMovimentoEstoqueLancamento

-- 4.Aqui vou incluir o historico de ataalização

	insert into Cad_FarEstoqueFarmaciaHistorico
	(idEstoqueFarmacia, QtdeAntes, QtdeDepois, Descricao, idMovimentoEstoqueLancamento, idMovimentoEstoque)
	select FMEL.idEstoqueFarmacia,
	FEF.QtdeEstoque - FMEL.QtdeEntrada as QtdAntes,
	FEF.QtdeEstoque as QtdDepois,
	'Entrada de mercadoria Qtd ' + cast( FMEL.QtdeEntrada as varchar) +
	'- Lote ' + cast( FMEL.NumeroLote as varchar) +
	'- Fabricação ' + convert(varchar(10), FMEL.DataFabricacao, 103) +
	'- Validade ' + convert(varchar(10), FMEL.DataValidade, 103) as Descricao,
	FMEL.idMovimentoEstoqueLancamento, FMEL.idMovimentoEstoque
	from Tab_FarMovimentoEstoqueLancamento FMEL
	join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null
	JOIN Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = FMEL.idEstoqueFarmacia
	left join Cad_FarEstoqueFarmaciaLote FEFL
		on FEFL.idEstoqueFarmacia = FMEL.idEStoqueFarmacia
		and FEFL.NumeroLote = FMEL.NumeroLote
	where FMEL.idMovimentoEstoque = @idMovimentoEstoque
		and FMEL.Desativado =0
		and FMEL.idMovimentoEstoqueLancamento = @idMovimentoEstoqueLancamento



	FETCH NEXT FROM db_cursor INTO @idMovimentoEstoqueLancamento
END

CLOSE db_cursor
DEALLOCATE db_cursor


insert into Cad_FarProdutoFarmaciaFornecedor
(idProdutoFarmacia, idFornecedor)
select FEF.idProdutoFarmacia, FME.idFornecedor
from
Tab_FarMovimentoEstoqueLancamento FMEL
JOIN Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = FMEL.idEstoqueFarmacia and FEF.Desativado = 0
join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.Desativado = 0
left join Cad_FarProdutoFarmaciaFornecedor PFF on PFF.idProdutoFarmacia = FEF.idProdutoFarmacia and PFF.idFornecedor = FME.idFornecedor
where FMEL.Desativado = 0 and FME.idMovimentoEstoque = @idMovimentoEstoque
and PFF.idProdutoFarmacia is null

COMMIT TRAN ATUALIZAESTOQUE



end
GO

ALTER proc [Cad_FarEstoqueFarmacia_idEstoqueRequisicaoLancamento]  (@idEstoqueRequisicaoLancamento int, @idusuario int)
--essa procedure será executada na Dispensa de medicamento por paciente.
--ela que irá efetivar a saida da mercadoria da farmacia para o ambulatório
as
begin

Begin tran ATUALIZAESTOQUE

declare @idUnidadeEstoqueDestino int
set @idUnidadeEstoqueDestino = (
		select max(R.idUnidadeEstoqueDestino) from Tab_FarEstoqueRequisicaoLancamentoLote RLL
		join Tab_FarEstoqueRequisicaoLancamento RL on RL.idEstoqueRequisicaoLancamento = RLL.idEstoqueRequisicaoLancamento
		join Tab_FarEstoqueRequisicao R on R.idEstoqueRequisicao = RL.idEstoqueRequisicao
		where RLL.idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento
	)


declare @idProdutoFarmacia int
set @idProdutoFarmacia = (
		select max(idProdutoFarmacia) from Tab_FarEstoqueRequisicaoLancamentoLote RLL
		join Tab_FarEstoqueRequisicaoLancamento RL on RL.idEstoqueRequisicaoLancamento = RLL.idEstoqueRequisicaoLancamento
		where RLL.idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento
	)


declare @idEmpresaFilial int
set @idEmpresaFilial = 0
/*( a requisicação não tem a filial para escolher
		select max(R.idEmpresaFilial) from Tab_FarEstoqueRequisicaoLancamentoLote RLL
		join Tab_FarEstoqueRequisicaoLancamento RL on RL.idEstoqueRequisicaoLancamento = RLL.idEstoqueRequisicaoLancamento
		join Tab_FarEstoqueRequisicao R on R.idEstoqueRequisicao = RL.idEstoqueRequisicao
		where RLL.idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento
	)
*/

-- primeiro tenho que incluir o idEstoqueFarmacia se não existir no destino
exec cad_FarEstoqueFarmacia_Insert @idProdutoFarmacia, @idUnidadeEstoqueDestino, @idEmpresaFilial
print 'feito. primeiro tenho que incluir o idEstoqueFarmacia se não existir no destino'

--join Tab_FarEstoqueRequisicaoLancamento RL on RL.idEstoqueRequisicaoLancamento = RLL.idEstoqueRequisicaoLancamento
--join Tab_FarEstoqueRequisicao R on R.idEstoqueRequisicao = RL.idEstoqueRequisicao

declare @idEstoqueFarmacia int
set @idEstoqueFarmacia = (select idEstoqueFarmacia from Cad_FarEstoqueFarmacia
							where idprodutofarmacia = @idprodutofarmacia
							and idUnidadeAtendimento = @idUnidadeEstoqueDestino
							and idEmpresaFilial = @idEmpresaFilial)


-- 1. Fazer insert na tabela Cad_FarEstoqueFarmaciaLote com a quantidade zerada,
-- se o registro do lote já existir então não devo incluir nada, terá um updade depois que fará isso.
insert into Cad_FarEstoqueFarmaciaLote
(idEstoqueFarmacia, NumeroLote, DataFabricacao, DataValidade, QtdeEstoque, Desativado)
select @idEstoqueFarmacia, LoteOrigem.NumeroLote, LoteOrigem.DataFabricacao,
LoteOrigem.DataValidade, 0, 0
from Tab_FarEstoqueRequisicaoLancamentoLote RLL
join Cad_FarEstoqueFarmaciaLote LoteOrigem on LoteOrigem.idEstoqueFarmaciaLote = RLL.idEstoqueFarmaciaLote
left join Cad_FarEstoqueFarmaciaLote LoteDestino on LoteDestino.idEstoqueFarmacia = @idEstoqueFarmacia
and LoteDestino.NumeroLote = LoteOrigem.NumeroLote
where RLL.idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento
and LoteDestino.idEstoqueFarmacia is null
print 'feito. -- 1. Fazer insert na tabela Cad_FarEstoqueFarmaciaLote com a quantidade zerada, '


-- 2.Agora que tenho todos os lotes na tabela Cad_FarEstoqueFarmaciaLote
-- vou fazer update nos registros atualizando a quantidade em estoque no Destino (idestoqueFarmacia) somar
update loteDestino
set loteDestino.QtdeEstoque = isnull(loteDestino.QtdeEstoque,0) + RLL.QtdeEntrega
from Tab_FarEstoqueRequisicaoLancamentoLote RLL
join Cad_FarEstoqueFarmaciaLote LoteOrigem on LoteOrigem.idEstoqueFarmaciaLote = RLL.idEstoqueFarmaciaLote
join Cad_FarEstoqueFarmaciaLote LoteDestino on LoteDestino.idEstoqueFarmacia = @idEstoqueFarmacia
and LoteDestino.NumeroLote = LoteOrigem.NumeroLote
where RLl.idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento
print 'feito. 2.Agora que tenho todos os lotes na tabela Cad_FarEstoqueFarmaciaLote'

-- 3.Agora que tenho todos os lotes na tabela Cad_FarEstoqueFarmaciaLote
-- vou fazer update nos registros atualizando a quantidade em estoque na SAIDA (idestoqueFarmaciaSaida) subtrair
update loteOrigem
set LoteOrigem.QtdeEstoque = isnull(LoteOrigem.QtdeEstoque,0) - RLL.QtdeEntrega
from Tab_FarEstoqueRequisicaoLancamentoLote RLL
join Cad_FarEstoqueFarmaciaLote LoteOrigem on LoteOrigem.idEstoqueFarmaciaLote = RLL.idEstoqueFarmaciaLote
where RLl.idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento
print 'feito. 3.Agora que tenho todos os lotes na tabela Cad_FarEstoqueFarmaciaLote'




declare @idEstoqueRequisicaoLancamentoLote int


DECLARE db_cursor CURSOR FOR
SELECT idEstoqueRequisicaoLancamentoLote from Tab_FarEstoqueRequisicaoLancamentoLote
where idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento

OPEN db_cursor
FETCH NEXT FROM db_cursor INTO @idEstoqueRequisicaoLancamentoLote

WHILE @@FETCH_STATUS = 0
BEGIN


	-- 4.Agora tenho que atualizar a quantidade da tabela Cad_FarEstoqueFarmacia DESTINO
	update destino
	set destino.QtdeEstoque = isnull(destino.QtdeEstoque,0) + RLL.QtdeEntrega
	from Tab_FarEstoqueRequisicaoLancamento RL
	join Cad_FarEstoqueFarmacia Destino on Destino.idEstoqueFarmacia = @idEstoqueFarmacia
	join Tab_FarEstoqueRequisicaoLancamentoLote RLL on RLL.idEstoqueRequisicaoLancamento = RL.idEstoqueRequisicaoLancamento
	where RL.idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento
	and RLL.idEstoqueRequisicaoLancamentoLote = @idEstoqueRequisicaoLancamentoLote

	print 'feito. 4.Agora tenho que atualizar a quantidade da tabela Cad_FarEstoqueFarmacia DESTINO'


	-- 5.Agora tenho que atualizar a quantidade da tabela Cad_FarEstoqueFarmacia -- SAIDA (SUBTRAIR)
	update origem
	set origem.QtdeEstoque = isnull(origem.QtdeEstoque,0) - RLL.QtdeEntrega
	from Tab_FarEstoqueRequisicaoLancamento RL
	join Cad_FarEstoqueFarmacia Origem on Origem.idEstoqueFarmacia = RL.idEstoqueFarmacia
	join Tab_FarEstoqueRequisicaoLancamentoLote RLL on RLL.idEstoqueRequisicaoLancamento = RL.idEstoqueRequisicaoLancamento
	where RL.idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento
	and RLL.idEstoqueRequisicaoLancamentoLote = @idEstoqueRequisicaoLancamentoLote



	print 'feito. 5.Agora tenho que atualizar a quantidade da tabela Cad_FarEstoqueFarmacia -- SAIDA (SUBTRAIR)'


	-- 6.Aqui vou incluir o historico de ataalização
	insert into Cad_FarEstoqueFarmaciaHistorico
	(idEstoqueFarmacia, QtdeAntes, QtdeDepois, Descricao, DataHora, idUsuario)
	select
	@idEstoqueFarmacia, EstoqueDestino.QtdeEstoque - RLL.QtdeEntrega, EstoqueDestino.QtdeEstoque,
	'Entrada por Requisição Qtd ' + cast( RLL.QtdeEntrega as varchar) +
	'- Lote ' + cast( loteDestino.NumeroLote as varchar) +
	'- Fabricação ' + convert(varchar(10), loteDestino.DataFabricacao, 103) +
	'- Validade ' + convert(varchar(10), loteDestino.DataValidade, 103) as Descricao,
	GETDATE(), @idusuario
	from Tab_FarEstoqueRequisicaoLancamentoLote RLL
	join Cad_FarEstoqueFarmaciaLote LoteOrigem on LoteOrigem.idEstoqueFarmaciaLote = RLL.idEstoqueFarmaciaLote
	join Cad_FarEstoqueFarmaciaLote LoteDestino on LoteDestino.idEstoqueFarmacia = @idEstoqueFarmacia
	join Cad_FarEstoqueFarmacia EstoqueDestino on EstoqueDestino.idEstoqueFarmacia = LoteDestino.idEstoqueFarmacia
	and LoteDestino.NumeroLote = LoteOrigem.NumeroLote
	where RLl.idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento
	and RLL.idEstoqueRequisicaoLancamentoLote = @idEstoqueRequisicaoLancamentoLote

	print 'feito. Inclusão do histórico no estoque de destino.'



	insert into Cad_FarEstoqueFarmaciaHistorico
	(idEstoqueFarmacia, QtdeAntes, QtdeDepois, Descricao, DataHora, idUsuario)
	select
	loteOrigem.idEstoqueFarmacia, estoqueOrigem.QtdeEstoque + RLL.QtdeEntrega, estoqueOrigem.QtdeEstoque,
	'Saída por Requisição Qtd ' + cast( RLL.QtdeEntrega as varchar) +
	'- Lote ' + cast( loteOrigem.NumeroLote as varchar) +
	'- Fabricação ' + convert(varchar(10), loteOrigem.DataFabricacao, 103) +
	'- Validade ' + convert(varchar(10), loteOrigem.DataValidade, 103) as Descricao,
	GETDATE(), @idusuario
	from Tab_FarEstoqueRequisicaoLancamentoLote RLL
	join Cad_FarEstoqueFarmaciaLote LoteOrigem on LoteOrigem.idEstoqueFarmaciaLote = RLL.idEstoqueFarmaciaLote
	join Cad_FarEstoqueFarmacia EstoqueOrigem on EstoqueOrigem.idEStoqueFarmacia = LoteOrigem.idEstoqueFarmacia
	--join Cad_FarEstoqueFarmaciaLote LoteDestino on LoteDestino.idEstoqueFarmacia = @idEstoqueFarmacia
	--and LoteDestino.NumeroLote = LoteOrigem.NumeroLote
	where RLl.idEstoqueRequisicaoLancamento = @idEstoqueRequisicaoLancamento
	and RLL.idEstoqueRequisicaoLancamentoLote = @idEstoqueRequisicaoLancamentoLote

	print 'feito. Inclusão do histórico no estoque de destino.'


	FETCH NEXT FROM db_cursor INTO @idEstoqueRequisicaoLancamentoLote
END

CLOSE db_cursor
DEALLOCATE db_cursor

COMMIT TRAN ATUALIZAESTOQUE

end


GO

ALTER proc Cad_FarEstoqueFarmacia_Insert (@idProdutoFarmacia int, @idUnidadeAtendimento int, @idEmpresaFilial int)
as
begin
insert into Cad_FarEstoqueFarmacia
(idUnidadeAtendimento,idProdutoFarmacia,
QtdeEstoqueReposicao,
QtdeEstoque,
Desativado,
idEmpresaFilial)
select 
@idUnidadeAtendimento,
f.idProdutoFarmacia,
0 as QtdeEstoqueReposicao,
0 as QtdeEstoque,
0 as Desativado,
@idEmpresaFilial
from Cad_FarProdutoFarmacia F
left join Cad_FarEstoqueFarmacia E on E.idUnidadeAtendimento = @idUnidadeAtendimento
and E.idProdutoFarmacia = F.idProdutoFarmacia
where E.idEstoqueFarmacia is null
and f.idProdutoFarmacia = @idProdutoFarmacia

end
GO

ALTER proc [Cad_FarEstoqueFarmacia_Saida]  (@idMovimentoEstoque int)
--essa procedure será executada na compra de mercadoria.
--ela que irá efetivar a entrada da mercadoria no estoque.
-- ESSA PROCEDURE TAMBÉM É USADA PARA FAZER A DEVOLUÇÃO DO SETOR PARA A FARMACIA.
as
begin

Begin tran ATUALIZAESTOQUE

-- 1. Fazer insert na tabela Cad_FarEstoqueFarmaciaLote com a quantidade zerada,
-- se o registro do lote já existir então não devo incluir nada, terá um updade depois que fará isso.
insert into Cad_FarEstoqueFarmaciaLote
(idEstoqueFarmacia, NumeroLote, DataFabricacao, DataValidade, QtdeEstoque, Desativado)
select FMEL.idEstoqueFarmacia, FMEL.NumeroLote, FMEL.DataFabricacao, FMEL.DataValidade, 0 as QtdeEstoque, 0 as Desativado
from Tab_FarMovimentoEstoqueLancamento FMEL
join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null
left join Cad_FarEstoqueFarmaciaLote FEFL
	on FEFL.idEstoqueFarmacia = FMEL.idEStoqueFarmacia
	and FEFL.NumeroLote = FMEL.NumeroLote
where FMEL.idMovimentoEstoque = @idMovimentoEstoque
and FEFL.idEstoqueFarmaciaLote is null
and FMEL.Desativado =0

-- 2.Agora que tenho todos os lotes na tabela Cad_FarEstoqueFarmaciaLote
-- vou fazer update nos registros atualizando a quantidade em estoque no Destino (idestoqueFarmacia) somar
update FEFL
set FEFL.QtdeEstoque = isnull(FEFL.QtdeEstoque,0) + FMEL.QtdeEntrada
from Tab_FarMovimentoEstoqueLancamento FMEL
join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null and FME.TipoMovimentoConsumoSetor = 0
left join Cad_FarEstoqueFarmaciaLote FEFL
	on FEFL.idEstoqueFarmacia = FMEL.idEStoqueFarmacia
	and FEFL.NumeroLote = FMEL.NumeroLote
where FMEL.idMovimentoEstoque = @idMovimentoEstoque
and FMEL.Desativado =0

-- 3.Agora que tenho todos os lotes na tabela Cad_FarEstoqueFarmaciaLote
-- vou fazer update nos registros atualizando a quantidade em estoque na SAIDA (idestoqueFarmaciaSaida) subtrair
update FEFL
set FEFL.QtdeEstoque = isnull(FEFL.QtdeEstoque,0) - FMEL.QtdeEntrada
from Tab_FarMovimentoEstoqueLancamento FMEL
join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null
left join Cad_FarEstoqueFarmaciaLote FEFL
	on FEFL.idEstoqueFarmacia = FMEL.idEStoqueFarmaciaSaida --(SAIDA)
	and FEFL.NumeroLote = FMEL.NumeroLote
where FMEL.idMovimentoEstoque = @idMovimentoEstoque
and FMEL.Desativado =0




declare @idMovimentoEstoqueLancamento int

DECLARE db_cursor CURSOR FOR
SELECT idMovimentoEstoqueLancamento from Tab_FarMovimentoEstoqueLancamento
where idMovimentoEstoque = @idMovimentoEstoque

OPEN db_cursor
FETCH NEXT FROM db_cursor INTO @idMovimentoEstoqueLancamento

WHILE @@FETCH_STATUS = 0
BEGIN



	-- 4.Agora tenho que atualizar a quantidade da tabela Cad_FarEstoqueFarmacia DESTINO
	update FEF
	set FEF.QtdeEstoque = isnull(FEF.QtdeEstoque,0) + FMEL.QtdeEntrada
	from Tab_FarMovimentoEstoqueLancamento FMEL
	join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null  and FME.TipoMovimentoConsumoSetor = 0
	left join Cad_FarEstoqueFarmacia FEF
		on FEF.idEstoqueFarmacia = FMEL.idEStoqueFarmacia
	where FMEL.idMovimentoEstoque = @idMovimentoEstoque
	and FMEL.Desativado =0
	and FMEL.idMovimentoEstoqueLancamento = @idMovimentoEstoqueLancamento
	
	-- 5.Agora tenho que atualizar a quantidade da tabela Cad_FarEstoqueFarmacia -- SAIDA (SUBTRAIR)
	update FEF
	set FEF.QtdeEstoque = isnull(FEF.QtdeEstoque,0) - FMEL.QtdeEntrada --(SUBTRAIR)
	from Tab_FarMovimentoEstoqueLancamento FMEL
	join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null
	left join Cad_FarEstoqueFarmacia FEF
		on FEF.idEstoqueFarmacia = FMEL.idEStoqueFarmaciaSaida
	where FMEL.idMovimentoEstoque = @idMovimentoEstoque
	and	FMEL.Desativado =0
	and FMEL.idMovimentoEstoqueLancamento = @idMovimentoEstoqueLancamento


	-- 6.Aqui vou incluir o historico de ataalização

	insert into Cad_FarEstoqueFarmaciaHistorico
	(idEstoqueFarmacia, QtdeAntes, QtdeDepois, Descricao, idMovimentoEstoqueLancamento, idMovimentoEstoque)
	select FMEL.idEstoqueFarmacia,
	FEF.QtdeEstoque - FMEL.QtdeEntrada as QtdAntes,
	FEF.QtdeEstoque as QtdDepois,
	case when FME.TipoMovimentoDevolucao = 1 then '(Devolução) ' ELSE '' end +
	'Entrada de Mercadoria Qtd ' + cast( FMEL.QtdeEntrada as varchar) +
	'- Lote ' + cast( FMEL.NumeroLote as varchar) +
	'- Fabricação ' + convert(varchar(10), FMEL.DataFabricacao, 103) +
	'- Validade ' + convert(varchar(10), FMEL.DataValidade, 103) as Descricao,
	FMEL.idMovimentoEstoqueLancamento, FMEL.idMovimentoEstoque
	from Tab_FarMovimentoEstoqueLancamento FMEL
	join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null  and FME.TipoMovimentoConsumoSetor = 0
	JOIN Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = FMEL.idEstoqueFarmacia
	left join Cad_FarEstoqueFarmaciaLote FEFL
		on FEFL.idEstoqueFarmacia = FMEL.idEStoqueFarmacia
		and FEFL.NumeroLote = FMEL.NumeroLote
	where FMEL.idMovimentoEstoque = @idMovimentoEstoque
	and FMEL.Desativado =0
	and FMEL.idMovimentoEstoqueLancamento = @idMovimentoEstoqueLancamento

	-- 6.Aqui vou incluir o historico de ataalização

	insert into Cad_FarEstoqueFarmaciaHistorico
	(idEstoqueFarmacia, QtdeAntes, QtdeDepois, Descricao, idMovimentoEstoqueLancamento, idMovimentoEstoque)
	select FMEL.idEstoqueFarmaciaSaida,
	FEF.QtdeEstoque + FMEL.QtdeEntrada as QtdAntes,
	FEF.QtdeEstoque as QtdDepois,
	case when FME.TipoMovimentoDevolucao = 1 then '(Devolução) ' 
	when FME.TipoMovimentoConsumoSetor = 1 then '(Consumo por Setor) '
	ELSE '' end +
	'Saida de Mercadoria Qtd ' + cast( FMEL.QtdeEntrada as varchar) +
	'- Lote ' + cast( FMEL.NumeroLote as varchar) +
	'- Fabricação ' + convert(varchar(10), FMEL.DataFabricacao, 103) +
	'- Validade ' + convert(varchar(10), FMEL.DataValidade, 103) as Descricao,
	FMEL.idMovimentoEstoqueLancamento, FMEL.idMovimentoEstoque
	from Tab_FarMovimentoEstoqueLancamento FMEL
	join Tab_FarMovimentoEstoque FME on FME.idMovimentoEstoque = FMEL.idMovimentoEstoque and FME.DataFechamento is null
	JOIN Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = FMEL.idEstoqueFarmaciaSaida
	left join Cad_FarEstoqueFarmaciaLote FEFL
		on FEFL.idEstoqueFarmacia = FMEL.idEStoqueFarmaciaSaida
		and FEFL.NumeroLote = FMEL.NumeroLote
	where FMEL.idMovimentoEstoque = @idMovimentoEstoque
	and FMEL.Desativado =0
	and FMEL.idMovimentoEstoqueLancamento = @idMovimentoEstoqueLancamento


	FETCH NEXT FROM db_cursor INTO @idMovimentoEstoqueLancamento
END

CLOSE db_cursor
DEALLOCATE db_cursor




COMMIT TRAN ATUALIZAESTOQUE


end


GO

ALTER proc [Cad_FarProdutoFarmacia_Insert]
(@idMaterialMedicamentoTussNomenclatura int, @idLaboratorio int)
as
begin

insert into Cad_FarProdutoFarmacia
(
idMaterialMedicamentoTussNomenclatura,
NomeProdutoInterno,
idMaterialMedicamentoGrupo,
idMedicamentoPrincipioAtivo,
idLaboratorio,
TipoMaterial,
TipoMedicamento,
TipoGenerico,
DataCAdastro,
CodigoBarraEAN13,
Utilizado
)

select @idMaterialMedicamentoTussNomenclatura,
PTN.DescricaoTuss + isnull(' ' + PTN.Apresentacao, '') as NomeProdutoInterno,
PTN.idMaterialMedicamentoGrupo,
PTN.idMedicamentoPrincipioAtivo,
@idLaboratorio, 
PTN.TipoMaterial,
PTN.TipoMedicamento,
PTN.TipoGenerico,
--PTN.idTipoEmbalagemProduto,
--PTN.QtdeEmbalagemProduto,
--PTN.idTipoEmbalagemDistribuicao,
--PTN.QTDEEmbalagemDistribuicao,
getdate() as DataCAdastro,
PTN.CodigoBarraEAN13,
PTN.Utilizado
--PTN.BloqueioProduto,
--PTN.BloqueioprodutoMotivo,
--PTN.LiberacaoComReceituario,
--PTN.idPosologiadeUso,
--PTN.idPosologiadeAplicacao
From Tab_MaterialMedicamentoTussNomenclatura PTN
where
idMaterialMedicamentoTussNomenclatura = @idMaterialMedicamentoTussNomenclatura 


UPDATE Tab_MaterialMedicamentoTussNomenclatura
SET Utilizado = 1
where idMaterialMedicamentoTussNomenclatura = @idMaterialMedicamentoTussNomenclatura 


end
GO

ALTER procedure [Cad_PlanoConvenioProcedimento_update_idProcedimentoTabelaValor] (@idPlanoConvenio int)
as begin

update pcp
set pcp.idProcedimentoTabelaValor = tvn.idProcedimentoTabelaValor,
pcp.PTVMoedaCobranca = tvn.PTVMoedaCobranca,
pcp.PTVValProcedimento = tvn.PTVValProcedimento

from Cad_PlanoConvenioProcedimento pcp
join cad_planoconvenio pc on pc.idplanoconvenio = pcp.idplanoconvenio
join Tab_ProcedimentoTabelaValor Tv on tv.idprocedimentotabelavalor = pcp.idProcedimentoTabelaValor
join Tab_ProcedimentoTabelaValor tvn on tvn.idProcedimentoTabela = pc.idProcedimentoTabela and tvn.idProcedimentoTussNomenclatura = tv.idProcedimentoTussNomenclatura
where pcp.idProcedimentoTabelaValor <> tvn.idProcedimentoTabelaValor
and pc.idplanoconvenio = @idPlanoConvenio
end

GO

ALTER proc Cad_PlanoConvenioProcedimentoFator_INSERT
-- essa procedure é executada pelo formulario Unt_CadPlanoConvenioProcedimentoFator
@idPlanoConvenioProcedimento int
as begin

if exists(select * from Cad_PlanoConvenioProcedimentoFator where idPlanoConvenioProcedimento = @idPlanoConvenioProcedimento and Desativado = 0)
begin
	insert into Cad_PlanoConvenioProcedimentoFator
	(idPlanoConvenioProcedimento, idEmpresaFilial,
	idProcedimentoFCProAmb,idProcedimentoFCProInt,idProcedimentoFCProUti,
	idProcedimentoFCLabAmb, idProcedimentoFCLabInt, idProcedimentoFCLabUti,
	idProcedimentoFCFisAmb, idProcedimentoFCFisInt, idProcedimentoFCFisUti,
	idProcedimentoFCUltAmb, idProcedimentoFCUltInt, idProcedimentoFCUltUti,
	idProcedimentoFCRadAmb, idProcedimentoFCRadInt, idProcedimentoFCRadUti,
	ValFilmeRaioxAmb, ValFilmeRaioxInt, ValFilmeRaioxUti, 
	ValFilmeUltraAmb, ValFilmeUltraInt, ValFilmeUltraUti)
	
	select 
	@idPlanoConvenioProcedimento, 0, 
	Pc.idProcedimentoFCProAmb, pc.idProcedimentoFCProInt, pc.idProcedimentoFCProUti,
	pc.idProcedimentoFCLabAmb, pc.idProcedimentoFCLabInt, pc.idProcedimentoFCLabUti,
	pc.idProcedimentoFCFisAmb, pc.idProcedimentoFCFisInt, pc.idProcedimentoFCFisUti,
	pc.idProcedimentoFCUltAmb, pc.idProcedimentoFCUltInt, pc.idProcedimentoFCUltUti,
	pc.idProcedimentoFCRadAmb, pc.idProcedimentoFCRadInt, pc.idProcedimentoFCRadUti,
	pc.ValFilmeRaioxAmb, pc.ValFilmeRaioxInt, pc.ValFilmeRaioxUti, 
	pc.ValFilmeUltraAmb, pc.ValFilmeUltraInt, pc.ValFilmeUltraUti
	
	from Cad_PlanoConvenioProcedimento pcp
	cross join Cad_Empresa e 
	left join Cad_PlanoConvenioProcedimentoFator pf on pf.idPlanoConvenioProcedimento = pcp.idPlanoConvenioProcedimento and pf.idEmpresaFilial = 0 and pf.Desativado =0
	left join Cad_PlanoConvenio pc on pc.idPlanoConvenio = pcp.idPlanoConvenio
	where pcp.idPlanoConvenioProcedimento = @idPlanoConvenioProcedimento
	and pf.idPlanoConvenioProcedimento is null

	
	
	
	insert into Cad_PlanoConvenioProcedimentoFator
	(idPlanoConvenioProcedimento, idEmpresaFilial, 
	idProcedimentoFCProAmb,idProcedimentoFCProInt,idProcedimentoFCProUti,
	idProcedimentoFCLabAmb, idProcedimentoFCLabInt, idProcedimentoFCLabUti,
	idProcedimentoFCFisAmb, idProcedimentoFCFisInt, idProcedimentoFCFisUti,
	idProcedimentoFCUltAmb, idProcedimentoFCUltInt, idProcedimentoFCUltUti,
	idProcedimentoFCRadAmb, idProcedimentoFCRadInt, idProcedimentoFCRadUti,
	ValFilmeRaioxAmb, ValFilmeRaioxInt, ValFilmeRaioxUti, 
	ValFilmeUltraAmb, ValFilmeUltraInt, ValFilmeUltraUti)
	
	select 
	@idPlanoConvenioProcedimento, e.idEmpresaFilial, 
	Pc.idProcedimentoFCProAmb, pc.idProcedimentoFCProInt, pc.idProcedimentoFCProUti,
	pc.idProcedimentoFCLabAmb, pc.idProcedimentoFCLabInt, pc.idProcedimentoFCLabUti,
	pc.idProcedimentoFCFisAmb, pc.idProcedimentoFCFisInt, pc.idProcedimentoFCFisUti,
	pc.idProcedimentoFCUltAmb, pc.idProcedimentoFCUltInt, pc.idProcedimentoFCUltUti,
	pc.idProcedimentoFCRadAmb, pc.idProcedimentoFCRadInt, pc.idProcedimentoFCRadUti,
	pc.ValFilmeRaioxAmb, pc.ValFilmeRaioxInt, pc.ValFilmeRaioxUti, 
	pc.ValFilmeUltraAmb, pc.ValFilmeUltraInt, pc.ValFilmeUltraUti
	
	from Cad_PlanoConvenioProcedimento pcp
	join Cad_EmpresaFilial e on e.desativado = 0
	left join Cad_PlanoConvenioProcedimentoFator pf on pf.idPlanoConvenioProcedimento = pcp.idPlanoConvenioProcedimento and pf.idEmpresaFilial = e.idEmpresaFilial and pf.Desativado =0
	left join Cad_PlanoConvenio pc on pc.idPlanoConvenio = pcp.idPlanoConvenio
	where pcp.idPlanoConvenioProcedimento = @idPlanoConvenioProcedimento
	and pf.idPlanoConvenioProcedimento is null
	


end



end


GO

ALTER procedure [Cad_PlanoConvenioTaxa_Atualiza_idTaxaTabelaValor] (@idPlanoConvenio int, @idTaxaTabelaValor int)
as begin

update pcp
set
pcp.TaxaCodigoProprio = tvn.TaxaCodigoProprio,
pcp.ValorTaxa = tvn.ValorTaxa

from Cad_PlanoConvenioTaxa pcp
join cad_planoconvenio pc on pc.idplanoconvenio = pcp.idplanoconvenio
join Tab_TaxaTabelaValor Tv on tv.idTaxatabelavalor = pcp.idTaxaTabelaValor
join Tab_TaxaTabelaValor tvn on tvn.idTaxaTabela = pc.idTaxaTabela and tvn.idTaxaTussNomenclatura = tv.idTaxaTussNomenclatura
where pcp.idTaxaTabelaValor = tvn.idTaxaTabelaValor
and pc.idplanoconvenio = @idPlanoConvenio
and pcp.idTaxaTabelaValor = @idTaxaTabelaValor
end

GO

ALTER procedure [dbo].[Cad_PlanoConvenioTaxa_update_idTaxaTabelaValor] (@idPlanoConvenio int)
as begin

update pcp
set pcp.idTaxaTabelaValor = tvn.idTaxaTabelaValor,
pcp.TaxaCodigoProprio = tvn.TaxaCodigoProprio,
pcp.ValorTaxa = tvn.ValorTaxa

from Cad_PlanoConvenioTaxa pcp
join cad_planoconvenio pc on pc.idplanoconvenio = pcp.idplanoconvenio
join Tab_TaxaTabelaValor Tv on tv.idTaxatabelavalor = pcp.idTaxaTabelaValor
join Tab_TaxaTabelaValor tvn on tvn.idTaxaTabela = pc.idTaxaTabela and tvn.idTaxaTussNomenclatura = tv.idTaxaTussNomenclatura
where pcp.idTaxaTabelaValor <> tvn.idTaxaTabelaValor
and pc.idplanoconvenio = @idPlanoConvenio
end

GO

ALTER proc Cad_ProdutoFarmacia_Insert
(@idMaterialMedicamentoTussNomenclatura int, @idLaboratorio int)
as
begin
select @idMaterialMedicamentoTussNomenclatura,
PTN.DescricaoTuss + isnull(' ' + PTN.Apresentacao, '') as NomeProdutoInterno,
PTN.idMaterialMedicamentoGrupo,
PTN.idMedicamentoPrincipioAtivo,
@idLaboratorio, 
PTN.TipoMaterial,
PTN.TipoMedicamento,
PTN.TipoGenerico,
--PTN.idTipoEmbalagemProduto,
--PTN.QtdeEmbalagemProduto,
--PTN.idTipoEmbalagemDistribuicao,
--PTN.QTDEEmbalagemDistribuicao,
getdate() as DataCAdastro,
PTN.CodigoBarraEAN13,
PTN.Utilizado
--PTN.BloqueioProduto,
--PTN.BloqueioprodutoMotivo,
--PTN.LiberacaoComReceituario,
--PTN.idPosologiadeUso,
--PTN.idPosologiadeAplicacao
From Tab_MaterialMedicamentoTussNomenclatura PTN
where
idMaterialMedicamentoTussNomenclatura = @idMaterialMedicamentoTussNomenclatura 



end

--select * from Tab_MaterialMedicamentoTussNomenclatura
GO

ALTER  proc Copia_Cad_PlanoConvenioProcedimento
@idProcedimentoTabela int,
@idPlanoConvenio int
as
insert into Cad_PlanoConvenioProcedimento
(idPlanoConvenio, idProcedimentoTabelaValor, PTVMoedaCobranca, PTVValProcedimento, PTVValM2Filme, PTVNumIncidenciaFilme,
PTVValPercentualUrgencia, PTVCobrancaEnfermaria, PTVCobrancaApartamento, ValorFranquia, PercentualFranquia,
NecessitaAutorizacao, PCPCodigoTussReferencia, PCPDescricaoTussReferencia)
--declare @idplanoconvenio int
--set @idplanoconvenio = 5
--declare @idProcedimentoTabela int
--set @idProcedimentoTabela = 2
select @idPlanoConvenio, PTV.idProcedimentoTabelaValor, PTV.PTVMoedaCobranca, PTV.PTVValProcedimento, isnull(PTV.PTVValM2Filme,0),
case when isnull(PTV.PTVValM2Filme,0) > 0 and isnull(PTV.PTVNumIncidenciaFilme,0) = 0 then 1
else isnull(PTV.PTVNumIncidenciaFilme,0) end

, PTV.PTVValPercentualUrgencia, PTV.PTVCobrancaEnfermaria, PTV.PTVCobrancaApartamento,
0, 0, isnull(PTV.NecessitadeAutorizacao,0), PTN.PTNCodigoTuss, PTN.PTNDescricaoTuss
from Tab_ProcedimentoTabelaValor PTV
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = PTV.idProcedimentoTussNomenclatura
and PTN.PTNProcedimentoRealizado = 1 and PTN.Desativado = 0

left join Cad_PlanoConvenioProcedimento pc on pc.idPlanoConvenio = @idPlanoConvenio
and pc.idProcedimentoTAbelaValor = ptv.idProcedimentoTabelaValor and pc.desativado =0

where PTV.idProcedimentoTabela = @idProcedimentoTabela
and pc.idplanoconvenio is null

GO

ALTER proc [Copia_Cad_PrestadorMedicoESpecialidade]
@idPrestadorMedicoEspecialidade int
as
insert into cad_prestadorMedicoEspecialidade
(
idPrestadorMedico, idCbos, AtendeAmbulatorio, AtendeProntoSocorro, AtendeInternacao, 
AtendeUti, Desativado, Segunda, Terca, Quarta, Quinta, Sexta, Sabado, Domingo,
SegundaHoraInicio, SegundaHoraFim, TercaHoraInicio, TercaHoraFim,
QuartaHoraInicio, QuartaHoraFim, QuintaHoraInicio, QuintaHoraFim, SextaHoraInicio,
SextaHoraFim, SabadoHoraInicio, SabadoHoraFim, DomingoHoraInicio, DomingoHoraFim,
DataInicioExibicao, 
DataFimExibicao,
SegundaQuantidade,
SegundaQuantidadeMaxima,
TercaQuantidade,
TercaQuantidadeMaxima,
QuartaQuantidade,
QuartaQuantidadeMaxima,
QuintaQuantidade,
QuintaQuantidadeMaxima,
SextaQuantidade,
SextaQuantidadeMaxima,
SabadoQuantidade,
SabadoQuantidadeMaxima,
DomingoQuantidade,
DomingoQuantidadeMaxima,
Segundaalmoco,
TercaAlmoco,
QuartaAlmoco,
QuintaAlmoco,
SextaAlmoco,
SabadoAlmoco,
DomingoAlmoco,
SegundaAlmocoInicio,
TercaAlmocoInicio,
QuartaAlmocoInicio,
QuintaAlmocoInicio,
SextaAlmocoInicio,
SabadoAlmocoInicio,
DomingoAlmocoInicio,
SegundaAlmocoFim,
TercaAlmocoFim,
QuartaAlmocoFim,
QuintaAlmocoFim,
SextaAlmocoFim,
SabadoAlmocoFim,
DomingoAlmocoFim,

idSalaDomingo,
idSalaSegunda,
idSalaTerca,
idSalaQuarta,
idSalaQuinta,
idSalaSexta,
idSalaSabado


)

select idPrestadorMedico, idCbos, AtendeAmbulatorio, AtendeProntoSocorro, AtendeInternacao, 
AtendeUti, Desativado, Segunda, Terca, Quarta, Quinta, Sexta, Sabado, Domingo,
SegundaHoraInicio, SegundaHoraFim, TercaHoraInicio, TercaHoraFim,
QuartaHoraInicio, QuartaHoraFim, QuintaHoraInicio, QuintaHoraFim, SextaHoraInicio,
SextaHoraFim, SabadoHoraInicio, SabadoHoraFim, DomingoHoraInicio, DomingoHoraFim,
DataInicioExibicao, 
DataFimExibicao,
SegundaQuantidade,
SegundaQuantidadeMaxima,
TercaQuantidade,
TercaQuantidadeMaxima,
QuartaQuantidade,
QuartaQuantidadeMaxima,
QuintaQuantidade,
QuintaQuantidadeMaxima,
SextaQuantidade,
SextaQuantidadeMaxima,
SabadoQuantidade,
SabadoQuantidadeMaxima,
DomingoQuantidade,
DomingoQuantidadeMaxima,
Segundaalmoco,
TercaAlmoco,
QuartaAlmoco,
QuintaAlmoco,
SextaAlmoco,
SabadoAlmoco,
DomingoAlmoco,
SegundaAlmocoInicio,
TercaAlmocoInicio,
QuartaAlmocoInicio,
QuintaAlmocoInicio,
SextaAlmocoInicio,
SabadoAlmocoInicio,
DomingoAlmocoInicio,
SegundaAlmocoFim,
TercaAlmocoFim,
QuartaAlmocoFim,
QuintaAlmocoFim,
SextaAlmocoFim,
SabadoAlmocoFim,
DomingoAlmocoFim,

idSalaDomingo,
idSalaSegunda,
idSalaTerca,
idSalaQuarta,
idSalaQuinta,
idSalaSexta,
idSalaSabado

from cad_prestadormedicoespecialidade
where idprestadormedicoespecialidade = @idprestadorMedicoEspecialidade


insert into cad_prestadormedicoespecialidadeprocedimento
(
idPrestadorMedicoEspecialidade,
idProcedimentoTussNomenclatura,
Minutos,
Desativado,
QtdeProcedimentoDia,
QtdeProcedimentoDiaDomingo,
QtdeProcedimentoDiaSegunda,
QtdeProcedimentoDiaTerca,
QtdeProcedimentoDiaQuarta,
QtdeProcedimentoDiaQuinta,
QtdeProcedimentoDiaSexta,
QtdeProcedimentoDiaSabado,
QtdeProcedimentoDiaDomingoIlimitado,
QtdeProcedimentoDiaSegundaIlimitado,
QtdeProcedimentoDiaTercaIlimitado,
QtdeProcedimentoDiaQuartaIlimitado,
QtdeProcedimentoDiaQuintaIlimitado,
QtdeProcedimentoDiaSextaIlimitado,
QtdeProcedimentoDiaSabadoIlimitado
)
select 
@@identity,
idProcedimentoTussNomenclatura,
Minutos,
Desativado,
QtdeProcedimentoDia,
QtdeProcedimentoDiaDomingo,
QtdeProcedimentoDiaSegunda,
QtdeProcedimentoDiaTerca,
QtdeProcedimentoDiaQuarta,
QtdeProcedimentoDiaQuinta,
QtdeProcedimentoDiaSexta,
QtdeProcedimentoDiaSabado,
QtdeProcedimentoDiaDomingoIlimitado,
QtdeProcedimentoDiaSegundaIlimitado,
QtdeProcedimentoDiaTercaIlimitado,
QtdeProcedimentoDiaQuartaIlimitado,
QtdeProcedimentoDiaQuintaIlimitado,
QtdeProcedimentoDiaSextaIlimitado,
QtdeProcedimentoDiaSabadoIlimitado
from cad_prestadorMedicoEspecialidadeProcedimento
where desativado =0 and idprestadormedicoespecialidade = @idprestadormedicoespecialidade


GO

ALTER proc [dbo].[DCM_DICOMtoSQL]
as
begin

update i
set i.idPaciente = P.idPaciente
from dcm_imagem i

join Cad_Paciente P on P.Paciente = i.PacienteNome collate Latin1_General_CI_AI
	and P.DataNascimento = i.PacienteDataNascimento

join Tab_Atendimento A on A.idPaciente = P.idPaciente 
and cast(A.DataAtendimento as DATE) = CAST(i.datahora as DATE)

where i.idpaciente is null
and i.datahora >= GETDATE() - 30
end


GO

ALTER proc [dbo].[ExportaBPA] @DataFaturamento datetime
as begin


--declare @dataFaturamento datetime
--set @dataFaturamento = GETDATE()

declare @Controle varchar(4)
set @Controle = '1111'

declare @folhas int
set @folhas = 16

declare @Registros int
set @Registros = 283


/*
Calculo do campo de controle:
1) Somar o codigo de todos os procedimentos + quantidade.
2) Obter o resto da divisão do resultado acima por 1111.
3) Somar 1111 ao resto da divisão acima.
*/

---- HEADER CABEÇALHO
select 
1 as Ordem,
'01' + -- 01 - indicador de linha do Header
'#BPA#' + -- #BPA# - indicador de início do cabeçalho
convert(varchar(6), GETDATE(), 112) + -- Ano e mês de Processamento da produção no formato (AAAAMM).
dbo.zeroEsquerda(@Registros, 6) + -- Número de linhas do BPA gravadas. completar com zeros à esquerda.
dbo.zeroEsquerda(@Folhas, 6) + -- Quantidades de folhas de BPA gravadas. Completar com zeros à esquerda.
@Controle + -- Campo de controle.DOMÍNIO [1111..2221]
cast(e.NomeRazaoSocial as CHAR(30)) + -- Nome do órgão de origem responsável pela informação.
CAST(e.Apelido as CHAR(6))  + -- Sigla do órgão de origem responsável pela digitação.
CAST(e.CNPJ as CHAR(14)) + -- Sigla do órgão de origem responsável pela digitação.
cast('SIA' as CHAR(40)) + -- Nome do órgão de saúde destino do arquivo.
'M' + -- Indicador do órgão destino Estadual ou Municipal - "M" ou "E".
'SMGH201404' + --Versão do sistema, informação livre, pode conter qualquer letra e numero.
CHAR(13) + CHAR(10) as Linha
from Cad_Empresa e 

union

-- BPA-C (Boletim de Produção Ambulatorial CONSOLIDADO)
select 
2 as Ordem,
'02' + -- 02 = Identificação de linha de produção BPA-C
e.CodigoCNES + -- Código do CNES. A última posição à direita é o dígito verificador.
''
FROM cad_empresa e

union

-- BPA-I (Boletim de Produção Ambulatorial INDIVIDUALIZADA)
Select 
3 as Ordem,
'03' + -- 03 = Identificação de linha de produção BPA-I
e.CodigoCNES + -- Código do CNES. A última posição à direita é o dígito verificador.
convert(varchar(6), a.DataAtendimento, 112) + -- Competência de realização do procedimento.
dbo.ZeroEsquerda(PM.CodigoCNSProfissional, 15) + -- CNS do Medico
'2253202' + -- ** CBO do Medico
convert(varchar(8), a.DataAtendimento, 112) + -- Data de atendimento
dbo.ZeroEsquerda(1, 3) + -- ** Número da folha do BPA. Domínio [001..999]  
dbo.ZeroEsquerda(1, 2) + -- ** Número sequencial da linha dentro da folha do BPA. Domínio [01..20]
CAST(ptn.PTNCodigoTuss as CHAR(10)) + -- Código do procedimento ambulatorial. A última posição à direita é o dígito verificador.
dbo.ZeroEsquerda(P.CartaoNacionalSus, 15) + -- CNS do Paciente
case when sexo.Sexualidade = 'F' then 'F' else 'M' end + -- M – Masculino ou F – Feminino
'111111' + -- ** Código IBGE do município de residência
'1111' + -- ** CID 10

dbo.zeroEsquerda(dbo.idade(P.Datanascimento, A.DataAtendimento),3) + -- Idade

dbo.zeroEsquerda(1,6) + -- ** Quantidade de procedimentos produzidos.

dbo.zeroEsquerda(1,2) + -- ** Caracter de atendimento
dbo.zeroesquerda(s.idatendimentoservico, 13) + -- Numero da Autorização do estabelecimento
'EXT' + -- "BPA" -SIA/SUS ; "EXT"-OUTROS SISTEMAS

cast(P.Paciente as CHAR(30)) collate Latin1_General_CI_AS + -- Nome do usuario
convert(varchar(8), P.DataNascimento, 112) + -- Data de nascimento do usuário

isnull(cor.Codigo , 99) + -- Raca/cor do usuário
'    ' + -- Etnia do usuário

CAST(isnull(p.Nacionalidade,'') as CHAR(3)) + -- Nacionalidade do usuario
'000' + -- ** Codigo do Serviço
'000' + -- ** Codigo da Classificação
'00000000' + -- ** Codigo da Sequencia da Equipe
'0000' + -- ** Codigo da Area da Equipe
'00000000000000' + -- Codigo do CNPJ da empresa que realizou a manutenção ou adaptação da OPM
dbo.zeroEsquerda(p.Cep, 8) + -- Cep do usuario

isnull(lo.Codigo,'081') + -- codigo de logradouro do paciente
cast(isnull(p.Endereco,'') as CHAR(30)) + -- endereço do paciente
CAST(isnull(p.Complemento,'') as CHAR(10)) + -- complemento do endereço do paciente
CAST(isnull(p.Numero,'') as CHAR(5)) + -- numero do endereço do paciente
CAST(isnull(p.bairro,'') as CHAR(30)) + -- bairro do endereço do paciente
CAST(isnull(p.TelefoneResidencial,'') as CHAR(11)) + -- telefone do paciente
cast(isnull(p.Email,'') as CHAR(40)) + -- email do paciente

CHAR(13) + CHAR(10)

FROM Tab_Atendimento A
join Tab_AtendimentoServico S on S.idAtendimento = A.idAtendimento and S.Desativado =0
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio --and PC.TipoFaturamento = 1
join Cad_PrestadorMedico PM on PM.idPrestadorMedico = A.idMedicoExecutante
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = S.idProcedimentoTussNomenclatura and PTN.PTNProcedimentoTipoSUS = 1
join Cad_Paciente p on P.idpaciente = A.idPaciente
join Cad_ANSSexualidade Sexo on Sexo.idSexualidade = P.idsexualidade
left join Cad_ANSCor Cor on Cor.idCor = P.idCor
left join cad_ANSTipoLogradouro Lo on Lo.idTipoLogradouro = P.idTipoLogradouro
cross join Cad_Empresa e 
where A.Desativado = 0
and A.Gravado = 1
and A.DataAtendimento is not null
and dbo.AnoMes(A.DataAtendimento) = dbo.AnoMes(@DataFaturamento)
end


GO

ALTER proc [dbo].[FIN_RECEITA_INSERT] @idAtendimento int
as begin

--if not exists(select * from fin_receita where idatendimento = @idAtendimento  and Desativado = 0)
--print 'forma 1'

-- FORMA 1.


declare @QuantidadeReceita int
set @QuantidadeReceita = (Select count(*) from Fin_Receita r where r.Desativado = 0 and r.idAtendimento = @idAtendimento)

declare @ValorDevido money
set @ValorDevido = (Select sum(valorDevido) from Fin_Receita r where r.Desativado = 0 and r.idAtendimento = @idAtendimento)


if (@valorDevido > 0 ) begin
	declare @valorrecebido money
	set @valorrecebido = (select sum(isnull(valorpago1,0) + isnull(valorpago2,0)+ isnull(valorpago3,0)) from tab_Atendimento where idatendimento =@idatendimento)

	if @valorDevido <> @valorrecebido begin
		update Fin_Receita set desativado = 1 where idAtendimento = @idAtendimento 	
	end 


end

/*

if ( @QuantidadeReceita =1 ) begin
	if exists(select A.idAtendimento
		from Tab_Atendimento A
		left join Fin_Receita R on R.idAtendimento = A.idAtendimento and R.Desativado =0 and R.idForma = A.idForma1 and R.ValorDevido = A.ValorPago1
		where 
		A.idAtendimento = @idAtendimento
		and R.idReceita is null ) 
		
		update Fin_Receita set desativado = 1 where idAtendimento = @idAtendimento 
	
end

if ( @QuantidadeReceita =2 ) begin
	if exists(select A.idAtendimento
		from Tab_Atendimento A
		left join Fin_Receita R on R.idAtendimento = A.idAtendimento and R.Desativado =0 and R.idForma = A.idForma2 and R.ValorDevido = A.ValorPago2
		where 
		A.idAtendimento = @idAtendimento
		and A.idForma2 is not null
		and A.ValorPago2 is not null
		and R.idReceita is null ) 
		
		update Fin_Receita set desativado = 1 where idAtendimento = @idAtendimento 
 
	
end


if ( @QuantidadeReceita =3 ) begin
	if exists(select A.idAtendimento
		from Tab_Atendimento A
		left join Fin_Receita R on R.idAtendimento = A.idAtendimento and R.Desativado =0 and R.idForma = A.idForma3 and R.ValorDevido = A.ValorPago3
		where 
		A.idAtendimento = @idAtendimento
		and A.idForma3 is not null
		and A.ValorPago3 is not null
		and R.idReceita is null ) 
		
		update Fin_Receita set desativado = 1 where idAtendimento = @idAtendimento 

	
end


*/


if (select COUNT(*) from Fin_Receita where idAtendimento = @idAtendimento and Desativado = 0) = 0 begin
insert into fin_Receita
(idPlano, idPlanosub, idConta, DataMensalidade, DataVencimento, DataPagamento, ValorDevido, ValorPago,
idForma, Descricao,
Parcela, Parcelas, idCentro, TipoParcelamento, DataInclusao, idusuarioPagamentoAuto, idPaciente,
ReceitaMensal, Contabilizada, DiaNaoUtil, idAtendimento, Forma, ValorPDesconto, ValorDesconto, CartaoNumero)
select
e.idPlanoAtendimento, e.idPlanoSubAtendimento, isnull(f1.idContaAtendimento, e.idContaAtendimento),
cast(convert(varchar(10), a.DataInclusao- day(a.DataInclusao) + 1, 103) as datetime) as DataMensalidade,
case when f1.Forma <> 'DINHEIRO' then
	dbo.AcharDiaUtilPosterior(cast(convert(varchar(10), a.DataInclusao, 103) as datetime) + (f1.DiasParaPagamento * n.numero)) 
else
	dateadd(day, (f1.DiasParaPagamento * n.numero), a.DataInclusao ) 
end as DataVencimento,

case when f1.IncluirRegistroPago = 1 then
	case when f1.Forma <> 'DINHEIRO' then
		dbo.AcharDiaUtilPosterior(a.DataInclusao + (f1.DiasParaPagamento * n.Numero) + 0.0001)
	else
		a.DataInclusao + (f1.DiasParaPagamento * n.Numero) + 0.0001
	end
else
	null
end
as DataPagamento,
cast(a.ValorPago1 / f1.parcelas AS decimal(9,2)) as ValorDevido,
case when f1.IncluirRegistroPago =1 then
	cast(a.ValorPago1 / f1.parcelas AS decimal(9,2))
	-
	case when f1.ValorPDesconto > 0 then
		cast((cast(a.ValorPago1 / f1.parcelas AS decimal(9,2)) * f1.ValorPDesconto ) / 100 as decimal(9,2))
	else
		0
	end
else
	null
end as ValorPago,
a.idForma1 as idForma,
'ATENDIMENTO ' as Descricao,
n.Numero as Parcela,
case
when f1.Parcelas = 0 then
	1
else
	f1.Parcelas
end as Parcelas,

e.idCentroAtendimento,
case when f1.CartaoCredito =1 and f1.Parcelas > 1 then
	5
else
0
end as TipoParcelamento,

a.DataInclusao as DataInclusao,
a.idUsuarioInclusao, a.idPaciente,
0 as ReceitaMensal, 0 as Contabilizada, 3 as DiaNaoUtil, a.idAtendimento, 1 as Forma,
f1.ValorPDesconto,
case when f1.ValorPDesconto > 0 then
	cast((cast(a.ValorPago1 / f1.parcelas AS decimal(9,2)) * f1.ValorPDesconto ) / 100 as decimal(9,2))
else
	0
end as ValorDesconto,
DBO.SomenteNumeros( a.NumeroDocumento )

from Tab_Atendimento a
join Fin_Forma f1 on f1.idForma = isnull(a.idForma1, 1)
join sis_numero n on n.Numero <= isnull(f1.Parcelas,1)
join Cad_Empresa e on e.idempresa = 1 and e.idPlanoAtendimento is not null and e.idPlanoSubAtendimento is not null and e.idCentroAtendimento is not null
where a.idAtendimento = @idatendimento and a.ValorPago1 > 0


print 'forma 2'
-- forma 2
--if (select COUNT(*) from Fin_Receita where idAtendimento = @idAtendimento  and Desativado = 0) = 1
insert into fin_Receita
(idPlano, idPlanosub, idConta, DataMensalidade, DataVencimento, DataPagamento, ValorDevido, ValorPago,
idForma, Descricao,
Parcela, Parcelas, idCentro, TipoParcelamento, DataInclusao, idusuarioPagamentoAuto, idPaciente,
ReceitaMensal, Contabilizada, DiaNaoUtil, idAtendimento, Forma, ValorPDesconto, ValorDesconto, CartaoNumero)
select
e.idPlanoAtendimento, e.idPlanoSubAtendimento, isnull(f1.idContaAtendimento, e.idContaAtendimento),
cast(convert(varchar(10), a.DataInclusao- day(a.DataInclusao) + 1, 103) as datetime) as DataMensalidade,
cast(convert(varchar(10), a.DataInclusao, 103) as datetime) + (f1.DiasParaPagamento * n.Numero) as DataVencimento,
case when f1.IncluirRegistroPago = 1 then
	dbo.AcharDiaUtilPosterior(a.DataInclusao + (f1.DiasParaPagamento * n.Numero) + 0.0001)
else
	null
end
as DataPagamento,
cast(a.ValorPago2 / f1.Parcelas AS decimal(9,2)) as ValorDevido,
case when f1.IncluirRegistroPago =1 then
	cast(a.ValorPago2 / f1.Parcelas AS decimal(9,2))
	-
	case when f1.ValorPDesconto > 0 then
		cast((cast(a.ValorPago2 /f1.Parcelas AS decimal(9,2)) * f1.ValorPDesconto ) / 100 as decimal(9,2))
	else
		0
	end
else
	null
end as ValorPago,
a.idForma2 as idForma,
'ATENDIMENTO ' as Descricao,
n.Numero as Parcela,
case
when f1.Parcelas = 0 then
	1
else
	f1.Parcelas
end as Parcelas,

e.idCentroAtendimento,
case when f1.CartaoCredito =1 and f1.Parcelas > 1 then
	5
else
0
end as TipoParcelamento,

a.DataInclusao as DataInclusao,
a.idUsuarioInclusao, a.idPaciente,
0 as ReceitaMensal, 0 as Contabilizada, 3 as DiaNaoUtil, a.idAtendimento, 1 as Forma,
f1.ValorPDesconto,
case when f1.ValorPDesconto > 0 then
	cast((cast(a.ValorPago2 /f1.Parcelas AS decimal(9,2)) * f1.ValorPDesconto ) / 100 as decimal(9,2))
else
	0
end as ValorDesconto,
DBO.SomenteNumeros( a.NumeroDocumento2 )

from Tab_Atendimento a
join Fin_Forma f1 on f1.idForma = isnull(a.idForma2, 1)
join sis_numero n on n.Numero <= isnull(f1.Parcelas,1)

join Cad_Empresa e on e.idempresa = 1 and e.idPlanoAtendimento is not null and e.idPlanoSubAtendimento is not null and e.idCentroAtendimento is not null
where a.idAtendimento = @idatendimento and a.ValorPago2 > 0

-- FORMA 3
--if (select COUNT(*) from Fin_Receita where idAtendimento = @idAtendimento  and Desativado = 0) = 2
insert into fin_Receita
(idPlano, idPlanosub, idConta, DataMensalidade, DataVencimento, DataPagamento, ValorDevido, ValorPago,
idForma, Descricao,
Parcela, Parcelas, idCentro, TipoParcelamento, DataInclusao, idusuarioPagamentoAuto, idPaciente,
ReceitaMensal, Contabilizada, DiaNaoUtil, idAtendimento, Forma, ValorPDesconto, ValorDesconto, CartaoNumero)
select
e.idPlanoAtendimento, e.idPlanoSubAtendimento, isnull(f1.idContaAtendimento, e.idContaAtendimento),
cast(convert(varchar(10), a.DataInclusao- day(a.DataInclusao) + 1, 103) as datetime) as DataMensalidade,
cast(convert(varchar(10), a.DataInclusao, 103) as datetime) + (f1.DiasParaPagamento * n.numero) as DataVencimento,
case when f1.IncluirRegistroPago = 1 then
	dbo.AcharDiaUtilPosterior(a.DataInclusao + ( f1.DiasParaPagamento * n.Numero) + 0.0001)
else
	null
end
as DataPagamento,
cast(a.ValorPago3 / f1.parcelas as decimal(9,2)) as ValorDevido,
case when f1.IncluirRegistroPago =1 then
	cast(a.ValorPago3 / f1.Parcelas AS decimal(9,2))
	-
	case when f1.ValorPDesconto > 0 then
		cast(( cast(a.ValorPago3 /f1.Parcelas AS decimal(9,2))  * f1.ValorPDesconto ) / 100 as decimal(9,2))
	else
		0
	end
else
	null
end as ValorPago,
a.idForma3 as idForma,
'ATENDIMENTO ' as Descricao,
n.Numero as Parcela,
case
when f1.Parcelas = 0 then
	1
else
	f1.Parcelas
end as Parcelas,

e.idCentroAtendimento,
case when f1.CartaoCredito =1 and f1.Parcelas > 1 then
	5
else
0
end as TipoParcelamento,

a.DataInclusao as DataInclusao,
a.idUsuarioInclusao, a.idPaciente,
0 as ReceitaMensal, 0 as Contabilizada, 3 as DiaNaoUtil, a.idAtendimento, 1 as Forma,
f1.ValorPDesconto,
case when f1.ValorPDesconto > 0 then
	cast((cast(a.ValorPago3 / f1.Parcelas AS decimal(9,2)) * f1.ValorPDesconto ) / 100 as decimal(9,2))
else
	0
end as ValorDesconto,
DBO.SomenteNumeros( a.NumeroDocumento3 )

from Tab_Atendimento a
join Fin_Forma f1 on f1.idForma = isnull(a.idForma3, 1)
join Cad_Empresa e on e.idempresa = 1 and e.idPlanoAtendimento is not null and e.idPlanoSubAtendimento is not null and e.idCentroAtendimento is not null
join sis_numero n on n.Numero <= isnull(f1.Parcelas,1)
where a.idAtendimento = @idatendimento and a.ValorPago3 > 0
end



-----
declare @valortotalcliente money
set @valortotalcliente = (select sum(S.ValorTotalCliente) as ValorTotalCliente from Tab_AtendimentoServico S where S.idAtendimento = @idAtendimento)

declare @valortotalpago money
set @valortotalpago = (select SUM(valorpago) from Fin_Receita where idatendimento = @idAtendimento)

set @valortotalpago = @valortotalpago + (select SUM(ValorDevido) from Fin_Receita r join fin_forma f on f.idforma = r.idForma where idatendimento = @idAtendimento and (f.CartaoCredito = 1 or f.CartaoDebito = 1))


declare @valortotalDesconto money
set @valortotalDesconto = (select SUM(valordesconto) from Tab_Atendimento where idAtendimento = @idAtendimento)

declare @valortotaldebito money
set @valortotaldebito = @valortotalcliente - @valortotalpago - @valortotalDesconto


if (@valortotaldebito >0)

-- DEBITO
insert into fin_Receita
(idPlano, idPlanosub, idConta, DataMensalidade, DataVencimento, DataPagamento, ValorDevido, ValorPago,
idForma, Descricao,
Parcela, Parcelas, idCentro, TipoParcelamento, DataInclusao, idusuarioPagamentoAuto, idPaciente,
ReceitaMensal, Contabilizada, DiaNaoUtil, idAtendimento, Forma)
select
e.idPlanoAtendimento, e.idPlanoSubAtendimento, isnull(e.idContaAtendimentoDebito, e.idContaAtendimento),
cast(convert(varchar(10), a.DataInclusao- day(a.DataInclusao) + 1, 103) as datetime) as DataMensalidade,
cast(convert(varchar(10), a.DataInclusao, 103) as datetime) as DataVencimento,
null as DataPagamento,
@valortotaldebito as ValorDevido,
null as ValorPago,
null as idForma,
'ATENDIMENTO ' as Descricao, 1, 1, e.idCentroAtendimento, 0 as TipoParcelamento,
a.DataInclusao as DataInclusao,
null, a.idPaciente,
0 as ReceitaMensal, 0 as Contabilizada, 3 as DiaNaoUtil, a.idAtendimento, 0 as Forma

from Tab_Atendimento a
join Cad_Empresa e on e.idempresa = 1 and e.idPlanoAtendimento is not null and e.idPlanoSubAtendimento is not null and e.idCentroAtendimento is not null
where a.idAtendimento = @idatendimento



end
GO

ALTER proc [FIN_RECEITA_INSERT_GerarMensalidadeClube] @idclubecontrato int
as
----------------------
--- Calcula o Valor da mensalidade do Contrato Clube - Gravando do Fin_Receita
---
--- 20/03/2024 - Gustavo   - Calculo pela quantidade de beneficiarios informado na adesao
--- 23/03/2024 - Janderson - Acerto dia vencimento quando mes com 28/29 dias 
--- 16/08/2024 - janderson - Gera mensalidade com identificacao de conta banco ( cad_ClubeTipoCobranca / Cad_EmpresaClube )
--- 10/09/2024 - Gustavo   - Atualizacao
begin

---declare @idclubecontrato int
---set @idclubecontrato = 34

declare @idplanosubMensalidade int
declare @idplanoMensalidade int
select @idplanosubMensalidade = idplanosubMensalidade,
@idplanoMensalidade = idplanoMensalidade from Cad_ClubeEmpresa

declare @DataAdesaoContrato date
declare @dataRenovacaoContrato date

declare @dataProximaMensalidade date
declare @valorMensalidade money

--- Carregando Valores DataAdesao e Datarenovacao - Gustavo 08/2022 --
--- quando estiver preenchido a data renovacao, considerar essa como parametro
--- para gerar o contas a pagar ( boletos / carnet )
---
select @DataAdesaoContrato = DataAdesao from cad_clubecontrato
where idClubeContrato = @idclubecontrato and desativado = 0

select @DataRenovacaoContrato = DataRenovacaoContrato from cad_clubecontrato
where idClubeContrato = @idclubecontrato and desativado = 0

--- 22/09/2022 - Gustavo ( substitui DataMensalidade por DataVencimento )
--- Motivo - O lancamento ref mes nem sempre e compativel com o vencimento/pagamento, interferindo na geracao de novas mensalidades
select @dataProximaMensalidade = dateadd(month, 1, max(DataVencimento)) from fin_receita
where idclubeContrato = @idclubecontrato and desativado = 0



print @dataProximaMensalidade

declare @DataInicioModuloFinanceiro datetime
select @DataInicioModuloFinanceiro = max(DataInicioModuloFinanceiro) from cad_clubeempresa

---- inclusao nessa procedure fica com a seguinte logica
---- se o usuario marcar o bit digitouqtdebeneficiariogerarmensalidade
---- indica que o usuario vai gerar mensalidade/boleto sem ter a necessidade no momento de cadastrar os dependentes (geralmente plano empresa)
----
---- pego o valor da mensalidade = valormensalidade * QtdeBeneficiarioGerarMensalidade e tenho o valor do ajuste
---- pego o valor da carteirinha = valortaxaCarteirinha * QtdeBeneficiarioGerarMensalidade e tenho o valor de emissao do total de carteiras
---- pego o valor de adesao * 1 - nao tenho certeza disso ser necessario, apenas uma prevenção, acho que nao alteraria nada
----
---- seguindo a logica nao sera necessario alterar as formulas de calculo de primeira e demais mensalidades

declare @DigitouQtdeBeneficiarioGerarMensalidade bit 
declare @AtualizaValorTaxas bit

declare @ValorTaxaCarteirinha money
declare @ValorTaxaAdesao money
---declare @ValorAjusteBeneficiario money

select 
@DigitouQtdeBeneficiarioGerarMensalidade = DigitouQtdeBeneficiarioGerarMensalidade,
@AtualizaValorTaxas = AtualizaValorTaxas,
@valorMensalidade = ValorMensalidade,
@ValorTaxaAdesao = ValorTaxaAdesao,
@ValortaxaCarteirinha = ValorTaxaCarteirinha
from cad_clubeContrato where idclubecontrato = @idclubecontrato


if @AtualizaValorTaxas = 1 begin
	Select @valortaxacarteirinha = valortaxacarteirinha * QtdeBeneficiarioCadastrado,
           @ValorTaxaAdesao = ValorTaxaAdesao
	from cad_clubeContrato where idclubecontrato = @idclubecontrato
end


if @DigitouQtdeBeneficiarioGerarMensalidade = 1 begin
	select 
		@ValorTaxaCarteirinha =  (ValorTaxaCarteirinha * QtdeBeneficiarioGerarMensalidade),
		@valorMensalidade = (ValorMensalidade * QtdeBeneficiarioGerarMensalidade) 
		from cad_clubeContrato where idclubecontrato = @idclubecontrato
end
-----------

if @dataProximaMensalidade is null and @dataRenovacaoContrato is null begin
  select @dataProximaMensalidade = case when @DataInicioModuloFinanceiro > DataAdesao then @DataInicioModuloFinanceiro else DataAdesao end,
         @valorMensalidade = @ValorMensalidade + isnull(@valorTaxaAdesao,0) + isnull(@valortaxaCarteirinha, 0) from cad_clubecontrato where idClubeContrato = @idclubecontrato
end else
if @dataProximaMensalidade is null and @dataRenovacaoContrato is not null begin
  select @dataProximaMensalidade = DataRenovacaoContrato,
         @valorMensalidade = @ValorMensalidade + isnull(@valorTaxaAdesao,0) + isnull(@valortaxaCarteirinha, 0) from cad_clubecontrato where idClubeContrato = @idclubecontrato
end else begin
	select @valorMensalidade = @ValorMensalidade from cad_clubecontrato where idClubeContrato = @idclubecontrato

end

----------------------- alterei esse comentario, substituindo acima 08/2022
---if @dataProximaMensalidade is null and @dataRenovacaoContrato is null begin
---
---	select @dataProximaMensalidade = DataAdesao, @valorMensalidade = ValorMensalidade + isnull(valorTaxaAdesao,0) + isnull(valortaxaCarteirinha, 0) from cad_clubecontrato where idClubeContrato = @idclubecontrato
---end else begin
---	select @valorMensalidade = ValorMensalidade from cad_clubecontrato where idClubeContrato = @idclubecontrato
---end
-----------------------
declare @DataVencimento datetime

set @DataVencimento = dateadd(day, day(@dataProximaMensalidade) * -1  , @dataProximaMensalidade )

set @DataVencimento = dateadd(day, 1 , @DataVencimento )

declare @ValorFaixaEtaria money
set @ValorFaixaEtaria = isnull(dbo.idContratoTOValorFaixaEtaria(@idclubecontrato, @dataProximaMensalidade),0)

--fin_receita.DataVencimento = @ValorMensalidade + @ValorFaixaEtaria,


declare @dataproximoVencimento datetime
select @dataproximoVencimento  = dateadd(day,

case
	when cc.DiasVencimentoCobranca >= 1 and cc.DiasVencimentoCobranca <= 30 then cc.DiasVencimentoCobranca
	when cc.DataRenovacaoContrato is not null then day(cc.DataRenovacaoContrato)
	when cc.DataRenovacaoContrato is null then day(cc.DataAdesao)
end
	- 1, @DataVencimento  )
from cad_clubecontrato cc
join Cad_ClubeEmpresa emp on emp.idconta is not null
where cc.idclubecontrato = @idclubecontrato


while month(@dataproximaMensalidade) <> month(@dataproximoVencimento) begin
	set @dataproximoVencimento = dateadd(day, -1, @dataproximoVencimento)

end



insert into fin_receita
(idclubeContrato, idPlano, idplanosub,
DataMensalidade,
DataVencimento,
ValorDevido, Descricao,
Parcela, Parcelas, tipoParcelamento, DataInclusao, DiaNaoUtil, idconta)


select
cc.idClubeContrato,
@idplanoMensalidade, @idplanosubMensalidade,
@dataProximaMensalidade,

@dataProximoVencimento,


---select cc.idClubeContrato, @idplanoMensalidade, @idplanosubMensalidade,
---  @dataProximaMensalidade, dateadd(day,
---		case
---  			when cc.DiasVencimentoCobranca >= 1 and cc.DiasVencimentoCobranca <= 30 then
---				cc.DiasVencimentoCobranca
---			else
---				day(cc.DataAdesao)
---		end
---    		- 1, @DataVencimento  ),

@ValorMensalidade + @ValorFaixaEtaria,
---'MENSALIDADE - REFERENTE A DATA DE VENCIMENTO ' + convert(varchar(10), @DataVencimento, 103) as Descricao,
'MENSALIDADE - REFERENTE A DATA DE VENCIMENTO ' + convert(varchar(10), @DataProximaMensalidade, 103) as Descricao,

1 as Parcela, 1 as Parcelas, 0 as TipoParcelamento, getdate() as DataInclusao, 3 as DiaNaoUtil,
isnull(ctc.idConta, emp.idconta)

from cad_clubecontrato cc
left join Cad_ClubeTipoCobranca ctc on ctc.idClubeTipoCobranca = cc.idTipoCobrancaContrato

join Cad_ClubeEmpresa emp on emp.idconta is not null
where cc.idclubecontrato = @idclubecontrato

end
GO

ALTER proc FIN_RECEITA_INSERT_GerarValoAlteracaoClube @idclubecontratoGestao int
as begin

---declare @idclubecontratoGestao int
---set @idclubecontratoGestao = 4

declare @idPlanoSubAlteracaoContrato int
declare @idPlanoAlteracaoContrato int

select
@idPlanoSubAlteracaoContrato = idPlanoSubAlteracaoContrato,
@idPlanoAlteracaoContrato = idPlanoAlteracaoContrato from Cad_ClubeEmpresa


declare @DataAlteracaoNoContrato date
declare @valorMensalidade money

select @DataAlteracaoNoContrato = DataAlteracaoNoContrato from Cad_ClubeContratoGestao
where idClubeContratoGestao = @idclubecontratoGestao and desativado = 0

select
@valorMensalidade = ValorMensalidade + isnull(valorTaxaTrocaBeneficiario, 0) + isnull(valortaxaQuebraContrato, 0)
                                     + isnull(ValorTaxa1ViaCarteirinha, 0)   + isnull(valortaxa2ViaCarteirinha, 0)
									 * isnull (QtdeAlteracaoBeneficiario, 1)
from cad_clubecontratoGestao
where idClubeContratoGestao = @idclubecontratoGestao
end

------------------------------------------------------------
--- Data de Vencimento = Data da Realização da Alteração ---
------------------------------------------------------------
declare @DataPagamento date
set @DataPagamento = getdate()


insert into fin_receita
(idclubeContrato, idPlano, idplanosub,
DataMensalidade,
DataVencimento,
ValorDevido, Descricao,
Parcela, Parcelas, tipoParcelamento, DataInclusao, DiaNaoUtil, idconta)



select
cc.idClubeContrato,
@idPlanoAlteracaoContrato, @idplanoSubAlteracaoContrato,

getdate() as DataMensalidade,
getdate() as DataVencimento,

@ValorMensalidade,

case
	when valorTaxaTrocaBeneficiario > 1 then 'ALTERAÇÃO, Inclusão/Exclusão Beneficiário em: ' + convert(varchar(10), @DataPagamento, 103)
	when valortaxaQuebraContrato    > 1 then 'ALTERAÇÃO, Quebra de Contrato em: ' + convert(varchar(10), @DataPagamento, 103)
else
	'ALTERAÇÃO, Emissão da Carteira de Identificação em: ' + convert(varchar(10), @DataPagamento, 103) end as Descricao,

1 as Parcela, 1 as Parcelas,
0 as TipoParcelamento,

getdate() as DataInclusao,
3 as DiaNaoUtil,
emp.idconta


from cad_clubecontratoGestao cc
join Cad_ClubeEmpresa emp on emp.idconta is not null
where cc.idclubecontratoGestao = @idclubecontratoGestao
GO

ALTER proc [FIN_RECEITACONVENIO_INSERT] @idPlanoConvenio int, @numeroLoteTuss int
as begin


if exists(select * from fin_receita where idplanoconvenio = @idPlanoConvenio and numeroLoteTuss = @numeroLoteTuss and desativado = 0)
update fin_receita set desativado = 1 where idplanoconvenio = @idPlanoConvenio and numeroLoteTuss = @numeroLoteTuss and desativado = 0



insert into fin_Receita
(idPlano, idPlanosub, idConta, idConvenio, idPlanoConvenio, NumeroLoteTuss, DataMensalidade, DataVencimento, 
Descricao,
Parcela, Parcelas, TipoParcelamento, DataInclusao, 
ReceitaMensal, Contabilizada, DiaNaoUtil, ValorDevido)


select
co.idPlano, co.idPlanoSub, co.idConta, co.idConvenio, a.idPlanoconvenio, @NumeroLoteTuss,
max(a.[data Faturamento]),
max(dateadd(month, 1, a.[data Faturamento])) as DataVencimento,
'Lote n° ' + cast(a.NumeroLoteTuss as varchar),
1 as Parcela,
1 as Parcelas,
0 as TipoParcelamento,
getdate() as DataInclusao,
0 as ReceitaMensal,
0 as Contabilizada,
3 as diaNaoUtil,
sum(A.ValorTotalConvenio ) as ValorDevido

from vw_Tab_Faturamento a
join Cad_PlanoConvenio pc on pc.idplanoConvenio = a.idPlanoConvenio
join Cad_Convenio co on co.idConvenio = pc.idconvenio
join Cad_Empresa e on e.idempresa = 1 and e.idPlanoAtendimento is not null and e.idPlanoSubAtendimento is not null and e.idCentroAtendimento is not null
where a.idPlanoConvenio = @idPlanoconvenio
and a.NumeroLoteTuss = @numeroLoteTuss
and a.desativado =0 
group by
co.idPlano, co.idPlanoSub, co.idConta, co.idConvenio, a.idPlanoConvenio,
'Lote n° ' + cast(a.NumeroLoteTuss as varchar)

end



GO

ALTER proc PC_AdicionaMaterialnoAtendimento
--------------------------------------------------------------------------
--- Cobranca Kit - Adiciona Kit Procedimento no Atendimento 
--- Botao Adicionar no Atendimento - Adicona Kit Material e Medicamento
--------------------------------------------------------------------------
--- 11/02/2015
--- 24/07/2018 janderson , acrescentei o case do pk.MultiplicarQTDMatMed
---                        Multiplica a Qtde do Item do Kit pelo Valor e adiciona no Atendimento
---
@idAtendimentoServico int
as
insert into Tab_AtendimentoServico
(idatendimento, Quantidade, ValorTotalCliente, ValorTotalConvenio, PTVValProcedimento, PTVValM2FilmeTotal,
ValorTotalProcedimento, PTVMoedaCobranca, idMaterialTabelaValor, idMedicamentoTabelaValor, idMaterialTussNomenclatura, idMedicamentoTussNomenclatura,  idAtendimentoServicoOrigem, ContaConsolidada)

select
a.idAtendimento, isnull(pkt.qtdeMaterialMedicamento, 1) * case when pk.MultiplicarQTDMatMed =1 then S.Quantidade else 1 END as qtdeMaterialMedicamento,

case
when pcp.CobrarValorKit = 0 then
	0
when pc.TipoFaturamento = 0 then
	isnull(ttv.ValorMaterialMedicamentoCobranca * isnull(pkt.qtdeMaterialMedicamento, 1) * case when pk.MultiplicarQTDMatMed =1 then S.Quantidade else 1 END,0)
else 0 end as ValorTotalCliente,


case
when pcp.CobrarValorKit = 0 then
	0
when pc.TipoFaturamento = 0 then
	0
else
isnull(ttv.ValorMaterialMedicamentoCobranca * isnull(pkt.qtdeMaterialMedicamento, 1) * case when pk.MultiplicarQTDMatMed =1 then S.Quantidade else 1 END,0) end as ValorTotalConvenio,


case when pcp.CobrarValorKit = 0 then
	0
else
	isnull(ttv.ValorMaterialMedicamentoCobranca * case when pk.MultiplicarQTDMatMed =1 then S.Quantidade else 1 END,0)
end	as PTVValProcedimento,

0,


case when pcp.CobrarValorKit = 0 then
	0
else
	isnull(ttv.ValorMaterialMedicamentoCobranca * isnull(pkt.qtdeMaterialMedicamento, 1) * case when pk.MultiplicarQTDMatMed =1 then S.Quantidade else 1 END ,0)
end as ValorTotalProcedimento,


'R$' as PTVMoedaCobranca,


case when MMTN.TipoMaterial = 1 then ttv.idMaterialMedicamentoTabelaValor else null end,
case when MMTN.TipoMedicamento = 1 or MMTN.TipoGenerico = 1 then ttv.idMaterialMedicamentoTabelaValor else null end,


case when MMTN.TipoMaterial = 1 then pkt.idMaterialMedicamentoTussNomenclatura else null end,
case when MMTN.TipoMedicamento = 1 or MMTN.TipoGenerico = 1 then pkt.idMaterialMedicamentoTussNomenclatura else null end,

@idAtendimentoServico, pk.ContaConsolidada


from tab_Atendimentoservico s
join tab_atendimento a on a.idatendimento = s.idatendimento
join cad_pacienteplano pp on pp.idpacienteplano = a.idpacienteplano and pp.desativado = 0
join cad_planoconvenio pc on pc.idplanoconvenio = pp.idplanoconvenio and pc.desativado = 0
join cad_planoconvenioprocedimento pcp on pcp.idplanoconvenio = pc.idplanoconvenio
	and pcp.idProcedimentoTabelaValor = s.idProcedimentoTabelaValor and pcp.desativado = 0
	and pcp.idPlanoConvenioProcedimento = s.idplanoconvenioprocedimento
join Tab_ProcedimentoKit pk on pk.idprocedimentokit = pcp.idprocedimentokit and pk.desativado = 0

	and
	(
		(
			dbo.cobrarkitGuia1(pk.idProcedimentoKit, isnull(a.idEmpresaFilial,0)) = 1
			and
			A.idatendimentoanterior is null
		)
		or
		(
			dbo.cobrarkitGuia2(pk.idProcedimentoKit, isnull(a.idEmpresaFilial,0)) = 1
			and
			A.idatendimentoanterior is not null
		)
	)


join Tab_ProcedimentoKitMaterialMedicamento pkt on pkt.idProcedimentoKit = pk.idprocedimentokit and pkt.desativado = 0 and pkt.desativado = 0
join tab_materialmedicamentotussnomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = pkt.idMaterialMedicamentoTussNomenclatura and MMTN.desativado = 0
join tab_MaterialMedicamentoTabelaValor ttv on
	( ttv.idMaterialMedicamentoTabela = ( case when MMTN.TipoMaterial = 1 then pc.idMaterialTabela when MMTN.TipoMedicamento = 1 or MMTN.TipoGenerico = 1 then pc.idMedicamentoTabela else 0 end) )
	and ttv.idMaterialMedicamentoTussNomenclatura = pkt.idMaterialMedicamentoTussNomenclatura
	and ttv.Desativado = 0
where s.idatendimentoservico = @idAtendimentoServico




-- FILME
insert into Tab_AtendimentoServico
(idatendimento,
Quantidade,
ValorTotalCliente,
ValorTotalConvenio,
PTVValProcedimento,
PTVValM2FilmeTotal,
ValorTotalProcedimento,
PTVMoedaCobranca,
idMaterialTabelaValor, idMedicamentoTabelaValor, idMaterialTussNomenclatura, idMedicamentoTussNomenclatura,  idAtendimentoServicoOrigem, FilmeAcumuladonoValorTotalProcedimento)
select
a.idAtendimento,
S.Quantidade as qtdeMaterialMedicamento,
0 as ValorTotalCliente,
isnull(PTVValM2FilmeTotal,0) as ValorTotalConvenio,
isnull(PTVValM2FilmeTotal,0)  as PTVValProcedimento,
isnull(PTVValM2FilmeTotal,0)  as PTVValM2FilmeTotal,
isnull(PTVValM2FilmeTotal,0)  as ValorTotalProcedimento,
'R$' as PTVMoedaCobranca,

ttv.idMaterialMedicamentoTabelaValor,
null,
pcp.idMaterialMedicamentoTussNomenclatura,
null,
@idAtendimentoServico,
0
from tab_Atendimentoservico s
join tab_atendimento a on a.idatendimento = s.idatendimento
join cad_pacienteplano pp on pp.idpacienteplano = a.idpacienteplano and pp.desativado = 0
join cad_planoconvenio pc on pc.idplanoconvenio = pp.idplanoconvenio and pc.desativado = 0
join cad_planoconvenioprocedimento pcp on pcp.idplanoconvenio = pc.idplanoconvenio
	and pcp.idProcedimentoTabelaValor = s.idProcedimentoTabelaValor and pcp.desativado = 0
	and pcp.idPlanoConvenioProcedimento = s.idplanoconvenioprocedimento

join tab_materialmedicamentotussnomenclatura MMTN on
	MMTN.idMaterialMedicamentoTussNomenclatura = pcp.idMaterialMedicamentoTussNomenclatura and MMTN.desativado = 0

join tab_MaterialMedicamentoTabelaValor ttv on
	( ttv.idMaterialMedicamentoTabela = ( case when MMTN.TipoMaterial = 1 then pc.idMaterialTabela when MMTN.TipoMedicamento = 1 or MMTN.TipoGenerico = 1 then pc.idMedicamentoTabela else 0 end) )
	and ttv.idMaterialMedicamentoTussNomenclatura = pcp.idMaterialMedicamentoTussNomenclatura
	and ttv.Desativado = 0

where s.idatendimentoservico = @idAtendimentoServico
GO

ALTER proc [PC_AdicionaMaterialnoOrcamento]
@idOrcamentoServico int
as

declare @idPlanoConvenioParticular int
set @idPlanoConvenioParticular = ( select isnull(max(idplanoconvenio),0) from cad_planoconvenio where desativado = 0 and tipoFaturamento = 0 )

print @idPlanoConvenioParticular 

insert into Tab_OrcamentoServico
(idOrcamento, Quantidade, Valor, idMaterialTussNomenclatura, idMedicamentoTussNomenclatura, idOrcamentoServicoOrigem, ContaConsolidada)

select
a.idOrcamento, 

isnull(pkt.qtdeMaterialMedicamento, 1) * S.Quantidade as Quantidade, 

case 
when pcp.CobrarValorKit = 0 then
	0
when pc.TipoFaturamento = 0 then 
	isnull(ttv.ValorMaterialMedicamentoCobranca ,0)
else 0 
end as ValorTotalCliente,

case when MMTN.TipoMaterial = 1 then MMTN.idMaterialMedicamentoTussNomenclatura else null end,
case when MMTN.TipoMedicamento = 1 or MMTN.TipoGenerico = 1  then MMTN.idMaterialMedicamentoTussNomenclatura else null end,

@idOrcamentoServico, pk.ContaConsolidada
from Tab_OrcamentoServico s
join Tab_Orcamento a on a.idOrcamento = s.idOrcamento
join cad_planoconvenio pc on pc.idplanoconvenio = @idplanoconvenioParticular
join cad_planoconvenioprocedimento pcp on pcp.idplanoconvenio = pc.idplanoconvenio
	and pcp.idProcedimentoTabelaValor = s.idProcedimentoTabelaValor and pcp.desativado = 0
	--and pcp.idPlanoConvenioProcedimento = s.idplanoconvenioprocedimento
join Tab_ProcedimentoKit pk on pk.idprocedimentokit = pcp.idprocedimentokit and pk.desativado = 0
join Tab_ProcedimentoKitMaterialMedicamento pkt on pkt.idProcedimentoKit = pk.idprocedimentokit and pkt.desativado = 0 and pkt.desativado = 0
join tab_materialmedicamentotussnomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = pkt.idMaterialMedicamentoTussNomenclatura and MMTN.desativado = 0
join tab_MaterialMedicamentoTabelaValor ttv on
	( ttv.idMaterialMedicamentoTabela = ( case when MMTN.TipoMaterial = 1 then pc.idMaterialTabela when MMTN.TipoMedicamento = 1 or MMTN.TipoGenerico = 1  then pc.idMedicamentoTabela else 0 end) )
	and ttv.idMaterialMedicamentoTussNomenclatura = pkt.idMaterialMedicamentoTussNomenclatura
	and ttv.Desativado = 0
where s.idOrcamentoServico = @idOrcamentoServico


GO

ALTER proc PC_AdicionaTaxanoAtendimento
--------------------------------------------------------------------------
--- Cobranca Kit - Adiciona Kit Procedimento no Atendimento 
--- Botao Adicionar no Atendimento - Adicona Kit Taxas
--------------------------------------------------------------------------
--- Gustavo - 20/09/2018 - Acrescentei o case do pk.MultiplicarQTDTaxa
---                        Multiplica a Qtde do Item do Kit pelo Valor e adiciona no Atendimento
---

@idAtendimentoServico int
as
insert into Tab_AtendimentoServico
(idatendimento, Quantidade, ValorTotalCliente, ValorTotalConvenio, PTVValProcedimento, PTVValM2FilmeTotal,
ValorTotalProcedimento, PTVMoedaCobranca, idTaxaTabelaValor, idTaxaTussNomenclatura, idAtendimentoServicoOrigem, ContaConsolidada)
select

--- a.idAtendimento, isnull(pkt.qtdeTaxa, 1) as qtdeTaxa, - trocado linha baixo ( Multiplicar pela qtde kit )
a.idAtendimento, isnull(pkt.qtdeTaxa, 1) * case when pk.MultiplicarQTDTaxa = 1 then S.Quantidade else 1 END as qtdeTaxa,


case
when pcp.CobrarValorKit = 0 then 0
--- when pc.TipoFaturamento = 0 then isnull(PCT.ValorTaxa,0) - trocado linha abaixo ( Multiplicar pela qtde kit )
when pc.TipoFaturamento = 0 then isnull(PCT.ValorTaxa * isnull(pkt.qtdeTaxa, 1) * case when pk.MultiplicarQTDTaxa = 1 then S.Quantidade else 1 END,0)
else 0 end as ValorTotalCliente,


case
when pcp.CobrarValorKit = 0 then 0
when pc.TipoFaturamento = 0 then 0
else
---	isnull(PCT.ValorTaxa,0) - trocado linha abaixo ( Multiplicar pela qtde kit )
isnull(PCT.ValorTaxa * isnull(pkt.qtdeTaxa, 1) * case when pk.MultiplicarQTDTaxa = 1 then S.Quantidade else 1 END,0)
end as ValorTotalConvenio,


case when pcp.CobrarValorKit = 0 then 0
else
---	PCT.ValorTaxa - trocado linha abaixo ( Multiplicar pela qtde kit )
isnull(PCT.ValorTaxa * case when pk.MultiplicarQTDTaxa = 1 then S.Quantidade else 1 END,0)
end as PTVValProcedimento, 0,


case when pcp.CobrarValorKit = 0 then 0
else
---	isnull(PCT.ValorTaxa,0) - trocado linha abaixo ( Multiplicar pela qtde kit )
isnull(PCT.ValorTaxa * isnull(pkt.qtdeTaxa, 1) * case when pk.MultiplicarQTDTaxa = 1 then S.Quantidade else 1 END ,0)
end as ValorTotalProcedimento,


'R$' as PTVMoedaCobranca, pct.idTaxaTabelaValor, pkt.idTaxaTussNomenclatura,
@idAtendimentoServico, pk.ContaConsolidada


from tab_Atendimentoservico s
join tab_atendimento a on a.idatendimento = s.idatendimento
join cad_pacienteplano pp on pp.idpacienteplano = a.idpacienteplano and pp.desativado = 0
join cad_planoconvenio pc on pc.idplanoconvenio = pp.idplanoconvenio and pc.desativado = 0
join cad_planoconvenioprocedimento pcp on pcp.idplanoconvenio = pc.idplanoconvenio and pcp.idProcedimentoTabelaValor = s.idProcedimentoTabelaValor and pcp.desativado = 0
join Tab_ProcedimentoKit pk on pk.idprocedimentokit = pcp.idprocedimentokit
	and
	(
		(
			dbo.cobrarkitGuia1(pk.idProcedimentoKit, isnull(a.idEmpresaFilial,0)) = 1
			and
			A.idatendimentoanterior is null
		)
		or
		(
			dbo.cobrarkitGuia2(pk.idProcedimentoKit, isnull(a.idEmpresaFilial,0)) = 1
			and
			A.idatendimentoanterior is not null
		)

	)

join Tab_ProcedimentoKitTaxa pkt on pkt.idProcedimentoKit = pk.idprocedimentokit and pkt.desativado = 0
join tab_taxaTabelaValor ttv on ttv.idTaxaTabela = pc.idTaxaTabela and ttv.idTaxaTussNomenclatura = pkt.idTaxaTussNomenclatura and ttv.desativado = 0
join Cad_PlanoConvenioTaxa PCT on PCT.idPlanoConvenio = pc.idPlanoConvenio and pct.idTaxaTabelaValor = ttv.idTaxaTabelaValor and PCT.desativado =0
where s.idatendimentoservico = @idAtendimentoServico
GO

ALTER proc [PC_AdicionaTaxanoOrcamento] 
@idOrcamentoServico int
as

declare @idPlanoConvenioParticular int
set @idPlanoConvenioParticular = ( select isnull(max(idplanoconvenio),0) from cad_planoconvenio where desativado = 0 and tipoFaturamento = 0 )

print @idPlanoConvenioParticular 

insert into Tab_OrcamentoServico
(idOrcamento, Quantidade, Valor, idTaxaTussNomenclatura, idOrcamentoServicoOrigem, ContaConsolidada)
select 
a.idOrcamento, isnull(pkt.qtdeTaxa, 1) as qtdeTaxa, 

case when pcp.CobrarValorKit = 0 then
	0
else
	PCT.ValorTaxa 
end as PTVValProcedimento, 

pkt.idTaxaTussNomenclatura,

@idorcamentoServico, pk.contaConsolidada
from Tab_OrcamentoServico s
join Tab_Orcamento a on a.idOrcamento = s.idOrcamento
join cad_planoconvenio pc on pc.idplanoconvenio = @idPlanoConvenioParticular
join cad_planoconvenioprocedimento pcp on pcp.idplanoconvenio = pc.idplanoconvenio and pcp.idProcedimentoTabelaValor = s.idProcedimentoTabelaValor and pcp.desativado = 0
join Tab_ProcedimentoKit pk on pk.idprocedimentokit = pcp.idprocedimentokit
join Tab_ProcedimentoKitTaxa pkt on pkt.idProcedimentoKit = pk.idprocedimentokit and pkt.desativado = 0
join tab_taxaTabelaValor ttv on ttv.idTaxaTabela = pc.idTaxaTabela and ttv.idTaxaTussNomenclatura = pkt.idTaxaTussNomenclatura and ttv.desativado = 0
join Cad_PlanoConvenioTaxa PCT on PCT.idPlanoConvenio = pc.idPlanoConvenio and pct.idTaxaTabelaValor = ttv.idTaxaTabelaValor and PCT.desativado =0
where s.idOrcamentoServico = @idOrcamentoServico


GO

ALTER procedure PC_Cad_Agenda_Insert @idusuario int, @idPrestadormedico int, @idPaciente int
-- com essa procedure o sistema vai incluir o cad_agenda e tab_atendimento, para permitir ao medico incluir a consulta sem precisar da recepção.

as begin

declare @encaixe int
set @encaixe = 0

/*
declare @idUsuario int
set @idUsuario = 1


declare @idprestadorMedico int
set @idprestadorMedico = 3

declare @idpaciente int
set @idpaciente = 88922
*/

declare @idplanoConvenio int
set @idplanoConvenio = (select max(PP.idplanoconvenio) From Cad_Paciente P 
join Cad_PacientePlano PP on PP.idPacientePlano = (select MAX(idPacientePlano) from Cad_PacientePlano where Desativado = 0 and idPaciente = P.idPaciente)
where P.idPaciente = @idpaciente)


declare @proximoNumero int
set @proximoNumero = isnull((select MAX(numero) from Cad_Agenda where idPrestadorMedico = @idprestadorMedico 
	and Desativado = 0 and cast(DataHoraMarcada as DATE) = CAST(getdate() as date)),0) + 1

declare @idPLanoConvenioGuiaTiss int
set @idPLanoConvenioGuiaTiss = isnull((select MAX(idplanoconvenioguiatiss) from Cad_PlanoConvenioGuiaTiss 
	where Desativado =0 and idPlanoConvenio = @idPLanoConvenio and idGuiaTissAtendimento = 2),0)

if @idPLanoConvenioGuiaTiss = 0 
	set @idPLanoConvenioGuiaTiss = isnull((select MAX(idplanoconvenioguiatiss) from Cad_PlanoConvenioGuiaTiss 
	where Desativado =0 and idPlanoConvenio = @idPLanoConvenio and idGuiaTissAtendimento = 3),0)
	

insert into Cad_Agenda
(idPaciente, DataHoraMarcada, idProcedimentoTussNomenclatura, idPrestadorMedico, idPlanoConvenio, Minutos, 
Confirmado, Falta, SegundoInicio, SegundosFim, idUsuarioAuto, Encaixe, Paciente, TelefoneResidencial, TelefoneCelular, TelefoneComercial, 
idPrestadorMedicoEspecialidade, idPlanoConvenioProcedimento, DataHoraInclusao, Numero)
select 
P.idPaciente, GETDATE() as DataHoraMarcada, 1 as idProcedimentoTussNomenclatura, pm.idPrestadorMedico, pp.idPlanoConvenio, pm.EscalaAgenda as minutos, 
1 as Confirmado, 0 as Falta, 0 as SegundoInicio, 0 as SegundosFim, @idusuario, @encaixe, P.Paciente, P.TelefoneResidencial, P.TelefoneCelular, P.TelefoneComercial,
PME.idPrestadorMedicoEspecialidade, PCP.idPlanoConvenioProcedimento, GETDATE(), @proximoNumero
From Cad_Paciente P 
join Cad_PacientePlano PP on PP.idPacientePlano = (select MAX(idPacientePlano) from Cad_PacientePlano where Desativado = 0 and idPaciente = P.idPaciente)
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = PP.idPlanoConvenio
join Cad_PrestadorMedico pm on pm.idPrestadorMedico = @idPrestadormedico
join Cad_PrestadorMedicoEspecialidade PME on PME.idPrestadorMedicoEspecialidade = (select MAX(idprestadorMedicoEspecialidade) from Cad_PrestadorMedicoEspecialidade where Desativado = 0 and idPrestadorMedico = PM.idPrestadorMedico)
join Tab_ProcedimentoTabelaValor PTV on PTV.idProcedimentoTabela = pc.idProcedimentoTabela and PTV.Desativado = 0 and PTV.idProcedimentoTussNomenclatura = 1
join Cad_PlanoConvenioProcedimento PCP on PCP.idPlanoConvenio = PP.idPlanoConvenio and PCP.Desativado = 0 and PCP.idProcedimentoTabelaValor = PTV.idProcedimentoTabelaValor
where P.idPaciente = @idPaciente


declare @idAgenda int
set @idAgenda = @@IDENTITY



--irá incluir o registro em Tab_Atendimento 
insert into Tab_Atendimento
(NumeroProntuario, NumeroGuia, idUnidadeAtendimento, idPaciente, idUsuarioInclusao, DataAtendimento, HoraAtendimentoNormal, HoraAtendimentoUrgencia, idCaraterSolicitacao, 
DataEmissaoGuia, idPacientePlano, idMedicoExecutante, idEspecialidadeExecutante, Gravado, 
ContratadoOperadora, ContratadoSolicitante, ContratadoCNES, revisao, Consulta, Desativado, idPlanoConvenioGuiaTiss, TipoGuia, idPlanoConvenio,
NumeroGuiaDigitada, idTipoAtendimento, idIndicadorAcidente, idTipoConsulta, idTipoSaidaConsulta, 
DataInclusao, idEmpresaFilial, AtendidoComReceituario, idTipoSaidaSpadt, idAgenda, idconvenio, AtendimentoAoRN, 
TipoRegistroOperadora)

select
a.idAgenda as NumeroProntuario, a.idAgenda as NumeroGuia, 1 as idUnidadeAtendimento, a.idPaciente, a.idUsuarioAuto, a.DataHoraInclusao as DataAtendimento,
1 as HoraAtendimentoNormal, 0 as HoraAtendimentoUrgencia, 3 as idCaraterSolicitacao,
CAST(a.DataHoraInclusao as DATE) as DataEmissaoGuia, pp.idPacientePlano, a.idPrestadorMedico, a.idPrestadorMedicoEspecialidade, 1 as Gravado,
null as contratadoOperadora, null as ContratadoSolicitante, null as contratoCNES, 0 as Revisao, 1 as Consulta, 0 as Desativado, 
PCGT.idPlanoConvenioGuiaTiss, 1 as TipoGuia, pp.idPlanoConvenio, 0 as numeroGuiaDigitada, 4 as idTipoAtendimento, 4 as idIndicadorAcidente, 1 as idTipoConsulta,
5 as idTipoSaidaConsulta, a.DataHoraInclusao, 0 as idEmpresaFilial, 0 as AtendimentoComReceituario, 5 as idTipoSaidaSPSADT, a.idAgenda, 
PC.idConvenio, 0 as AtendimentoaoRN, 0 as TipoRegistroOperadora

from Cad_Agenda a
join Cad_Paciente P on P.idPaciente = a.idPaciente
join Cad_PacientePlano PP on PP.idPacientePlano = (select MAX(idPacientePlano) from Cad_PacientePlano where Desativado = 0 and idPaciente = P.idPaciente)
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = PP.idPlanoConvenio
left join Cad_PlanoConvenioGuiaTiss PCGT on PCGT.idPlanoConvenioGuiaTiss = @idPLanoConvenioGuiaTiss
where a.idAgenda = @idAgenda

print @idagenda
print @@identity

update Cad_Agenda
set idAtendimento = @@IDENTITY
where idAgenda = @idAgenda

end


GO

ALTER proc PC_Cad_PlanoConvenioEspecialidade_Copia_Plano
	@idPlanoConvenioOrigem int,
	@idPlanoConvenioDestino int
-- copiar as Especialidades do plano para outros planos
AS
BEGIN

insert into [Cad_PlanoConvenioEspecialidade] 
(
	[idPlanoConvenio],
	[idCbos] ,
	[NumeroDiasRevisao],
	[NumeroDiasCarencia],
	[AceitaAmbulatorio],
	[AceitaProntoSocorro],
	[AceitaInternacao],
	[AceitaUti],
	[BloqueioEspecialidade],
	[BloqueioMotivo],
	[Desativado]
)
select
	@idPlanoConvenioDestino,
	[idCbos] ,
	[NumeroDiasRevisao],
	[NumeroDiasCarencia],
	[AceitaAmbulatorio],
	[AceitaProntoSocorro],
	[AceitaInternacao],
	[AceitaUti],
	[BloqueioEspecialidade],
	[BloqueioMotivo],
	[Desativado]
from Cad_PlanoConvenioEspecialidade
where idPlanoConvenio= @idPlanoConvenioOrigem
end

GO

ALTER proc PC_Cad_PlanoConvenioProcedimento_Copia_Plano
	@idPlanoConvenioOrigem int,
	@idPlanoConvenioDestino int
-- copiar os Procedimentos atendidos pelo plano para outros planos
AS
BEGIN

insert into [Cad_PlanoConvenioProcedimento] 
(
	[idPlanoConvenio],
	[idProcedimentoTabelaValor] ,
	[PTVMoedaCobranca],
	[PTVValProcedimento],
	[PTVValM2Filme],
	[PTVNumIncidenciaFilme],
	[PTVValPercentualUrgencia],
	[PTVCobrancaEnfermaria],
	[PTVCobrancaApartamento],
	[ValorFranquia],
	[PercentualFranquia],
	[NecessitaAutorizacao],
	[idProcedimentoKit],
	[PCPCodigoTussReferencia],
	[PCPDescricaoTussReferencia],
	[Desativado]
)
select
	@idPlanoConvenioDestino,
	[idProcedimentoTabelaValor] ,
	[PTVMoedaCobranca],
	[PTVValProcedimento],
	[PTVValM2Filme],
	[PTVNumIncidenciaFilme],
	[PTVValPercentualUrgencia],
	[PTVCobrancaEnfermaria],
	[PTVCobrancaApartamento],
	[ValorFranquia],
	[PercentualFranquia],
	[NecessitaAutorizacao],
	[idProcedimentoKit],
	[PCPCodigoTussReferencia],
	[PCPDescricaoTussReferencia],
	[Desativado]

from Cad_PlanoConvenioProcedimento
where idPlanoConvenio= @idPlanoConvenioOrigem
end

GO

ALTER proc PC_Cad_PrestadorMedicoEspecialidade_Copia_Especialidade
	@idPrestadorMedicoOrigem int,
	@idPrestadorMedicoDestino int
-- copiar a especialidade do medico de um para outro medico
AS
BEGIN

insert into [Cad_PrestadorMedicoEspecialidade] 
(
	[idPrestadorMedico] ,
	[idCbos] ,
	[AtendeAmbulatorio],
	[AtendeProntoSocorro],
	[AtendeInternacao],
	[AtendeUti],
	[Desativado],
	[Segunda],
	[Terca],
	[Quarta],
	[Quinta],
	[Sexta],
	[Sabado],
	[Domingo],
	[SegundaHoraInicio],
	[SegundaHoraFim],
	[TercaHoraInicio], 
	[TercaHoraFim], 
	[QuartaHoraInicio], 
	[QuartaHoraFim], 
	[QuintaHoraInicio], 
	[QuintaHoraFim], 
	[SextaHoraInicio], 
	[SextaHoraFim], 
	[SabadoHoraInicio], 
	[SabadoHoraFim], 
	[DomingoHoraInicio], 
	[DomingoHoraFim], 
	[DataInicioExibicao], 
	[DataFimExibicao], 
	[SegundaQuantidade], 
	[SegundaQuantidadeMaxima], 
	[TercaQuantidade], 
	[TercaQuantidadeMaxima], 
	[QuartaQuantidade], 
	[QuartaQuantidadeMaxima], 
	[QuintaQuantidade], 
	[QuintaQuantidadeMaxima], 
	[SextaQuantidade], 
	[SextaQuantidadeMaxima], 
	[SabadoQuantidade], 
	[SabadoQuantidadeMaxima], 
	[DomingoQuantidade], 
	[DomingoQuantidadeMaxima], 
	[SegundaAlmoco], 
	[TercaAlmoco], 
	[QuartaAlmoco], 
	[QuintaAlmoco], 
	[SextaAlmoco], 
	[SabadoAlmoco], 
	[DomingoAlmoco], 
	[SegundaAlmocoinicio] , 
	[TercaAlmocoinicio] , 
	[QuartaAlmocoinicio] , 
	[QuintaAlmocoinicio] , 
	[SextaAlmocoinicio] , 
	[SabadoAlmocoinicio] , 
	[DomingoAlmocoinicio] , 
	[SegundaAlmocoFim] , 
	[TercaAlmocoFim] , 
	[QuartaAlmocoFim] , 
	[QuintaAlmocoFim] , 
	[SextaAlmocoFim] , 
	[SabadoAlmocoFim], 
	[DomingoAlmocoFim]
)
select
	@idPrestadorMedicoDestino ,
	[idCbos] ,
	[AtendeAmbulatorio],
	[AtendeProntoSocorro],
	[AtendeInternacao],
	[AtendeUti],
	[Desativado],
	[Segunda],
	[Terca],
	[Quarta],
	[Quinta],
	[Sexta],
	[Sabado],
	[Domingo],
	[SegundaHoraInicio],
	[SegundaHoraFim],
	[TercaHoraInicio], 
	[TercaHoraFim], 
	[QuartaHoraInicio], 
	[QuartaHoraFim], 
	[QuintaHoraInicio], 
	[QuintaHoraFim], 
	[SextaHoraInicio], 
	[SextaHoraFim], 
	[SabadoHoraInicio], 
	[SabadoHoraFim], 
	[DomingoHoraInicio], 
	[DomingoHoraFim], 
	[DataInicioExibicao], 
	[DataFimExibicao], 
	[SegundaQuantidade], 
	[SegundaQuantidadeMaxima], 
	[TercaQuantidade], 
	[TercaQuantidadeMaxima], 
	[QuartaQuantidade], 
	[QuartaQuantidadeMaxima], 
	[QuintaQuantidade], 
	[QuintaQuantidadeMaxima], 
	[SextaQuantidade], 
	[SextaQuantidadeMaxima], 
	[SabadoQuantidade], 
	[SabadoQuantidadeMaxima], 
	[DomingoQuantidade], 
	[DomingoQuantidadeMaxima], 
	[SegundaAlmoco], 
	[TercaAlmoco], 
	[QuartaAlmoco], 
	[QuintaAlmoco], 
	[SextaAlmoco], 
	[SabadoAlmoco], 
	[DomingoAlmoco], 
	[SegundaAlmocoinicio] , 
	[TercaAlmocoinicio] , 
	[QuartaAlmocoinicio] , 
	[QuintaAlmocoinicio] , 
	[SextaAlmocoinicio] , 
	[SabadoAlmocoinicio] , 
	[DomingoAlmocoinicio] , 
	[SegundaAlmocoFim] , 
	[TercaAlmocoFim] , 
	[QuartaAlmocoFim] , 
	[QuintaAlmocoFim] , 
	[SextaAlmocoFim] , 
	[SabadoAlmocoFim], 
	[DomingoAlmocoFim]
from Cad_PrestadorMedicoEspecialidade
where idprestadormedico= @idPrestadorMedicoOrigem

end

GO

ALTER proc PC_Cad_PrestadorMedicoPlano_Copia_Plano
	@idPrestadorMedicoOrigem int,
	@idPrestadorMedicoDestino int
-- copiar os Planos atendidos pelo medico para outros medico
AS
BEGIN

insert into [Cad_PrestadorMedicoPlano] 
(
	[idPrestadorMedico],
	[idPlanoConvenio] ,
	[TipodeAtendimento],
	[LimiteAtendimento],
	[AtendeAmbulatorio],
	[AtendeProntoSocorro],
	[AtendeInternacao],
	[AtendeUti],
	[Desativado]
)
select
	@idPrestadorMedicoDestino,
	[idPlanoConvenio] ,
	[TipodeAtendimento],
	[LimiteAtendimento],
	[AtendeAmbulatorio],
	[AtendeProntoSocorro],
	[AtendeInternacao],
	[AtendeUti],
	[Desativado]
from Cad_PrestadorMedicoPlano
where idprestadormedico= @idPrestadorMedicoOrigem
end

GO

ALTER proc [PC_CREATE_DROP_INDEX]
as
--06/01/2015
begin


DROP INDEX Tab_Atendimento.IX_Tab_Atendimento_NumeroProntuario
CREATE INDEX IX_Tab_Atendimento_NumeroProntuario ON Tab_Atendimento (NumeroProntuario) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX Tab_Atendimento.IX_Tab_Atendimento_idAtendimentoAnterior
CREATE INDEX IX_Tab_Atendimento_idAtendimentoAnterior ON Tab_Atendimento (idAtendimentoAnterior) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX Tab_ProcedimentoTussNomenclatura.IX_Tab_ProcedimentoTussNomenclatura_PTNProcedimentocomLaudo
CREATE INDEX IX_Tab_ProcedimentoTussNomenclatura_PTNProcedimentocomLaudo ON Tab_ProcedimentoTussNomenclatura (PTNProcedimentocomLaudo) WITH PAD_INDEX, FILLFACTOR = 50


DROP INDEX TAB_ATENDIMENTOLAUDOULTRASONOGRAFIA.IX_TAB_ATENDIMENTO_DATAATENDIMENTOLAUDO
CREATE INDEX IX_TAB_ATENDIMENTO_DATAATENDIMENTOLAUDO ON TAB_ATENDIMENTOLAUDOULTRASONOGRAFIA (DATAATENDIMENTOLAUDO) WITH PAD_INDEX, FILLFACTOR = 50


DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DATAATENDIMENTO
CREATE INDEX IX_TAB_ATENDIMENTO_DATAATENDIMENTO ON TAB_ATENDIMENTO (DATAATENDIMENTO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_HORAATENDIMENTO
CREATE INDEX IX_TAB_ATENDIMENTO_HORAATENDIMENTO ON TAB_ATENDIMENTO (HORAATENDIMENTO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DATAEMISSAOGUIA
CREATE INDEX IX_TAB_ATENDIMENTO_DATAEMISSAOGUIA ON TAB_ATENDIMENTO (DATAEMISSAOGUIA) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_IDMEDICOSOLICITANTE
CREATE INDEX IX_TAB_ATENDIMENTO_IDMEDICOSOLICITANTE ON TAB_ATENDIMENTO (IDMEDICOSOLICITANTE) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_GRAVADO
CREATE INDEX IX_TAB_ATENDIMENTO_GRAVADO ON TAB_ATENDIMENTO (GRAVADO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DESATIVADO
CREATE INDEX IX_TAB_ATENDIMENTO_DESATIVADO ON TAB_ATENDIMENTO (DESATIVADO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_CONSULTA
CREATE INDEX IX_TAB_ATENDIMENTO_CONSULTA ON TAB_ATENDIMENTO (CONSULTA) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_REVISAO
CREATE INDEX IX_TAB_ATENDIMENTO_REVISAO ON TAB_ATENDIMENTO (REVISAO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DATACANCELAMENTO
CREATE INDEX IX_TAB_ATENDIMENTO_DATACANCELAMENTO ON TAB_ATENDIMENTO (DATACANCELAMENTO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DATAFATURAMENTO
CREATE INDEX IX_TAB_ATENDIMENTO_DATAFATURAMENTO ON TAB_ATENDIMENTO (DATAFATURAMENTO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DATACOMPETENCIAFATURAMENTO
CREATE INDEX IX_TAB_ATENDIMENTO_DATACOMPETENCIAFATURAMENTO ON TAB_ATENDIMENTO (DATACOMPETENCIAFATURAMENTO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DATALOTETUSS
CREATE INDEX IX_TAB_ATENDIMENTO_DATALOTETUSS ON TAB_ATENDIMENTO (DATALOTETUSS) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DATALOTECONFIRMACAOTUSS
CREATE INDEX IX_TAB_ATENDIMENTO_DATALOTECONFIRMACAOTUSS ON TAB_ATENDIMENTO (DATALOTECONFIRMACAOTUSS) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DATAHORAAGENDAMENTO
CREATE INDEX IX_TAB_ATENDIMENTO_DATAHORAAGENDAMENTO ON TAB_ATENDIMENTO (DATAHORAAGENDAMENTO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DATAINCLUSAO
CREATE INDEX IX_TAB_ATENDIMENTO_DATAINCLUSAO ON TAB_ATENDIMENTO (DATAINCLUSAO) WITH PAD_INDEX, FILLFACTOR = 50


--DROP INDEX TAB_ATENDIMENTOINTERNACAO.IX_TAB_ATENDIMENTOINTERNACAO_PacienteInternado
--CREATE INDEX IX_TAB_ATENDIMENTOINTERNACAO_PacienteInternado ON TAB_ATENDIMENTOINTERNACAO (PacienteInternado) WITH PAD_INDEX, FILLFACTOR = 50

--DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_DataSaida
--CREATE INDEX IX_TAB_ATENDIMENTO_DataSaida ON TAB_ATENDIMENTO (DataSaida) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX CAD_AGENDA.IX_CAD_AGENDA_DESATIVADO
CREATE INDEX IX_CAD_AGENDA_DESATIVADO ON CAD_AGENDA (DESATIVADO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX CAD_AGENDA.IX_CAD_AGENDA_IDPRESTADORMEDICO
CREATE INDEX IX_CAD_AGENDA_IDPRESTADORMEDICO ON CAD_AGENDA (IDPRESTADORMEDICO) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX CAD_AGENDA.IX_CAD_AGENDA_DATAHORAMARCADA
CREATE INDEX IX_CAD_AGENDA_DATAHORAMARCADA ON CAD_AGENDA (DATAHORAMARCADA) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX CAD_AGENDA.IX_CAD_AGENDA_IDAGENDAPAI
CREATE INDEX IX_CAD_AGENDA_IDAGENDAPAI ON CAD_AGENDA (IDAGENDAPAI) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_PROCEDIMENTOTUSSNOMENCLATURA.IX_TAB_PROCEDIMENTOTUSSNOMENCLATURA_PTNAplicaCCirurgico
CREATE INDEX IX_TAB_PROCEDIMENTOTUSSNOMENCLATURA_PTNAplicaCCirurgico 
	ON TAB_PROCEDIMENTOTUSSNOMENCLATURA (PTNAplicaCCirurgico) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTOSERVICOEQUIPE.IX_TAB_ATENDIMENTOSERVICOEQUIPE_PrestadorMedico1AuxiliarImprimir
CREATE INDEX IX_TAB_ATENDIMENTOSERVICOEQUIPE_PrestadorMedico1AuxiliarImprimir
	ON TAB_ATENDIMENTOSERVICOEQUIPE (PrestadorMedico1AuxiliarImprimir) WITH PAD_INDEX, FILLFACTOR = 50


DROP INDEX TAB_ATENDIMENTOSERVICO.IX_TAB_ATENDIMENTOSERVICO_idAtendimento
CREATE INDEX IX_TAB_ATENDIMENTOSERVICO_idAtendimento
	ON TAB_ATENDIMENTOSERVICO (idAtendimento) WITH PAD_INDEX, FILLFACTOR = 50
  

----

DROP INDEX TAB_ATENDIMENTOSERVICOEQUIPE.IX_TAB_ATENDIMENTOSERVICOEQUIPE_idPrestadorMedicoCirurgiao
CREATE INDEX IX_TAB_ATENDIMENTOSERVICOEQUIPE_idPrestadorMedicoCirurgiao
	ON TAB_ATENDIMENTOSERVICOEQUIPE (idPrestadorMedicoCirurgiao) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTOSERVICOEQUIPE.IX_TAB_ATENDIMENTOSERVICOEQUIPE_Desativado
CREATE INDEX IX_TAB_ATENDIMENTOSERVICOEQUIPE_Desativado
	ON TAB_ATENDIMENTOSERVICOEQUIPE (Desativado) WITH PAD_INDEX, FILLFACTOR = 50


DROP INDEX TAB_ATENDIMENTOSERVICOEQUIPE.IX_TAB_ATENDIMENTOSERVICOEQUIPE_idAtendimentoServico
CREATE INDEX IX_TAB_ATENDIMENTOSERVICOEQUIPE_idAtendimentoServico
	ON TAB_ATENDIMENTOSERVICOEQUIPE (idAtendimentoServico) WITH PAD_INDEX, FILLFACTOR = 50



DROP INDEX TAB_ATENDIMENTOSERVICOEQUIPE.IX_TAB_ATENDIMENTOSERVICOEQUIPE_PrestadorMedico2AuxiliarImprimir
CREATE INDEX IX_TAB_ATENDIMENTOSERVICOEQUIPE_PrestadorMedico2AuxiliarImprimir
	ON TAB_ATENDIMENTOSERVICOEQUIPE (PrestadorMedico2AuxiliarImprimir) WITH PAD_INDEX, FILLFACTOR = 50
	

DROP INDEX TAB_ATENDIMENTOSERVICOEQUIPE.IX_TAB_ATENDIMENTOSERVICOEQUIPE_PrestadorMedico3AuxiliarImprimir
CREATE INDEX IX_TAB_ATENDIMENTOSERVICOEQUIPE_PrestadorMedico3AuxiliarImprimir
	ON TAB_ATENDIMENTOSERVICOEQUIPE (PrestadorMedico3AuxiliarImprimir) WITH PAD_INDEX, FILLFACTOR = 50
	
DROP INDEX TAB_ATENDIMENTOSERVICOEQUIPE.IX_TAB_ATENDIMENTOSERVICOEQUIPE_PrestadorMedico4AuxiliarImprimir
CREATE INDEX IX_TAB_ATENDIMENTOSERVICOEQUIPE_PrestadorMedico4AuxiliarImprimir
	ON TAB_ATENDIMENTOSERVICOEQUIPE (PrestadorMedico4AuxiliarImprimir) WITH PAD_INDEX, FILLFACTOR = 50
		
DROP INDEX Tab_ProcedimentoTussNomenclatura.IX_Tab_ProcedimentoTussNomenclatura_PTNAplicaCCirurgico
CREATE INDEX IX_Tab_ProcedimentoTussNomenclatura_PTNAplicaCCirurgico
	ON Tab_ProcedimentoTussNomenclatura (PTNAplicaCCirurgico) WITH PAD_INDEX, FILLFACTOR = 50
	



DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_Internacao
CREATE INDEX IX_TAB_ATENDIMENTO_Internacao
	ON TAB_ATENDIMENTO (Internacao) WITH PAD_INDEX, FILLFACTOR = 50


DROP INDEX TAB_ATENDIMENTOSERVICO.IX_TAB_ATENDIMENTOSERVICO_idProcedimentoTussNomenclatura
CREATE INDEX IX_TAB_ATENDIMENTOSERVICO_idProcedimentoTussNomenclatura
	ON TAB_ATENDIMENTOSERVICO (idProcedimentoTussNomenclatura) WITH PAD_INDEX, FILLFACTOR = 50

DROP INDEX TAB_ATENDIMENTOSERVICO.IX_TAB_ATENDIMENTOSERVICO_idTaxaTussNomenclatura
CREATE INDEX IX_TAB_ATENDIMENTOSERVICO_idTaxaTussNomenclatura
	ON TAB_ATENDIMENTOSERVICO (idTaxaTussNomenclatura) WITH PAD_INDEX, FILLFACTOR = 50


DROP INDEX TAB_ATENDIMENTOSERVICO.IX_TAB_ATENDIMENTOSERVICO_idMedicamentoTussNomenclatura
CREATE INDEX IX_TAB_ATENDIMENTOSERVICO_idMedicamentoTussNomenclatura
	ON TAB_ATENDIMENTOSERVICO (idMedicamentoTussNomenclatura) WITH PAD_INDEX, FILLFACTOR = 50
	

DROP INDEX TAB_ATENDIMENTOSERVICO.IX_TAB_ATENDIMENTOSERVICO_idMaterialTussNomenclatura
CREATE INDEX IX_TAB_ATENDIMENTOSERVICO_idMaterialTussNomenclatura
	ON TAB_ATENDIMENTOSERVICO (idMaterialTussNomenclatura) WITH PAD_INDEX, FILLFACTOR = 50


DROP INDEX TAB_ATENDIMENTO.IX_TAB_ATENDIMENTO_idPlanoConvenio
CREATE INDEX IX_TAB_ATENDIMENTO_idPlanoConvenio
	ON TAB_ATENDIMENTO (idPlanoConvenio) WITH PAD_INDEX, FILLFACTOR = 50


  

end
GO

ALTER PROCEDURE [dbo].[PC_CREATE_DROP_INDEX_2015] AS 

DECLARE @TableName VARCHAR(255)
DECLARE @sql NVARCHAR(500)
DECLARE @fillfactor INT
SET @fillfactor = 80
DECLARE TableCursor CURSOR FOR
SELECT OBJECT_SCHEMA_NAME([object_id])+'.'+name AS TableName
FROM sys.tables order by TableName
OPEN TableCursor
FETCH NEXT FROM TableCursor INTO @TableName
WHILE @@FETCH_STATUS = 0
BEGIN
SET @sql = 'ALTER INDEX ALL ON ' + @TableName + ' REBUILD WITH (FILLFACTOR = ' + CONVERT(VARCHAR(3),@fillfactor) + ')'
print @sql
declare @datahora datetime
set @datahora = GETDATE()
EXEC (@sql)
print datediff(second, @datahora, getdate())

FETCH NEXT FROM TableCursor INTO @TableName
END
CLOSE TableCursor
DEALLOCATE TableCursor



GO

ALTER proc [PC_importaMensagem]
@idHistoricoMensagemNova int
as
begin

insert into Sis_HistoricoMensagem
(DAtaHora, idUsuarioOrigem, idUsuarioDestino, Mensagem, progresso, progressostep, progressomaximo, segundos, segundosR, idArquivo, Arquivo, Concluido, TipoOrigemDestino, DataHoraOKAviso)
select DAtaHora, idUsuarioOrigem, idUsuarioDestino, Mensagem, progresso, progressostep, progressomaximo, segundos, segundosR, idArquivo, Arquivo, Concluido, TipoOrigemDestino, GETDATE() from Sis_HistoricoMensagemNova
where idHistoricoMensagemNova = @idHistoricoMensagemNova
and ( Concluido = 1 or idArquivo is null or Segundos > 0 )

delete Sis_HistoricoMensagemNova
where idHistoricoMensagemNova = @idHistoricoMensagemNova
and ( Concluido = 1 or idArquivo is null or Segundos > 0 )

end
GO

ALTER proc [PC_importaMensagemNaoLida]
@idUsuario int
as
begin

insert into Sis_HistoricoMensagem
(DAtaHora, idUsuarioOrigem, idUsuarioDestino, Mensagem, progresso, progressostep, progressomaximo, segundos, segundosR, idArquivo, Arquivo, Concluido, TipoOrigemDestino)
select DAtaHora, idUsuarioOrigem, idUsuarioDestino, Mensagem, progresso, progressostep, progressomaximo, segundos, segundosR, idArquivo, Arquivo, Concluido, TipoOrigemDestino from Sis_HistoricoMensagemNova
where idusuarioDestino = @idusuario
and ( Concluido = 1 or idArquivo is null or Segundos > 0 )

delete Sis_HistoricoMensagemNova
where idusuarioDestino = @idusuario
and ( Concluido = 1 or idArquivo is null or Segundos > 0 )

end


GO

ALTER proc PC_Tab_AtendimentoConsulta
@idAtendimento int
as begin

update Tab_Atendimento set Consulta = 0 
where idAtendimento = @idatendimento

update a
set a.Consulta = 1
from Tab_Atendimento a 
left join Tab_AtendimentoServico TS on TS.idatendimento = a.idatendimento
left join tab_procedimentotussnomenclatura PTN on PTN.idprocedimentotussnomenclatura  = ts.idprocedimentotussnomenclatura
cross join Cad_Empresa e 
where  a.idAtendimento = @idatendimento
and ( ptn.idProcedimentoTussSubGrupo = e.idProcedimentoTussSubGrupoConsultaAmb
or idProcedimentoTussSubGrupo = e.idProcedimentoTussSubGrupoProntoSocorroAmb)
end


GO

ALTER proc [dbo].[PC_Tab_AtendimentoServico_AtualizaDesconto](@idatendimento int)
--set @idatendimento = 7401

--select S.ValorTotalCliente, T.ValorTotalCliente, A.ValorDesconto,
as
-- primeiro eu jogo o valor 0 porque o usuario pode ter tirado o desconto depois de salvar a primeira vez.
update tab_Atendimentoservico
set ValorDescontoServico = 0
where idatendimento = @idatendimento

-- aqui vou pegar o valor do desconto na guia.
declare @ValorDesconto_guia money
set @ValorDesconto_guia =
	(select ValorDesconto from tab_Atendimento
	where idatendimento = @idatendimento)

-- se o valor do desconto for maior que zero, então tenho que ver o %.
if @ValorDesconto_Guia > 0 begin

update S
set ValorDescontoServico = 
	case when S.ValorDescontoServicoDinheiro > 0 then 
		S.ValorDescontoServicoDinheiro
	else
		( cast( S.ValorTotalCliente / T.ValorTotalCliente * A.ValorDesconto as Decimal(9,2)))
	end
from Tab_AtendimentoServico S
join vw_Tab_AtendimentoTotal T on T.idAtendimento = S.idAtendimento
join Tab_Atendimento A on A.idAtendimento = T.idAtendimento
where T.idatendimento = @idAtendimento
-- aqui vou pegar o valor do desconto que acabei de gravar, e somar.
declare @ValorDescontoServico_soma money
set @ValorDescontoServico_soma =
	(select sum(ValorDescontoServico) from tab_AtendimentoServico
	where idatendimento = @idatendimento)

if @ValorDesconto_guia <> @ValorDescontoServico_Soma begin
	-- se tiver uma difereça de centavos, vou pegar o ultimo idatendimentoservico, e passar esse centavo.
	declare @idAtendimentoServico money
	set @idAtendimentoServico =
	(
	select max(idatendimentoservico) from tab_atendimentoservico
	where idatendimento = @idatendimento
	)
	update tab_atendimentoservico
	set ValorDescontoServico =  ValorDescontoServico + (  @ValorDesconto_guia - @ValorDescontoServico_Soma)
	where idatendimentoservico = @idatendimentoservico
end

end
GO

ALTER proc [PC_Tab_AtendimentoServico_AtualizaidProcedimentoKitEmpresa]
@idAtendimentoServico int
as begin


update s
set
	s.idProcedimentokitEmpresa = Ke.idProcedimentoKitEmpresa
	from tab_Atendimentoservico s
	join tab_atendimento a on a.idatendimento = s.idatendimento --and a.idatendimentoAnterior is null
	join cad_pacienteplano pp on pp.idpacienteplano = a.idpacienteplano and pp.desativado = 0
	join cad_planoconvenio pc on pc.idplanoconvenio = pp.idplanoconvenio and pc.desativado = 0
	join cad_planoconvenioprocedimento pcp on pcp.idplanoconvenio = pc.idplanoconvenio
		and pcp.idProcedimentoTabelaValor = s.idProcedimentoTabelaValor and pcp.desativado = 0
		and pcp.idPlanoConvenioProcedimento = s.idplanoconvenioprocedimento
	join Tab_ProcedimentoKit pk on pk.idprocedimentokit = pcp.idprocedimentokit and pk.desativado = 0
	--and dbo.cobrarkitGuia1(pk.idProcedimentoKit, isnull(a.idEmpresaFilial,0)) = 1
	join Tab_ProcedimentoKitEmpresa KE on KE.idProcedimentoKit = pk.idprocedimentokit
		and KE.Desativado = 0 and Ke.idEmpresaOrigem = a.idEmpresaFilial
		and KE.cobrarKitGuia2 = 1
	where s.idatendimentoservico =@idatendimentoservico


end
GO

ALTER proc PC_Tab_AtendimentoServico_AtualizaNumeroAgenda @idAtendimento int
as begin
	update TAS
	set TAS.NumeroAgenda = dbo.maiorNumero(
		(
		select isnull(MAX(zTAS.NumeroAgenda),0) + 1
		from Tab_AtendimentoServico zTAS
		--join Tab_Atendimento zTA on zTA.idAtendimento = zTAS.idAtendimento
		--join Tab_ProcedimentoTussNomenclatura zPTN on zPTN.idProcedimentoTussNomenclatura = zTAS.idProcedimentoTussNomenclatura and zPTN.Desativado = 0
		join vw_Tab_AtendimentoSala zSala on cast(Sala.DataInclusao as date) = cast( GETDATE() as DATE) and  zSala.idUnidadeAtendimento = PTN.idUnidadeAtendimento
		),
		(
		select isnull(MAX(Fila.Numero),0) + 1
		from Cad_AutoFila Fila
		where cast(Fila.DataHora as date) = cast(getdate() as date) and  Fila.idUnidadeAtendimento = Sala.idUnidadeAtendimento and Fila.Desativado =0
		)
	)


from Tab_AtendimentoServico TAS
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = TAS.idProcedimentoTussNomenclatura and PTN.Desativado = 0
join vw_Tab_AtendimentoSala Sala on Sala.idAtendimento = TAS.idAtendimento and Sala.idUnidadeAtendimento = PTN.idUnidadeAtendimento
where
TAS.idAtendimento = @idatendimento
and TAS.NumeroAgenda is null



end


GO

ALTER proc [dbo].[PC_Tab_AtendimentoServico_AtualizaValor](@idatendimento int)
as

declare @ValorPFaturado money
set @ValorPFaturado = (	select max(PC.ValorPFaturado) from Tab_Atendimento A
						join Cad_PlanoConvenio PC on PC.idPlanoConvenio =A.idPlanoConvenio
						where A.idAtendimento = @idAtendimento and A.Gravado = 1 and A.Desativado =0
					)

set @ValorPFaturado = ISNULL(@ValorPFaturado,0)

declare @idPaciente int
set @idPaciente = (select MAX(idpaciente) from Tab_Atendimento where idAtendimento = @idatendimento)

declare @idPacientePlano int
set @idPacientePlano = (select MAX(idPacientePlano) from Tab_Atendimento where idAtendimento = @idatendimento)

declare @idEmpresaFilial int
set @idEmpresaFilial = ( Select ISNULL(max(idEmpresaFilial), 0) from Tab_Atendimento where idAtendimento = @idatendimento)


declare @DataEmissaoGuia datetime
set @DataEmissaoGuia = (Select A.DataAtendimento from Tab_Atendimento A where idAtendimento = @idatendimento)
set @DataEmissaoGuia = convert(varchar(10), @DataEmissaoGuia,103)


declare @Regra70TodosOsProcedimentosApartirQuantidade2 bit
select @Regra70TodosOsProcedimentosApartirQuantidade2 = PC.Regra70TodosOsProcedimentosApartirQuantidade2
from Cad_PacientePlano PP
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = PP.idPlanoConvenio
where PP.idpacientePlano = @idPacientePlano


if ( @ValorPFaturado > 0 ) begin
print 'entrou aqui if ( @ValorPFaturado > 0 ) begin'
-- 1. vou devolver ao VALORTOTALCONVENIO o seu valor orignal, caso o mesmo esteja preenchido.
-- pois essa procedure pode está sendo executada na guia pela segunda vez, e isso muda tudo.
	update TAS
	set 
	TAS.ValorTotalConvenio = isnull(TAS.ValorTotalConvenioOriginal,TAS.ValorTotalConvenio),
	TAS.Quantidade70p = null,
	TAS.Quantidade100p = null,
	TAS.ValorPercentoReducaoAcrescimo = 0,
	TAS.ValorTotalProcedimento = isnull(TAS.ValorTotalProcedimentoOriginal, TAS.ValorTotalProcedimento)
	from tab_Atendimentoservico TAS
	join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
	join Cad_PlanoConvenioProcedimento PCP on PCP.idPlanoConvenio = A.idPlanoConvenio
		  and PCP.idProcedimentoTabelaValor = tas.idProcedimentoTabelaValor and PCP.Desativado = 0 -- and PCP.PermitirValorPFaturado = 1 
		  and TAS.idProcedimentoTussNomenclatura is not null
	--and PCP.UsaValorPFaturado = 1
	--join Tab_ProcedimentoTussNomenclatura PTN ON PTN.idProcedimentoTussNOmenclatura = TAS.idProcedimentoTussNomenclatura and PTN.UsaValorPFaturado = 1
	where A.idPacientePlano = @idPacientePlano
	and cast(A.DataAtendimento as date) = @DataEmissaoGuia
	and TAS.idProcedimentoTabelaValor is not null
	--and TAS.ValorTotalConvenioOriginal is not null
	and TAS.Desativado = 0
	and TAS.PossuiValorNaEquipe = 0

	and A.Desativado = 0
	and A.Gravado = 1 and A.Desativado =0
	and isnull(A.idEmpresaFilial,0) = @idEmpresaFilial



	-- 2. vou localizar o idatendimentoservico que com o maior valor
	declare @MAIOR_ValorTotalProcedimento money
	set @MAIOR_ValorTotalProcedimento = (
		select MAX(isnull(TAS.ValorTotalProcedimentoOriginal, TAS.ValorTotalProcedimento)) from Tab_AtendimentoServico TAS
		join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
		join Cad_PlanoConvenioProcedimento PCP on PCP.idPlanoConvenio = A.idPlanoConvenio --and PCP.UsaValorPFaturado = 1
		and PCP.idProcedimentoTabelaValor = tas.idProcedimentoTabelaValor and PCP.Desativado = 0  and PCP.PermitirValorPFaturado = 1
		and TAS.idProcedimentoTussNomenclatura is not null

	--	join Tab_ProcedimentoTussNomenclatura PTN ON PTN.idProcedimentoTussNOmenclatura = TAS.idProcedimentoTussNomenclatura and PTN.UsaValorPFaturado = 1
		where A.idPacientePlano = @idPacientePlano
		and TAS.idProcedimentoTabelaValor is not null
		and cast(A.DataAtendimento as date) = @DataEmissaoGuia
		and A.Desativado = 0 and TAS.Desativado = 0
		and A.Gravado = 1 and A.Desativado =0
		and isnull(A.idEmpresaFilial,0) = @idEmpresaFilial
		)
	print 'valor total convenio ' +  cast( @MAIOR_ValorTotalProcedimento as varchar)
	print '@valorpfaturamento ' + cast(@ValorPFaturado  as varchar)

	declare @MAIOR_ValorTotalConvenio2 money -- mesmo que não use tenho que declarar e zerar
	declare @idAtendimentoServico2 int -- mesmo que não use tenho que declarar e zerar
	set @idAtendimentoServico2 = -1 -- mesmo que não use tenho que declarar e zerar


	declare @idAtendimentoServico int -- esse idatendimentoservico, irá receber o id onde possui o maior @MAIOR_ValorTotalProcedimento
	set @idAtendimentoServico = (
	select min(TAS.idATendimentoServico) from Tab_AtendimentoServico TAS
	join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
	join Cad_PlanoConvenioProcedimento PCP on PCP.idPlanoConvenio = A.idPlanoConvenio --and PCP.UsaValorPFaturado = 1
    and PCP.idProcedimentoTabelaValor = tas.idProcedimentoTabelaValor and PCP.Desativado = 0  and PCP.PermitirValorPFaturado = 1
	and TAS.idProcedimentoTussNomenclatura is not null

--	join Tab_ProcedimentoTussNomenclatura PTN ON PTN.idProcedimentoTussNOmenclatura = TAS.idProcedimentoTussNomenclatura and PTN.UsaValorPFaturado = 1
	where A.idPacientePlano = @idPacientePlano
	and TAS.idProcedimentoTabelaValor is not null
	and cast(A.DataAtendimento as date) = @DataEmissaoGuia
	and A.Desativado = 0 and TAS.Desativado = 0
	and TAS.ValorTotalProcedimento = @MAIOR_ValorTotalProcedimento
	and A.Gravado = 1 and A.Desativado =0
	and isnull(A.idEmpresaFilial,0) = @idEmpresaFilial
	)
	-- pronto. já achei o id que terá o maior valor
	-- o idatendimentoServico de maior valro vai terá quantidade 1 em 100%.
	update tab_atendimentoServico set Quantidade100p = 1 
	where idAtendimentoServico = @idAtendimentoServico

	-- o idatendimentoServico de maior valor talvez tenha quantidade em 70%.
	update tab_atendimentoServico set Quantidade70p = Quantidade - 1 
	where idAtendimentoServico = @idAtendimentoServico and quantidade > quantidade100p

	-- 
	update TAS set TAS.Quantidade70p = 
		case 
			when @Regra70TodosOsProcedimentosApartirQuantidade2 = 1   then 
				TAS.quantidade -1 
			else 
				TAS.quantidade 
			end

	from tab_Atendimentoservico TAS
	join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
	join Cad_PlanoConvenioProcedimento PCP on PCP.idPlanoConvenio = A.idPlanoConvenio
		  and PCP.idProcedimentoTabelaValor = tas.idProcedimentoTabelaValor and PCP.Desativado = 0 and PCP.PermitirValorPFaturado = 1 
		  and TAS.idProcedimentoTussNomenclatura is not null
	where A.idPacientePlano = @idPacientePlano
	and cast(A.DataAtendimento as date) = @DataEmissaoGuia
	and TAS.idProcedimentoTabelaValor is not null
	--and TAS.ValorTotalConvenioOriginal is not null
	and TAS.Desativado = 0
	and TAS.PossuiValorNaEquipe = 0
	and A.Desativado = 0
	and A.Gravado = 1 and A.Desativado =0
	and isnull(A.idEmpresaFilial,0) = @idEmpresaFilial
	and (TAS.idAtendimentoServico <> @idAtendimentoServico)
		





	print 'update 16/04/2024 teste'
	update TAS
	set TAS.ValorTotalConvenioOriginal = TAS.ValorTotalConvenio,
	TAS.VAlorTotalProcedimentoOriginal = TAS.VAlorTotalProcedimento,
	TAS.ValorPercentoReducaoAcrescimo = @valorPFaturado,
	TAS.ValorTotalConvenio = 
		case when TAS.Quantidade70p is null then
			isnull(TAS.ValorTotalConvenioOriginal , TAS.ValorTotalConvenio)
		when TAS.Quantidade = TAS.Quantidade70P then 
					(
						(
						isnull(TAS.ValorTotalConvenioOriginal , TAS.ValorTotalConvenio ) - ISNULL(TAS.PTVValM2FilmeTotal,0) - ISNULL(TAS.PTVValPorteTotal,0)
						) * 0.70
					) + ISNULL(TAS.PTVValM2FilmeTotal,0) + ISNULL(tas.PTVValPorteTotal,0)

		when TAS.Quantidade > ISNULL(TAS.Quantidade70P,0) then 
			( 
				(
				( 
					(
						( (isnull(TAS.ValorTotalConvenioOriginal , TAS.ValorTotalConvenio) - ISNULL(TAS.PTVValM2FilmeTotal,0) - ISNULL(TAS.PTVValPorteTotal,0)  )  / TAS.Quantidade ) 
						
					)
					* TAS.Quantidade70P 
				) * 0.70 
				) + (ISNULL(tas.PTVValM2FilmeUnidade,0) * TAS.Quantidade70P)
				  + (ISNULL(tas.PTVValPorteUnidade,0) * TAS.Quantidade70P)
			) +
				( isnull(TAS.ValorTotalConvenioOriginal , TAS.ValorTotalConvenio) / TAS.Quantidade )
				


		end

	from tab_Atendimentoservico TAS
	join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
	join Cad_PlanoConvenioProcedimento PCP on PCP.idPlanoConvenio = A.idPlanoConvenio --and PCP.UsaValorPFaturado = 1
		  and PCP.idProcedimentoTabelaValor = tas.idProcedimentoTabelaValor and PCP.Desativado = 0  and PCP.PermitirValorPFaturado = 1
		  and TAS.idProcedimentoTussNomenclatura is not null

	where A.idPacientePlano = @idPacientePlano
	and cast(A.DataAtendimento as date) = @DataEmissaoGuia
	and TAS.idProcedimentoTabelaValor is not null
	and TAS.Desativado = 0
	and TAS.PossuiValorNaEquipe = 0
	and A.Desativado = 0
	and A.Gravado = 1 and A.Desativado =0
	and isnull(A.idEmpresaFilial,0) = @idEmpresaFilial
	print 'antes do else'
end else begin

	update TAS
	set TAS.ValorTotalConvenio = TAS.ValorTotalConvenioOriginal,
	TAS.ValorPercentoReducaoAcrescimo = 0
	--TAS.ValorTotalProcedimento = TAS.VAlorTotalProcedimentoOriginal
	from tab_Atendimentoservico TAS
	join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
	join Cad_PlanoConvenioProcedimento PCP on PCP.idPlanoConvenio = A.idPlanoConvenio --and PCP.UsaValorPFaturado = 1
		  and PCP.idProcedimentoTabelaValor = tas.idProcedimentoTabelaValor and PCP.Desativado = 0 and PCP.PermitirValorPFaturado = 1
		  and TAS.idProcedimentoTussNomenclatura is not null
	--join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNOmenclatura = TAS.idProcedimentoTussNomenclatura and PTN.UsaValorPFaturado = 1
	where A.idPacientePlano = @idPacientePlano
	and cast(A.DataAtendimento as date) = @DataEmissaoGuia
	and TAS.idProcedimentoTabelaValor is not null
	and TAS.PossuiValorNaEquipe = 0
	and TAS.Desativado = 0
	and A.Desativado = 0
	and TAS.ValortotalConvenioOriginal is not null
	and A.Gravado = 1 and A.Desativado =0
	and isnull(A.idEmpresaFilial,0) = @idEmpresaFilial
	PRINT 'ELSE 3'
	-- aqui vou resolver o valor quando a quantidade = 2 ou 3, e só tem 1 procedimento na guia, e um deles deveria ter o valor 70%.
end
GO

ALTER proc PC_Tab_AtendimentoServico_CorrecaoValorConsulta 
@idAtendimento int
as
begin
-- essa procedure foi feita para corrigir o valor da consulta, quando a mesma está com o valor errado.
-- porem ainda pode evoluir muito, pegando valor de urgencia, corrigindo valor de outros procedimentos.
--set @idAtendimentoServico = 45720
update TS
set 
	ts.ValorTotalProcedimentoSemFilme = TV.ValorRealConvenio ,
	ts.ValorTotalConvenio = tv.ValorRealConvenio,
	ts.ValorTotalProcedimento = tv.ValorRealConvenio,
	ts.PTVValProcedimento = tv.ValorRealConvenio
from Tab_AtendimentoServico TS
join Tab_Atendimento A on A.idAtendimento = TS.idAtendimento
join vw_Tab_TabelaValor TV on Tv.idProcedimentoTabelaValor = TS.idProcedimentoTabelaValor
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = TV.idProcedimentoTussNomenclatura
and TV.idPlanoConvenio = A.idPlanoConvenio
and isnull(TV.idEmpresaFilial, A.idEmpresaFilial) = A.idEmpresaFilial
where TS.idAtendimento = @idatendimento
and PTN.PTNCodigoTuss in ('10101012', '10101039')
end

GO

-- 07/12/2023 23:13
CREATE proc [PC_Tab_AtendimentoServico_CorrecaoValorProcedimento] @idAtendimento int
as
begin
update ts
set
	ts.ValorTotalConvenio = tv.ValorRealConvenio * ts.Quantidade ,
	ts.ValorTotalProcedimento = tv.ValorRealConvenio,
	ts.ValorTotalProcedimentoSemFilme = TV.ValorRealConvenio ,
	ts.PTVValProcedimento = PCP.PTVValProcedimento

from Tab_AtendimentoServico TS
join Tab_Atendimento A on A.idAtendimento = TS.idAtendimento
join Cad_PlanoConvenioProcedimento PCP on PCP.idPlanoConvenioProcedimento = TS.idPlanoConvenioProcedimento

join vw_Tab_TabelaValor TV on Tv.idProcedimentoTabelaValor = TS.idProcedimentoTabelaValor and tv.idPlanoconvenio = a.idPlanoConvenio
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = TV.idProcedimentoTussNomenclatura
and TV.idPlanoConvenio = A.idPlanoConvenio
and isnull(TV.idEmpresaFilial, A.idEmpresaFilial) = A.idEmpresaFilial

where TS.idAtendimento  = @idAtendimento



update ts
set
	ts.ValorTotalConvenio = tv.ValorRealConvenio * ts.Quantidade ,
	ts.ValorTotalProcedimento = tv.ValorRealConvenio,
	ts.ValorTotalProcedimentoSemFilme = TV.ValorRealConvenio ,
	ts.PTVValProcedimento = PCP.PTVValProcedimento
from Tab_AtendimentoServico TS
join Tab_Atendimento A on A.idAtendimento = TS.idAtendimento
left join Cad_PlanoConvenioProcedimento PCP on PCP.idPlanoConvenioProcedimento = TS.idPlanoConvenioProcedimento

join vw_Tab_TabelaValor TV on Tv.idPlanoConvenio = A.idPlanoConvenio
	and tv.idProcedimentoTussNomenclatura = ts.idProcedimentoTussNomenclatura
	and tv.Desativado = 0
-- and  idProcedimentoTabelaValor = TS.idProcedimentoTabelaValor and tv.idPlanoconvenio = a.idPlanoConvenio
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = TV.idProcedimentoTussNomenclatura
and TV.idPlanoConvenio = A.idPlanoConvenio
and isnull(TV.idEmpresaFilial, A.idEmpresaFilial) = A.idEmpresaFilial
--left join vw_Tab_TabelaValor TVA on TVA.idProcedimentoTabelaValor = TS.idProcedimentoTabelaValor and TVA.idPlanoconvenio = a.idPlanoConvenio
where TS.idAtendimento  = @idAtendimento and ts.ValorTotalConvenio = 0


update ts
set
	ts.ValorTotalConvenio = tv.ValorRealConvenio * ts.Quantidade ,
	ts.ValorTotalProcedimento = tv.ValorRealConvenio,
	ts.ValorTotalProcedimentoSemFilme = TV.ValorRealConvenio ,
	ts.PTVValProcedimento = PCP.PTVValProcedimento
from Tab_AtendimentoServico TS
join Tab_Atendimento A on A.idAtendimento = TS.idAtendimento
left join Cad_PlanoConvenioProcedimento PCP on PCP.idPlanoConvenioProcedimento = TS.idPlanoConvenioProcedimento

join vw_Tab_TabelaValor TV on Tv.idPlanoConvenio = A.idPlanoConvenio
	and tv.idProcedimentoTussNomenclatura = ts.idProcedimentoTussNomenclatura
	and tv.Desativado = 0
-- and  idProcedimentoTabelaValor = TS.idProcedimentoTabelaValor and tv.idPlanoconvenio = a.idPlanoConvenio
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = TV.idProcedimentoTussNomenclatura
and TV.idPlanoConvenio = A.idPlanoConvenio
and isnull(TV.idEmpresaFilial, A.idEmpresaFilial) = A.idEmpresaFilial
left join vw_Tab_TabelaValor TVA on TVA.idProcedimentoTabelaValor = TS.idProcedimentoTabelaValor and TVA.idPlanoconvenio = a.idPlanoConvenio
where TS.idAtendimento  = @idAtendimento and TVA.idProcedimentoTabelaValor is null




--fpaigrid.execsql('EXEC dbo.PC_AdicionaTaxanoAtendimento ' + inttostr(idAtendimentoServico)); NAO USAR
--fpaigrid.execsql('EXEC dbo.PC_AdicionaMaterialnoAtendimento ' + inttostr(idAtendimentoServico)); NAO USAR

EXEC dbo.PC_Tab_AtendimentoServicoAtualizaTotalConvenioRelacionado @idAtendimento -- ESTÁ NO LADO DE FORA
EXEC dbo.PC_Tab_AtendimentoServicoAtualizaTotalConvenioQuantidade @idAtendimento -- ESTÁ NO LADO DE FORA

--fpaigrid.execsql('EXEC dbo.[PC_Tab_AtendimentoServico_AtualizaidProcedimentoKitEmpresa] ' + inttostr(idAtendimentoServico)); NAO USAR
END
GO

ALTER proc [PC_Tab_AtendimentoServicoAtualizaTotalConvenioQuantidade] (@idAtendimento int)
-- JANDERSON 27/12/2017 - quando o serviço tem equipe o sistema não pode atualizar o valor totol convenio
as begin



update S
set S.FaturamentoPercentualx = 1,
S.ValorTotalConvenio = 
case when FilmeAcumuladonoValorTotalProcedimento = 1 then  
	S.PTVValM2FilmeTotal
else
	0
end
 + 
S.ValorTotalProcedimentoSemFilme +
case 	when S.Quantidade >= 2 then 
		cast(S.ValorTotalProcedimentoSemFilme * PCP.PTVPercentual2x / 100 as decimal(9,2))
	else
		0
end
+
case 	when S.Quantidade >= 3 then 
		cast(S.ValorTotalProcedimentoSemFilme * PCP.PTVPercentual3x / 100 as decimal(9,2))
	else
		0
end
+
case 	when S.Quantidade >= 4 then 
		cast(S.ValorTotalProcedimentoSemFilme * PCP.PTVPercentual4x / 100 as decimal(9,2))
	else
		0
end
+
case 	when S.Quantidade >= 5 then 
		cast(S.ValorTotalProcedimentoSemFilme * PCP.PTVPercentual5x / 100 as decimal(9,2))
	else
		0
end 
+
case 	when S.Quantidade >= 6 then 
		cast(S.ValorTotalProcedimentoSemFilme * PCP.PTVPercentual5x / 100 as decimal(9,2))
	else
		0
end 
+
case 	when S.Quantidade >= 7 then 
		cast(S.ValorTotalProcedimentoSemFilme * PCP.PTVPercentual5x / 100 as decimal(9,2))
	else
		0
end 


from tab_atendimentoservico S
join Tab_Atendimento A on a.idAtendimento = S.idAtendimento and A.TipoGuia <> 6
join tab_procedimentotabelavalor PTV on PTV.idProcedimentoTabelaValor = S.idProcedimentoTabelaValor
join cad_planoconvenioprocedimento PCP 
	on PCP.idprocedimentotabelaValor = PTV.idprocedimentotabelaValor
	and PCP.idPlanoConvenio = A.idPlanoConvenio

join Cad_PlanoConvenio PC on PC.idPlanoConvenio = PCP.idPlanoConvenio
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = PTV.idProcedimentoTussNomenclatura
cross join Cad_Empresa E
left join Tab_AtendimentoServicoEquipe SE on SE.idAtendimentoServico = S.idAtendimentoServico

where 
S.idAtendimento = @idAtendimento
and SE.idAtendimentoServicoEquipe is null
and S.FaturamentoPercentualRelacionado = 0
and S.Desativado =0
and S.Quantidade > 0
and 
(
	(PCP.PTVPercentual2x < 100 and PCP.PTVPercentual2x > 0)
	or
	(PCP.PTVPercentual3x < 100 and PCP.PTVPercentual3x > 0)
	or
	(PCP.PTVPercentual4x < 100 and PCP.PTVPercentual4x > 0)
	or
	(PCP.PTVPercentual5x < 100 and PCP.PTVPercentual5x > 0)
)


end
GO

-- 07/12/2023 23:31
CREATE proc [PC_Tab_AtendimentoServicoAtualizaTotalConvenioRelacionado](@idAtendimento int)
as begin
update S
set 
S.FaturamentoPercentualRelacionado = 1,
S.FaturamentoPercentualx =0,
S.ValorTotalConvenio = 
case when S.FilmeAcumuladonoValorTotalProcedimento = 1 then  
		S.PTVValM2FilmeTotal 
	else
		0
end
+ 
case 	when ( a.idUnidadeAtendimento = 1 ) and ( PCPR.PTVValorRealAmbulatorio > 0) then
		PCPR.PTVValorRealAmbulatorio
	when ( a.idUnidadeAtendimento <> 1 ) and ( PCPR.PTVValorRealProntoSocorro > 0) then
		PCPR.PTVValorRealprontoSocorro
	else
		cast((((S.ValorTotalProcedimentoSemFilme * S.Quantidade) * 

		(
			case 	when A.idUnidadeAtendimento = 1 then
				PCPR.PTVPercentualAmbulatorio
			else
				PCPR.PTVPercentualProntoSocorro
			end
		)


		) / 100) as decimal(9,2))
	end


--PCPR.PTVPercentualAmbulatorio, 
--PCPR.PTVValorRealAmbulatorio,
--PCPR.PTVPercentualProntoSocorro, 
--PCPR.PTVValorRealProntoSocorro


from tab_AtendimentoServico S
join Cad_PlanoConvenioProcedimentoRelacionado PCPR on PCPR.idProcedimentoTussNomenclatura = S.idProcedimentoTussNomenclatura

join Tab_Atendimento A on a.idAtendimento = S.idAtendimento
join Tab_AtendimentoServico SS on SS.idAtendimento = S.idAtendimento and SS.idAtendimentoSErvico <> S.idAtendimentoServico
join tab_procedimentotabelavalor PTV on PTV.idProcedimentoTabelaValor = SS.idProcedimentoTabelaValor
join cad_planoconvenioprocedimento PCP 
	on PCP.idprocedimentotabelaValor = PTV.idprocedimentotabelaValor
	and PCP.idPlanoConvenio = A.idPlanoConvenio

join Cad_PlanoConvenio PC on PC.idPlanoConvenio = PCP.idPlanoConvenio
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = PCPR.idProcedimentoTussNomenclatura

cross join Cad_Empresa E


where S.idAtendimento = @idAtendimento
and S.Desativado = 0
and PCPR.idPlanoConvenioProcedimento = PCP.idPlanoConvenioProcedimento
end
GO

ALTER procedure [pc_Tab_AtendimentoServicoGlosa] @numeroGuiaPrestador 
varchar(20), @codigoPrestadorNaOperadora varchar(20), @numeroLotePrestador int, @codigoProcedimento varchar(20)
as
-- JANDERSON 22/05/2015
begin
-- essa procedure retorna um select que é usado para importar as glosas XML 
-- testado com a amil

--declare @numeroGuiaPrestador varchar(30)
--declare @codigoPrestadorNaOperadora varchar(30)
--declare @codigoProcedimento varchar(30)

--set @numeroGuiaPrestador ='1419'
--set @codigoPrestadorNaOperadora = '10409688'
--set @codigoProcedimento = '80070019'

select TAS.* from tab_atendimentoservico TAS
join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio
left join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = TAS.idProcedimentoTussNomenclatura
left join Tab_TaxaTussNomenclatura TTN on TTN.idTaxaTussNomenclatura = TAS.idTaxaTussNomenclatura

left join Tab_TaxaTabelaValor TTV on TTV.idTaxaTabelaValor = TAS.idTaxaTabelaValor
left join Tab_MaterialMedicamentoTabelaValor MMTV on MMTV.idMaterialMedicamentoTabelaValor = TAS.idMaterialTabelaValor
left join Tab_MaterialMedicamentoTussNomenclatura MMTN 
	on MMTN.idMaterialMedicamentoTussNomenclatura = isnull(TAS.idMaterialTussNomenclatura, TAS.idMedicamentoTussNomenclatura)

where A.Desativado = 0
and A.NumeroGuia = @numeroGuiaPrestador
and A.NumeroLoteTuss = @numeroLotePrestador
and PC.NumeroRegistroOperadora = @codigoPrestadorNaOperadora

and 
( isnull(PTN.PTNCodigoTuss, isnull(MMTV.MaterialMedicamentoCodigoReferencia , isnull(MMTN.CodigoTuss, isnull(TTV.TaxaCodigoProprio, TTN.TTCodigoTuss)))) = @codigoProcedimento )
union
select TAS.* from tab_atendimentoservico TAS
join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio
where A.Desativado = 0
and A.NumeroGuia = @numeroGuiaPrestador
and A.NumeroLoteTuss = @numeroLotePrestador
AND tas.idMaterialTabelaValor IS NOT NULL
and PC.NumeroRegistroOperadora = @codigoPrestadorNaOperadora
and PC.MaterialCodigoProprio = @codigoProcedimento
union
select TAS.* from tab_atendimentoservico TAS
join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio
where A.Desativado = 0
and A.NumeroGuia = @numeroGuiaPrestador
and A.NumeroLoteTuss = @numeroLotePrestador
AND tas.idMedicamentoTabelaValor IS NOT NULL
and PC.NumeroRegistroOperadora = @codigoPrestadorNaOperadora
and PC.MedicamentoCodigoProprio = @codigoProcedimento

end
GO

ALTER procedure [pc_Tab_AtendimentoServicoGlosa2] 
@registroANS varchar(20), @numeroGuiaPrestador varchar(20), @codigoProcedimento varchar(20)
as
begin

select TAS.* from tab_atendimentoservico TAS
join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio and pc.CodigoPlanoNaANS = @registroANS
left join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = TAS.idProcedimentoTussNomenclatura
left join Tab_TaxaTussNomenclatura TTN on TTN.idTaxaTussNomenclatura = TAS.idTaxaTussNomenclatura

left join Tab_TaxaTabelaValor TTV on TTV.idTaxaTabelaValor = TAS.idTaxaTabelaValor
left join Tab_MaterialMedicamentoTabelaValor MMTV on MMTV.idMaterialMedicamentoTabelaValor = TAS.idMaterialTabelaValor
left join Tab_MaterialMedicamentoTussNomenclatura MMTN 
	on MMTN.idMaterialMedicamentoTussNomenclatura = isnull(TAS.idMaterialTussNomenclatura, TAS.idMedicamentoTussNomenclatura)

where A.Desativado = 0
and A.NumeroGuia = @numeroGuiaPrestador
--and A.NumeroLoteTuss = @numeroLotePrestador se eu filtrar o numero do lotetuss, tem convenio que manda um numero de lote diferente do que enviei.


and 
( isnull(PTN.PTNCodigoTuss, isnull(MMTV.MaterialMedicamentoCodigoReferencia , isnull(MMTN.CodigoTuss, isnull(TTV.TaxaCodigoProprio, TTN.TTCodigoTuss)))) = @codigoProcedimento )
union
select TAS.* from tab_atendimentoservico TAS
join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio and pc.CodigoPlanoNaANS = @registroANS
where A.Desativado = 0
and A.NumeroGuia = @numeroGuiaPrestador
---and A.NumeroLoteTuss = @numeroLotePrestador
AND tas.idMaterialTabelaValor IS NOT NULL
and PC.MaterialCodigoProprio = @codigoProcedimento
union
select TAS.* from tab_atendimentoservico TAS
join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio and pc.CodigoPlanoNaANS = @registroANS
where A.Desativado = 0
and A.NumeroGuia = @numeroGuiaPrestador
--and A.NumeroLoteTuss = @numeroLotePrestador
AND tas.idMedicamentoTabelaValor IS NOT NULL
and PC.MedicamentoCodigoProprio = @codigoProcedimento

end




GO

ALTER procedure [pc_Tab_AtendimentoServicoPagamento] 
@NumeroRegistroOperadora varchar(20), @numeroGuiaPrestador varchar(20), @codigoProcedimento varchar(20)
as
begin

select TAS.* from tab_atendimentoservico TAS
join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio and pc.NumeroRegistroOperadora = @NumeroRegistroOperadora
left join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = TAS.idProcedimentoTussNomenclatura
left join Tab_TaxaTussNomenclatura TTN on TTN.idTaxaTussNomenclatura = TAS.idTaxaTussNomenclatura

left join Tab_TaxaTabelaValor TTV on TTV.idTaxaTabelaValor = TAS.idTaxaTabelaValor
left join Tab_MaterialMedicamentoTabelaValor MMTV on MMTV.idMaterialMedicamentoTabelaValor = TAS.idMaterialTabelaValor
left join Tab_MaterialMedicamentoTussNomenclatura MMTN 
	on MMTN.idMaterialMedicamentoTussNomenclatura = isnull(TAS.idMaterialTussNomenclatura, TAS.idMedicamentoTussNomenclatura)

where A.Desativado = 0
and A.NumeroGuia = @numeroGuiaPrestador
--and A.NumeroLoteTuss = @numeroLotePrestador se eu filtrar o numero do lotetuss, tem convenio que manda um numero de lote diferente do que enviei.


and 
( isnull(PTN.PTNCodigoTuss, isnull(MMTV.MaterialMedicamentoCodigoReferencia , isnull(MMTN.CodigoTuss, isnull(TTV.TaxaCodigoProprio, TTN.TTCodigoTuss)))) = @codigoProcedimento )
union
select TAS.* from tab_atendimentoservico TAS
join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio and pc.NumeroRegistroOperadora = @NumeroRegistroOperadora
where A.Desativado = 0
and A.NumeroGuia = @numeroGuiaPrestador
---and A.NumeroLoteTuss = @numeroLotePrestador
AND tas.idMaterialTabelaValor IS NOT NULL
and PC.MaterialCodigoProprio = @codigoProcedimento
union
select TAS.* from tab_atendimentoservico TAS
join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio and pc.NumeroRegistroOperadora = @NumeroRegistroOperadora
where A.Desativado = 0
and A.NumeroGuia = @numeroGuiaPrestador
--and A.NumeroLoteTuss = @numeroLotePrestador
AND tas.idMedicamentoTabelaValor IS NOT NULL
and PC.MedicamentoCodigoProprio = @codigoProcedimento

end


GO

ALTER proc [PC_Tab_ProcedimentoTabelaValor_Copia_TabelaValor]
	@idProcedimentoTabelaOrigem int,
	@idProcedimentoTabelaDestino int,
	@comValor bit
-- copiar os Procedimentos Da TabelaProcedimentoValor Para Novas Tabelas
-- Antes de executar a tabela destino ja devera estar criada na opcao Procedimento Tabela
AS
BEGIN

insert into [Tab_ProcedimentoTabelaValor] 
(
	[idProcedimentoTabela],
	[idProcedimentoTussNomenclatura] ,
	[PTVMoedaCobranca],
	[PTVValPorteProcedimento],
	[idProcedimentoPorteProcedimento],
	[PTVValProcedimento],
	[PTVNumeroAuxiliar],
	[idProcedimentoPorteAnestesico],
	[PTVValM2Filme],
	[PTVNumIncidenciaFilme],
	[PTVValPercentualUrgencia],
	[PTVCobrancaEnfermaria],
	[PTVCobrancaApartamento],
	[PTVProcedimentoObs],
	[Desativado],
	[NecessitadeAutorizacao],
	[PTVCodigoTussReferencia]
)
select
	@idProcedimentoTabelaDestino,
	[idProcedimentoTussNomenclatura] ,
	[PTVMoedaCobranca],
	[PTVValPorteProcedimento],
	[idProcedimentoPorteProcedimento],
	case when @ComValor =1 then [PTVValProcedimento] else 0 end as PTVValProcedimento,
	[PTVNumeroAuxiliar],
	[idProcedimentoPorteAnestesico],
	[PTVValM2Filme],
	[PTVNumIncidenciaFilme],
	[PTVValPercentualUrgencia],
	[PTVCobrancaEnfermaria],
	[PTVCobrancaApartamento],
	[PTVProcedimentoObs],
	[Desativado],
	[NecessitadeAutorizacao],
	[PTVCodigoTussReferencia]

from Tab_ProcedimentoTabelaValor
where idProcedimentoTabela = @idProcedimentoTabelaOrigem
end


GO

ALTER  proc PC_Tab_TaxaTabelaValor_Copia_Tabela
	@idTaxaTabelaOrigem int,
	@idTaxaTabelaDestino int
-- copiar a Tabela de Taxas (Origem), Para Uma Nova (Destino)
AS
BEGIN

insert into [Tab_TaxaTabelaValor] 
(
	[idTaxaTabela],
	[idTaxaTussNomenclatura],
	[TaxaCodigoProprio],
	[ValorTaxa],
	[ValorPercUrgTaxa],
	[TipoTaxaAluguel],
	[TipoTaxaCurativo],
	[TipoTaxaDiaria],
	[TipoTaxaOxigenio],
	[TipoTaxaSala],
	[TipoTaxaPacote],
	[TipoTaxaOutras],
	[TipoTaxaRemocao],
	[TaxaTexto],
	[Desativado]
)
select
	@idTaxaTabelaDestino,
	[idTaxaTussNomenclatura],
	[TaxaCodigoProprio],
	[ValorTaxa],
	[ValorPercUrgTaxa],
	[TipoTaxaAluguel],
	[TipoTaxaCurativo],
	[TipoTaxaDiaria],
	[TipoTaxaOxigenio],
	[TipoTaxaSala],
	[TipoTaxaPacote],
	[TipoTaxaOutras],
	[TipoTaxaRemocao],
	[TaxaTexto],
	[Desativado]
from Tab_TaxaTabelaValor
where idTaxaTabela = @idTaxaTabelaOrigem
end

GO

ALTER proc [PC_ZerarProcedimentonoAtendimentoGuia2]
@idAtendimentoServico int
as begin


update s
set
	s.ValorTotalConvenio = 0,
	s.PTVVAlProcedimento = 0,
	s.ValorTotalProcedimento = 0,
	s.ValorTotalProcedimentoSemFilme = 0

	from tab_Atendimentoservico s
	join tab_atendimento a on a.idatendimento = s.idatendimento and a.idatendimentoAnterior is not null
	join cad_pacienteplano pp on pp.idpacienteplano = a.idpacienteplano and pp.desativado = 0
	join cad_planoconvenio pc on pc.idplanoconvenio = pp.idplanoconvenio and pc.desativado = 0
	join cad_planoconvenioprocedimento pcp on pcp.idplanoconvenio = pc.idplanoconvenio
		and pcp.idProcedimentoTabelaValor = s.idProcedimentoTabelaValor and pcp.desativado = 0
		and pcp.idPlanoConvenioProcedimento = s.idplanoconvenioprocedimento
	join Tab_ProcedimentoKit pk on pk.idprocedimentokit = pcp.idprocedimentokit and pk.desativado = 0
	and
	(
		(
			dbo.cobrarkitGuia1(pk.idProcedimentoKit, isnull(a.idEmpresaFilial,0)) = 1
			and
			A.idatendimentoanterior is null
		)
		or
		(
			dbo.cobrarkitGuia2(pk.idProcedimentoKit, isnull(a.idEmpresaFilial,0)) = 1
			and
			A.idatendimentoanterior is not null
		)
	)
	join Tab_ProcedimentoKitEmpresa KE on KE.idProcedimentoKit = pk.idprocedimentokit
		and KE.Desativado = 0 and Ke.idEmpresaDestino = a.idEmpresaFilial
		and KE.cobrarKitGuia2 = 1
		and KE.ProcedimentoZeradoGuia2 = 1

	where s.idatendimentoservico =@idatendimentoservico


end
GO

ALTER proc [dbo].[pr_Fin_Nota_Incluir_idReceita] @idReceita int
 as
set dateformat dmy

declare @idAtendimento int 
select @idAtendimento = idAtendimento from fin_receita where idReceita  = @idReceita
declare @valorPago money

set @valorPago = (Select max(isnull(ValorPago1,0) +  isnull(ValorPago2,0) + isnull(ValorPago3,0)) 
	from tab_Atendimento where idAtendimento = @idAtendimento)


insert into Fin_Nota
(idReceita, 
idAtendimento, 
idPaciente,
idEmpresa,
Nome,
RazaoSocial, 
cpf, 
cnpj, 
endereco, 
numero, 
complemento, 
bairro, 
cidade, 
estado,
cep, 
ValorNotaFiscal, 
ValorISS, 
ServicoCodigo,
Descricao, 
rps,
serie, 
DataEmissao, 
email)
select 
r.idReceita, 
@idAtendimento,
r.idPaciente,
1 as idEmpresa,
c.Paciente,
null as razaosocial,
c.CPF as CPF, 
null as CNPJ,

c.Endereco, 
c.Numero, 
cast(c.Complemento as varchar(20)) as EnderecoComplemento,
c.Bairro, 
case when len(c.Cidade) = 0 then 'Rio de Janeiro' else isnull(c.Cidade, 'Rio de Janeiro') end, 
cast( c.Estado as varchar(2)), 
c.Cep, 

@valorPago as Valor, 
@valorPago * 0.05 as ValorISS, 
emp.CodigoTributacaoMunicipio,
dbo.idAtendimentoToServicos(R.idAtendimento) as DescricaoNotaFiscal,
--'SERVIÇO MÉDICO PRESTADO' as DescricaoNotaFiscal,

( select dbo.ProximoRPS())  as RPS,
emp.SerieNotaFiscal,
cast( convert( varchar(10), getdate(), 103) as datetime),
cast(c.Email as varchar(50))
from fin_receita r 
join Cad_Paciente c on c.idpaciente = r.idPaciente
left join fin_nota n on n.idAtendimento = r.idAtendimento and n.desativado = 0
cross join Cad_empresa emp
where 
r.idReceita = @idReceita
--and ( len(c.cpf) = 11 or LEN(c.cnpj) = 14)
and n.idnota is null
--and r.DataVencimento >= 
and R.ValorDevido >0
GO

ALTER PROC PR_IndicadorAnual @data datetime
AS BEGIN
IF OBJECT_ID('TempDB.dbo.#PrimeiroAtendimento') IS NOT NULL
	DROP TABLE #PrimeiroAtendimento
IF OBJECT_ID('TempDB.dbo.#PacientesAtendidos') IS NOT NULL
DROP TABLE #PacientesAtendidos
IF OBJECT_ID('TempDB.dbo.#falta') IS NOT NULL
DROP TABLE #falta


SELECT ca.DataHoraMarcada AS DataAtendimento , ca.Confirmado
INTO #Falta
FROM Cad_Agenda ca
LEFT JOIN Tab_Atendimento A ON 
	(
		(a.idPaciente = ca.idPaciente ) 
		OR (a.idatendimento = ca.idatendimento)
		OR (a.idagenda = ca.idagenda)
	)
	AND CAST(a.Dataatendimento AS DATE) = CAST(ca.DataHoraMarcada AS DATE)
	AND a.desativado = 0 AND a.DataCancelamento IS NULL
	AND a.tipoGuia IN ( 1,2)
WHERE ca.desativado = 0
AND ca.DataHoraCancelamento IS NULL
AND ca.DataHoraMarcada <= CAST(GETDATE() AS DATE)
--AND CAST(ca.DataHoraMarcada AS DATE) = CAST(@data AS DATE)
AND YEAR(ca.datahoramarcada) = YEAR(@data)
AND ca.idagendapai IS NULL
AND a.idAtendimento IS NULL





SELECT DISTINCT a.idpaciente, a.dataatendimento INTo #PrimeiroAtendimento 
FROM tab_atendimento a
JOIN Cad_paciente p ON p.idpaciente = a.idPaciente 
	AND CAST(p.DataCadastro AS DATE) = CAST(a.dataatendimento AS date)
LEFT JOIN tab_Atendimento ant ON ant.idpaciente = a.idpaciente 
	AND ant.idatendimento < a.idatendimento
	AND ant.desativado = 0
	AND ant.DataCancelamento IS NULL

WHERE 
a.desativado =0
AND a.DataCancelamento IS NULL
AND year(a.dataatendimento) = YEAR(@data)
AND a.tipoGuia IN ( 1,2)

AND ant.idAtendimento IS NULL




SELECT 
DISTINCT a.idpaciente, 
CAST(CAST(a.dataatendimento - DAY(a.dataatendimento) + 1 AS DATE) AS DATETIME) AS DataAtendimento
INTo #PacientesAtendidos
FROM tab_atendimento a
WHERE 
a.desativado =0
AND a.DataCancelamento IS NULL
AND year(a.dataatendimento) = YEAR(@data)
AND a.tipoGuia IN ( 1,2)







SELECT 
0.2 AS Ordem,
'CONSULTA' AS Tipo,
SUM(CASE WHEN MONTH(A.dataatendimento) = 1 THEN 1 ELSE 0 END) AS Mes01,
SUM(CASE WHEN MONTH(A.dataatendimento) = 2 THEN 1 ELSE 0 END) AS Mes02,
SUM(CASE WHEN MONTH(A.dataatendimento) = 3 THEN 1 ELSE 0 END) AS Mes03,
SUM(CASE WHEN MONTH(A.dataatendimento) = 4 THEN 1 ELSE 0 END) AS Mes04,
SUM(CASE WHEN MONTH(A.dataatendimento) = 5 THEN 1 ELSE 0 END) AS Mes05,
SUM(CASE WHEN MONTH(A.dataatendimento) = 6 THEN 1 ELSE 0 END) AS Mes06,
SUM(CASE WHEN MONTH(A.dataatendimento) = 7 THEN 1 ELSE 0 END) AS Mes07,
SUM(CASE WHEN MONTH(A.dataatendimento) = 8 THEN 1 ELSE 0 END) AS Mes08,
SUM(CASE WHEN MONTH(A.dataatendimento) = 9 THEN 1 ELSE 0 END) AS Mes09,
SUM(CASE WHEN MONTH(A.dataatendimento) = 10 THEN 1 ELSE 0 END) AS Mes10,
SUM(CASE WHEN MONTH(A.dataatendimento) = 11 THEN 1 ELSE 0 END) AS Mes11,
SUM(CASE WHEN MONTH(A.dataatendimento) = 12 THEN 1 ELSE 0 END) AS Mes12,
COUNT(*) AS Total
FROM tab_Atendimento A
WHERE consulta = 1
AND desativado =0
AND DataCancelamento IS NULL
AND YEAR(a.dataatendimento) = YEAR(@data)
AND a.tipoGuia IN ( 1,2)

UNION
SELECT 
0.3 AS Ordem,
'REVISÃO' AS Tipo,
SUM(CASE WHEN MONTH(A.dataatendimento) = 1 THEN 1 ELSE 0 END) AS Mes01,
SUM(CASE WHEN MONTH(A.dataatendimento) = 2 THEN 1 ELSE 0 END) AS Mes02,
SUM(CASE WHEN MONTH(A.dataatendimento) = 3 THEN 1 ELSE 0 END) AS Mes03,
SUM(CASE WHEN MONTH(A.dataatendimento) = 4 THEN 1 ELSE 0 END) AS Mes04,
SUM(CASE WHEN MONTH(A.dataatendimento) = 5 THEN 1 ELSE 0 END) AS Mes05,
SUM(CASE WHEN MONTH(A.dataatendimento) = 6 THEN 1 ELSE 0 END) AS Mes06,
SUM(CASE WHEN MONTH(A.dataatendimento) = 7 THEN 1 ELSE 0 END) AS Mes07,
SUM(CASE WHEN MONTH(A.dataatendimento) = 8 THEN 1 ELSE 0 END) AS Mes08,
SUM(CASE WHEN MONTH(A.dataatendimento) = 9 THEN 1 ELSE 0 END) AS Mes09,
SUM(CASE WHEN MONTH(A.dataatendimento) = 10 THEN 1 ELSE 0 END) AS Mes10,
SUM(CASE WHEN MONTH(A.dataatendimento) = 11 THEN 1 ELSE 0 END) AS Mes11,
SUM(CASE WHEN MONTH(A.dataatendimento) = 12 THEN 1 ELSE 0 END) AS Mes12,
COUNT(*) AS Total
FROM tab_Atendimento A
WHERE consulta = 1 AND a.revisao = 1
AND desativado =0
AND DataCancelamento IS NULL
AND YEAR(a.dataatendimento) = YEAR(@data)
AND a.tipoGuia IN ( 1,2)

UNION
SELECT 
0 AS Ordem,
'PACIENTES ATENDIDOS' AS Tipo,

SUM(CASE WHEN MONTH(A.dataatendimento) = 1 THEN 1 ELSE 0 END) AS Mes01,
SUM(CASE WHEN MONTH(A.dataatendimento) = 2 THEN 1 ELSE 0 END) AS Mes02,
SUM(CASE WHEN MONTH(A.dataatendimento) = 3 THEN 1 ELSE 0 END) AS Mes03,
SUM(CASE WHEN MONTH(A.dataatendimento) = 4 THEN 1 ELSE 0 END) AS Mes04,
SUM(CASE WHEN MONTH(A.dataatendimento) = 5 THEN 1 ELSE 0 END) AS Mes05,
SUM(CASE WHEN MONTH(A.dataatendimento) = 6 THEN 1 ELSE 0 END) AS Mes06,
SUM(CASE WHEN MONTH(A.dataatendimento) = 7 THEN 1 ELSE 0 END) AS Mes07,
SUM(CASE WHEN MONTH(A.dataatendimento) = 8 THEN 1 ELSE 0 END) AS Mes08,
SUM(CASE WHEN MONTH(A.dataatendimento) = 9 THEN 1 ELSE 0 END) AS Mes09,
SUM(CASE WHEN MONTH(A.dataatendimento) = 10 THEN 1 ELSE 0 END) AS Mes10,
SUM(CASE WHEN MONTH(A.dataatendimento) = 11 THEN 1 ELSE 0 END) AS Mes11,
SUM(CASE WHEN MONTH(A.dataatendimento) = 12 THEN 1 ELSE 0 END) AS Mes12,
COUNT(*) AS Total

from #PacientesAtendidos A

UNION
SELECT 
0.1 AS Ordem,
'1º ATENDIMENTO' AS Tipo,

SUM(CASE WHEN MONTH(A.dataatendimento) = 1 THEN 1 ELSE 0 END) AS Mes01,
SUM(CASE WHEN MONTH(A.dataatendimento) = 2 THEN 1 ELSE 0 END) AS Mes02,
SUM(CASE WHEN MONTH(A.dataatendimento) = 3 THEN 1 ELSE 0 END) AS Mes03,
SUM(CASE WHEN MONTH(A.dataatendimento) = 4 THEN 1 ELSE 0 END) AS Mes04,
SUM(CASE WHEN MONTH(A.dataatendimento) = 5 THEN 1 ELSE 0 END) AS Mes05,
SUM(CASE WHEN MONTH(A.dataatendimento) = 6 THEN 1 ELSE 0 END) AS Mes06,
SUM(CASE WHEN MONTH(A.dataatendimento) = 7 THEN 1 ELSE 0 END) AS Mes07,
SUM(CASE WHEN MONTH(A.dataatendimento) = 8 THEN 1 ELSE 0 END) AS Mes08,
SUM(CASE WHEN MONTH(A.dataatendimento) = 9 THEN 1 ELSE 0 END) AS Mes09,
SUM(CASE WHEN MONTH(A.dataatendimento) = 10 THEN 1 ELSE 0 END) AS Mes10,
SUM(CASE WHEN MONTH(A.dataatendimento) = 11 THEN 1 ELSE 0 END) AS Mes11,
SUM(CASE WHEN MONTH(A.dataatendimento) = 12 THEN 1 ELSE 0 END) AS Mes12,
COUNT(*) AS Total
FROM #PrimeiroAtendimento A

UNION
SELECT 
5 AS Ordem,
'FALTA' AS Tipo,

SUM(CASE WHEN MONTH(A.dataatendimento) = 1 THEN 1 ELSE 0 END) AS Mes01,
SUM(CASE WHEN MONTH(A.dataatendimento) = 2 THEN 1 ELSE 0 END) AS Mes02,
SUM(CASE WHEN MONTH(A.dataatendimento) = 3 THEN 1 ELSE 0 END) AS Mes03,
SUM(CASE WHEN MONTH(A.dataatendimento) = 4 THEN 1 ELSE 0 END) AS Mes04,
SUM(CASE WHEN MONTH(A.dataatendimento) = 5 THEN 1 ELSE 0 END) AS Mes05,
SUM(CASE WHEN MONTH(A.dataatendimento) = 6 THEN 1 ELSE 0 END) AS Mes06,
SUM(CASE WHEN MONTH(A.dataatendimento) = 7 THEN 1 ELSE 0 END) AS Mes07,
SUM(CASE WHEN MONTH(A.dataatendimento) = 8 THEN 1 ELSE 0 END) AS Mes08,
SUM(CASE WHEN MONTH(A.dataatendimento) = 9 THEN 1 ELSE 0 END) AS Mes09,
SUM(CASE WHEN MONTH(A.dataatendimento) = 10 THEN 1 ELSE 0 END) AS Mes10,
SUM(CASE WHEN MONTH(A.dataatendimento) = 11 THEN 1 ELSE 0 END) AS Mes11,
SUM(CASE WHEN MONTH(A.dataatendimento) = 12 THEN 1 ELSE 0 END) AS Mes12,
COUNT(*) AS Total
FROM #Falta A

UNION
SELECT 
5.1 AS Ordem,
'FALTA COM CONFIRMAÇÃO' AS Tipo,

SUM(CASE WHEN MONTH(A.dataatendimento) = 1 THEN 1 ELSE 0 END) AS Mes01,
SUM(CASE WHEN MONTH(A.dataatendimento) = 2 THEN 1 ELSE 0 END) AS Mes02,
SUM(CASE WHEN MONTH(A.dataatendimento) = 3 THEN 1 ELSE 0 END) AS Mes03,
SUM(CASE WHEN MONTH(A.dataatendimento) = 4 THEN 1 ELSE 0 END) AS Mes04,
SUM(CASE WHEN MONTH(A.dataatendimento) = 5 THEN 1 ELSE 0 END) AS Mes05,
SUM(CASE WHEN MONTH(A.dataatendimento) = 6 THEN 1 ELSE 0 END) AS Mes06,
SUM(CASE WHEN MONTH(A.dataatendimento) = 7 THEN 1 ELSE 0 END) AS Mes07,
SUM(CASE WHEN MONTH(A.dataatendimento) = 8 THEN 1 ELSE 0 END) AS Mes08,
SUM(CASE WHEN MONTH(A.dataatendimento) = 9 THEN 1 ELSE 0 END) AS Mes09,
SUM(CASE WHEN MONTH(A.dataatendimento) = 10 THEN 1 ELSE 0 END) AS Mes10,
SUM(CASE WHEN MONTH(A.dataatendimento) = 11 THEN 1 ELSE 0 END) AS Mes11,
SUM(CASE WHEN MONTH(A.dataatendimento) = 12 THEN 1 ELSE 0 END) AS Mes12,
COUNT(*) AS Total
FROM #Falta A WHERE confirmado = 1

UNION
SELECT 
0.4 AS Ordem,
'EXAME' AS Tipo,
SUM(CASE WHEN MONTH(A.dataatendimento) = 1 THEN 1 ELSE 0 END) AS Mes01,
SUM(CASE WHEN MONTH(A.dataatendimento) = 2 THEN 1 ELSE 0 END) AS Mes02,
SUM(CASE WHEN MONTH(A.dataatendimento) = 3 THEN 1 ELSE 0 END) AS Mes03,
SUM(CASE WHEN MONTH(A.dataatendimento) = 4 THEN 1 ELSE 0 END) AS Mes04,
SUM(CASE WHEN MONTH(A.dataatendimento) = 5 THEN 1 ELSE 0 END) AS Mes05,
SUM(CASE WHEN MONTH(A.dataatendimento) = 6 THEN 1 ELSE 0 END) AS Mes06,
SUM(CASE WHEN MONTH(A.dataatendimento) = 7 THEN 1 ELSE 0 END) AS Mes07,
SUM(CASE WHEN MONTH(A.dataatendimento) = 8 THEN 1 ELSE 0 END) AS Mes08,
SUM(CASE WHEN MONTH(A.dataatendimento) = 9 THEN 1 ELSE 0 END) AS Mes09,
SUM(CASE WHEN MONTH(A.dataatendimento) = 10 THEN 1 ELSE 0 END) AS Mes10,
SUM(CASE WHEN MONTH(A.dataatendimento) = 11 THEN 1 ELSE 0 END) AS Mes11,
SUM(CASE WHEN MONTH(A.dataatendimento) = 12 THEN 1 ELSE 0 END) AS Mes12,
COUNT(*) AS Total
FROM Tab_AtendimentoServico tas
JOIN Tab_Atendimento a ON a.idatendimento = tas.idatendimento
JOIN Tab_ProcedimentoTussNomenclatura tptn ON tptn.idProcedimentoTussNomenclatura = tas.idProcedimentoTussNomenclatura
AND tptn.PTNConsulta = 0
WHERE 
a.desativado =0
AND a.DataCancelamento IS NULL
AND year(a.dataatendimento) = YEAR(@data)
AND a.tipoGuia IN ( 1,2)



ORDER BY Ordem

end
GO

ALTER  proc PreparaSis_Botao
-- EXEMPLO 
-- exec PreparaSis_Botao 'CADASTRO - OPERADORA', 'CADASTRO - OPERADORA'
@BotaoDescricao varchar(100),
@BotaoNome varchar(100)

as


declare @BotaoDescricao2 varchar(100)
declare @BotaoNome2 varchar(100)

--set @botaoDescricao = 'Financeiro -> Plano de contas'
--set @botaonome = 'Plano de contas'



-- INCLUIR
set @botaoDescricao2 = @botaoDescricao + ' -> Incluir'
set @botaonome2 = @botaoNome + ' Incluir'
if not exists( select * from sis_botao where botao = @botaonome2)
Insert into sis_botao
(Descricao, Botao)
values
(@BotaoDescricao2, @BotaoNome2)

-- ABRIR
set @botaoDescricao2 = @botaoDescricao + ' -> Abrir'
set @botaonome2 = @botaoNome + ' Abrir'
if not exists( select * from sis_botao where botao = @botaonome2)
Insert into sis_botao
(Descricao, Botao)
values
(@BotaoDescricao2, @BotaoNome2)

-- EXCLUIR
set @botaoDescricao2 = @botaoDescricao + ' -> Excluir'
set @botaonome2 = @botaoNome + ' Excluir'
if not exists( select * from sis_botao where botao = @botaonome2)
Insert into sis_botao
(Descricao, Botao)
values
(@BotaoDescricao2, @BotaoNome2)

-- LIXEIRA
set @botaoDescricao2 = @botaoDescricao + ' -> Lixeira'
set @botaonome2 = @botaoNome + ' Lixeira'
if not exists( select * from sis_botao where botao = @botaonome2)
Insert into sis_botao
(Descricao, Botao)
values
(@BotaoDescricao2, @BotaoNome2)

-- IMPRIMIR
set @botaoDescricao2 = @botaoDescricao + ' -> Imprimir'
set @botaonome2 = @botaoNome + ' Imprimir'
if not exists( select * from sis_botao where botao = @botaonome2)
Insert into sis_botao
(Descricao, Botao)
values
(@BotaoDescricao2, @BotaoNome2)

-- EXPORTAR
set @botaoDescricao2 = @botaoDescricao + ' -> Exportar'
set @botaonome2 = @botaoNome + ' Exportar'
if not exists( select * from sis_botao where botao = @botaonome2)
Insert into sis_botao
(Descricao, Botao)
values
(@BotaoDescricao2, @BotaoNome2)

-- SALVAR
set @botaoDescricao2 = @botaoDescricao + ' -> Salvar'
set @botaonome2 = @botaoNome + ' Salvar'
if not exists( select * from sis_botao where botao = @botaonome2)
Insert into sis_botao
(Descricao, Botao)
values
(@BotaoDescricao2, @BotaoNome2)

GO

ALTER proc [dbo].[PROC_PrestadorMedico_GeraComissao] @idAtendimentoServico int
as begin

	exec [PROC_PrestadorMedico_GeraComissao_Procedimento_Solicitante] @idAtendimentoServico
	exec [PROC_PrestadorMedico_GeraComissao_Executante] @idAtendimentoServico
	exec [PROC_PrestadorMedico_GeraComissao_Procedimento_Auxiliar] @idAtendimentoServico
	exec [PROC_PrestadorMedico_GeraComissao_Material_Auxiliar] @idAtendimentoServico
end
GO

ALTER proc [dbo].[PROC_PrestadorMedico_GeraComissao_Auxiliar]
	@idAtendimentoServico int
AS
BEGIN

declare @retorno money

declare @teste int

declare @idForma int


if (select count(*) from tab_atendimentoservico 
where idatendimentoservico = @idatendimentoservico 
and idProcedimentoTussNomenclatura is not null 
and idProfissionalAuxiliarVaiReceber is not null ) = 1
begin

declare @relacionado bit
set @relacionado = 	( select FaturamentoPercentualRelacionado from tab_atendimentoservico
			  where idatendimentoservico = @idAtendimentoServico
			)

declare @idPrestadorMedicoRepasse int

-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @teste = 1
set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and PMR.Executante = 1
	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)





where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print isnull(@idPrestadorMedicoRepasse,0)


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @teste = 2
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- 3. testa? EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 3
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- 4. teste? EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 4
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)




	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- 5. testa? EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 5
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- 6. testa? EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 6
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- 7. testa? EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 7
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- 8. testa? procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @teste = 8
	set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- 9. testa? procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 9
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- 10. testa? procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 10
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- 11. testa? procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 11
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- 12. testa? plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 12
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- 13. testa? unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 13
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- 14. testa? (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 14
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end

print '@idPrestadorMedicoRepasse'
print @idPrestadorMedicoRepasse
print 'fim @idPrestadorMedicoRepasse'

declare @idAtendimento int
set @idatendimento = (Select max(idAtendimento) 
from Tab_AtendimentoServico 
where idAtendimentoServico = @idAtendimentoServico)

--declare @DiasParaComissao int
declare @FormaPagamento varchar(20)
declare @dataAtendimento datetime
select --@DiasParaComissao = f1.DiasParaComissao,
@dataAtendimento = a.DataAtendimento from Tab_Atendimento a where a.idAtendimento = @idAtendimento



if exists(select r.idReceita from fin_receita r join fin_forma f on f.idforma = r.idforma and f.CartaoCredito = 1 where r.idAtendimento = @idAtendimento)
	set @formaPagamento = 'CREDITO'
else
if exists(select r.idReceita from fin_receita r join fin_forma f on f.idforma = r.idforma and f.CartaoDebito = 1 where r.idAtendimento = @idAtendimento)
	set @formaPagamento = 'DEBITO'
else
	set @formaPagamento = 'DINHEIRO'


print @formapagamento

set @retorno =


isnull((

select



max(cast(

-- os 2 (( aqui vou retirar o x% do valor da comissão
 ( (


isnull(
case

	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 )
	then
		PMR.ValorComissaoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 )
	then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorComissaoInternacao

	when ( (sol.Emergencia = 1) and (@relacionado = 0) )   then
		PMR.ValorComissaoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorComissaoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorComissaoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorComissaoAmbulatorioRelacionado

end


,0)

+

( ( (
 (
  case
   when PC.TipoFaturamento = 1 then
	isnull(
		-- ASS.ValorTotalConvenio
		( ( ASS.ValorTotalConvenio  + ASS.ValorTotalCliente - ASS.PTVValM2FilmeTotal       ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
		+
		( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  )
	,0)

   else 0
   end
  )
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end)

  - ISNULL(ASS.ValorGlosa,0)

  - case when PMR.DescontarComissaoPagaAoSolicitante =1 then
		ASS.ValorComissaoSolicitante
	else
		0
	end


  - case when pmr.ConsiderarDescontoDoAtendimento = 1 then isnull(ASS.ValorDescontoServico,0) else 0 end

  )
	* isnull(

case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorPercentoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorPercentoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorPercentoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorPercentoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorPercentoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorPercentoAmbulatorioRelacionado

end




,0)) / 100 )






-- aqui vou retirar o x% do valor da comissão

) / 100 ) * (100 -

isnull(
case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorDescontoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorDescontoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorDescontoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorDescontoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		isnull(PMR.ValorDescontoAmbulatorio,0)
		+ case when @FormaPagamento = 'CREDITO' then isnull(PMR.VPercDescontoCCreditoAmbulatorio,0) else 0  end
		+ case when @FormaPagamento = 'DEBITO' then isnull(PMR.VPercDescontoCDebitoAmbulatorio,0) else 0  end

	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorDescontoAmbulatorioRelacionado

end,0))

as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
left join Tab_AtendimentoServicoEquipe ASE on ASE.idAtendimentoServico = ass.idAtendimentoServico
	and ASE.RepasseCirurgiao = 1

where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0

),0)

print @retorno


declare @valorComissao money

set @valorComissao = @retorno

update tab_atendimentoservico set ValorComissao = @retorno, idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse where idAtendimentoServico = @idAtendimentoServico


-- vou criar um if aqui
-- se foi pagamento no dinheiro pode pular
-- se foi cartao de credito e tem valor cadastrado en VPercDescontoCCreditoAmbulatorio, então pula também.
-- se foi cartao de debito e tem valor cadastrado em VPercDescontoCDebitoAmbulatorio, então pula também.



declare @DescontoTaxaCartao bit
set @DescontoTaxaCartao = (Select COUNT(*) from Cad_PrestadorMedicoRepasse where idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse and DescontarTaxaCartao = 1)

print '@DescontoTaxaCartao'
print @DescontoTaxaCartao

if @DescontoTaxaCartao = 1 begin

	if (select COUNT(*) from Fin_Receita where idAtendimento = @idAtendimento) > 0 begin

	  if (@retorno > 0) begin
		--declare @ValorDescontoCartao int
		declare @ValorPDescontoTotal money
		--set @ValorPDescontoTotal = (select ( Sum(ValorDevido)  / sum(ValorDevido - cast(ValorDesconto as decimal(9,2)))   ) - 1.0000  from Fin_Receita where idAtendimento = @idAtendimento)

		declare @DescontoOperadoraCartaoProporcional bit
		select @DescontoOperadoraCartaoProporcional =  DescontoOperadoraCartaoProporcional from cad_empresa

		if @DescontoOperadoraCartaoProporcional =1 begin
			set @ValorPDescontoTotal = (select  ((( sum(ValorDevido - cast(ValorDesconto as decimal(9,4))) / Sum(ValorDevido) ) - 1.0000 )  * -100.0000 )  from Fin_Receita where idAtendimento = @idAtendimento)
		end else begin
			select @idforma =
				case
					when (f1.ValorPDesconto >= isnull(f2.ValorPDesconto,0)) and (f1.ValorPDesconto >= isnull(F3.ValorPDesconto,0)) then F1.idForma
					when (f2.ValorPDesconto >= isnull(f3.ValorPDesconto,0)) and (f2.ValorPDesconto >= isnull(F1.ValorPDesconto,0)) then F2.idForma
					when (f3.ValorPDesconto >= isnull(f1.ValorPDesconto,0)) and (f3.ValorPDesconto >= isnull(F2.ValorPDesconto,0)) then F2.idForma
					else 0 end
				from tab_atendimento a
			left join fin_forma f1 on f1.idforma = a.idforma1 and f1.ValorPDesconto > 0
			left join fin_forma f2 on f2.idforma = a.idforma2 and f2.ValorPDesconto > 0
			left join fin_forma f3 on f3.idforma = a.idforma3 and f2.ValorPDesconto > 0
			where a.idAtendimento = @idAtendimento

			select @valorPDescontoTotal = valorPDesconto
			from fin_Forma where idforma = @idforma
		end
		print '@formaPagamento'
		print @formaPagamento
		print '@idforma'
		print @idforma

		PRINT '@idPrestadorMedicoRepasse'
		print @idPrestadorMedicoRepasse
		print '@ValorPDescontoTotal'
		print @ValorPDescontoTotal

		if isnull(@ValorPDescontoTotal,0) > 0 begin
			set @retorno = @retorno -  ( (@retorno * @ValorPDescontoTotal) / 100.00 )
		end
		print '@retorno'
		print @retorno

		set @valorComissao = @retorno


		--set @retorno = @ValorPDescontoTotal

		update tab_atendimentoservico set ValorComissao = @retorno where idAtendimentoServico = @idAtendimentoServico
	  end

	end
end

---- agora vou preparar o update do valorbasecomissao com o x%

declare @valorbasecomissao money
set @valorbasecomissao =


isnull((

select



max(cast(

-- os 2 (( aqui vou retirar o x% do valor da comissão
 ( (



( (
 (
  case
   when PC.TipoFaturamento = 1 then
	isnull(
		-- ASS.ValorTotalConvenio
		( ( ASS.ValorTotalConvenio  + ASS.ValorTotalCliente - ASS.PTVValM2FilmeTotal) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
		+
		( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  )
	,0)

   else 0
   end
  )
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end)

  - ISNULL(ASS.ValorGlosa,0)

  - case when pmr.ConsiderarDescontoDoAtendimento = 1 then isnull(ASS.ValorDescontoServico,0) else 0 end  )
	)






-- aqui vou retirar o x% do valor da comissão

) / 100 ) * (100 -

isnull(
case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorDescontoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorDescontoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorDescontoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorDescontoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		isnull(PMR.ValorDescontoAmbulatorio,0)
		+ case when @FormaPagamento = 'CREDITO' then isnull(PMR.VPercDescontoCCreditoAmbulatorio,0) else 0  end
		+ case when @FormaPagamento = 'DEBITO' then isnull(PMR.VPercDescontoCDebitoAmbulatorio,0) else 0  end
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorDescontoAmbulatorioRelacionado

end,0))

as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
left join Tab_AtendimentoServicoEquipe ASE on ASE.idAtendimentoServico = ass.idAtendimentoServico
	and ASE.RepasseCirurgiao = 1

where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0

),0)

print '@valorbasecomissao'
print @valorbasecomissao

update tab_atendimentoservico set valorbaseComissao = @valorbasecomissao where idAtendimentoServico = @idAtendimentoServico



	declare @idAtendimentoComissao int
	declare @idprestadorMedico int
	select @idPrestadorMedico= idProfissionalAuxiliarVaiReceber 
	from Tab_AtendimentoServico where idAtendimentoServico = @idAtendimentoServico
	
	
	print '@idPrestadorMedico'
	print @idPrestadorMedico
	
	select @idAtendimentoComissao = isnull(idAtendimentoComissao,0)
	from tab_Atendimentocomissao where idAtendimentoServico = @idAtendimentoServico and desativado =0 
	and idPrestadorMedico = @idPrestadorMedico
	--idFormaPagamento que tem a maior quantidade de parcelas usadas no pagamento feito pelo cliente
	select @idForma =
			case
				when isnull(F1.parcelas,1) >= isnull(F2.parcelas,1) and isnull(F1.parcelas, 1) >= isnull(F3.parcelas, 1) then
					F1.idForma
				when isnull(F2.parcelas,1) >= isnull(F3.parcelas,1) and isnull(F2.parcelas, 1) >= isnull(F1.parcelas, 1) then
					F2.idForma
				when isnull(F3.parcelas,1) >= isnull(F1.parcelas,1) and isnull(F3.parcelas, 1) >= isnull(F2.parcelas, 1) then
					F3.idForma
			end

	from tab_atendimento a
	LEFT join fin_forma f1 on f1.idforma = a.idforma1
	left join fin_forma f2 on f2.idforma = a.idforma2
	left join fin_forma f3 on f3.idforma = a.idforma3
	where a.idAtendimento = @idAtendimento


	--1.desativado todas as comissões do @idatendimentoservico
	update tab_Atendimentocomissao set desativado = 1 where idatendimentoservico = @idAtendimentoServico and Auxiliar = 1
		print '@idforma'
		print @idforma
		print 'vai fazer o insert'
	--2. vou incluir a comissão que falta por exemplo parcela 2 e 3.
		insert into Tab_AtendimentoComissao
		(idatendimento, DataVencimento, idAtendimentoServico, DataHoraInclusao, idPrestadorMedicoRepasse, idPrestadorMedico, Auxiliar,
		ValorComissao, ValorBaseComissao, teste,
		Parcela, idForma)
		select
			@idAtendimento,
			case
				when n.numero = 1 then                            DATEADD(day, isnull(f.DiasParaComissao,0), @DataAtendimento)
				when n.numero > 1 then dateadd(month, n.numero-1, DATEADD(day, isnull(f.DiasParaComissao,0), @DataAtendimento))
				else @DataAtendimento
			end
		,
		@idAtendimentoServico, GETDATE(),
		@idPrestadorMedicoRepasse, PMR.idPrestadorMedico, 1,

		@valorComissao / f.Parcelas , @valorbasecomissao, @teste,
		n.Numero as Parcela,
		f.idForma

		from Cad_PrestadorMedicoRepasse PMR
		left join fin_forma f on f.idforma = @idforma
		join sis_numero n on n.numero >= 1 and n.numero <= isnull(f.Parcelas,1)
		left join tab_AtendimentoComissao comissao on
				comissao.idatendimentoservico = @idAtendimentoServico
				and isnull(comissao.Parcela,1) = n.numero
				and comissao.Auxiliar = 1

		where pmr.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
		and comissao.idAtendimentoComissao is null

	-- agora vou fazer update nas parcelas que foram excluidas e não deveria, por exemplo parcela 1.
	print '@dataatendimento'
	print @dataatendimento
	
		update AC
		set AC.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse,
		ac.DataVencimento =
			case
				when n.numero = 1 then                            DATEADD(day, isnull(f.DiasParaComissao,0), @DataAtendimento)
				when n.numero > 1 then dateadd(month, n.numero-1, DATEADD(day, isnull(f.DiasParaComissao,0), @DataAtendimento))
				else @DataAtendimento
			end
		,

		AC.valorbaseComissao = @valorbasecomissao / isnull(f.Parcelas,1),
		AC.ValorComissao = @ValorComissao / isnull(f.Parcelas,1),
		AC.idprestadorMedico = pmr.idprestadorMedico,
		ac.Desativado = 0,
		teste = @teste,
		ac.Parcela = isnull(ac.Parcela,1),
		ac.idForma = f.idForma,
		AC.idAtendimento = @idAtendimento
		from Tab_AtendimentoComissao AC
		join Cad_PrestadorMedicoRepasse pmr on pmr.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
		left join fin_forma f on f.idforma = @idforma
		join sis_numero n on n.numero = isnull(ac.parcela, 1)
		where AC.idAtendimentoServico = @idAtendimentoServico


---- fim do update valor base comissao


end



return isnull(@retorno,0)
end
GO

ALTER proc PROC_PrestadorMedico_GeraComissao_Equipe_Medico1Auxiliar
	@idAtendimentoServico int, @idAtendimentoServicoEquipe int
--------------------------------------------------------
--- Calcula Comissao de Prestador - Equipe 1 Auxiliar ---
---                                                  ---
--- Janderson - 19/07/2019 - Correcao na Identificacao do Prestador
---

AS
BEGIN

declare @retorno money


if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1 
begin

if (select count(*) from Tab_AtendimentoServicoEquipe where idatendimentoservico = @idatendimentoservico and idAtendimentoServicoEquipe =@idAtendimentoServicoEquipe) > 0 
begin


declare @relacionado bit
set @relacionado = 	0

declare @idPrestadorMedicoRepasse int
declare @idPrestadorMedico int
set @idPrestadorMedico = (select idPrestadorMedico1Auxiliar from Tab_AtendimentoServicoEquipe where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe)


-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @idPrestadorMedicoRepasse =
( select PMR.idPrestadorMedicoRepasse
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = @idPrestadorMedico
where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print @idPrestadorMedicoRepasse


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
			on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse

declare @valorteste money

set @retorno = isnull((

select max(cast( isnull(PMR.ValorComissaoCCirurgico,0)

+

( ( ( 
 (
  case 
   when PC.TipoFaturamento = 1 then 
	isnull(
		-- ASS.ValorTotalConvenio
		( ( TASE.Valor1Auxiliar ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
				
	,0)
	
   else 0 
   end
  ) 
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end) 
  
  - isnull(ASS.ValorDescontoServico,0))
	* isnull(PMR.ValorPercentoCCirurgico ,0)) / 100 ) 


as Decimal(19,2)))

from tab_atendimentoservicoequipe TASE
join tab_AtendimentoServico ass on ass.idAtendimentoServico = tase.idAtendimentoServico
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio


where 
TASE.idAtendimentoServicoEquipe = @idAtendimentoservicoEquipe
and TASE.idPrestadorMedico1Auxiliar is not null 
AND TASE.PrestadorMedico1AuxiliarImprimir = 1
AND TASE.Repasse1Auxiliar = 1
and PMR.Desativado = 0 

),0)

print 'idprestadormedicorepasse'
print @idPrestadorMedicoRepasse
print 'retorno'
print @retorno

update Tab_AtendimentoServicoEquipe set Valor1AuxiliarComissao = @retorno where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe


end

end


return isnull(@retorno,0)
end
GO

ALTER proc PROC_PrestadorMedico_GeraComissao_Equipe_Medico2Auxiliar
	@idAtendimentoServico int, @idAtendimentoServicoEquipe int
--------------------------------------------------------
--- Calcula Comissao de Prestador - Equipe 2 Auxiliar ---
---                                                  ---
--- Janderson - 19/07/2019 - Correcao na Identificacao do Prestador
---

AS
BEGIN

declare @retorno money


if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1 
begin

if (select count(*) from Tab_AtendimentoServicoEquipe where idatendimentoservico = @idatendimentoservico and idAtendimentoServicoEquipe =@idAtendimentoServicoEquipe) > 0 
begin

declare @relacionado bit
set @relacionado = 	0

declare @idPrestadorMedicoRepasse int
declare @idPrestadorMedico int
set @idPrestadorMedico = (select idPrestadorMedico2Auxiliar from Tab_AtendimentoServicoEquipe where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe)


-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @idPrestadorMedicoRepasse =
( select PMR.idPrestadorMedicoRepasse
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = @idPrestadorMedico
where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print @idPrestadorMedicoRepasse


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
			on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse

declare @valorteste money

set @retorno = isnull((

select max(cast( isnull(PMR.ValorComissaoCCirurgico,0)

+

( ( ( 
 (
  case 
   when PC.TipoFaturamento = 1 then 
	isnull(
		-- ASS.ValorTotalConvenio
		( ( TASE.Valor2Auxiliar ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
				
	,0)
	
   else 0 
   end
  ) 
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end) 
  
  - isnull(ASS.ValorDescontoServico,0))
	* isnull(PMR.ValorPercentoCCirurgico ,0)) / 100 ) 


as Decimal(19,2)))

from tab_atendimentoservicoequipe TASE
join tab_AtendimentoServico ass on ass.idAtendimentoServico = tase.idAtendimentoServico
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio


where 
TASE.idAtendimentoServicoEquipe = @idAtendimentoservicoEquipe
and TASE.idPrestadorMedico2Auxiliar is not null 
AND TASE.PrestadorMedico2AuxiliarImprimir = 1
AND TASE.Repasse2Auxiliar = 1
and PMR.Desativado = 0

),0)

print 'idprestadormedicorepasse'
print @idPrestadorMedicoRepasse
print 'retorno'
print @retorno

update Tab_AtendimentoServicoEquipe set Valor2AuxiliarComissao = @retorno where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe


end

end


return isnull(@retorno,0)
end
GO

ALTER proc [dbo].[PROC_PrestadorMedico_GeraComissao_Equipe_Medico3Auxiliar]
	@idAtendimentoServico int, @idAtendimentoServicoEquipe int
--------------------------------------------------------
--- Calcula Comissao de Prestador - Equipe 3 Auxiliar ---
---                                                  ---
--- Janderson - 19/07/2019 - Correcao na Identificacao do Prestador
---
	
AS
BEGIN

declare @retorno money


if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1 
begin

if (select count(*) from Tab_AtendimentoServicoEquipe where idatendimentoservico = @idatendimentoservico and idAtendimentoServicoEquipe =@idAtendimentoServicoEquipe) > 0 
begin


declare @relacionado bit
set @relacionado = 	0

declare @idPrestadorMedicoRepasse int
declare @idPrestadorMedico int
set @idPrestadorMedico = (select idPrestadorMedico3Auxiliar from Tab_AtendimentoServicoEquipe where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe)


-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @idPrestadorMedicoRepasse =
( select PMR.idPrestadorMedicoRepasse
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = @idPrestadorMedico
where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print @idPrestadorMedicoRepasse


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
			on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse

declare @valorteste money

set @retorno = isnull((

select max(cast( isnull(PMR.ValorComissaoCCirurgico,0)

+

( ( ( 
 (
  case 
   when PC.TipoFaturamento = 1 then 
	isnull(
		-- ASS.ValorTotalConvenio
		( ( TASE.Valor3Auxiliar ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
				
	,0)
	
   else 0 
   end
  ) 
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end) 
  
  - isnull(ASS.ValorDescontoServico,0))
	* isnull(PMR.ValorPercentoCCirurgico ,0)) / 100 ) 


as Decimal(19,2)))

from tab_atendimentoservicoequipe TASE
join tab_AtendimentoServico ass on ass.idAtendimentoServico = tase.idAtendimentoServico
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio


where 
TASE.idAtendimentoServicoEquipe = @idAtendimentoservicoEquipe
and TASE.idPrestadorMedico3Auxiliar is not null 
AND TASE.PrestadorMedico3AuxiliarImprimir = 1
AND TASE.Repasse3Auxiliar = 1
and PMR.Desativado = 0

),0)

print 'idprestadormedicorepasse'
print @idPrestadorMedicoRepasse
print 'retorno'
print @retorno

update Tab_AtendimentoServicoEquipe set Valor3AuxiliarComissao = @retorno where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe


end

end


return isnull(@retorno,0)
end
GO

ALTER proc PROC_PrestadorMedico_GeraComissao_Equipe_Medico4Auxiliar
	@idAtendimentoServico int, @idAtendimentoServicoEquipe int
--------------------------------------------------------
--- Calcula Comissao de Prestador - Equipe 4 Auxiliar ---
---                                                  ---
--- Janderson - 19/07/2019 - Correcao na Identificacao do Prestador
---
	
AS
BEGIN

declare @retorno money


if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1 
begin

if (select count(*) from Tab_AtendimentoServicoEquipe where idatendimentoservico = @idatendimentoservico and idAtendimentoServicoEquipe =@idAtendimentoServicoEquipe) > 0 
begin


declare @relacionado bit
set @relacionado = 	0

declare @idPrestadorMedicoRepasse int
declare @idPrestadorMedico int
set @idPrestadorMedico = (select idPrestadorMedico4Auxiliar from Tab_AtendimentoServicoEquipe where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe)


-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @idPrestadorMedicoRepasse =
( select PMR.idPrestadorMedicoRepasse
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = @idPrestadorMedico
where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print @idPrestadorMedicoRepasse


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
			on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse

declare @valorteste money

set @retorno = isnull((

select max(cast( isnull(PMR.ValorComissaoCCirurgico,0)

+

( ( ( 
 (
  case 
   when PC.TipoFaturamento = 1 then 
	isnull(
		-- ASS.ValorTotalConvenio
		( ( TASE.Valor4Auxiliar ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
				
	,0)
	
   else 0 
   end
  ) 
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end) 
  
  - isnull(ASS.ValorDescontoServico,0))
	* isnull(PMR.ValorPercentoCCirurgico ,0)) / 100 ) 


as Decimal(19,2)))

from tab_atendimentoservicoequipe TASE
join tab_AtendimentoServico ass on ass.idAtendimentoServico = tase.idAtendimentoServico
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio


where 
TASE.idAtendimentoServicoEquipe = @idAtendimentoservicoEquipe
and TASE.idPrestadorMedico4Auxiliar is not null 
AND TASE.PrestadorMedico4AuxiliarImprimir = 1
AND TASE.Repasse4Auxiliar = 1

and PMR.Desativado = 0 

),0)

print 'idprestadormedicorepasse'
print @idPrestadorMedicoRepasse
print 'retorno'
print @retorno

update Tab_AtendimentoServicoEquipe set Valor4AuxiliarComissao = @retorno where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe


end

end



return isnull(@retorno,0)
end
GO

ALTER proc PROC_PrestadorMedico_GeraComissao_Equipe_MedicoAnestesista
	@idAtendimentoServico int, @idAtendimentoServicoEquipe int
--------------------------------------------------------
--- Calcula Comissao de Prestador - Equipe Anestesia ---
---                                                  ---
--- Janderson - 19/07/2019 - Correcao na Identificacao do Prestador
---
	
AS
BEGIN

declare @retorno money


if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1 
begin

if (select count(*) from Tab_AtendimentoServicoEquipe where idatendimentoservico = @idatendimentoservico and idAtendimentoServicoEquipe =@idAtendimentoServicoEquipe) > 0 
begin


declare @relacionado bit
set @relacionado = 	0

declare @idPrestadorMedicoRepasse int
declare @idPrestadorMedico int
set @idPrestadorMedico = (select idPrestadorMedicoAnestesista from Tab_AtendimentoServicoEquipe where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe)


-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @idPrestadorMedicoRepasse =
( select PMR.idPrestadorMedicoRepasse
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = @idPrestadorMedico
where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print @idPrestadorMedicoRepasse


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
			on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse

declare @valorteste money

set @retorno = isnull((

select max(cast( isnull(PMR.ValorComissaoCCirurgico,0)

+

( ( ( 
 (
  case 
   when PC.TipoFaturamento = 1 then 
	isnull(
		-- ASS.ValorTotalConvenio
		( ( TASE.ValorAnestesista ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
				
	,0)
	
   else 0 
   end
  ) 
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end) 
  
  - isnull(ASS.ValorDescontoServico,0))
	* isnull(PMR.ValorPercentoCCirurgico ,0)) / 100 ) 


as Decimal(19,2)))

from tab_atendimentoservicoequipe TASE
join tab_AtendimentoServico ass on ass.idAtendimentoServico = tase.idAtendimentoServico
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio


where 
TASE.idAtendimentoServicoEquipe = @idAtendimentoservicoEquipe
and TASE.idPrestadorMedicoAnestesista is not null 
AND TASE.PrestadorMedicoAnestesistaImprimir = 1
AND TASE.RepasseAnestesista = 1
and PMR.Desativado = 0 

),0)

print 'idprestadormedicorepasse'
print @idPrestadorMedicoRepasse
print 'retorno'
print @retorno

update Tab_AtendimentoServicoEquipe set ValorAnestesistaComissao = @retorno where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe


end

end

return isnull(@retorno,0)
end
GO

ALTER proc PROC_PrestadorMedico_GeraComissao_Equipe_MedicoCirurgiao
	@idAtendimentoServico int, @idAtendimentoServicoEquipe int
--------------------------------------------------------
--- Calcula Comissao de Prestador - Equipe Cirurgiao ---
---                                                  ---
--- Janderson - 19/07/2019 - Correcao na Identificacao do Prestador
---

AS
BEGIN

declare @retorno money


if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1 
begin

if (select count(*) from Tab_AtendimentoServicoEquipe where idatendimentoservico = @idatendimentoservico and idAtendimentoServicoEquipe =@idAtendimentoServicoEquipe) > 0 
begin

declare @relacionado bit
set @relacionado = 	0

declare @idPrestadorMedicoRepasse int
declare @idPrestadorMedico int
set @idPrestadorMedico = (select idPrestadorMedicoCirurgiao from Tab_AtendimentoServicoEquipe where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe)


-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @idPrestadorMedicoRepasse =
( select PMR.idPrestadorMedicoRepasse
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = @idPrestadorMedico
where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print @idPrestadorMedicoRepasse


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
			on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse

declare @valorteste money

set @retorno = isnull((

select max(cast( isnull(PMR.ValorComissaoCCirurgico,0)

+

( ( ( 
 (
  case 
   when PC.TipoFaturamento = 1 then 
	isnull(
		-- ASS.ValorTotalConvenio
		( ( TASE.ValorCirurgiao ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
				
	,0)
	
   else 0 
   end
  ) 
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end) 
  
  - isnull(ASS.ValorDescontoServico,0))
	* isnull(PMR.ValorPercentoCCirurgico ,0)) / 100 ) 


as Decimal(19,2)))

from tab_atendimentoservicoequipe TASE
join tab_AtendimentoServico ass on ass.idAtendimentoServico = tase.idAtendimentoServico
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio


where 
TASE.idAtendimentoServicoEquipe = @idAtendimentoservicoEquipe
and TASE.idPrestadorMedicoCirurgiao is not null 
AND TASE.MedicoCirurgiaoImprimir = 1
AND TASE.RepasseCirurgiao = 1
and PMR.Desativado = 0

),0)

print 'idprestadormedicorepasse'
print @idPrestadorMedicoRepasse
print 'retorno'
print @retorno

update Tab_AtendimentoServicoEquipe set ValorCirurgiaoComissao = @retorno where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe


end

end


return isnull(@retorno,0)
end
GO

ALTER proc PROC_PrestadorMedico_GeraComissao_Equipe_MedicoInstrumentador
	@idAtendimentoServico int, @idAtendimentoServicoEquipe int
--------------------------------------------------------
--- Calcula Comissao de Prestador - Equipe Instrumentador ---
---                                                       ---
--- Janderson - 19/07/2019 - Correcao na Identificacao do Prestador
---
	
AS
BEGIN

declare @retorno money


if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1 
begin


if (select count(*) from Tab_AtendimentoServicoEquipe where idatendimentoservico = @idatendimentoservico and idAtendimentoServicoEquipe =@idAtendimentoServicoEquipe) > 0 
begin


declare @relacionado bit
set @relacionado = 	0

declare @idPrestadorMedicoRepasse int
declare @idPrestadorMedico int
set @idPrestadorMedico = (select idPrestadorMedicoInstrumentador from Tab_AtendimentoServicoEquipe where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe)


-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @idPrestadorMedicoRepasse =
( select PMR.idPrestadorMedicoRepasse
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = @idPrestadorMedico
where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print @idPrestadorMedicoRepasse


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico
		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = @idPrestadorMedico

		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @idPrestadorMedicoRepasse =
	( select PMR.idPrestadorMedicoRepasse
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
			on PMR.idPrestadorMedico = @idPrestadorMedico

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse

declare @valorteste money

set @retorno = isnull((

select max(cast( isnull(PMR.ValorComissaoCCirurgico,0)

+

( ( ( 
 (
  case 
   when PC.TipoFaturamento = 1 then 
	isnull(
		-- ASS.ValorTotalConvenio
		( ( TASE.ValorInstrumentador ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
				
	,0)
	
   else 0 
   end
  ) 
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end) 
  
  - isnull(ASS.ValorDescontoServico,0))
	* isnull(PMR.ValorPercentoCCirurgico ,0)) / 100 ) 


as Decimal(19,2)))

from tab_atendimentoservicoequipe TASE
join tab_AtendimentoServico ass on ass.idAtendimentoServico = tase.idAtendimentoServico
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio


where 
TASE.idAtendimentoServicoEquipe = @idAtendimentoservicoEquipe
and TASE.idPrestadorMedicoInstrumentador is not null 
AND TASE.PrestadorMedicoInstrumentadorImprimir = 1
AND TASE.RepasseInstrumentador = 1
and PMR.Desativado = 0 

),0)

print 'idprestadormedicorepasse'
print @idPrestadorMedicoRepasse
print 'retorno'
print @retorno

update Tab_AtendimentoServicoEquipe set ValorInstrumentadorComissao = @retorno where idAtendimentoServicoEquipe = @idAtendimentoServicoEquipe


end

end


return isnull(@retorno,0)
end
GO

-- 01/04/2024 23:50

CREATE proc [dbo].[PROC_PrestadorMedico_GeraComissao_Executante]
	@idAtendimentoServico int
AS
-- 01/04/2024 - janderson e gustavo, condição para registro ficar com desativado = 1
-- essa procedure vai substituir a PROC_PrestadorMedico_GeraComissao
-- ´pois agora o delphi vai char a procedure
BEGIN
--declare @idAtendimentoServico int
--set @idatendimentoservico = 3

declare @retorno money
/*
update TAS
set TAS.ValorPDescontoFilme = isnull(PCPF.ValorPDescontoFilme,),
TAS.ValorPDescontoProcedimento = isnull(PCPF.ValorPDescontoProcedimento,0)
from Tab_AtendimentoServico TAS
join Cad_PlanoConvenioProcedimentoFator PCPF on PCPF.idPlanoConvenioProcedimentoFator = TAS.idPlanoConvenioProcedimentoFator
where TAS.idAtendimentoServico = @idAtendimentoServico
*/


declare @teste int

declare @idForma int


if ( (	select COUNT(*) from Tab_AtendimentoServico
		where idAtendimentoServico  = @idAtendimentoServico
		and isnull(idPlanoConvenioProcedimentoFator,0) = 0 ) <> -1 ) begin

	update TAS
	set TAS.ValorPDescontoProcedimento = isnull(isnull(PCPF.ValorPDEscontoProcedimento, isnull(EF.ValorPDEscontoProcedimento, E.ValorPDEscontoProcedimento)),0),
	TAS.ValorPDescontoFilme = isnull(isnull(PCPF.ValorPDescontoFilme, ISNULL(EF.ValorPDescontoFilme, E.ValorPDescontoFilme)),0)
	from tab_atendimentoservico TAS
	join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
	join Tab_ProcedimentoTabelaValor TTV on TTV.idProcedimentoTabelaValor = TAS.idProcedimentoTabelaValor
	left join Cad_PlanoConvenioProcedimento PCP on PCP.idProcedimentoTabelaValor = TTV.idProcedimentoTabelaValor and PCP.Desativado = 0 and PCP.idPlanoConvenioProcedimento = TAS.idPlanoConvenioProcedimento

	left join Cad_PlanoConvenioProcedimentoFator PCPF on PCPF.idPlanoConvenioProcedimento = PCP.idPlanoConvenioProcedimento
												and PCPF.idEmpresaFilial = isnull(A.idEmpresaFilial,0)
												and PCPF.Desativado = 0
	cross join Cad_Empresa e
	left join Cad_EmpresaFilial ef on ef.idempresaFilial = A.idEmpresaFilial

	where TAS.idAtendimentoServico = @idAtendimentoServico

	PRINT 'Desconto executado'
end



if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1
begin

declare @relacionado bit
set @relacionado = 	( select FaturamentoPercentualRelacionado from tab_atendimentoservico
			  where idatendimentoservico = @idAtendimentoServico
			)

declare @idPrestadorMedicoRepasse int

-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @teste = 1
set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)

	and PMR.Executante = 1
	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)





where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print @idPrestadorMedicoRepasse


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @teste = 2
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber),  a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- 3. testa? EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 3
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- 4. teste? EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 4
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)




	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- 5. testa? EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 5
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- 6. testa? EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 6
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- 7. testa? EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 7
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- 8. testa? procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @teste = 8
	set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- 9. testa? procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 9
  print 'testando procedimento selecionado, plano selecionado, (unidade todas)'
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- 10. testa? procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 10
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber) , a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- 11. testa? procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 11
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- 12. testa? plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 12
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- 13. testa? unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 13
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber),  a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- 14. testa? (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 14
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber),  a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end

print '@idPrestadorMedicoRepasse'
print @idPrestadorMedicoRepasse
print 'fim @idPrestadorMedicoRepasse'

declare @idAtendimento int
set @idatendimento = (Select max(idAtendimento) from Tab_AtendimentoServico where idAtendimentoServico = @idAtendimentoServico)

--declare @DiasParaComissao int
declare @FormaPagamento varchar(20)
declare @dataAtendimento datetime
select --@DiasParaComissao = f1.DiasParaComissao,
@dataAtendimento = a.DataAtendimento from Tab_Atendimento a left join Fin_Forma f1 on f1.idForma = a.idForma1  where a.idAtendimento = @idAtendimento



if exists(select r.idReceita from fin_receita r join fin_forma f on f.idforma = r.idforma and f.CartaoCredito = 1 where r.idAtendimento = @idAtendimento)
	set @formaPagamento = 'CREDITO'
else
if exists(select r.idReceita from fin_receita r join fin_forma f on f.idforma = r.idforma and f.CartaoDebito = 1 where r.idAtendimento = @idAtendimento)
	set @formaPagamento = 'DEBITO'
else
	set @formaPagamento = 'DINHEIRO'


print @formapagamento

set @retorno =


isnull((

select



max(cast(

-- os 2 (( aqui vou retirar o x% do valor da comissão
 ( (


isnull(
case

	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 )
	then
		PMR.ValorComissaoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 )
	then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorComissaoInternacao

	when ( (sol.Emergencia = 1) and (@relacionado = 0) )   then
		PMR.ValorComissaoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorComissaoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) 
	and pmr.ConsiderarDescontoDoAtendimento = 1 
	and ass.ValorDescontoServico > 0
	then
		PMR.ValorComissaoAmbulatorio -	isnull(
			case when ASS.ValorDescontoServico < PMR.ValorComissaoAmbulatorio then
				ASS.ValorDescontoServico
			else
				PMR.ValorComissaoAmbulatorio
			end,0)

	when (sol.Emergencia = 0) and (@relacionado = 0) 
	then
		PMR.ValorComissaoAmbulatorio 
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorComissaoAmbulatorioRelacionado

end



,0)

+

( ( (
 (
  case
   when PC.TipoFaturamento = 1 then
	isnull(
		-- ASS.ValorTotalConvenio
		( ( ASS.ValorTotalConvenio  + ASS.ValorTotalCliente - ASS.PTVValM2FilmeTotal       ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
		+
		( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  )
	,0)

   else 0
   end
  )
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end)

  - ISNULL(ASS.ValorGlosa,0)

  - case when PMR.DescontarComissaoPagaAoSolicitante =1 then
		isnull(ASS.ValorComissaoSolicitante,0)
	else
		0
	end


  - case when pmr.ConsiderarDescontoDoAtendimento = 1 then isnull(ASS.ValorDescontoServico,0) else 0 end

  )
	* isnull(

case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorPercentoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorPercentoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorPercentoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorPercentoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorPercentoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorPercentoAmbulatorioRelacionado

end




,0)) / 100 )






-- aqui vou retirar o x% do valor da comissão

) / 100 ) * (100 -

isnull(
case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorDescontoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorDescontoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorDescontoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorDescontoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		isnull(PMR.ValorDescontoAmbulatorio,0)
		+ case when @FormaPagamento = 'CREDITO' then isnull(PMR.VPercDescontoCCreditoAmbulatorio,0) else 0  end
		+ case when @FormaPagamento = 'DEBITO' then isnull(PMR.VPercDescontoCDebitoAmbulatorio,0) else 0  end

	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorDescontoAmbulatorioRelacionado

end,0))

as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
left join Tab_AtendimentoServicoEquipe ASE on ASE.idAtendimentoServico = ass.idAtendimentoServico
	and ASE.RepasseCirurgiao = 1

where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0

),0)

print 'valorcomissao'
print @retorno


declare @valorComissao money

set @valorComissao = @retorno

update tab_atendimentoservico set ValorComissao = @retorno, idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse where idAtendimentoServico = @idAtendimentoServico


-- vou criar um if aqui
-- se foi pagamento no dinheiro pode pular
-- se foi cartao de credito e tem valor cadastrado en VPercDescontoCCreditoAmbulatorio, então pula também.
-- se foi cartao de debito e tem valor cadastrado em VPercDescontoCDebitoAmbulatorio, então pula também.



declare @DescontoTaxaCartao bit
set @DescontoTaxaCartao = (Select COUNT(*) from Cad_PrestadorMedicoRepasse where idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse and DescontarTaxaCartao = 1)

print '@DescontoTaxaCartao'
print @DescontoTaxaCartao

if @DescontoTaxaCartao = 1 begin

	if (select COUNT(*) from Fin_Receita where idAtendimento = @idAtendimento) > 0 begin

	  if (@retorno > 0) begin
		--declare @ValorDescontoCartao int
		declare @ValorPDescontoTotal money
		--set @ValorPDescontoTotal = (select ( Sum(ValorDevido)  / sum(ValorDevido - cast(ValorDesconto as decimal(9,2)))   ) - 1.0000  from Fin_Receita where idAtendimento = @idAtendimento)

		declare @DescontoOperadoraCartaoProporcional bit
		select @DescontoOperadoraCartaoProporcional =  DescontoOperadoraCartaoProporcional from cad_empresa

		if @DescontoOperadoraCartaoProporcional =1 begin
			set @ValorPDescontoTotal = (select  ((( sum(ValorDevido - cast(ValorDesconto as decimal(9,4))) / Sum(ValorDevido) ) - 1.0000 )  * -100.0000 )  from Fin_Receita where idAtendimento = @idAtendimento)
		end else begin
			select @idforma =
				case
					when (f1.ValorPDesconto >= isnull(f2.ValorPDesconto,0)) and (f1.ValorPDesconto >= isnull(F3.ValorPDesconto,0)) then F1.idForma
					when (f2.ValorPDesconto >= isnull(f3.ValorPDesconto,0)) and (f2.ValorPDesconto >= isnull(F1.ValorPDesconto,0)) then F2.idForma
					when (f3.ValorPDesconto >= isnull(f1.ValorPDesconto,0)) and (f3.ValorPDesconto >= isnull(F2.ValorPDesconto,0)) then F2.idForma
					else 0 end
				from tab_atendimento a
			left join fin_forma f1 on f1.idforma = a.idforma1 and f1.ValorPDesconto > 0
			left join fin_forma f2 on f2.idforma = a.idforma2 and f2.ValorPDesconto > 0
			left join fin_forma f3 on f3.idforma = a.idforma3 and f2.ValorPDesconto > 0
			where a.idAtendimento = @idAtendimento

			select @valorPDescontoTotal = valorPDesconto
			from fin_Forma where idforma = @idforma
		end
		print '@formaPagamento'
		print @formaPagamento
		print '@idforma'
		print @idforma

		PRINT '@idPrestadorMedicoRepasse'
		print @idPrestadorMedicoRepasse
		print '@ValorPDescontoTotal'
		print @ValorPDescontoTotal

		if isnull(@ValorPDescontoTotal,0) > 0 begin
			set @retorno = @retorno -  ( (@retorno * @ValorPDescontoTotal) / 100.00 )
		end
		print '@retorno'
		print @retorno

		set @valorComissao = @retorno


		--set @retorno = @ValorPDescontoTotal

		update tab_atendimentoservico set ValorComissao = @retorno where idAtendimentoServico = @idAtendimentoServico
	  end

	end
end

---- agora vou preparar o update do valorbasecomissao com o x%

declare @valorbasecomissao money
set @valorbasecomissao =


isnull((

select



max(cast(

-- os 2 (( aqui vou retirar o x% do valor da comissão
 ( (



( (
 (
  case
   when PC.TipoFaturamento = 1 then
	isnull(
		-- ASS.ValorTotalConvenio
		( ( ASS.ValorTotalConvenio  + ASS.ValorTotalCliente - ASS.PTVValM2FilmeTotal) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
		+
		( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  )
	,0)

   else 0
   end
  )
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end)

  - ISNULL(ASS.ValorGlosa,0)

  - case when pmr.ConsiderarDescontoDoAtendimento = 1 then isnull(ASS.ValorDescontoServico,0) else 0 end  )
	)






-- aqui vou retirar o x% do valor da comissão

) / 100 ) * (100 -

isnull(
case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorDescontoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorDescontoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorDescontoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorDescontoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		isnull(PMR.ValorDescontoAmbulatorio,0)
		+ case when @FormaPagamento = 'CREDITO' then isnull(PMR.VPercDescontoCCreditoAmbulatorio,0) else 0  end
		+ case when @FormaPagamento = 'DEBITO' then isnull(PMR.VPercDescontoCDebitoAmbulatorio,0) else 0  end
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorDescontoAmbulatorioRelacionado

end,0))

as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
left join Tab_AtendimentoServicoEquipe ASE on ASE.idAtendimentoServico = ass.idAtendimentoServico
	and ASE.RepasseCirurgiao = 1

where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0

),0)

print 'valorbasecomissao'
print @valorbasecomissao

update tab_atendimentoservico set valorbaseComissao = @valorbasecomissao where idAtendimentoServico = @idAtendimentoServico



	declare @idAtendimentoComissao int
	declare @idprestadorMedico int

	select @idAtendimentoComissao = isnull(idAtendimentoComissao,0),  @idPrestadorMedico = isnull(idprestadorMedico,0)
	from tab_Atendimentocomissao where idAtendimentoServico = @idAtendimentoServico and desativado =0 and Executante = 1
	--idFormaPagamento que tem a maior quantidade de parcelas usadas no pagamento feito pelo cliente
	select @idForma =
			case
				when isnull(F1.parcelas,1) >= isnull(F2.parcelas,1) and isnull(F1.parcelas, 1) >= isnull(F3.parcelas, 1) then
					F1.idForma
				when isnull(F2.parcelas,1) >= isnull(F3.parcelas,1) and isnull(F2.parcelas, 1) >= isnull(F1.parcelas, 1) then
					F2.idForma
				when isnull(F3.parcelas,1) >= isnull(F1.parcelas,1) and isnull(F3.parcelas, 1) >= isnull(F2.parcelas, 1) then
					F3.idForma
			end

	from tab_atendimento a
	join fin_forma f1 on f1.idforma = a.idforma1
	left join fin_forma f2 on f2.idforma = a.idforma2
	left join fin_forma f3 on f3.idforma = a.idforma3
	where a.idAtendimento = @idAtendimento


	--1.desativado todas as comissões do @idatendimentoservico
	update tab_Atendimentocomissao set desativado = 1 where idatendimentoservico = @idAtendimentoServico and Executante = 1

	print '@idforma'
	print @idforma
	print 'antes do insert tab_atendimentoComissao'
	print '@dataatendimento'
	print @dataatendimento

	--2. vou incluir a comissão que falta por exemplo parcela 2 e 3.
		declare @idconvenio int
		select @idconvenio = c.idConvenio from tab_atendimentoservico s
		join tab_atendimento a on a.idatendimento = s.idatendimento
		join cad_planoconvenio pc on pc.idPlanoConvenio = a.idPlanoConvenio
		join cad_convenio c on c.idconvenio = pc.idconvenio
		where s.idAtendimentoServico = @idatendimentoServico

		insert into Tab_AtendimentoComissao
		(DataVencimento, idAtendimento,idAtendimentoServico, DataHoraInclusao, idPrestadorMedicoRepasse,
		idPrestadorMedico, Executante, ValorComissao, ValorBaseComissao, teste,
		Parcela, idForma)
		select
			case
				when n.numero = 1 then                            DATEADD(day, isnull(isnull(f.DiasParaComissao, convenio.diasVencimentoRepasse), 0), @DataAtendimento)
				when n.numero > 1 then dateadd(month, n.numero-1, DATEADD(day, isnull(isnull(f.DiasParaComissao, convenio.diasVencimentoRepasse), 0), @DataAtendimento))
				else @DataAtendimento
			end
		,
		@idatendimento,
		@idAtendimentoServico, GETDATE(),
		@idPrestadorMedicoRepasse, PMR.idPrestadorMedico, 1,

		@valorComissao / f.Parcelas , @valorbasecomissao, @teste,
		n.Numero as Parcela,
		f.idForma

		from Cad_PrestadorMedicoRepasse PMR
		left join fin_forma f on f.idforma = @idforma
		left join cad_convenio convenio on convenio.idconvenio = @idconvenio
		join sis_numero n on n.numero >= 1 and n.numero <= isnull(f.Parcelas,1)
		left join tab_AtendimentoComissao comissao on
				comissao.idatendimentoservico = @idAtendimentoServico
				and isnull(comissao.Parcela,1) = n.numero
				and comissao.Executante = 1

		where pmr.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
		and comissao.idAtendimentoComissao is null

	-- agora vou fazer update nas parcelas que foram excluidas e não deveria, por exemplo parcela 1.
		update AC
		set AC.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse,
		ac.DataVencimento =
			case
				when n.numero = 1 then                            DATEADD(day, isnull(f.DiasParaComissao,0), @DataAtendimento)
				when n.numero > 1 then dateadd(month, n.numero-1, DATEADD(day, isnull(f.DiasParaComissao,0), @DataAtendimento))
				else @DataAtendimento
			end
		,

		AC.valorbaseComissao = @valorbasecomissao / isnull(f.Parcelas,1),
		AC.ValorComissao = @ValorComissao / isnull(f.Parcelas,1),
		AC.idprestadorMedico = pmr.idprestadorMedico,
		ac.Desativado = 0,
		teste = @teste,
		ac.Parcela = isnull(ac.Parcela,1),
		ac.idForma = f.idForma
		from Tab_AtendimentoComissao AC
		join Cad_PrestadorMedicoRepasse pmr on pmr.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
		left join fin_forma f on f.idforma = @idforma
		join sis_numero n on n.numero = isnull(ac.parcela, 1)
		where AC.idAtendimentoServico = @idAtendimentoServico
		and ac.executante = 1
		and @idPrestadorMedicoRepasse > 0




---- fim do update valor base comissao







end

 else
if
(select count(*) from vw_Cad_PrestadorMedicoRepasseMaterial where idPrestadorMedico = @idPrestadorMedicoRepasse and desativado =0 ) > 0 and
(select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idMaterialTussNomenclatura is not null) = 1 begin
	exec Proc_PrestadorMedico_GeraComissao_Material @idAtendimentoServico
end else
if
(select count(*) from vw_Cad_PrestadorMedicoRepasseMedicamento where idPrestadorMedico = @idPrestadorMedicoRepasse and desativado =0 ) > 0 and
(select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idMedicamentoTussNomenclatura is not null) = 1 begin
	exec Proc_PrestadorMedico_GeraComissao_Medicamento @idAtendimentoServico
end else
if
(select count(*) from vw_Cad_PrestadorMedicoRepasseTaxa where idPrestadorMedico = @idPrestadorMedicoRepasse and desativado =0 ) > 0 and
(select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idTaxaTussNomenclatura is not null) = 1 begin
	exec Proc_PrestadorMedico_GeraComissao_Taxa @idAtendimentoServico

end


/*
-- desativamos porque deu problema no total da Guia de Honorarios ao realizar a reducao de mesma via os valores calculados estao corretos
-- mas o valor total da guia esta totalmente errado,  se precisar retornar esse update TESTE COM O IDATENDIMENTO = 184042  do cotra.

declare @valorProcedimento money
select @valorProcedimento = (isnull(ValorTotalConvenio,0) + isnull(ValorTotalCliente,0)) from Tab_Atendimentoservico
where idatendimentoservico = @idAtendimentoServico

declare @PercentualCobranca money

select @PercentualCobranca = isnull(max(PercentualCobranca),0)
from Tab_atendimentoservico TAS
join Cad_ANSViaAcesso AVA on AVA.idViaAcesso = TAS.idViaAcesso
where TAS.idAtendimentoservico = @idAtendimentoServico

----set @ValorProcedimento = @ValorProcedimento * @PercentualCobranca / 100


----update ASEE
----Set
----ASEE.ValorCirurgiao = ( @valorProcedimento * Quantidade) ,
----ASEE.Valor1Auxiliar = ( @valorProcedimento * Quantidade) * 0.30,
----ASEE.Valor2Auxiliar = ( @valorProcedimento * Quantidade) * 0.20,
----ASEE.Valor3Auxiliar = ( @valorProcedimento * Quantidade) * 0.20,
----ASEE.Valor4Auxiliar = ( @valorProcedimento * Quantidade) * 0.20,
----ASEE.ValorInstrumentador = ( @valorProcedimento * Quantidade) * 0.10
----from Tab_AtendimentoServicoEquipe ASEE
----join Tab_AtendimentoServico ASE on ASE.idAtendimentoServico = ASEE.idAtendimentoServico
----where ASEE.idAtendimentoServico = @idAtendimentoServico
----and isnull(ASEE.ValorCirurgiao,0) = 0

*/


if (select count(*) from tab_atendimentoServico where idatendimento = @idAtendimento) = 1 begin
	--se a primeira forma de pagamento é dinheiro e tem uma segunda forma selecionada.
	if (select count(*) from tab_atendimento a
	join fin_forma f1 on f1.idforma = a.idforma1 and f1.dinheiro = 1
	where a.idatendimento = @idatendimento
	and a.idForma2 is not null
	) > 0 begin
		print 'vai entrar na comissão no dinheiro'
		exec PROC_PrestadorMedico_GeraComissao_Executante_Dinheiro @idAtendimentoServico
	end

end

print '@idPrestadorMedicoRepasse'
print @idPrestadorMedicoRepasse

return isnull(@retorno,0)
end
GO

ALTER proc [dbo].[PROC_PrestadorMedico_GeraComissao_Executante_Dinheiro]
	@idAtendimentoServico int
AS

BEGIN

declare @retorno money


declare @teste int

declare @idForma int


if ( (	select COUNT(*) from Tab_AtendimentoServico
		where idAtendimentoServico  = @idAtendimentoServico
		and isnull(idPlanoConvenioProcedimentoFator,0) = 0 ) <> -1 ) begin

	update TAS
	set TAS.ValorPDescontoProcedimento = isnull(isnull(PCPF.ValorPDEscontoProcedimento, isnull(EF.ValorPDEscontoProcedimento, E.ValorPDEscontoProcedimento)),0),
	TAS.ValorPDescontoFilme = isnull(isnull(PCPF.ValorPDescontoFilme, ISNULL(EF.ValorPDescontoFilme, E.ValorPDescontoFilme)),0)
	from tab_atendimentoservico TAS
	join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
	join Tab_ProcedimentoTabelaValor TTV on TTV.idProcedimentoTabelaValor = TAS.idProcedimentoTabelaValor
	left join Cad_PlanoConvenioProcedimento PCP on PCP.idProcedimentoTabelaValor = TTV.idProcedimentoTabelaValor and PCP.Desativado = 0 and PCP.idPlanoConvenioProcedimento = TAS.idPlanoConvenioProcedimento

	left join Cad_PlanoConvenioProcedimentoFator PCPF on PCPF.idPlanoConvenioProcedimento = PCP.idPlanoConvenioProcedimento
												and PCPF.idEmpresaFilial = isnull(A.idEmpresaFilial,0)
												and PCPF.Desativado = 0
	cross join Cad_Empresa e
	left join Cad_EmpresaFilial ef on ef.idempresaFilial = A.idEmpresaFilial

	where TAS.idAtendimentoServico = @idAtendimentoServico

	PRINT 'Desconto executado'
end



if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1
begin

declare @relacionado bit
set @relacionado = 	( select FaturamentoPercentualRelacionado from tab_atendimentoservico
			  where idatendimentoservico = @idAtendimentoServico
			)

declare @idPrestadorMedicoRepasse int

-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @teste = 1
set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)

	and PMR.Executante = 1
	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)





where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print @idPrestadorMedicoRepasse


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @teste = 2
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber),  a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- 3. testa? EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 3
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- 4. teste? EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 4
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)




	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- 5. testa? EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 5
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- 6. testa? EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 6
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- 7. testa? EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 7
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- 8. testa? procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @teste = 8
	set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- 9. testa? procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 9
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- 10. testa? procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 10
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber) , a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- 11. testa? procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 11
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- 12. testa? plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 12
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber), a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- 13. testa? unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 13
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber),  a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- 14. testa? (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 14
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = isnull(isnull(ass.idProfissionalRepasse, ass.idProfissionalquevaireceber),  a.idMedicoExecutante)
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end

print '@idPrestadorMedicoRepasse'
print @idPrestadorMedicoRepasse
print 'fim @idPrestadorMedicoRepasse'

declare @idAtendimento int
set @idatendimento = (Select max(idAtendimento) from Tab_AtendimentoServico where idAtendimentoServico = @idAtendimentoServico)

--declare @DiasParaComissao int
declare @FormaPagamento varchar(20)
declare @dataAtendimento datetime
select --@DiasParaComissao = f1.DiasParaComissao,
@dataAtendimento = a.DataAtendimento from Tab_Atendimento a join Fin_Forma f1 on f1.idForma = a.idForma1  where a.idAtendimento = @idAtendimento


set @formaPagamento = ''
declare @valorBaseComissaoDinheiro money
set @valorBaseComissaoDinheiro = null



if exists(select r.idReceita from fin_receita r join fin_forma f on f.idforma = r.idforma and f.Dinheiro = 1 where r.idAtendimento = @idAtendimento and r.desativado = 0) begin
	set @formaPagamento = 'DINHEIRO'
	select @valorBaseComissaoDinheiro = sum(r.valorDevido) from fin_Receita r join fin_forma f on f.idforma = r.idforma and f.Dinheiro = 1 where r.idAtendimento = @idAtendimento and r.desativado = 0
	print '@valorBaseComissaoDinheiro '
	print @valorBaseComissaoDinheiro 	
end

print @formapagamento

set @retorno =


isnull((

select



max(cast(

-- os 2 (( aqui vou retirar o x% do valor da comissão
 ( (


isnull(
case

	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 )
	then
		PMR.ValorComissaoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 )
	then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorComissaoInternacao

	when ( (sol.Emergencia = 1) and (@relacionado = 0) )   then
		PMR.ValorComissaoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorComissaoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorComissaoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorComissaoAmbulatorioRelacionado

end


,0)

+

( ( (
 (
  case
   when PC.TipoFaturamento = 1 then
	isnull(
		-- ASS.ValorTotalConvenio
		( (@valorBaseComissaoDinheiro       ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
		+
		( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  )
	,0)

   else 0
   end
  )
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(@valorBaseComissaoDinheiro,0)
	ELSE
	0
  end)

  - ISNULL(ASS.ValorGlosa,0)

  - case when PMR.DescontarComissaoPagaAoSolicitante =1 then
		ASS.ValorComissaoSolicitante
	else
		0
	end


  -- - case when pmr.ConsiderarDescontoDoAtendimento = 1 then isnull(ASS.ValorDescontoServico,0) else 0 end

  )
	* isnull(

case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorPercentoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorPercentoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorPercentoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorPercentoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorPercentoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorPercentoAmbulatorioRelacionado

end




,0)) / 100 )






-- aqui vou retirar o x% do valor da comissão

) / 100 ) * (100 -

isnull(
case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorDescontoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorDescontoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorDescontoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorDescontoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		isnull(PMR.ValorDescontoAmbulatorio,0)
		+ case when @FormaPagamento = 'CREDITO' then isnull(PMR.VPercDescontoCCreditoAmbulatorio,0) else 0  end
		+ case when @FormaPagamento = 'DEBITO' then isnull(PMR.VPercDescontoCDebitoAmbulatorio,0) else 0  end

	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorDescontoAmbulatorioRelacionado

end,0))

as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	and PMR.Executante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
left join Tab_AtendimentoServicoEquipe ASE on ASE.idAtendimentoServico = ass.idAtendimentoServico
	and ASE.RepasseCirurgiao = 1

where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0

),0)

print @retorno


declare @valorComissao money

set @valorComissao = @retorno

print '@idAtendimentoServico'
print @idAtendimentoServico
update tab_atendimentoservico set ValorComissao = @retorno, idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse where idAtendimentoServico = @idAtendimentoServico



return isnull(@retorno,0)
end
end
GO

-- 07/05/2024 18:27
CREATE   proc [dbo].[PROC_PrestadorMedico_GeraComissao_Material]
	@idAtendimentoServico int
AS
BEGIN
--exec  PROC_PrestadorMedico_GeraComissao_Material 7721
--select valorcomissao, valortotalconvenio,* from tab_atendimentoservico
--where idatendimentoservico = 7721
--update tab_atendimentoservico
--set valorcomissao = 0
--where idatendimentoservico = 7721
-- teste janderson


-- primeiro tenho que saber qual será o registro da tabela Cad_PrestadorMedicoRepasse
-- JANDERSON 19/12/2017 17
--- JANDERSON 02/08/2018 correção da comissão, considerando valorglosa.





declare @retorno money

declare @teste int

if (
	select COUNT(*) 
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.EMaterial = 1 and PMR.Desativado = 0
	where ass.idAtendimentoServico = @idAtendimentoServico
) = 0 begin
	
	set @retorno = 0

end else begin



declare @idPrestadorMedicoRepasse int
set @teste = 1
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMaterialtussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idMaterialTussNomenclatura = ass.idMaterialTussNomenclatura
	and PMR.idPlanoConvenio = pa.idPlanoConvenio
	)

if @idPrestadorMedicoRepasse is null begin
set @teste = 2
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMaterialtussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idMaterialTussNomenclatura = ass.idMaterialTussNomenclatura
	and PMR.idPlanoConvenio is null
	)

end

if @idPrestadorMedicoRepasse is null begin
set @teste = 3
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMaterialtussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	--and PMR.idMaterialTussNomenclatura = ass.idMaterialTussNomenclatura
	and PMR.idPlanoConvenio = pa.idPlanoConvenio
	)
end


if @idPrestadorMedicoRepasse is null begin
set @teste = 4
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMaterialtussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idMaterialTussNomenclatura is null
	and PMR.idPlanoConvenio is null
	)

end





declare @relacionado bit
set @relacionado = 	( select FaturamentoPercentualRelacionado from tab_atendimentoservico
			  where idatendimentoservico = @idAtendimentoServico
			)

--set @relacionado = 0



-- vou ter que buscar o retorno 2 vezes.
-- a primeira buscando um registro especifico pelo idprocedimentotussnomenclatura e outro no geral caso o primeiro nao retorne nada.

--print 'IDPRESTADORMEDICOREPASSE ' + cast( @idPrestadorMedicoRepasse as varchar)


set @retorno = isnull((



select max(cast( isnull(
case 	
	when (a.Internacao = 1 ) then
		PMR.ValorComissaoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorComissaoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorComissaoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorComissaoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorComissaoAmbulatorioRelacionado

end


,0)

+

( ( (isnull(ASS.ValorTotalConvenio,0) + isnull(ASS.ValorTotalCliente,0)   - ISNULL(ASS.ValorGlosa,0) - ISNULL(PMR.ValorComissaoDesconto,0) )
	* isnull(

case 	
	when (a.Internacao = 1 ) then
		PMR.ValorPercentoInternacao
	
	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorPercentoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorPercentoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorPercentoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorPercentoAmbulatorioRelacionado

end



,0)) / 100 )


as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join Tab_MaterialMedicamentoTussNomenclatura MMTN
	on MMTN.idMaterialMedicamentoTussNomenclatura = idMaterialtussNomenclatura

join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse

join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao

where
ASS.idAtendimentoServico = @idAtendimentoServico
and PMR.Desativado = 0
and ass.idMaterialTussNomenclatura is not null


),0)



--print  cast(@retorno as varchar)



end

update tab_atendimentoservico set ValorComissao = @retorno where idAtendimentoServico = @idAtendimentoServico and idMaterialTussNomenclatura is not null


	declare @valorcomissao money
	set @valorcomissao = @retorno

	declare @idAtendimentoComissao int
	declare @idprestadorMedico int

	select @idAtendimentoComissao = isnull(idAtendimentoComissao,0),  @idPrestadorMedico = isnull(idprestadorMedico,0) from tab_Atendimentocomissao where idAtendimentoServico = @idAtendimentoServico and desativado =0 and Executante = 1
	
	if isnull(@idAtendimentoComissao,0) = 0 -- se não encontrou então vai incluir.
		insert into Tab_AtendimentoComissao
		(idAtendimentoServico, DataHoraInclusao, idPrestadorMedicoRepasse, idPrestadorMedico, Executante, ValorComissao, teste)
		select @idAtendimentoServico, GETDATE(), @idPrestadorMedicoRepasse, idPrestadorMedico, 1, @valorComissao, @teste
		from Cad_PrestadorMedicoRepasse where idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	else
		update AC
		set AC.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse,
		AC.ValorComissao = @ValorComissao,
		AC.idprestadorMedico = @idprestadorMedico,
		Desativado = 0,
		teste = @teste
		from Tab_AtendimentoComissao AC 
		where AC.idAtendimentoComissao = @idAtendimentoComissao


exec PROC_PrestadorMedico_GeraComissao_Material_Auxiliar @idAtendimentoServico

return @retorno

end
GO

ALTER proc [dbo].[PROC_PrestadorMedico_GeraComissao_Material_Auxiliar]
	@idAtendimentoServico int
AS
BEGIN
--exec  PROC_PrestadorMedico_GeraComissao_Material 7721
--select valorcomissao, valortotalconvenio,* from tab_atendimentoservico
--where idatendimentoservico = 7721
--update tab_atendimentoservico
--set valorcomissao = 0
--where idatendimentoservico = 7721
-- teste janderson


-- primeiro tenho que saber qual será o registro da tabela Cad_PrestadorMedicoRepasse
-- JANDERSON 19/12/2017 17
--- JANDERSON 02/08/2018 correção da comissão, considerando valorglosa.





declare @retorno money

declare @teste int

if (
	select COUNT(*) 
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber 
	and PMR.EMaterial = 1 and PMR.Desativado = 0
	where ass.idAtendimentoServico = @idAtendimentoServico
	and ass.idMaterialTussNomenclatura is not null
) = 0 begin
	
	set @retorno = 0

end else begin



declare @idPrestadorMedicoRepasse int
set @teste = 1
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMaterialtussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = idProfissionalAuxiliarVaiReceber and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idMaterialTussNomenclatura = ass.idMaterialTussNomenclatura
	and PMR.idPlanoConvenio = pa.idPlanoConvenio
	)

if @idPrestadorMedicoRepasse is null begin
set @teste = 2
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMaterialtussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idMaterialTussNomenclatura = ass.idMaterialTussNomenclatura
	and PMR.idPlanoConvenio is null
	)

end

if @idPrestadorMedicoRepasse is null begin
set @teste = 3
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMaterialtussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	--and PMR.idMaterialTussNomenclatura = ass.idMaterialTussNomenclatura
	and PMR.idPlanoConvenio = pa.idPlanoConvenio
	)
end


if @idPrestadorMedicoRepasse is null begin
set @teste = 4
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMaterialtussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idMaterialTussNomenclatura is null
	and PMR.idPlanoConvenio is null
	)

end


print '@idPrestadorMedicoRepasse' 
print @idPrestadorMedicoRepasse

declare @idAtendimento int
set @idatendimento = (Select max(idAtendimento) 
from Tab_AtendimentoServico 
where idAtendimentoServico = @idAtendimentoServico)



declare @relacionado bit
set @relacionado = 	( select FaturamentoPercentualRelacionado from tab_atendimentoservico
			  where idatendimentoservico = @idAtendimentoServico
			)

--set @relacionado = 0



-- vou ter que buscar o retorno 2 vezes.
-- a primeira buscando um registro especifico pelo idprocedimentotussnomenclatura e outro no geral caso o primeiro nao retorne nada.

--print 'IDPRESTADORMEDICOREPASSE ' + cast( @idPrestadorMedicoRepasse as varchar)


set @retorno = isnull((



select max(cast( isnull(
case 	
	when (a.Internacao = 1 ) then
		PMR.ValorComissaoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorComissaoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorComissaoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorComissaoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorComissaoAmbulatorioRelacionado

end


,0)

+

( ( (isnull(ASS.ValorTotalConvenio,0) + isnull(ASS.ValorTotalCliente,0)   - ISNULL(ASS.ValorGlosa,0) - ISNULL(PMR.ValorComissaoDesconto,0) )
	* isnull(

case 	
	when (a.Internacao = 1 ) then
		PMR.ValorPercentoInternacao
	
	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorPercentoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorPercentoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorPercentoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorPercentoAmbulatorioRelacionado

end



,0)) / 100 )


as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join Tab_MaterialMedicamentoTussNomenclatura MMTN
	on MMTN.idMaterialMedicamentoTussNomenclatura = idMaterialtussNomenclatura

join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse

join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao

where
ASS.idAtendimentoServico = @idAtendimentoServico
and PMR.Desativado = 0
and ass.idMaterialTussNomenclatura is not null


),0)



--print  cast(@retorno as varchar)

print 'entrou aqui'




	declare @valorcomissao money
	set @valorcomissao = @retorno

	declare @idAtendimentoComissao int
	declare @idprestadorMedico int

	select @idAtendimentoComissao = isnull(idAtendimentoComissao,0),  
	@idPrestadorMedico = isnull(idprestadorMedico,0) 
	from tab_Atendimentocomissao 
	where idAtendimentoServico = @idAtendimentoServico 
	and desativado =0 and Auxiliar = 1
	
	print '@idatendimentocomissao'
	print @idatendimentocomissao
	if isnull(@idAtendimentoComissao,0) = 0 begin -- se não encontrou então vai incluir.
		print 'vai fazer insert'
		insert into Tab_AtendimentoComissao
		(idatendimento, idAtendimentoServico, DataHoraInclusao, idPrestadorMedicoRepasse, idPrestadorMedico, Auxiliar, ValorComissao, teste)
		select @idatendimento, @idAtendimentoServico, GETDATE(), @idPrestadorMedicoRepasse, idPrestadorMedico, 1, @valorComissao, @teste
		from Cad_PrestadorMedicoRepasse where idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	end else begin
		print 'vai fazer update'
		update AC
		set AC.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse,
		AC.ValorComissao = @ValorComissao,
		AC.idprestadorMedico = @idprestadorMedico,
		Desativado = 0,
		teste = @teste,
		ac.idAtendimento = @idatendimento,
		ac.auxiliar = 1,
		ac.DataVencimento = a.DataAtendimento
			
				
		from Tab_AtendimentoComissao AC 
		join Tab_Atendimento a on a.idAtendimento = ac.idAtendimento
		where AC.idAtendimentoComissao = @idAtendimentoComissao
	end
end

return @retorno

end
GO

ALTER   proc [dbo].[PROC_PrestadorMedico_GeraComissao_Medicamento]
	@idAtendimentoServico int
AS
BEGIN
--exec  PROC_PrestadorMedico_GeraComissao_Material 7721
--select valorcomissao, valortotalconvenio,* from tab_atendimentoservico
--where idatendimentoservico = 7721
--update tab_atendimentoservico
--set valorcomissao = 0
--where idatendimentoservico = 7721
-- teste janderson


-- primeiro tenho que saber qual será o registro da tabela Cad_PrestadorMedicoRepasse

-- JANDERSON 19/12/2017 17
--- JANDERSON 02/08/2018 correção da comissão, considerando valorglosa.



declare @retorno money


declare @teste int

if (
	select COUNT(*) 
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.Emedicamento = 1 and PMR.Desativado = 0
	where ass.idAtendimentoServico = @idAtendimentoServico
) = 0 begin
	
	set @retorno = 0

end else begin



declare @idPrestadorMedicoRepasse int
set @teste = 1
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMedicamentotussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idMedicamentoTussNomenclatura = ass.idMedicamentoTussNomenclatura
	and PMR.idPlanoConvenio = pa.idPlanoConvenio
	)

if @idPrestadorMedicoRepasse is null begin
set @teste = 2
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMedicamentotussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idMedicamentoTussNomenclatura = ass.idMedicamentoTussNomenclatura
	and PMR.idPlanoConvenio is null
	)

end


if @idPrestadorMedicoRepasse is null begin
	set @teste = 3
	set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMedicamentotussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
--	and PMR.idMedicamentoTussNomenclatura = ass.idMedicamentoTussNomenclatura
	and PMR.idPlanoConvenio = pa.idPlanoConvenio
	)


end 

if @idPrestadorMedicoRepasse is null begin
	set @teste = 4
	set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_MaterialMedicamentoTussNomenclatura MMTN on MMTN.idMaterialMedicamentoTussNomenclatura = idMedicamentotussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.EMaterial = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idMedicamentoTussNomenclatura is null
	and PMR.idPlanoConvenio is null
	)

end



--declare @retorno money


declare @relacionado bit
set @relacionado = 	( select FaturamentoPercentualRelacionado from tab_atendimentoservico
			  where idatendimentoservico = @idAtendimentoServico
			)

--set @relacionado = 0



-- vou ter que buscar o retorno 2 vezes.
-- a primeira buscando um registro especifico pelo idprocedimentotussnomenclatura e outro no geral caso o primeiro nao retorne nada.
set @retorno = isnull((



select max(cast( isnull(

case 	
	when (a.Internacao = 1 ) then
		PMR.ValorComissaoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorComissaoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorComissaoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorComissaoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorComissaoAmbulatorioRelacionado

end


,0)

+

( ( (isnull(ASS.ValorTotalConvenio,0) + isnull(ASS.ValorTotalCliente,0)  - ISNULL(ASS.ValorGlosa,0) - ISNULL(PMR.ValorComissaoDesconto,0)  )
	* isnull(

case 	
	when (a.Internacao = 1 ) then
		PMR.ValorPercentoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorPercentoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorPercentoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorPercentoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorPercentoAmbulatorioRelacionado

end



,0)) / 100 )


as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join Tab_MaterialMedicamentoTussNomenclatura MMTN
	on MMTN.idMaterialMedicamentoTussNomenclatura = idMedicamentotussNomenclatura

join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse

join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao

where
ASS.idAtendimentoServico = @idAtendimentoServico
and PMR.Desativado = 0
and ass.idMedicamentoTussNomenclatura is not null


),0)




--print  cast(@retorno as varchar)



end
update tab_atendimentoservico set ValorComissao = @retorno where idAtendimentoServico = @idAtendimentoServico


	declare @valorcomissao money
	set @valorcomissao = @retorno

	declare @idAtendimentoComissao int
	declare @idprestadorMedico int

	select @idAtendimentoComissao = isnull(idAtendimentoComissao,0),  @idPrestadorMedico = isnull(idprestadorMedico,0) from tab_Atendimentocomissao where idAtendimentoServico = @idAtendimentoServico and desativado =0 and Executante = 1
	
	if isnull(@idAtendimentoComissao,0) = 0 -- se não encontrou então vai incluir.
		insert into Tab_AtendimentoComissao
		(idAtendimentoServico, DataHoraInclusao, idPrestadorMedicoRepasse, idPrestadorMedico, Executante, ValorComissao, teste)
		select @idAtendimentoServico, GETDATE(), @idPrestadorMedicoRepasse, idPrestadorMedico, 1, @valorComissao, @teste
		from Cad_PrestadorMedicoRepasse where idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	else
		update AC
		set AC.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse,
		AC.ValorComissao = @ValorComissao,
		AC.idprestadorMedico = @idprestadorMedico,
		Desativado = 0,
		teste = @teste
		from Tab_AtendimentoComissao AC 
		where AC.idAtendimentoComissao = @idAtendimentoComissao





return @retorno

end
GO

ALTER proc [dbo].[PROC_PrestadorMedico_GeraComissao_Procedimento_Auxiliar]
	@idAtendimentoServico int
AS
BEGIN

declare @retorno money

declare @teste int

declare @idForma int


if (select count(*) from tab_atendimentoservico 
where idatendimentoservico = @idatendimentoservico 
and idProcedimentoTussNomenclatura is not null 
and idProfissionalAuxiliarVaiReceber is not null ) = 1
begin

declare @relacionado bit
set @relacionado = 	( select FaturamentoPercentualRelacionado from tab_atendimentoservico
			  where idatendimentoservico = @idAtendimentoServico
			)

declare @idPrestadorMedicoRepasse int

-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. Testa? Empresa, procedimento, unidade
-- 4. testa? Empresa, procedimento
-- 5. teste? Empresa, unidade.

-- 6. Testa? Procedimento, unidade,plano
-- 7. Testa? procedimento, plano
-- 8. Testa? procedimento, unidade
-- 9. testa? procedimento
-- 10. teste? unidade.
-- 11. teste? todo


-- 1. Testa? Empresa, Procedimento, unidade,plano
set @teste = 1
set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and PMR.Executante = 1
	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)





where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print isnull(@idPrestadorMedicoRepasse,0)


-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @teste = 2
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse

-- 3. testa? EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 3
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- 4. teste? EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 4
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)




	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse


-- 5. testa? EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 5
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse


-- 6. testa? EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 6
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)



	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- 7. testa? EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 7
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.
-- 8. testa? procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
	set @teste = 8
	set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse


-- 9. testa? procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 9
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse

-- 10. testa? procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 10
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- 11. testa? procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 11
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse


-- 12. testa? plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 12
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)
end
print @idPrestadorMedicoRepasse


-- 13. testa? unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 13
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- 14. testa? (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 14
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end

print '@idPrestadorMedicoRepasse'
print @idPrestadorMedicoRepasse
print 'fim @idPrestadorMedicoRepasse'

declare @idAtendimento int
set @idatendimento = (Select max(idAtendimento) 
from Tab_AtendimentoServico 
where idAtendimentoServico = @idAtendimentoServico)

--declare @DiasParaComissao int
declare @FormaPagamento varchar(20)
declare @dataAtendimento datetime
select --@DiasParaComissao = f1.DiasParaComissao,
@dataAtendimento = a.DataAtendimento from Tab_Atendimento a where a.idAtendimento = @idAtendimento



if exists(select r.idReceita from fin_receita r join fin_forma f on f.idforma = r.idforma and f.CartaoCredito = 1 where r.idAtendimento = @idAtendimento)
	set @formaPagamento = 'CREDITO'
else
if exists(select r.idReceita from fin_receita r join fin_forma f on f.idforma = r.idforma and f.CartaoDebito = 1 where r.idAtendimento = @idAtendimento)
	set @formaPagamento = 'DEBITO'
else
	set @formaPagamento = 'DINHEIRO'


print @formapagamento

set @retorno =


isnull((

select



max(cast(

-- os 2 (( aqui vou retirar o x% do valor da comissão
 ( (


isnull(
case

	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 )
	then
		PMR.ValorComissaoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 )
	then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorComissaoInternacao

	when ( (sol.Emergencia = 1) and (@relacionado = 0) )   then
		PMR.ValorComissaoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorComissaoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorComissaoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorComissaoAmbulatorioRelacionado

end


,0)

+

( ( (
 (
  case
   when PC.TipoFaturamento = 1 then
	isnull(
		-- ASS.ValorTotalConvenio
		( ( ASS.ValorTotalConvenio  + ASS.ValorTotalCliente - ASS.PTVValM2FilmeTotal       ) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
		+
		( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  )
	,0)

   else 0
   end
  )
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end)

  - ISNULL(ASS.ValorGlosa,0)

  - case when PMR.DescontarComissaoPagaAoSolicitante =1 then
		ASS.ValorComissaoSolicitante
	else
		0
	end


  - case when pmr.ConsiderarDescontoDoAtendimento = 1 then isnull(ASS.ValorDescontoServico,0) else 0 end

  )
	* isnull(

case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorPercentoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorPercentoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorPercentoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorPercentoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorPercentoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorPercentoAmbulatorioRelacionado

end




,0)) / 100 )






-- aqui vou retirar o x% do valor da comissão

) / 100 ) * (100 -

isnull(
case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorDescontoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorDescontoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorDescontoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorDescontoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		isnull(PMR.ValorDescontoAmbulatorio,0)
		+ case when @FormaPagamento = 'CREDITO' then isnull(PMR.VPercDescontoCCreditoAmbulatorio,0) else 0  end
		+ case when @FormaPagamento = 'DEBITO' then isnull(PMR.VPercDescontoCDebitoAmbulatorio,0) else 0  end

	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorDescontoAmbulatorioRelacionado

end,0))

as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
left join Tab_AtendimentoServicoEquipe ASE on ASE.idAtendimentoServico = ass.idAtendimentoServico
	and ASE.RepasseCirurgiao = 1

where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0

),0)

print @retorno


declare @valorComissao money

set @valorComissao = @retorno

--update tab_atendimentoservico set ValorComissao = @retorno, idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse where idAtendimentoServico = @idAtendimentoServico


-- vou criar um if aqui
-- se foi pagamento no dinheiro pode pular
-- se foi cartao de credito e tem valor cadastrado en VPercDescontoCCreditoAmbulatorio, então pula também.
-- se foi cartao de debito e tem valor cadastrado em VPercDescontoCDebitoAmbulatorio, então pula também.



declare @DescontoTaxaCartao bit
set @DescontoTaxaCartao = (Select COUNT(*) from Cad_PrestadorMedicoRepasse where idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse and DescontarTaxaCartao = 1)

print '@DescontoTaxaCartao'
print @DescontoTaxaCartao

if @DescontoTaxaCartao = 1 begin

	if (select COUNT(*) from Fin_Receita where idAtendimento = @idAtendimento) > 0 begin

	  if (@retorno > 0) begin
		--declare @ValorDescontoCartao int
		declare @ValorPDescontoTotal money
		--set @ValorPDescontoTotal = (select ( Sum(ValorDevido)  / sum(ValorDevido - cast(ValorDesconto as decimal(9,2)))   ) - 1.0000  from Fin_Receita where idAtendimento = @idAtendimento)

		declare @DescontoOperadoraCartaoProporcional bit
		select @DescontoOperadoraCartaoProporcional =  DescontoOperadoraCartaoProporcional from cad_empresa

		if @DescontoOperadoraCartaoProporcional =1 begin
			set @ValorPDescontoTotal = (select  ((( sum(ValorDevido - cast(ValorDesconto as decimal(9,4))) / Sum(ValorDevido) ) - 1.0000 )  * -100.0000 )  from Fin_Receita where idAtendimento = @idAtendimento)
		end else begin
			select @idforma =
				case
					when (f1.ValorPDesconto >= isnull(f2.ValorPDesconto,0)) and (f1.ValorPDesconto >= isnull(F3.ValorPDesconto,0)) then F1.idForma
					when (f2.ValorPDesconto >= isnull(f3.ValorPDesconto,0)) and (f2.ValorPDesconto >= isnull(F1.ValorPDesconto,0)) then F2.idForma
					when (f3.ValorPDesconto >= isnull(f1.ValorPDesconto,0)) and (f3.ValorPDesconto >= isnull(F2.ValorPDesconto,0)) then F2.idForma
					else 0 end
				from tab_atendimento a
			left join fin_forma f1 on f1.idforma = a.idforma1 and f1.ValorPDesconto > 0
			left join fin_forma f2 on f2.idforma = a.idforma2 and f2.ValorPDesconto > 0
			left join fin_forma f3 on f3.idforma = a.idforma3 and f2.ValorPDesconto > 0
			where a.idAtendimento = @idAtendimento

			select @valorPDescontoTotal = valorPDesconto
			from fin_Forma where idforma = @idforma
		end
		print '@formaPagamento'
		print @formaPagamento
		print '@idforma'
		print @idforma

		PRINT '@idPrestadorMedicoRepasse'
		print @idPrestadorMedicoRepasse
		print '@ValorPDescontoTotal'
		print @ValorPDescontoTotal

		if isnull(@ValorPDescontoTotal,0) > 0 begin
			set @retorno = @retorno -  ( (@retorno * @ValorPDescontoTotal) / 100.00 )
		end
		print '@retorno'
		print @retorno

		set @valorComissao = @retorno


		--set @retorno = @ValorPDescontoTotal

--		update tab_atendimentoservico set ValorComissao = @retorno where idAtendimentoServico = @idAtendimentoServico
	  end

	end
end

---- agora vou preparar o update do valorbasecomissao com o x%

declare @valorbasecomissao money
set @valorbasecomissao =


isnull((

select



max(cast(

-- os 2 (( aqui vou retirar o x% do valor da comissão
 ( (



( (
 (
  case
   when PC.TipoFaturamento = 1 then
	isnull(
		-- ASS.ValorTotalConvenio
		( ( ASS.ValorTotalConvenio  + ASS.ValorTotalCliente - ASS.PTVValM2FilmeTotal) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
		+
		( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  )
	,0)

   else 0
   end
  )
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end)

  - ISNULL(ASS.ValorGlosa,0)

  - case when pmr.ConsiderarDescontoDoAtendimento = 1 then isnull(ASS.ValorDescontoServico,0) else 0 end  )
	)






-- aqui vou retirar o x% do valor da comissão

) / 100 ) * (100 -

isnull(
case
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorDescontoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorDescontoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorDescontoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorDescontoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		isnull(PMR.ValorDescontoAmbulatorio,0)
		+ case when @FormaPagamento = 'CREDITO' then isnull(PMR.VPercDescontoCCreditoAmbulatorio,0) else 0  end
		+ case when @FormaPagamento = 'DEBITO' then isnull(PMR.VPercDescontoCDebitoAmbulatorio,0) else 0  end
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorDescontoAmbulatorioRelacionado

end,0))

as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = ass.idProfissionalAuxiliarVaiReceber

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
left join Tab_AtendimentoServicoEquipe ASE on ASE.idAtendimentoServico = ass.idAtendimentoServico
	and ASE.RepasseCirurgiao = 1

where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0

),0)

print '@valorbasecomissao'
print @valorbasecomissao

update tab_atendimentoservico set valorbaseComissao = @valorbasecomissao where idAtendimentoServico = @idAtendimentoServico



	declare @idAtendimentoComissao int
	declare @idprestadorMedico int
	select @idPrestadorMedico= idProfissionalAuxiliarVaiReceber 
	from Tab_AtendimentoServico where idAtendimentoServico = @idAtendimentoServico
	
	
	print '@idPrestadorMedico'
	print @idPrestadorMedico
	
	select @idAtendimentoComissao = isnull(idAtendimentoComissao,0)
	from tab_Atendimentocomissao where idAtendimentoServico = @idAtendimentoServico and desativado =0 
	and idPrestadorMedico = @idPrestadorMedico
	--idFormaPagamento que tem a maior quantidade de parcelas usadas no pagamento feito pelo cliente
	select @idForma =
			case
				when isnull(F1.parcelas,1) >= isnull(F2.parcelas,1) and isnull(F1.parcelas, 1) >= isnull(F3.parcelas, 1) then
					F1.idForma
				when isnull(F2.parcelas,1) >= isnull(F3.parcelas,1) and isnull(F2.parcelas, 1) >= isnull(F1.parcelas, 1) then
					F2.idForma
				when isnull(F3.parcelas,1) >= isnull(F1.parcelas,1) and isnull(F3.parcelas, 1) >= isnull(F2.parcelas, 1) then
					F3.idForma
			end

	from tab_atendimento a
	LEFT join fin_forma f1 on f1.idforma = a.idforma1
	left join fin_forma f2 on f2.idforma = a.idforma2
	left join fin_forma f3 on f3.idforma = a.idforma3
	where a.idAtendimento = @idAtendimento


	--1.desativado todas as comissões do @idatendimentoservico
	update tab_Atendimentocomissao set desativado = 1 where idatendimentoservico = @idAtendimentoServico and Auxiliar = 1
		print '@idforma'
		print @idforma
		print 'vai fazer o insert'
	--2. vou incluir a comissão que falta por exemplo parcela 2 e 3.
		insert into Tab_AtendimentoComissao
		(idatendimento, DataVencimento, idAtendimentoServico, DataHoraInclusao, idPrestadorMedicoRepasse, idPrestadorMedico, Auxiliar,
		ValorComissao, ValorBaseComissao, teste,
		Parcela, idForma)
		select
			@idAtendimento,
			case
				when n.numero = 1 then                            DATEADD(day, isnull(f.DiasParaComissao,0), @DataAtendimento)
				when n.numero > 1 then dateadd(month, n.numero-1, DATEADD(day, isnull(f.DiasParaComissao,0), @DataAtendimento))
				else @DataAtendimento
			end
		,
		@idAtendimentoServico, GETDATE(),
		@idPrestadorMedicoRepasse, PMR.idPrestadorMedico, 1,

		@valorComissao / f.Parcelas , @valorbasecomissao, @teste,
		n.Numero as Parcela,
		f.idForma

		from Cad_PrestadorMedicoRepasse PMR
		left join fin_forma f on f.idforma = @idforma
		join sis_numero n on n.numero >= 1 and n.numero <= isnull(f.Parcelas,1)
		left join tab_AtendimentoComissao comissao on
				comissao.idatendimentoservico = @idAtendimentoServico
				and isnull(comissao.Parcela,1) = n.numero
				and comissao.Auxiliar = 1

		where pmr.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
		and comissao.idAtendimentoComissao is null

	-- agora vou fazer update nas parcelas que foram excluidas e não deveria, por exemplo parcela 1.
	print '@dataatendimento'
	print @dataatendimento
	
		update AC
		set AC.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse,
		ac.DataVencimento =
			case
				when n.numero = 1 then                            DATEADD(day, isnull(f.DiasParaComissao,0), @DataAtendimento)
				when n.numero > 1 then dateadd(month, n.numero-1, DATEADD(day, isnull(f.DiasParaComissao,0), @DataAtendimento))
				else @DataAtendimento
			end
		,

		AC.valorbaseComissao = @valorbasecomissao / isnull(f.Parcelas,1),
		AC.ValorComissao = @ValorComissao / isnull(f.Parcelas,1),
		AC.idprestadorMedico = pmr.idprestadorMedico,
		ac.Desativado = 0,
		teste = @teste,
		ac.Parcela = isnull(ac.Parcela,1),
		ac.idForma = f.idForma,
		AC.idAtendimento = @idAtendimento
		from Tab_AtendimentoComissao AC
		join Cad_PrestadorMedicoRepasse pmr on pmr.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
		left join fin_forma f on f.idforma = @idforma
		join sis_numero n on n.numero = isnull(ac.parcela, 1)
		where AC.idAtendimentoServico = @idAtendimentoServico
		and ac.Auxiliar=1


---- fim do update valor base comissao


end



return isnull(@retorno,0)
end
GO

-- 01/04/2024 23:50
CREATE proc [dbo].[PROC_PrestadorMedico_GeraComissao_Procedimento_Solicitante]
	@idAtendimentoServico int
AS
-- 01/04/2024 - janderson e gustavo, condição para registro ficar com desativado = 1
-- JANDERSON 19/12/2017
-- JANDERSON 19/12/2017 17
-- JANDERSON 21/01/2019
-- acrescentei na procedure as regras de verificação do grupo de procedimento. que não existia, e nas condições que testa todos os planos, unidades, acrescentei para verificar todos os grupos
BEGIN

declare @teste int

declare @retorno money


if ( (	select COUNT(*) from Tab_AtendimentoServico
		where idAtendimentoServico  = @idAtendimentoServico 
		and isnull(idPlanoConvenioProcedimentoFator,0) = 0 ) <> -1 ) begin
	
	update TAS
	set TAS.ValorPDescontoProcedimento = isnull(isnull(PCPF.ValorPDEscontoProcedimento, isnull(EF.ValorPDEscontoProcedimento, E.ValorPDEscontoProcedimento)),0),
	TAS.ValorPDescontoFilme = isnull(isnull(PCPF.ValorPDescontoFilme, ISNULL(EF.ValorPDescontoFilme, E.ValorPDescontoFilme)),0)
	from tab_atendimentoservico TAS 
	join Tab_Atendimento A on A.idAtendimento = TAS.idAtendimento
	join Tab_ProcedimentoTabelaValor TTV on TTV.idProcedimentoTabelaValor = TAS.idProcedimentoTabelaValor
	left join Cad_PlanoConvenioProcedimento PCP on PCP.idProcedimentoTabelaValor = TTV.idProcedimentoTabelaValor and PCP.Desativado = 0 and PCP.idPlanoConvenioProcedimento = TAS.idPlanoConvenioProcedimento

	left join Cad_PlanoConvenioProcedimentoFator PCPF on PCPF.idPlanoConvenioProcedimento = PCP.idPlanoConvenioProcedimento
												and PCPF.idEmpresaFilial = isnull(A.idEmpresaFilial,0)
												and PCPF.Desativado = 0
	cross join Cad_Empresa e
	left join Cad_EmpresaFilial ef on ef.idempresaFilial = A.idEmpresaFilial
	
	where TAS.idAtendimentoServico = @idAtendimentoServico											
	
	PRINT 'Desconto executado'
end



if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1 
begin

declare @relacionado bit
set @relacionado = 	( select FaturamentoPercentualRelacionado from tab_atendimentoservico
			  where idatendimentoservico = @idAtendimentoServico
			)

declare @idPrestadorMedicoRepasse int


-- 1. Testa? Empresa, Procedimento, unidade,plano
-- 2. Testa? Empresa, procedimento, plano
-- 3. testa? EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
-- 4. testa? EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
-- 5. Testa? Empresa, grupo, unidade,plano, procedimento todos.
-- 6. Testa? Empresa, grupo, plano, procedimento todos.
-- 7. testa? EMPRESA, grupo selecionado, unidade selecionado, (plano todos) (procedimento todos)
-- 8. testa? EMPRESA, grupo selecionado, (unidade todos), (plano todos) (procedimento todos)
-- 9. testa? EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
-- 10. testa? EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
-- 11. testa? EMPRESA, (procedimento todos), (unidade todos), (plano todos)
-- 12. testa? procedimento selecionado, plano selecionado, unidade.
-- 13. testa? procedimento selecionado, plano selecionado, (unidade todas)
-- 14. testa? procedimento selecionado, unidade selecionado, (plano todos)
-- 15. testa? procedimento selecionado, (unidade todos), (plano todos)
-- 16. testa? grupo selecionado, plano selecionado, unidade selecionado, ( grupo todos).
-- 17. testa? grupo selecionado, plano selecionado, (unidade todas) (procedimento todos)
-- 18. testa? grupo selecionado, unidade selecionado, (plano todos), (procedimento todos)
-- 19. testa? gupo selecionado, (unidade todos), (plano todos), (procedimento todos)
-- 20. testa? plano selecionado, (procedimento todos), (unidade todos), (grupo todos)
-- 21. testa? unidade selecioando, (procedimento todos), (plano todos)
-- 22. testa? (procedimento todos), (unidade todos), (plano todos)





-- 1. Testa? Empresa, Procedimento, unidade,plano
set @teste = 1
set @idPrestadorMedicoRepasse =
( select MAX(PMR.idPrestadorMedicoRepasse)
from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante)
	and PMR.Solicitante = 1
	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
	
	
	
	
where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
and (PMR.idPlanoConvenio = a.idPlanoConvenio)
and (PMR.idEmpresaFilial = A.idEmpresaFilial)
--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
)

print @idPrestadorMedicoRepasse



-- 2. Testa? Empresa, procedimento, plano
if @idPrestadorMedicoRepasse is null begin
  set @teste = 2
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1
	
	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse



-- 3. testa? EMPRESA, procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 3
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse



-- 4. testa? EMPRESA, procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 4
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
		
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse



if @idPrestadorMedicoRepasse is null begin
	-- 5. Testa? Empresa, grupo, unidade,plano, procedimento todos.
	set @teste = 5
	set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante)
	and PMR.Solicitante = 1
	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresaFilial)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse



-- 6. Testa? Empresa, grupo, plano, procedimento todos.
if @idPrestadorMedicoRepasse is null begin
  set @teste = 6
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1
	
	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end

print @idPrestadorMedicoRepasse



-- 7. testa? EMPRESA, grupo selecionado, unidade selecionado, (plano todos) (procedimento todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 7
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse



-- 8. testa? EMPRESA, grupo selecionado, (unidade todos), (plano todos) (procedimento todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 8
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
		
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	and (PMR.idProcedimentoTussNomenclatura is null)

	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse



-- 9. testa? EMPRESA, plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 9
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
		
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idProcedimentoTussGrupo is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)
end
print @idPrestadorMedicoRepasse



-- 10. testa? EMPRESA, unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 10
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
		
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idProcedimentoTussGrupo is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse




-- 11. testa? EMPRESA, (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 11
  
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idProcedimentoTussGrupo is null)
	and (PMR.idEmpresaFilial = A.idEmpresafilial)
	)

end
print @idPrestadorMedicoRepasse





-- aqui para baixo é a mesma coisa que as opções acima , a diferença e que agora vou pegar a comissão
-- onde o campo EMPRESAFILIAL esteja em branco.

-- 12. testa? procedimento selecionado, plano selecionado, unidade.
if @idPrestadorMedicoRepasse is null begin
    set @teste = 12
	set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)

			
	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse




-- 13. testa? procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 13
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse



-- 14. testa? procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
 set @teste = 14
 set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse



-- 15. testa? procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 15
  
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- 16. testa? grupo selecionado, plano selecionado, unidade selecionado, ( grupo todos).
if @idPrestadorMedicoRepasse is null begin
    set @teste = 16
	set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
	where ass.idAtendimentoServico = @idAtendimentoservico
	and	PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end

print @idPrestadorMedicoRepasse



-- 17. testa? grupo selecionado, plano selecionado, (unidade todas) (procedimento todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 17
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	)

end

print @idPrestadorMedicoRepasse



-- 18. testa? grupo selecionado, unidade selecionado, (plano todos), (procedimento todos)
if @idPrestadorMedicoRepasse is null begin
 set @teste = 18
 set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- 19. testa? gupo selecionado, (unidade todos), (plano todos), (procedimento todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 19
  
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
			
	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse



-- 20. testa? plano selecionado, (procedimento todos), (unidade todos), (grupo todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 20

  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial is null)
	and (PMR.idProcedimentoTussGrupo is null)
	)
end
print @idPrestadorMedicoRepasse




-- 21. testa? unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 21
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idProcedimentoTussGrupo is null)

	and (PMR.idEmpresaFilial is null)
	)

end
print @idPrestadorMedicoRepasse




-- 22. testa? (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 22
  set @idPrestadorMedicoRepasse =
	( select MAX(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = A.idMedicoSolicitante
	and PMR.Solicitante = 1


	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim

	and
	(
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)


	where ass.idAtendimentoServico = @idAtendimentoservico
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idProcedimentoTussGrupo is null)
	and (PMR.idEmpresaFilial is null)
	)

end

print '@idPrestadorMedicoRepasse'
print @idPrestadorMedicoRepasse


set @retorno =


isnull((

select



max(cast(

-- os 2 (( aqui vou retirar o x% do valor da comissão
 ( (


isnull(
case

	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (ASE.MedicoCirurgiaoImprimir = 1 )
	then
		PMR.ValorComissaoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null )
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 )
	then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorComissaoInternacao

	when ( (sol.Emergencia = 1) and (@relacionado = 0) )   then
		PMR.ValorComissaoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorComissaoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorComissaoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorComissaoAmbulatorioRelacionado

end


,0)

+

( ( (
 (
  case
   when PC.TipoFaturamento = 1 then
	isnull(
		-- ASS.ValorTotalConvenio
		( ( ASS.ValorTotalConvenio  + ASS.ValorTotalCliente - isnull(ASS.ValorGlosa,0) - ASS.PTVValM2FilmeTotal) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
		+
		( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  )
	,0)
	
   else 0 
   end
  ) 
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end) 
  
  - case when pmr.ConsiderarDescontoDoAtendimento = 1 then isnull(ASS.ValorDescontoServico,0) else 0 end
  )
	
	* isnull(

case 	
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null ) 
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorPercentoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null ) 
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorPercentoInternacao
	
	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorPercentoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorPercentoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorPercentoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorPercentoAmbulatorioRelacionado

end




,0)) / 100 )






-- aqui vou retirar o x% do valor da comissão

) / 100 ) * (100 -

isnull(
case 	
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null ) 
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorDescontoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null ) 
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorDescontoInternacao
	
	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorDescontoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorDescontoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorDescontoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorDescontoAmbulatorioRelacionado

end,0))

as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	and PMR.Solicitante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
		
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
left join Tab_AtendimentoServicoEquipe ASE on ASE.idAtendimentoServico = ass.idAtendimentoServico

where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0

),0)


print @retorno

declare @ValorComissaoSolicitante money
set @ValorComissaoSolicitante = @retorno


print '@ValorComissaoSolicitante'
print @ValorComissaoSolicitante
print 'fim @ValorComissaoSolicitante'

update tab_atendimentoservico set ValorComissaoSolicitante = @retorno where idAtendimentoServico = @idAtendimentoServico


---- agora vou preparar o update do valorbasecomissao com o x%

declare @valorbasecomissao money
set @valorbasecomissao = 


isnull((

select 



max(cast( 

-- os 2 (( aqui vou retirar o x% do valor da comissão
 ( (



( ( 
 (
  case 
   when PC.TipoFaturamento = 1 then 
	isnull(
		-- ASS.ValorTotalConvenio
		( ( ASS.ValorTotalConvenio  + ASS.ValorTotalCliente - ASS.PTVValM2FilmeTotal) * ( (100 - ASS.ValorPDescontoProcedimento) / 100)  )
		+
		( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  )
	,0)
	
   else 0 
   end
  ) 
  +
  (case when PC.TipoFaturamento = 0 then
	isnull(ASS.ValorTotalCliente,0)
	ELSE
	0
  end) 
  
  - case when pmr.ConsiderarDescontoDoAtendimento = 1 then isnull(ASS.ValorDescontoServico,0) else 0 end
  )
	
	)






-- aqui vou retirar o x% do valor da comissão

) / 100 ) * (100 -

isnull(
case 	
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null ) 
	and (ASE.MedicoCirurgiaoImprimir = 1 ) then
		PMR.ValorDescontoCCirurgico
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is not null ) 
	and (isnull(ASE.MedicoCirurgiaoImprimir,0) = 0 ) then
		0
	when (a.Internacao = 1 ) and ( ASE.idatendimentoservicoequipe is null ) then
		PMR.ValorDescontoInternacao
	
	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorDescontoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorDescontoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorDescontoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorDescontoAmbulatorioRelacionado

end,0))

as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	and PMR.Solicitante = 1

	and cast(a.DataAtendimento as time) >= PMR.HorarioInicio
	and cast(a.DataAtendimento as time) <= PMR.HorarioFim
	
	and 
	(	
     	( PMR.RepasseDomingo = 1 and datepart(dw, a.DataAtendimento ) = 1 )
	or ( PMR.RepasseSegunda = 1 and datepart(dw, a.DataAtendimento ) = 2 )
	or ( PMR.RepasseTerca = 1 and datepart(dw, a.DataAtendimento ) = 3 )
	or ( PMR.RepasseQuarta = 1 and datepart(dw, a.DataAtendimento ) = 4 )
	or ( PMR.RepasseQuinta = 1 and datepart(dw, a.DataAtendimento ) = 5 )
	or ( PMR.RepasseSexta = 1 and datepart(dw, a.DataAtendimento ) = 6 )
	or ( PMR.RepasseSabado = 1 and datepart(dw, a.DataAtendimento ) = 7 )
	)
	
		
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
left join Tab_AtendimentoServicoEquipe ASE on ASE.idAtendimentoServico = ass.idAtendimentoServico

where ass.idAtendimentoServico = @idAtendimentoservico
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0

),0)

print @valorbasecomissao

update tab_atendimentoservico set valorbaseComissaoSolicitante = @valorbasecomissao, idPrestadorMedicoRepasseSolicitante = @idPrestadorMedicoRepasse where idAtendimentoServico = @idAtendimentoServico


	declare @idAtendimentoComissao int
	declare @idprestadorMedico int

	select @idAtendimentoComissao = isnull(idAtendimentoComissao,0),  @idPrestadorMedico = isnull(idprestadorMedico,0) from tab_Atendimentocomissao where idAtendimentoServico = @idAtendimentoServico and desativado =0 and Solicitante = 1
	
	print 'desativado =1'
	update tab_Atendimentocomissao set desativado = 1 where idatendimentoservico = @idAtendimentoServico and Solicitante = 1

	if isnull(@idAtendimentoComissao,0) = 0 -- se não encontrou então vai incluir.
		insert into Tab_AtendimentoComissao
		(idAtendimentoServico, DataHoraInclusao, idPrestadorMedicoRepasse, idPrestadorMedico, Solicitante, ValorComissao, ValorBaseComissao, teste)
		select @idAtendimentoServico, GETDATE(), @idPrestadorMedicoRepasse, idPrestadorMedico, 1, 
		@ValorComissaoSolicitante, @valorbasecomissao, 
		@teste
		from Cad_PrestadorMedicoRepasse where idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	else
		update AC
		set AC.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse,
		AC.valorbaseComissao = @valorbasecomissao,
		AC.ValorComissao = @ValorComissaoSolicitante,
		AC.idprestadorMedico = @idprestadorMedico,
		Desativado = 0,
		teste = @teste
		from Tab_AtendimentoComissao AC 
		where AC.idAtendimentoComissao = @idAtendimentoComissao
		and ac.Solicitante = 1
		and @idPrestadorMedicoRepasse > 0






---- fim do update valor base comissao




end





return isnull(@retorno,0)
end
GO

--- Atualização Gustavo x Janderson 25/03/2022 - incluida no DM na versao 04/04 em 05/04/2022
CREATE  proc PROC_PrestadorMedico_GeraComissao_Taxa
	@idAtendimentoServico int
AS
BEGIN
--------------------------------------------------------------------------------------
--exec  PROC_PrestadorMedico_GeraComissao_Taxa 7721
--select valorcomissao, valortotalconvenio,* from tab_atendimentoservico
--where idatendimentoservico = 7721
--update tab_atendimentoservico
--set valorcomissao = 0
--where idatendimentoservico = 7721
-- teste janderson
--------------------------------------------------------------------------------------
-- primeiro tenho que saber qual será o registro da tabela Cad_PrestadorMedicoRepasse

--- JANDERSON 19/12/2017 17
--- JANDERSON 02/08/2018 correção da comissão, considerando valorglosa
--- GUSTAVO   26/01/2022 Correção do Relacionamento Prestador Medico (ass.idPrestadormedico para PMR.idPrestadormedico)
---           Colocado do DM 2022 em 25/03/2022 - Atualizado com Janderson


declare @retorno money


declare @teste int

if (
	select COUNT(*)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idMedicoExecutante) and PMR.ETaxa = 1 and PMR.Desativado = 0
	where ass.idAtendimentoServico = @idAtendimentoServico
) = 0 begin
	PRINT 'nao tem comissão'
	set @retorno = 0

end else begin


declare @idPrestadorMedicoRepasse int
set @teste = 1
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_TaxaTussNomenclatura MMTN on MMTN.idTaxaTussNomenclatura = ass.idTaxatussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idmedicoexecutante) and PMR.ETaxa = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idTaxaTussNomenclatura = ass.idTaxaTussNomenclatura
	and PMR.idPlanoConvenio = pa.idPlanoConvenio
	)

if @idPrestadorMedicoRepasse is null begin
set @teste = 2
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_TaxaTussNomenclatura MMTN on MMTN.idTaxaTussNomenclatura = ass.idTaxaTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idmedicoexecutante) and PMR.ETaxa = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idTaxaTussNomenclatura = ass.idTaxaTussNomenclatura
	and PMR.idPlanoConvenio is null
	)

end

if @idPrestadorMedicoRepasse is null begin
set @teste = 3
set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_TaxaTussNomenclatura MMTN on MMTN.idTaxaTussNomenclatura = ass.idTaxatussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idmedicoexecutante) and PMR.ETaxa = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
---	and PMR.idTaxaTussNomenclatura = ass.idTaxaTussNomenclatura
	and PMR.idPlanoConvenio = pa.idPlanoConvenio
	)

end


if @idPrestadorMedicoRepasse is null begin
	set @teste = 4
	set @idPrestadorMedicoRepasse =
	(
	select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoServico ass
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	left join Cad_pacientePlano pa on pa.idpacienteplano= a.idpacienteplano
	join Tab_TaxaTussNomenclatura MMTN on MMTN.idTaxaTussNomenclatura = ass.idTaxatussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = isnull(ass.idProfissionalquevaireceber, a.idmedicoexecutante) and PMR.ETaxa = 1 and PMR.Desativado = 0
	where
	ASS.idAtendimentoServico = @idAtendimentoServico
	and PMR.idTaxaTussNomenclatura is null
	and PMR.idPlanoConvenio is null
	)

end





declare @relacionado bit
set @relacionado = 	( select FaturamentoPercentualRelacionado from tab_atendimentoservico
			  where idatendimentoservico = @idAtendimentoServico
			)

--set @relacionado = 0

-- vou ter que buscar o retorno 2 vezes.
-- a primeira buscando um registro especifico pelo idprocedimentotussnomenclatura e outro no geral caso o primeiro nao retorne nada.


set @retorno = isnull((



select max(cast( isnull(
case
	when (a.Internacao = 1 ) then
		PMR.ValorComissaoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorComissaoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorComissaoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorComissaoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorComissaoAmbulatorioRelacionado

end


,0)

+

( ( ( (isnull(ASS.ValorTotalConvenio,0) + isnull(ASS.ValorTotalCliente,0))  - ISNULL(ASS.ValorGlosa,0) )
	* isnull(

case
	when (a.Internacao = 1 ) then
		PMR.ValorPercentoInternacao

	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorPercentoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorPercentoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorPercentoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorPercentoAmbulatorioRelacionado

end



,0)) / 100 )


as Decimal(19,2)))

from tab_AtendimentoServico ass
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join Tab_TaxaTussNomenclatura MMTN
	on MMTN.idTaxaTussNomenclatura = ass.idTaxatussNomenclatura

join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse

join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao

where
ASS.idAtendimentoServico = @idAtendimentoServico
and PMR.Desativado = 0
and ass.idTaxaTussNomenclatura is not null


),0)




--print  cast(@retorno as varchar)



end
update tab_atendimentoservico set ValorComissao = @retorno where idAtendimentoServico = @idAtendimentoServico


	declare @valorcomissao money
	set @valorcomissao = @retorno

	declare @idAtendimentoComissao int
	declare @idprestadorMedico int

	select @idAtendimentoComissao = isnull(idAtendimentoComissao,0),  @idPrestadorMedico = isnull(idprestadorMedico,0) from tab_Atendimentocomissao where idAtendimentoServico = @idAtendimentoServico and desativado =0 and Executante = 1

	if isnull(@idAtendimentoComissao,0) = 0 -- se não encontrou então vai incluir.
		insert into Tab_AtendimentoComissao
		(idAtendimentoServico, DataHoraInclusao, idPrestadorMedicoRepasse, idPrestadorMedico, Executante, ValorComissao, teste)
		select @idAtendimentoServico, GETDATE(), @idPrestadorMedicoRepasse, idPrestadorMedico, 1, @valorComissao, @teste
		from Cad_PrestadorMedicoRepasse where idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	else
		update AC
		set AC.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse,
		AC.ValorComissao = @ValorComissao,
		AC.idprestadorMedico = @idprestadorMedico,
		Desativado = 0,
		teste = @teste
		from Tab_AtendimentoComissao AC
		where AC.idAtendimentoComissao = @idAtendimentoComissao



return @retorno

end
GO

ALTER proc [dbo].[PROC_PrestadorMedico_GeraComissaoSeriado]
	@idAtendimentoSeriado int
AS
BEGIN
-- JANDERSON 19/12/2017 
-- JANDERSON 01/09/2019

declare @retorno money


declare @teste int

declare @idAtendimentoServico int
set @idAtendimentoServico = (select idAtendimentoServico from tab_atendimentoseriado where idatendimentoseriado = @idatendimentoseriado and desativado =0)

declare @quantidadeSeriada int
set @quantidadeSeriada = (select count(*) from tab_atendimentoSeriado where idAtendimentoServico = @idAtendimentoServico and desativado = 0)

--if (select count(*) from tab_atendimentoservico where idatendimentoservico = @idatendimentoservico and idProcedimentoTussNomenclatura is not null) = 1 begin

declare @relacionado bit
set @relacionado = 	( select FaturamentoPercentualRelacionado from tab_atendimentoservico
			  where idatendimentoservico = @idAtendimentoServico
			)

declare @idPrestadorMedicoRepasse int

-- primeiro faço o teste considerando o campo da empresa.
-- 1. Testa? Procedimento, unidade,plano
-- 2. Testa? procedimento, plano
-- 3. Testa? procedimento, unidade
-- 4. testa? procedimento
-- 5. teste? unidade.
-- 5. teste? todo



if @idPrestadorMedicoRepasse is null begin
	set @teste = 1
	set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join Tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR	on PMR.idPrestadorMedico = seriado.idProfissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresaFilial)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end


-- procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 2
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = seriado.idProfissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresaFilial)
	)

end

-- procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 3
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = seriado.idProfissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresaFilial)
	)

end


-- procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 4
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = seriado.idprofissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresaFilial)
	)

end


-- plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 5
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = seriado.idprofissionalquevaireceber
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	and (PMR.idEmpresaFilial = A.idEmpresaFilial)
	)
end


-- unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 6
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = seriado.idprofissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresaFilial)
	)

end




-- (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 7
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = seriado.idprofissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	and (PMR.idEmpresaFilial = A.idEmpresaFilial)
	)

end






-- 1. Testa? Procedimento, unidade,plano
-- 2. Testa? procedimento, plano
-- 3. Testa? procedimento, unidade
-- 4. testa? procedimento
-- 5. teste? unidade.
-- 5. teste? todo


if @idPrestadorMedicoRepasse is null begin
  set @teste = 8
	set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join Tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR	on PMR.idPrestadorMedico = seriado.idProfissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio = a.idPlanoConvenio)
	--and (PMR.idProcedimentoTussGrupo = PTN.idProcedimentoTussGrupo)
	)
end


-- procedimento selecionado, plano selecionado, (unidade todas)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 9
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = seriado.idProfissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	)

end

-- procedimento selecionado, unidade selecionado, (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 10
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR on PMR.idPrestadorMedico = seriado.idProfissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento = a.idUnidadeAtendimento)
	and (PMR.idPlanoConvenio is null)
	)

end


-- procedimento selecionado, (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 11
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = seriado.idprofissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	)

end


-- plano selecionado, (procedimento todos), (unidade todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 12
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = seriado.idprofissionalquevaireceber
	join Cad_Pacienteplano Pp on Pp.idPacienteplano = a.idPacienteplano

	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio = Pp.idPlanoConvenio)
	)
end


-- unidade selecioando, (procedimento todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 13
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = seriado.idprofissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento = a.idunidadeatendimento)
	and (PMR.idPlanoConvenio is null)
	)

end




-- (procedimento todos), (unidade todos), (plano todos)
if @idPrestadorMedicoRepasse is null begin
  set @teste = 14
  set @idPrestadorMedicoRepasse =
	( select max(PMR.idPrestadorMedicoRepasse)
	from tab_AtendimentoSeriado seriado
	join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
	join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
	join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
	join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
	join Cad_PrestadorMedicoRepasse PMR
		on PMR.idPrestadorMedico = seriado.idprofissionalquevaireceber
	where seriado.idAtendimentoseriado = @idAtendimentoSeriado
	and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
	and (PMR.idProcedimentoTussNomenclatura is null)
	and (PMR.idUnidadeAtendimento is null)
	and (PMR.idPlanoConvenio is null)
	)

end




print @quantidadeseriada


set @retorno = isnull((

select max(cast( isnull(
case 	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorComissaoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorComissaoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorComissaoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorComissaoAmbulatorioRelacionado

end


,0)

+


--( ( ( ( (case when PC.TipoFaturamento = 1 then isnull(ASS.ValorTotalConvenio,0) else 0 end) + isnull(ASS.ValorTotalCliente,0) - isnull(ASS.ValorDescontoServico,0) ) / @quantidadeSeriada )
--	* isnull(



( ( ( ( ( (case when PC.TipoFaturamento = 1 then 
	isnull(ASS.ValorTotalConvenio,0) else 0 end) + isnull(ASS.ValorTotalCliente,0) 
	- isnull(ASS.PTVValM2FilmeTotal,0) - isnull(ASS.ValorDescontoServico,0) ) 
	+ ( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  ) )
	
	
	/ @quantidadeSeriada )


	* isnull(



case 	when (sol.Emergencia = 1) and (@relacionado = 0) then
		PMR.ValorPercentoPSocorro
	when (sol.Emergencia = 1) and (@relacionado = 1) then
		PMR.ValorPercentoPSocorroRelacionado

	when (sol.Emergencia = 0) and (@relacionado = 0) then
		PMR.ValorPercentoAmbulatorio
	when (sol.Emergencia = 0) and (@relacionado = 1) then
		PMR.ValorPercentoAmbulatorioRelacionado

end




,0)) / 100 )


as Decimal(9,2)))

from tab_AtendimentoSeriado seriado
join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
where seriado.idatendimentoseriado = @idAtendimentoSeriado
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0

),0)


declare @ValorBaseComissao money
set @ValorBaseComissao = 
(select isnull(max(
	(( 
	((case when PC.TipoFaturamento = 1 then 
		isnull(ASS.ValorTotalConvenio,0) 
	else 
		0 
	end) 
	+ isnull(ASS.ValorTotalCliente,0) 
	- isnull(ASS.PTVValM2FilmeTotal,0) - isnull(ASS.ValorDescontoServico,0) ) 
	
	+ ( ASS.PTVValM2FilmeTotal * ( (100 - ASS.ValorPDescontoFilme) / 100)  ) )
	)
	/ @quantidadeSeriada 
	),0)



from tab_AtendimentoSeriado seriado
join tab_AtendimentoServico ass on ass.idatendimentoservico = seriado.idatendimentoservico
join Tab_Atendimento a on a.idAtendimento = ass.idAtendimento
join cad_AnsCAraterSolicitacao Sol on sol.idCaraterSolicitacao = a.idCaraterSolicitacao
join TAb_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNomenclatura = ass.idProcedimentoTussNomenclatura
join Cad_PrestadorMedicoRepasse PMR
	on PMR.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
join Cad_PacientePlano PP on PP.idPacientePlano = a.idPacientePlano
join Cad_PlanoConvenio PC on PC.idPlanoConvenio= PP.idPlanoConvenio
where seriado.idatendimentoseriado = @idAtendimentoSeriado
and PMR.Desativado = 0 and PMR.ETaxa = 0 and PMR.EMaterial = 0 and PMR.EMedicamento = 0
)

update tab_atendimentoseriado set ValorComissao = @retorno, ValorBaseComissao = cast(@ValorBaseComissao as decimal(9,2)) where idAtendimentoSeriado = @idAtendimentoSeriado

	declare @valorComissao money
	set @valorComissao = @retorno


	declare @idAtendimentoComissao int
	declare @idprestadorMedico int

	select @idAtendimentoComissao = isnull(idAtendimentoComissao,0),  @idPrestadorMedico = isnull(idprestadorMedico,0) from tab_Atendimentocomissao where idAtendimentoSeriado = @idAtendimentoSeriado and desativado =0 and Executante = 1
	

	update tab_Atendimentocomissao set desativado = 1 where idAtendimentoSeriado = @idAtendimentoSeriado and Executante = 1
	if isnull(@idAtendimentoComissao,0) = 0 -- se não encontrou então vai incluir.
		insert into Tab_AtendimentoComissao
		(idAtendimentoSeriado, DataHoraInclusao, idPrestadorMedicoRepasse, idPrestadorMedico, Executante, ValorComissao, ValorBaseComissao, teste)
		select @idAtendimentoSeriado, GETDATE(), @idPrestadorMedicoRepasse, idPrestadorMedico, 1, @valorComissao, @valorbasecomissao, @teste
		from Cad_PrestadorMedicoRepasse where idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse
	else
		update AC
		set AC.idPrestadorMedicoRepasse = @idPrestadorMedicoRepasse,
		AC.valorbaseComissao = @valorbasecomissao,
		AC.ValorComissao = @ValorComissao,
		AC.idprestadorMedico = @idprestadorMedico,
		Desativado = 0,
		teste = @teste
		from Tab_AtendimentoComissao AC 
		where AC.idAtendimentoComissao = @idAtendimentoComissao






declare @totalseriado money
set @totalseriado = isnull((select sum(valorcomissao) from tab_atendimentoseriado where idatendimentoservico = @idatendimentoservico),0)

update ss
set ss.valorcomissao = @totalseriado
from tab_atendimentoservico ss
join tab_atendimentoseriado seriado on seriado.idatendimentoservico = ss.idatendimentoservico
where ss.idatendimentoservico = @idatendimentoservico

--end 

return isnull(@retorno,0)
end
GO

ALTER proc RealizarBackup @banco varchar(50), @caminho varchar(500)
as begin
BACKUP DATABASE @banco TO DISK = @caminho with init, nounload, name = 'Backup', noskip, stats = 10, noformat
end
GO

ALTER proc REINDEXAR_BANCO_2023
as begin

DECLARE
@IncludeFileGroup bit = 1,
@IncludeDrop bit = 1,
@IncludeFillFactor bit = 1

-- Get all existing indexes, but NOT the primary keys
DECLARE Indexes_cursor CURSOR
FOR SELECT
SC.Name AS SchemaName
, SO.Name AS TableName
, SI.Object_Id AS TableId
, SI.[Name] AS IndexName
, SI.Index_ID AS IndexId
, FG.[Name] AS FileGroupName
, CASE WHEN SI.Fill_Factor = 0 THEN 100 ELSE SI.Fill_Factor END Fill_Factor
FROM sys.indexes SI
LEFT JOIN sys.filegroups FG
ON SI.data_space_id = FG.data_space_id
INNER JOIN sys.objects SO
ON SI.object_id = SO.object_id
INNER JOIN sys.schemas SC
ON SC.schema_id = SO.schema_id
WHERE ObjectProperty(SI.Object_Id, 'IsUserTable') = 1
AND SI.[Name] IS NOT NULL
AND SI.is_primary_key = 0
AND SI.is_unique_constraint = 0
AND IndexProperty(SI.Object_Id, SI.[Name], 'IsStatistics') = 0
ORDER BY Object_name(SI.Object_Id), SI.Index_ID

DECLARE @SchemaName sysname
DECLARE @TableName sysname
DECLARE @TableId int
DECLARE @IndexName sysname
DECLARE @FileGroupName sysname
DECLARE @IndexId int
DECLARE @FillFactor int

DECLARE @NewLine nvarchar(4000) SET @NewLine = CHAR(13) + CHAR(10)
DECLARE @Tab nvarchar(4000) SET @Tab = Space(4)

-- Loop through all indexes
OPEN Indexes_cursor

FETCH NEXT
FROM Indexes_cursor
INTO @SchemaName, @TableName, @TableId, @IndexName,
@IndexId, @FileGroupName, @FillFactor

WHILE (@@Fetch_Status = 0)
BEGIN

DECLARE @sIndexDesc nvarchar(4000)
DECLARE @sCreateSql nvarchar(4000)
DECLARE @sDropSql nvarchar(4000)

SET @sIndexDesc = '-- Index ' + @IndexName + ' on table ' + @TableName
SET @sDropSql = 'IF EXISTS (SELECT 1' + @NewLine
+ ' FROM sysindexes si' + @NewLine
+ ' INNER JOIN sysobjects so' + @NewLine
+ ' ON so.id = si.id' + @NewLine
+ ' WHERE si.[Name] = ''' + @IndexName + ''' ' + @NewLine
+ ' AND so.[Name] = ''' + @TableName + ''') ' + @NewLine
+ 'BEGIN' + @NewLine
+ ' DROP INDEX [' + @IndexName + '] ON
[' + @SchemaName + '].[' + @TableName + ']' + @NewLine
+ 'END' + @NewLine

SET @sCreateSql = 'CREATE'

-- Check if the index is unique
IF (IndexProperty(@TableId, @IndexName, ' IsUnique') = 1)
BEGIN
SET @sCreateSql = @sCreateSql + ' UNIQUE'
END
--END IF
-- Check if the index is clustered
IF (IndexProperty(@TableId, @IndexName, ' IsClustered') = 1)
BEGIN
SET @sCreateSql = @sCreateSql + ' CLUSTERED'
END
--END IF

SET @sCreateSql = @sCreateSql + ' INDEX [' + @IndexName + ']
ON [' + @SchemaName + '].[' + @TableName + ']' + @NewLine + '(' + @NewLine

--Get all columns of the index
DECLARE IndexColumns_cursor CURSOR
FOR SELECT SC.[Name],
IC.[is_included_column],
IC.is_descending_key
FROM sys.index_columns IC
INNER JOIN sys.columns SC
ON IC.Object_Id = SC.Object_Id
AND IC.Column_ID = SC.Column_ID
WHERE IC.Object_Id = @TableId
AND Index_ID = @IndexId
ORDER BY IC.key_ordinal

DECLARE @IxColumn sysname
DECLARE @IxIncl bit
DECLARE @Desc bit
DECLARE @IxIsIncl bit SET @IxIsIncl = 0
DECLARE @IxFirstColumn bit SET @IxFirstColumn = 1

--Loop through all columns of the index and append them to the CREATE statement
OPEN IndexColumns_cursor
FETCH NEXT
FROM IndexColumns_cursor
INTO @IxColumn, @IxIncl, @Desc

WHILE (@@Fetch_Status = 0)
BEGIN
IF (@IxFirstColumn = 1)
BEGIN
SET @IxFirstColumn = 0
END
ELSE
BEGIN
--check to see if it's an included column
IF (@IxIsIncl = 0) AND (@IxIncl = 1)
BEGIN
SET @IxIsIncl = 1
SET @sCreateSql = @sCreateSql + @NewLine + ')' +
@NewLine + 'INCLUDE' + @NewLine + '(' + @NewLine
END
ELSE
BEGIN
SET @sCreateSql = @sCreateSql + ',' + @NewLine
END
--END IF
END
--END IF

SET @sCreateSql = @sCreateSql + @Tab + '[' + @IxColumn + ']'
--check if ASC or DESC
IF @IxIsIncl = 0
BEGIN
IF @Desc = 1
BEGIN
SET @sCreateSql = @sCreateSql + ' DESC'
END
ELSE
BEGIN
SET @sCreateSql = @sCreateSql + ' ASC'
END
--END IF
END
--END IF
FETCH NEXT
FROM IndexColumns_cursor
INTO @IxColumn, @IxIncl, @Desc
END
--END WHILE
CLOSE IndexColumns_cursor
DEALLOCATE IndexColumns_cursor

SET @sCreateSql = @sCreateSql + @NewLine + ') '

IF @IncludeFillFactor = 1
BEGIN
SET @sCreateSql = @sCreateSql + @NewLine +
'WITH (PAD_INDEX  = ON, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON, FillFactor = ' + Cast(@FillFactor as varchar(13)) + ')' + @NewLine
END
--END IF

IF @IncludeFileGroup = 1
BEGIN
SET @sCreateSql = @sCreateSql + 'ON ['+ @FileGroupName + ']' + @NewLine
END
ELSE
BEGIN
SET @sCreateSql = @sCreateSql + @NewLine
END
--END IF

PRINT '-- **************************************************************'
PRINT @sIndexDesc
PRINT '-- **************************************************************'

IF @IncludeDrop = 1
BEGIN
PRINT @sDropSql
EXECUTE sp_executesql @sDropSql

PRINT 'GO'
END
--END IF

PRINT @sCreateSql
EXECUTE sp_executesql @sCreateSql
PRINT 'GO' + @NewLine + @NewLine

FETCH NEXT
FROM Indexes_cursor
INTO @SchemaName, @TableName, @TableId, @IndexName,
@IndexId, @FileGroupName, @FillFactor
END
--END WHILE
CLOSE Indexes_cursor
DEALLOCATE Indexes_cursor




end
GO

ALTER   PROC [dbo].[REORGANIZAR_INDICE_2023_03]
AS BEGIN

DECLARE @tableName nvarchar(500) 
DECLARE @indexName nvarchar(500) 
DECLARE @percentFragment decimal(11,2) 
DECLARE @page_count int
 
DECLARE FragmentedTableList cursor for 
SELECT  dbtables.[name] AS 'Table',
    dbindexes.[name] AS 'Index',
    indexstats.avg_fragmentation_in_percent,
    indexstats.page_count
FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS indexstats
INNER JOIN sys.tables dbtables 
  ON dbtables.[object_id] = indexstats.[object_id]
INNER JOIN sys.schemas dbschemas 
  ON dbtables.[schema_id] = dbschemas.[schema_id]
INNER JOIN sys.indexes dbindexes 
  ON dbindexes.[object_id] = indexstats.[object_id]
  AND indexstats.index_id = dbindexes.index_id
  AND dbindexes.[name] IS NOT NULL
WHERE indexstats.database_id = DB_ID()
    AND indexstats.avg_fragmentation_in_percent > 05
    AND indexstats.page_count  > 10 
ORDER BY indexstats.page_count DESC, indexstats.avg_fragmentation_in_percent DESC
 
OPEN FragmentedTableList 
FETCH NEXT FROM FragmentedTableList  
INTO @tableName, @indexName, @percentFragment, @page_count
 
WHILE @@FETCH_STATUS = 0 
  BEGIN 
    PRINT 'Processando ' + @indexName + ' na tabela ' + @tableName + ' com ' + CAST(@percentFragment AS NVARCHAR(50)) + '% fragmentado' 
       
    IF(@percentFragment BETWEEN 05 AND 30) 
      BEGIN 
        
        EXEC( 'ALTER INDEX ' +  @indexName + ' ON ' + @tableName + ' REORGANIZE;') 
        PRINT 'Concluindo a reorganização do índice ' + @indexName + ' da tabela ' + @tableName 
      END 
    ELSE IF (@percentFragment > 30)
      BEGIN 
        EXEC( 'ALTER INDEX ' +  @indexName + ' ON ' + @tableName + ' REBUILD; ') 
        PRINT 'Concluindo a recriação do índice ' + @indexName + 'da tabela ' + @tableName 
    END  
    FETCH NEXT FROM FragmentedTableList  
    INTO @tableName, @indexName, @percentFragment,@page_count
  END 
CLOSE FragmentedTableList 
DEALLOCATE FragmentedTableList

END

GO

ALTER proc [RespostatoIDMensagemFacilita] 
as
update r
set r.idMensagem = m.idMensagem from 
Sms_Resposta r
join Sms_Mensagem m 
	on m.DataHora <r.DataResposta 
	and m.Telefone = r.Telefone
	and m.DataHora > r.DataResposta -2
where r.idMensagem is null
GO

ALTER proc Sis_HistoricoXMLRemessa_Insert @idusuario int, @tipo varchar(50), @nomeArquivo varchar(100), @numeroLoteTuss int, @datalotetuss datetime
as begin

/*
declare @idusuario int
set @idusuario = 1

declare @nomeArquivo  varchar(100)
set @nomeArquivo = 'teste.xml'


declare @numeroLoteTuss int
set @numeroLoteTuss = 16072

declare @datalotetuss datetime
set @datalotetuss = '13/07/2017 14:31:00'

*/
declare @idPlanoconvenio int
set @idPlanoconvenio = (select MAX(idPlanoConvenio) from tab_atendimento where NumeroLoteTuss = @numeroLoteTuss and DataLoteTuss = @datalotetuss)


declare @idHistoricoXMLRemessa int



if @idPlanoconvenio > 0 begin

	insert into [Sis_HistoricoXMLRemessa]
		(nomeArquivo, idusuarioRemessa, tipo, datahoraremessa, idPlanoConvenio, numeroLoteTuss)
	values
		(@nomeArquivo, @idusuario, @tipo, @datalotetuss, @idPlanoconvenio, @numeroLoteTuss)


	set @idHistoricoXMLRemessa = @@IDENTITY


	insert into [Sis_HistoricoXMLRemessaAtendimento]
	(idHistoricoXMLremessa, idAtendimento, NumeroLoteTuss)
	select @idHistoricoXMLRemessa, idAtendimento, NumeroLoteTuss from Tab_Atendimento where NumeroLoteTuss = @numeroLoteTuss and DataLoteTuss = @datalotetuss


	insert into [Sis_HistoricoXMLRemessaAtendimentoServico]
	(idHistoricoXMLremessaAtendimento, idAtendimentoServico)
	select RA.idHistoricoXMLRemessaAtendimento, S.idAtendimentoServico
	from [Sis_HistoricoXMLRemessaAtendimento] RA
	join Tab_Atendimento A on A.idAtendimento = RA.idAtendimento
	join Tab_AtendimentoServico S on S.idAtendimento = A.idAtendimento and S.Desativado = 0
	where RA.idHistoricoXMLremessa = @idHistoricoXMLRemessa


end


select @idHistoricoXMLRemessa as idHistoricoXMLRemessa
end


GO

ALTER proc sms_Mensagem_Insert @idAgenda int
as
begin

insert into sms_mensagem
(idagenda, Nome, Telefone, DataHora, datahoraagendamento, Mensagem)
select a.idAgenda, a.paciente, replace(a.TelefoneCelular, '-', ''),
GETDATE(), a.dataHoraMarcada - 2 ,
dbo.primeirapalavra(a.Paciente) + ', seu exame esta agendado para '
+ convert(varchar(10), a.datahoramarcada,103) + ' ' + convert(varchar(5), a.datahoramarcada,114)
+ ', caso precise desmarcar ligue para nossa central (21) 1111-2222' as Mensagem
from cad_agenda a
left join sms_mensagem m on m.idagenda = a.idagenda
where
a.idAgenda = @idAgenda
and a.Desativado = 0
and len(a.telefonecelular) >= 8
and m.idmensagem is null


end
GO

ALTER proc [sms_Mensagem_Insert_amanha]
as
begin
if (select max(datasms) from Cad_Empresa) < CONVERT(varchar(10), getdate(), 103) begin
insert into sms_mensagem
(idagenda, Nome, Telefone, DataHora, datahoraagendamento, Mensagem)
select a.idAgenda, a.paciente, replace(a.TelefoneCelular, '-', ''),
GETDATE(), GETDATE(),
dbo.primeirapalavra(a.Paciente) + ', seu exame está agendado para '
+ convert(varchar(10), a.datahoramarcada,103) + ' ' + convert(varchar(5), a.datahoramarcada,114)
+ ', caso precise desmarcar responda a mensagem ou ligue (21) 1111-2222' as Mensagem
from cad_agenda a
left join sms_mensagem m on m.idagenda = a.idagenda
where convert(varchar(10), a.datahoramarcada,103) = convert(varchar(10), GETDATE() + 1,103)
and a.Desativado = 0
and len(a.telefonecelular) >= 8
and m.idmensagem is null
and 0=1 ----- PAREI PORQUE AGORA ESTAMOS GRAVANDO AO SALVAR O REGISTRO
update Cad_Empresa set datasms = GETDATE()

end
end

GO

ALTER proc [sp_Fin_DespesaGeradorProximo_idDespesa]
@idDespesa int
-- DATA DO MES REFERENTE AO REGISTROS QUE JÁ EXISTEM, OS MESES FUTUROS QUE SERÃO CRIADOS.
-- DIFERENTE DA PROCEDURE ANTERIOR SP_FIN_DESPESAGERADOR
as
---------------------------- QUANDO ALTERAR ESSA FUNÇÃO ALTERAR TAMBME A OUTRA "PROXIMO"



declare @idDespesaOrigem int
set @idDespesaOrigem = (Select isnull(idDespesaOrigem , idDespesa ) from Fin_Despesa where idDespesa = @idDespesa)

declare @datavencimento datetime
set @datavencimento = (select datavencimento from Fin_Despesa where idDespesa = @idDespesa)

declare @delete int
set @delete =  (select count(*) from Fin_Despesa where idDespesaOrigem = @idDespesaOrigem and DataPagamento is null
and DataVencimento > @datavencimento and Desativado = 0)


delete from Fin_Despesa where idDespesaOrigem = @idDespesaOrigem and DataPagamento is null
and DataVencimento > @datavencimento


update fin_Despesa
set idDespesaorigem = null 
where iddespesa = @iddespesa

--declare @idDespesa int
--set @idDespesa = 18268

declare @parcelasnovas int
set @parcelasnovas = (select Parcelas - Parcela from fin_despesa where idDespesa =@idDespesa) 

set rowcount @parcelasnovas







insert into fin_despesa
(idPlano, idPlanoSub, idPaciente, idConta, DataMensalidade, DataVencimento, 
ValorDevido, Descricao, idEmpresaCobranca, idFornecedor, idPrestadorMedico, Parcela, Parcelas, 
DespesaMensal, idDespesaOrigem, TipoParcelamento, Contabilizada, idCentro,
idForma, observacao, DataInclusao, DiaNaoUtil, ChequeNumero
)


select 
de.idPlano, de.idPlanoSub, de.idPaciente, de.idConta, 

'01/01/1900' as DataMensalidade, 
d.Data as DataVencimento,

de.ValorDevido, de.Descricao, de.idEmpresaCobranca, de.idFornecedor, de.idPrestadorMedico, 

case when de.Parcelas > 1 then 
	ROW_NUMBER() over (order by de.dataVencimento) + de.parcela
else
	de.Parcela
end

as Parcela, 

de.Parcelas, 
de.DespesaMensal, de.idDespesa, isnull(de.TipoParcelamento, 0 ) as TipoParcelamento, de.Contabilizada, de.idCentro,
de.idForma, de.observacao, getdate(),De.DiaNaoUtil, 

case when len(de.chequenumero) > 0 then
	ROW_NUMBER() over (order by de.dataVencimento) + de.ChequeNumero
else
	null
end as chequenumero

from fin_despesa de

join sis_data d on 
	de.TipoParcelamento = 1 -- diario
	or 
	( de.TipoParcelamento = 2 and datepart(dw, d.data) = datepart(dw, de.dataVencimento) ) -- semanal
	or
	( de.TipoParcelamento = 3 and datediff(day, de.dataVencimento, d.data) % 14 = 0)    -- 2 semanas
	or
	( de.TipoParcelamento = 4 and datediff(day, de.dataVencimento, d.data) % 28 = 0)    -- 28 dias
	or
	( de.TipoParcelamento = 5 and cast(convert(varchar(10), -- mensal
		dateadd(month, datediff(month, de.dataVencimento, d.data), de.dataVencimento), 103) as datetime) = d.data)
	or
	( de.TipoParcelamento = 6 and cast(convert(varchar(10), dateadd(month, datediff(month, de.dataVencimento, d.data), de.dataVencimento), 103) as datetime) = d.data
		and -- trimestral
		(( month(d.data) in (1,4,7,10) and month(de.dataVencimento) in (1,4,7,10))
		or ( month(d.data) in (2,5,8,11) and month(de.dataVencimento) in (2,5,8,11))
		or ( month(d.data) in (3,6,9,12) and month(de.dataVencimento) in (3,6,9,12))
		)
		
	)
	
	or -- semestral
	( de.TipoParcelamento = 7 and cast(convert(varchar(10), dateadd(month, datediff(month, de.dataVencimento, d.data), de.dataVencimento), 103) as datetime) = d.data
		and 
		(
		   ( month(d.data) in (1,7) and month(de.dataVencimento) in (1,7))
		or ( month(d.data) in (2,8) and month(de.dataVencimento) in (2,8))
		or ( month(d.data) in (3,9) and month(de.dataVencimento) in (3,9))
		or ( month(d.data) in (4,10) and month(de.dataVencimento) in (4,10))
		or ( month(d.data) in (5,11) and month(de.dataVencimento) in (5,11))
		or ( month(d.data) in (6,12) and month(de.dataVencimento) in (6,12))
		
		)
		
	)

	or -- anual
	( de.TipoParcelamento = 8 and cast(convert(varchar(10), dateadd(month, datediff(month, de.dataVencimento, d.data), de.dataVencimento), 103) as datetime) = d.data
		and 
		(
			month(d.data) = month(de.dataVencimento)
		
		)
		
	or -- 3 anos                                               
	( de.TipoParcelamento = 9 and datediff(month, de.dataVencimento, d.data) % 36 = 0
		and cast(convert(varchar(10), 
		dateadd(month, datediff(month, de.dataVencimento, d.data), de.dataVencimento), 103) as datetime) = d.data
	
	)
	
	or -- primeira Sexta feira do mes.                                               
	( de.TipoParcelamento = 10 and convert(varchar(10), dbo.PrimeiraSextaFeira(d.Data),103) = convert(varchar(10), d.data,103) )
	
	)

	or -- 1 Sexta feira do mes.                                               
	( de.TipoParcelamento = 11 and convert(varchar(10), dbo.SegundaSextaFeira(d.Data),103) = convert(varchar(10), d.data,103) ) 
	
	or -- 2 Sexta feira do mes.                                               
	( de.TipoParcelamento = 12 and convert(varchar(10), dbo.TercaSextaFeira(d.Data),103) = convert(varchar(10), d.data,103) ) 
	
	or -- 3 Sexta feira do mes.                                               
	( de.TipoParcelamento = 13 and convert(varchar(10), dbo.QuartaSextaFeira(d.Data),103) = convert(varchar(10), d.data,103) ) 
	
	or -- 4 a sexta dia util
	( de.TipoParcelamento = 14 and datepart(dw, d.Data) <> 1 and datepart(dw, d.Data) <> 7 )
	
	
left join fin_Despesa da on da.idDespesaOrigem = isnull(de.idDespesaOrigem, de.idDespesa) and da.DataVencimento = d.data





Where 
de.iddespesa = @idDespesa
and d.data <= dateadd(year, 50, getdate())
and d.data > de.DataVencimento
and da.idDespesa is null
and de.Desativado = 0
and 
(
	isnull( de.TipoParcelamento, 0) > 0  -- trimestral
)

and de.Parcela <= de.Parcelas

order by d.data


set rowcount 0



--update fin_Despesa
--set datamensalidade = datavencimento - day(datavencimento) + 1
--where dataMensalidade = '01/01/1900'

/*
update D
set D.DespesaMensal = 0
From Cad_FuncionarioConta fc
join Fin_Despesa D on D.idFuncionarioConta = fc.idfuncionarioConta 
where 
dbo.anomes(fc.DataVencimentoFinal) = dbo.anomes(d.DataVencimento)
and D.DespesaMensal = 1
and D.Desativado = 0
*/


GO

ALTER proc [sp_Fin_ReceitaGeradorProximo_idReceita]
@idReceita int
-- DATA DO MES REFERENTE AO REGISTROS QUE JÁ EXISTEM, OS MESES FUTUROS QUE SERÃO CRIADOS.
-- DIFERENTE DA PROCEDURE ANTERIOR SP_FIN_RECEITAGERADOR
as
---------------------------- QUANDO ALTERAR ESSA FUNÇÃO ALTERAR TAMBME A OUTRA "PROXIMO"



declare @idReceitaOrigem int
set @idReceitaOrigem = (Select isnull(idReceitaOrigem , idReceita ) from Fin_Receita where idReceita = @idReceita)

declare @datavencimento datetime
set @datavencimento = (select datavencimento from Fin_Receita where idReceita = @idReceita)

declare @delete int
set @delete =  (select count(*) from Fin_Receita where idReceitaOrigem = @idReceitaOrigem and DataPagamento is null
and DataVencimento > @datavencimento and Desativado = 0)


delete from Fin_Receita where idReceitaOrigem = @idReceitaOrigem and DataPagamento is null
and DataVencimento > @datavencimento


update fin_Receita
set idReceitaorigem = null 
where idReceita = @idReceita

--declare @idReceita int
--set @idReceita = 18268

declare @parcelasnovas int
set @parcelasnovas = (select Parcelas - Parcela from fin_Receita where idReceita =@idReceita) 

set rowcount @parcelasnovas







insert into fin_Receita
(
idUsuarioInclusao,
cartaobandeira, CartaoNumero, DataPagamentoAuto, idusuarioPagamentoAuto, 
idPlano, idPlanoSub, idPaciente, idConta, DataMensalidade, DataVencimento, 

ValorDevido, 
DataPagamento, ValorPago, ValorDesconto,


Descricao, idEmpresaCobranca, idFornecedor, Parcela, Parcelas, 
ReceitaMensal, idReceitaOrigem, TipoParcelamento, Contabilizada, idCentro,
idForma, observacao, DataInclusao, DiaNaoUtil, ChequeNumero
)


select 
de.idUsuarioInclusao,
de.cartaobandeira, de.CartaoNumero, de.DataPagamentoAuto, de.idusuarioPagamentoAuto, 
de.idPlano, de.idPlanoSub, de.idPaciente, de.idConta, 

de.DataMensalidade, 
d.Data as DataVencimento,

de.ValorDevido, 
case when f.IncluirRegistroPago = 1 then
	de.datapagamento + ( f.DiasParaPagamento * ROW_NUMBER() over (order by de.dataVencimento)  )
	
else 
	null
end as DataPagamento,

	
case when f.IncluirRegistroPago = 1 then
	de.ValorPago
else 
	null
end as ValorPago,

de.ValorDesconto,


de.Descricao, de.idEmpresaCobranca, de.idFornecedor, 

case when de.Parcelas > 1 then 
	ROW_NUMBER() over (order by de.dataVencimento) + de.parcela
else
	de.Parcela
end

as Parcela, 

de.Parcelas, 
de.ReceitaMensal, de.idReceita, isnull(de.TipoParcelamento, 0 ) as TipoParcelamento, de.Contabilizada, de.idCentro,
de.idForma, de.observacao, getdate(),De.DiaNaoUtil, 

case when len(de.chequenumero) > 0 then
	ROW_NUMBER() over (order by de.dataVencimento) + de.ChequeNumero
else
	null
end as chequenumero

from fin_Receita de
left join Fin_Forma f on f.idforma = de.idforma
join sis_data d on 
	de.TipoParcelamento = 1 -- diario
	or 
	( de.TipoParcelamento = 2 and datepart(dw, d.data) = datepart(dw, de.dataVencimento) ) -- semanal
	or
	( de.TipoParcelamento = 3 and datediff(day, de.dataVencimento, d.data) % 14 = 0)    -- 2 semanas
	or
	( de.TipoParcelamento = 4 and datediff(day, de.dataVencimento, d.data) % 28 = 0)    -- 28 dias
	or
	( de.TipoParcelamento = 5 and cast(convert(varchar(10), -- mensal
		dateadd(month, datediff(month, de.dataVencimento, d.data), de.dataVencimento), 103) as datetime) = d.data)
	or
	( de.TipoParcelamento = 6 and cast(convert(varchar(10), dateadd(month, datediff(month, de.dataVencimento, d.data), de.dataVencimento), 103) as datetime) = d.data
		and -- trimestral
		(( month(d.data) in (1,4,7,10) and month(de.dataVencimento) in (1,4,7,10))
		or ( month(d.data) in (2,5,8,11) and month(de.dataVencimento) in (2,5,8,11))
		or ( month(d.data) in (3,6,9,12) and month(de.dataVencimento) in (3,6,9,12))
		)
		
	)
	
	or -- semestral
	( de.TipoParcelamento = 7 and cast(convert(varchar(10), dateadd(month, datediff(month, de.dataVencimento, d.data), de.dataVencimento), 103) as datetime) = d.data
		and 
		(
		   ( month(d.data) in (1,7) and month(de.dataVencimento) in (1,7))
		or ( month(d.data) in (2,8) and month(de.dataVencimento) in (2,8))
		or ( month(d.data) in (3,9) and month(de.dataVencimento) in (3,9))
		or ( month(d.data) in (4,10) and month(de.dataVencimento) in (4,10))
		or ( month(d.data) in (5,11) and month(de.dataVencimento) in (5,11))
		or ( month(d.data) in (6,12) and month(de.dataVencimento) in (6,12))
		
		)
		
	)

	or -- anual
	( de.TipoParcelamento = 8 and cast(convert(varchar(10), dateadd(month, datediff(month, de.dataVencimento, d.data), de.dataVencimento), 103) as datetime) = d.data
		and 
		(
			month(d.data) = month(de.dataVencimento)
		
		)
		
	or -- 3 anos                                               
	( de.TipoParcelamento = 9 and datediff(month, de.dataVencimento, d.data) % 36 = 0
		and cast(convert(varchar(10), 
		dateadd(month, datediff(month, de.dataVencimento, d.data), de.dataVencimento), 103) as datetime) = d.data
	
	)
	
	or -- primeira Sexta feira do mes.                                               
	( de.TipoParcelamento = 10 and convert(varchar(10), dbo.PrimeiraSextaFeira(d.Data),103) = convert(varchar(10), d.data,103) )
	
	)

	or -- 1 Sexta feira do mes.                                               
	( de.TipoParcelamento = 11 and convert(varchar(10), dbo.SegundaSextaFeira(d.Data),103) = convert(varchar(10), d.data,103) ) 
	
	or -- 2 Sexta feira do mes.                                               
	( de.TipoParcelamento = 12 and convert(varchar(10), dbo.TercaSextaFeira(d.Data),103) = convert(varchar(10), d.data,103) ) 
	
	or -- 3 Sexta feira do mes.                                               
	( de.TipoParcelamento = 13 and convert(varchar(10), dbo.QuartaSextaFeira(d.Data),103) = convert(varchar(10), d.data,103) ) 
	
	or -- 4 a sexta dia util
	( de.TipoParcelamento = 14 and datepart(dw, d.Data) <> 1 and datepart(dw, d.Data) <> 7 )
	
	
left join fin_Receita da on da.idReceitaOrigem = isnull(de.idReceitaOrigem, de.idReceita) and da.DataVencimento = d.data





Where 
de.idReceita = @idReceita
and d.data <= dateadd(year, 50, getdate())
and d.data > de.DataVencimento
and da.idReceita is null
and de.Desativado = 0
and 
(
	isnull( de.TipoParcelamento, 0) > 0  -- trimestral
)

and de.Parcela <= de.Parcelas

order by d.data


set rowcount 0



--update fin_Receita
--set datamensalidade = datavencimento - day(datavencimento) + 1
--where dataMensalidade = '01/01/1900'

/*
update D
set D.ReceitaMensal = 0
From Cad_FuncionarioConta fc
join Fin_Receita D on D.idFuncionarioConta = fc.idfuncionarioConta 
where 
dbo.anomes(fc.DataVencimentoFinal) = dbo.anomes(d.DataVencimento)
and D.ReceitaMensal = 1
and D.Desativado = 0
*/
GO

ALTER PROCEDURE [sp_Sis_Backup]
AS

DECLARE @ERRO		integer
DECLARE @BackupPath	varchar(100)
DECLARE @DatabaseName	varchar(100)
DECLARE @Disk    		varchar(1000)

DECLARE @CLIENTE varchar(50)
set @CLIENTE = replace((SELECT max(apelido) from cad_empresa),' ', '')


SET @DatabaseName = 'SMGH'
SET @BackupPath = (SELECT MAX(DiretorioBackup) from cad_empresa)
SET @Disk = @BackupPath + @CLIENTE + '_' + @DatabaseName + '_' + DateName(WeekDay, GetDate()) + '.BAK'
SET @ERRO = 0

update cad_empresa set ArquivoUltimoBackup = @CLIENTE + '_' + @DatabaseName + '_' + DateName(WeekDay, GetDate()) + '.BAK'

-- Backup do siSuporteDB e inicializao do backup device
BACKUP DATABASE @DatabaseName TO DISK=@Disk WITH  INIT ,  NOUNLOAD ,  NAME = N'SMGH',  NOSKIP ,  STATS = 10,  NOFORMAT 


RETURN @ERRO
GO

ALTER PROCEDURE [dbo].[sp_Sis_BackupSMGH] @BackupPath varchar(250), @DatabaseName varchar(250)
AS

DECLARE @ERRO		integer
--DECLARE @BackupPath	varchar(100)
--DECLARE @DatabaseName	varchar(100)
DECLARE @Disk    		varchar(1000)


--SET @DatabaseName = 'TELEMARKETING'
--SET @BackupPath = 'C:\SABETELEMARKETING\BACKUP\'
SET @Disk = @BackupPath + @DatabaseName + '_' + cast( year( getdate() ) as varchar)
	+ case when len( cast( month( getdate() ) as varchar)) = 1 then '0' + cast( month( getdate() ) as varchar)  else cast( month( getdate() ) as varchar) end
	+ case when len( cast( day( getdate() ) as varchar)) = 1 then '0' + cast( day( getdate() ) as varchar)  else cast( day( getdate() ) as varchar) end
	+ convert(varchar(2), getdate() , 114) + SUBSTRING(convert(varchar(5), getdate() , 114),4,2)
	+ '.BAK'
SET @ERRO = 0

-- Backup do siSuporteDB e inicializao do backup device
BACKUP DATABASE @DatabaseName TO DISK=@Disk WITH  INIT ,  NOUNLOAD ,  NAME = N'SMGH backup',  NOSKIP ,  STATS = 10,  NOFORMAT

RETURN @ERRO
GO

ALTER proc TAB_ATENDIMENTO_PLANTONISTA_INSERT @idAtendimento int
as begin

if exists(select * from tab_atendimento a 
join cad_prestadormedico pm on pm.idPrestadorMedico = A.idMedicoExecutante and pm.ProfissionalTriagem = 1 and pm.idProcedimentoTussNomenclaturaSUSTriagemParaMedico is not null
join Cad_PlanoConvenio pc on pc.idPlanoConvenio = a.idPlanoConvenio and pc.TipoFaturamento = 2
left join Tab_Atendimento AA on AA.idAtendimentoOrigem = A.idAtendimento and AA.Desativado = 0
where AA.idAtendimento is null
) begin


declare @idConvenio int
declare @idPrestadorMedicoTriagem int
declare @idEspecialidadeTriagem int

declare @idPrestadorMedicoPlantonista int
declare @idEspecialidadePlantonista int
declare @medicoSolicitanteRegistro varchar(50)
declare @idConselhoProfissional int
declare @idUsuarioInclusao int
declare @Quantidade int


select @idPrestadorMedicoPlantonista = max(idPrestadorMedico) from Cad_PrestadorMedico
where desativado = 0 and MedicoPlantonista = 1

select @idEspecialidadePlantonista = max(idprestadorMedicoEspecialidade) from Cad_PrestadorMedicoEspecialidade
where desativado = 0 and idPrestadorMedico = @idPrestadorMedicoPlantonista

select * from Cad_PrestadorMedicoEspecialidade



select 
	@idConvenio = PC.idConvenio,
	@idPrestadorMedicoTriagem = A.idMedicoExecutante,
	@idEspecialidadeTriagem = A.idEspecialidadeExecutante,
	@medicoSolicitanteRegistro = PM.CRM,
	@idConselhoProfissional = PM.idConselhoProfissional,
	@idUsuarioInclusao = A.idUsuarioInclusao
from 
	Tab_Atendimento A
	join Cad_PlanoConvenio PC on PC.idPlanoConvenio = A.idPlanoConvenio
	join Cad_Prestadormedico PM on PM.idPrestadorMedico = A.idMedicoExecutante
where
A.idAtendimento = @idAtendimento



declare @idProcedimentoConsulta int                      -- CONSULTA SUS
set @idProcedimentoConsulta = (select max(idProcedimentoTussNomenclaturaSUSTriagemParaMedico) from Cad_PrestadorMedico where idPrestadorMedico = @idPrestadorMedicoTriagem)



declare @numeroProntuario int
set @numeroProntuario = (select isnull(max(NumeroProntuario) + 1, 1) from tab_atendimento where gravado = 1 and desativado = 0)

declare @proximoNumeroGuia int
set @proximoNumeroGuia = (select dbo.ProximoNumeroGuia(@idConvenio))

update Cad_Convenio set NumeroGuiaUltimoGerado = @proximoNumeroGuia where idConvenio = @idConvenio




insert into tab_Atendimento 
(
NumeroProntuario, NumeroGuia, idPaciente, idUnidadeAtendimento, DataAtendimento, HoraAtendimentoNormal, HoraAtendimentoUrgencia, 
idCaraterSolicitacao, DataEmissaoGuia, idPacientePlano, MedicoSolicitanteRegistro, idMedicoSolicitante, idEspecialidadeSolicitante,
idMedicoExecutante, idEspecialidadeExecutante, Gravado, contratadooperadora, contratadoSolicitante, contratadoCNES, idMedicoSolicitanteConselho,
Consulta, idPlanoConvenioGuiaTiss, TipoGuia, idPlanoConvenio, NumeroGuiaDigitada, idTipoAtendimento, idIndicadorAcidente, 
idTipoConsulta, idTipoSaidaConsulta, DataInclusao, idUsuarioInclusao, idEmpresaFilial, AtendidoComReceituario,
TipoRegistroOperadora, NumeroGuiaOperadora, idTipoSaidaSPadt, idConvenio, AtendimentoAoRN, idAtendimentoOrigem
)
select 
@NumeroProntuario as NumeroProntuario, 
@proximoNumeroGuia as NumeroGuia, 
A.idPaciente, 
A.idUnidadeAtendimento, 
getdate() as DataAtendimento, 
A.HoraAtendimentoNormal, 
A.HoraAtendimentoUrgencia, 
A.idCaraterSolicitacao, 
A.DataEmissaoGuia, 
A.idPacientePlano, 
@MedicoSolicitanteRegistro, 
@idPrestadorMedicoTriagem as idMedicoSolicitante, 
@idEspecialidadeTriagem as idEspecialidadeSolicitante,
@idPrestadorMedicoPlantonista,  --
@idEspecialidadePlantonista as idEspecialidadeExecutante, --
A.Gravado, 
A.contratadooperadora, 
A.contratadoSolicitante, 
A.contratadoCNES, 
@idConselhoProfissional as idMedicoSolicitanteConselho,
A.Consulta, 
A.idPlanoConvenioGuiaTiss, 
A.TipoGuia, 
A.idPlanoConvenio, 
A.NumeroGuiaDigitada, 
A.idTipoAtendimento, 
A.idIndicadorAcidente, 
A.idTipoConsulta, 
A.idTipoSaidaConsulta, 
getdate() as DataInclusao, 
@idUsuarioInclusao as idUsuarioInclusao, 
A.idEmpresaFilial, 
A.AtendidoComReceituario,
A.TipoRegistroOperadora, 
@proximoNumeroGuia,
A.idTipoSaidaSPadt,
A.idConvenio,
A.AtendimentoAoRN, A.idAtendimento
from tab_atendimento A
where A.idatendimento = @idAtendimento


declare @idAtendimentoNovo int
set @idAtendimentoNovo = @@identity
select @idAtendimentoNovo





insert into tab_atendimentoServico
(idAtendimento, 
idProcedimentoTussNomenclatura, 
Quantidade, 
idProcedimentoTabelaValor,  
ValorTotalConvenio, 
PTVValProcedimento, 
PTVValM2FilmeTotal,
ValorTotalProcedimento, 
PTVMoedaCobranca, 
idProfissionalQueVaiReceber, 
idUnidadeAtendimento, 
ValorTotalProcedimentoSemFilme, 
DataServicoInicio, DataServicoFim, idViaAcesso, idTecnicautilizada, 
idGrauParticipacaoExecutante, 
idEspecialidadeExecutanteQueVaiReceber, 
idPlanoConvenioProcedimento, ValorPercentualUrgencia, idProfissionalRepasse,
valorBaseComissao, PTVValPorteUnidade, PTVValPorteTotal)


select @idAtendimentoNovo,
--idProcedimentoTussNomenclaturaSUSTriagemParaMedico
pm.idProcedimentoTussNomenclaturaTriagemParaMedico as idProcedimentoTussNomenclatura,
1 as Quantidade,
TV.idProcedimentoTabelaValor, 
ISNULL(TV.ValorRealConvenio,0) as ValorTotalConvenio,
TV.PTVValProcedimento, 
TV.PTVValM2FilmeTotal,
TV.ValorRealConvenio as ValorTotalConvenio,
TV.PTVMoedaCobranca,
null as idProfissionalQueVaiReceber,
A.idUnidadeAtendimento,
TV.PTVValProcedimento - isnull(PTVValM2FilmeTotal,0) as ValorTotalProcedimentoSemFilme,
A.DataAtendimento as DataServicoInicio,
dateadd(minute, 15, A.DataAtendimento) as DataServicoFim, 1 as idViaAcesso, 1 as idTecnicautilizada,
ua.idGrauParticipacaoExecutante,
null as idEspecialidadeExecutanteQueVaiReceber,
TV.idPlanoConvenioProcedimento,
0 AS ValorPercentualUrgencia,
NULL AS idProfissionalRepasse,
0 AS valorBaseComissao,
0 AS PTVValPorteUnidade,
0 AS PTVValPorteTotal
From Tab_Atendimento A
join Cad_PlanoConvenio PC on PC.idPLanoConvenio = A.idPlanoConvenio
join Cad_PrestadorMedico PM on PM.idprestadorMedico = A.idMedicoSolicitante
join Cad_UnidadeAtendimento uA on uA.idUnidadeAtendimento = A.idunidadeAtendimento
left join vw_Tab_TabelaValor TV on TV.idPlanoConvenio= PC.idPlanoConvenio
	and TV.idProcedimentoTussNomenclatura = @idProcedimentoConsulta
	and TV.Desativado = 0

where 
A.idAtendimento = @idAtendimentoNovo

end

exec CAD_AGENDA_INSERT @idAtendimentoNovo


end

GO

ALTER proc [Tab_AtendimentoLaudoUltrasonografia_Insert] (@idAtendimentoLaudoUltrasonografia int)
as begin
insert into Tab_AtendimentoSeriado
(idAtendimento, idProfissionalQueVaiReceber, DataRealizacaoSeriado,
idAtendimentoLaudoUltrasonografia, idAtendimentoServico)
SELECT LU.idAtendimento, LU.idMedicoExecutante, lu.DataAtendimentoLaudo,
lu.idAtendimentoLaudoUltrasonografia, LU.idAtendimentoServico
FROM Tab_AtendimentoLaudoUltrasonografia LU
join Tab_ProcedimentoTussNomenclatura PTN on PTN.idProcedimentoTussNOmenclatura = Lu.idProcedimentoTussNomenclatura and PTNTipoProcedimentoSeriado = 1
left join Tab_AtendimentoSeriado TAS
	on TAS.idAtendimentoLaudoUltrasonografia = LU.idAtendimentoLaudoUltrasonografia
WHERE LU.idAtendimentoLaudoUltrasonografia =@idAtendimentoLaudoUltrasonografia
and TAS.idAtendimentoLaudoUltrasonografia is null
end


update TAS
set TAS.idProfissionalquevaireceber = LU.idMedicoExecutante
from Tab_AtendimentoSeriado TAS
join Tab_AtendimentoLaudoUltrasonografia LU on LU.idAtendimentoLaudoUltrasonografia = TAS.idAtendimentoLaudoUltrasonografia
where TAS.idAtendimentoLaudoUltrasonografia = @idAtendimentoLaudoUltrasonografia


GO

ALTER proc Tab_Atendimentomedico_CorrecaoFonte @idAtendimentoMedico int
as begin
update tab_atendimentoMedico
set HistoriaDoencaAtual = 
	REPLACE(cast(HistoriaDoencaAtual as varchar(8000)), 
	'MS Sans Serif', 
	'Tahoma'
	)
where idAtendimentoMedico = @idAtendimentoMedico

update tab_atendimentoMedico
set HistoriaDoencaAtual = 
	REPLACE(cast(HistoriaDoencaAtual as varchar(8000)), 
	'lang1046\f0\fs16', 
	'lang1046\f0\fs20'
	)
where idAtendimentoMedico = @idAtendimentoMedico

end


GO

ALTER proc Tab_AtendimentoServico_Incluir_Material_Medicamento @idAtendimento int
as
if not exists (select idatendimentoservico from Tab_AtendimentoServico where idAtendimento =@idAtendimento and ( idMaterialTussNomenclatura is not null or idMedicamentoTussNomenclatura is not null ) ) begin

insert into Tab_AtendimentoServico 
( idAtendimento, idMaterialTabelaValor, idMaterialTussNomenclatura, PTVMoedaCobranca,
Quantidade, ValorTotalCliente, ValorTotalConvenio, ValorTotalProcedimento, PTVValProcedimento, PTVValM2FilmeTotal, PTVValM2FilmeUnidade,
idProfissionalquevaireceber, idUnidadeAtendimento --idEstoqueAplicacaoLancamento
)


select 
A.idAtendimento, material.idMaterialMedicamentoTabelaValor, 
MM.idMaterialMedicamentoTussNomenclatura, 
'R$' as PTVMoedaCobranca,
SUM(EAL.QtdeAplicada), 
SUM(case when PC.TipoFaturamento = 0 then material.ValorMaterialMedicamentoCobranca * EAL.QtdeAplicada else 0 end),
SUM(case when PC.TipoFaturamento > 0 then material.ValorMaterialMedicamentoCobranca * EAL.QtdeAplicada else 0 end) as ValortotalConvenio,
0 as ValortotalProcedimento,
MAX(material.ValorMaterialMedicamentoCobranca) as PTVValProcedimento,
0 as PTVValM2FilmeTotal, 0 as PTVValM2FilmeUnidade,
MAX(A.idMedicoExecutante) as idProfissionalqueVaiReceber,
EA.idUnidadeEstoqueDestino
--EAL.idEstoqueAplicacaoLancamento
from Tab_FarEstoqueAplicacao EA
join Tab_FarEstoqueAplicacaoLancamento EAL on EAL.idEstoqueAplicacao = EA.idEstoqueAplicacao
join Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = EAL.idEstoqueFarmacia
join Cad_FarProdutoFarmacia PF on PF.idProdutoFarmacia = FEF.idProdutoFarmacia
join Tab_MaterialMedicamentoTussNomenclatura MM on MM.idMaterialMedicamentoTussNomenclatura = PF.idMaterialMedicamentoTussNomenclatura
join Tab_Atendimento A on A.idAtendimento = EA.idAtendimento
join Cad_PacientePlano PP on PP.idPacientePlano = A.idPacientePlano
join Cad_PlanoConvenio PC on PC.idplanoConvenio = PP.idPlanoConvenio
join Tab_MaterialMedicamentoTabelaValor Material on Material.idMaterialMedicamentoTabela = PC.idMaterialTabela
	and Material.idMaterialMedicamentoTussNomenclatura = MM.idMaterialMedicamentoTussNomenclatura
--left join Tab_AtendimentoServico SS on SS.idEstoqueAplicacaoLancamento = EAL.idEstoqueAplicacaoLancamento
where ea.Gravado = 1 
and ea.Desativado = 0
--and EAL.DataAplicacao is not null
--and SS.idAtendimentoServico is null
and A.idAtendimento = @idAtendimento
GROUP BY
A.idAtendimento, material.idMaterialMedicamentoTabelaValor, 
MM.idMaterialMedicamentoTussNomenclatura, EA.idUnidadeEstoqueDestino




insert into Tab_AtendimentoServico 
( 
idAtendimento, idMedicamentoTabelaValor, idMedicamentoTussNomenclatura, PTVMoedaCobranca,
Quantidade, ValorTotalCliente, ValorTotalConvenio, ValorTotalProcedimento, PTVValProcedimento, PTVValM2FilmeTotal, PTVValM2FilmeUnidade,
idProfissionalquevaireceber, idUnidadeAtendimento --, idEstoqueAplicacaoLancamento
)
select 
A.idAtendimento, material.idMaterialMedicamentoTabelaValor, 
MM.idMaterialMedicamentoTussNomenclatura, 'R$' as PTVMoedaCobranca,
SUM(EAL.QtdeAplicada), 
SUM(case when PC.TipoFaturamento = 0 then material.ValorMaterialMedicamentoCobranca * EAL.QtdeAplicada else 0 end),
SUM(case when PC.TipoFaturamento > 0 then material.ValorMaterialMedicamentoCobranca * EAL.QtdeAplicada else 0 end) as ValortotalConvenio,
0 as ValortotalProcedimento,
MAX(material.ValorMaterialMedicamentoCobranca) as PTVValProcedimento,
0 as PTVValM2FilmeTotal, 0 as PTVValM2FilmeUnidade,
MAX(A.idMedicoExecutante) as idProfissionalqueVaiReceber,
EA.idUnidadeEstoqueDestino
--EAL.idEstoqueAplicacaoLancamento
from Tab_FarEstoqueAplicacao EA
join Tab_FarEstoqueAplicacaoLancamento EAL on EAL.idEstoqueAplicacao = EA.idEstoqueAplicacao
join Cad_FarEstoqueFarmacia FEF on FEF.idEstoqueFarmacia = EAL.idEstoqueFarmacia
join Cad_FarProdutoFarmacia PF on PF.idProdutoFarmacia = FEF.idProdutoFarmacia
join Tab_MaterialMedicamentoTussNomenclatura MM on MM.idMaterialMedicamentoTussNomenclatura = PF.idMaterialMedicamentoTussNomenclatura
join Tab_Atendimento A on A.idAtendimento = EA.idAtendimento
join Cad_PacientePlano PP on PP.idPacientePlano = A.idPacientePlano
join Cad_PlanoConvenio PC on PC.idplanoConvenio = PP.idPlanoConvenio
join Tab_MaterialMedicamentoTabelaValor Material on Material.idMaterialMedicamentoTabela = PC.idMedicamentoTabela
	and Material.idMaterialMedicamentoTussNomenclatura = MM.idMaterialMedicamentoTussNomenclatura and Material.ValorMaterialMedicamentoCobranca > 0
--left join Tab_AtendimentoServico SS on SS.idEstoqueAplicacaoLancamento = EAL.idEstoqueAplicacaoLancamento
where ea.Gravado = 1 
and ea.Desativado = 0
and EAL.DataAplicacao is not null
--and SS.idAtendimentoServico is null
and A.idAtendimento = @idAtendimento
GROUP BY
A.idAtendimento, material.idMaterialMedicamentoTabelaValor, 
MM.idMaterialMedicamentoTussNomenclatura ,
EA.idUnidadeEstoqueDestino
end


GO

-- 26/05/2023 09:48


CREATE proc [dbo].[Tab_AtendimentoServicoEquipe_Atualiza_Tab_AtendimentoServico](@idatendimentoServico int)
-- essa procedure vai pegar o valor total da equipe quando GUIA DE HONORARIO INDIVIDUAL e atualizar no TAB_ATENDIMENTOSERVICO
-- 22/11/2014
-- 02/11/2017
-- 21/11/2017
-- 23/07/2018
-- 30/07/2018

as begin
update S
set

	S.ValorTotalConvenioOriginalEquipe = case when S.ValorTotalConvenioOriginalEquipe is null then S.ValorTotalConvenio else S.ValorTotalConvenioOriginalEquipe end,
	S.ValorTotalClienteOriginalEquipe = case when S.ValorTotalClienteOriginalEquipe is null then S.ValorTotalCliente else S.ValorTotalClienteOriginalEquipe end,

	S.ValorTotalConvenio = 
	case when S.ValortotalConvenio >0 or S.ValortotalConvenioOriginalEquipe >0  then
		(select sum(isnull(ValorCirurgiao,0) + isnull(Valor1Auxiliar,0) + isnull(Valor2Auxiliar,0) + isnull(Valor3Auxiliar,0) + isnull(Valor4Auxiliar + ValorInstrumentador,0) + isnull(ValorAnestesista,0)) from Tab_AtendimentoservicoEquipe where idAtendimentoServico = @idAtendimentoServico)
	else
		0
	end,

	S.ValorTotalCliente = 
	case when S.ValorTotalCliente >0 then
		(select sum(ValorCirurgiao + Valor1Auxiliar + Valor2Auxiliar + Valor3Auxiliar + Valor4Auxiliar + ValorInstrumentador + isnull(ValorAnestesista,0)) from Tab_AtendimentoservicoEquipe where idAtendimentoServico = @idAtendimentoServico)
	else
		0
	end


from Tab_AtendimentoServico S
join Tab_Atendimento A on A.idAtendimento = S.idAtendimento and (A.HonorarioIndividual = 1 or A.internacao = 1 or A.TipoGuia = 2)
where S.idAtendimentoServico = @idAtendimentoServico
and (S.ValorTotalconvenio > 0 or S.ValorTotalConvenioOriginalEquipe > 0)

end
GO

ALTER proc Tab_FarEstoqueRequisicaoLancamento_Insert(@idEstoqueRequisicao int)
as begin
-- essa procedure é para o botão REPETIR ULTIMA REQUISICÃO DA TELA DE INCLUSÃO DA REQUISIÇÃO.
declare @idAtendimento int
set @idAtendimento = ( select max(idAtendimento) from Tab_FarEstoqueRequisicao)

declare @idEstoqueRequisicaoOrigem int
set @idEstoqueRequisicaoOrigem = ( select max(idEstoqueRequisicao) from Tab_FarEstoqueRequisicao
where desativado = 0 and Gravado = 1 and idAtendimento = @idAtendimento and idEstoqueRequisicao < @idEstoquerequisicao)

insert into Tab_FarEstoqueRequisicaoLancamento
(idEstoqueRequisicao, idProdutoFarmacia, QtdePedido, idEstoqueFarmacia)
select @idEstoqueRequisicao, idProdutoFarmacia, QtdePedido, idEstoqueFarmacia
from Tab_FarEstoqueRequisicaoLancamento
where idEstoqueRequisicao = @idEstoqueRequisicaoOrigem

end

GO

ALTER proc [Tab_IntMedicoPrescricaoLancamento_Insert](@idMedicoPrescricao int)
as begin
-- essa procedure é para o botão REPETIR ULTIMA PRESCRICAO MEDICA DA TELA MEDICO PRESCRICAO.
declare @idAtendimento int
set @idAtendimento = ( select max(idAtendimento) from Tab_IntMedicoPrescricao where idMedicoPrescricao = @idMedicoPrescricao)

declare @idMedicoPrescricaoOrigem int
set @idMedicoPrescricaoOrigem = ( select max(idMedicoPrescricao) from Tab_IntMedicoPrescricao
where desativado = 0 and Gravado = 1 and idAtendimento = @idAtendimento and idMedicoPrescricao < @idMedicoPrescricao and numeroprescricao is not null)

print @idMedicoPrescricaoOrigem

insert into Tab_IntMedicoPrescricaoLancamento
(idMedicoPrescricao, idProdutoFarmacia, idProntuarioEletronicoTipoPrescricao, idProntuarioEletronicoPosologiaAplicacao,
 idProntuarioEletronicoViaAdministracao, AprazamentoEAdministracao, ComplementoDeAdministracao, QtdeProdutoPrescricao,
 idEstoqueFarmacia, HoraAtendimento1, idProntuarioEletronicoDietaHospitalar)

select @idMedicoPrescricao, idProdutoFarmacia, idProntuarioEletronicoTipoPrescricao, idProntuarioEletronicoPosologiaAplicacao,
 idProntuarioEletronicoViaAdministracao, AprazamentoEAdministracao, ComplementoDeAdministracao, QtdeProdutoPrescricao,
 idEstoqueFarmacia, HoraAtendimento1, idProntuarioEletronicoDietaHospitalar

from Tab_IntMedicoPrescricaoLancamento
where (idMedicoPrescricao = @idMedicoPrescricaoOrigem) and (idProntuarioEletronicoDietaHospitalar is null and desativado = 0)
end

GO

ALTER proc [Tab_IntMedicoPrescricaoLancamento_to_Tab_FarEstoqueRequisicaoLancamento]
(@idatendimento int, @idEstoqueRequisicao int, @idUnidadeAtendimento int)
as 
begin

delete RL
from Tab_FarEstoqueRequisicaoLancamento RL
join Tab_FarEstoqueRequisicao R on R.idEstoqueRequisicao = RL.idEstoqueRequisicao
where isnull(R.Gravado,0) = 0 and R.idAtendimento = @idatendimento

insert into Tab_FarEstoqueRequisicaoLancamento
(idEstoqueRequisicao, idProdutoFarmacia, QTDePedido, idEstoqueFarmacia, idMedicoPrescricaoLancamento) 
select 
@idEstoqueRequisicao, MPL.idProdutoFarmacia, MPL.QtdeProdutoPrescricao, 
dbo.idProdutoTOidEstoqueFarmacia(MPL.idProdutoFarmacia, @idUnidadeAtendimento), MPL.idMedicoPrescricaoLancamento

from Tab_IntMedicoPrescricaoLancamento MPL
join Cad_FarProdutoFarmacia FPF on FPF.idProdutoFarmacia = MPL.idProdutoFarmacia and FPF.ProdutoConsumoPaciente = 1
join Tab_IntMedicoPrescricao MP on MP.idMedicoPrescricao = MPL.idMedicoPrescricao AND MP.Gravado = 1 and MP.Desativado = 0
left join Tab_FarEstoqueRequisicaoLancamento RL on RL.idMedicoPrescricaoLancamento = MPL.idMedicoPrescricaoLancamento

left join Tab_FarEstoqueRequisicao R on R.idEstoqueRequisicao = RL.idEstoqueRequisicao 
and MP.idAtendimento = R.idAtendimento and R.Gravado = 1 and R.Desativado = 0

where 
MP.idAtendimento = @idAtendimento and R.idEstoqueRequisicao is null 
end


GO

ALTER proc [TransferenciaAtendimento] (@idPacienteAntigo int, @idPacientePlanoAntigo int, @idPacienteNovo int, @idPacientePlanoNovo int )
as begin
update Tab_Atendimento set idPaciente = @idPacienteNovo where idPaciente = @idPacienteAntigo
update Tab_Atendimento set idPacientePlano = @idPacientePlanoNovo where idPaciente = @idPacientePlanoAntigo
update Tab_AtendimentoLaudoUltrasonografia set idPaciente = @idPacienteNovo where idPaciente = @idPacienteAntigo

update tab_atendimentomedico set idpaciente = @idPacienteNovo where idPaciente = @idpacienteAntigo

end
GO

ALTER proc [dbo].[TransferenciaAtendimento2] (@idPacienteAntigo int, @idPacienteNovo int)
as begin
update Tab_Atendimento set idPaciente = @idPacienteNovo where idPaciente = @idPacienteAntigo
update Tab_AtendimentoLaudoUltrasonografia set idPaciente = @idPacienteNovo where idPaciente = @idPacienteAntigo
update tab_atendimentomedico set idpaciente = @idPacienteNovo where idPaciente = @idpacienteAntigo

update cad_pacienteplano set idpaciente = @idpacienteNovo, desativado = 1 where idpaciente = @idPacienteAntigo

end
GO

-- primeiro vou relacionar o PACIENTEID com o NUMERO DA GUIA. e o primeiro nome.



CREATE proc vw_Dcm_ImagemPacienteData2
as 
begin
update i
set i.idatendimento = a.idatendimento, i.idpaciente = p.idpaciente
from Dcm_imagem i
join Tab_Atendimento a on cast(a.NumeroGuia as varchar) = i.PacienteID  and a.DataAtendimento >= '01/03/2017'
join Cad_Paciente p on p.idPaciente = a.idPaciente 
where 
i.idPaciente is null and
dbo.PrimeiraPalavra(p.paciente) = dbo.PrimeiraPalavra(i.PacienteNome)

--

update i
set i.idpaciente = p.idpaciente
from Dcm_imagem i
join Cad_Paciente p on p.Paciente = i.PacienteNome collate Latin1_General_CI_AI and p.DataNascimento = i.PacienteDataNascimento
where 
i.idPaciente is null


end
GO

ALTER proc [dbo].[ZAP_Agendamento_Agendamento] @idAgenda integer
as begin
-- essa procedure vai criar na climesa uma mensagem whatsapp para cada agendamento feito pelo site ou sistema.


declare @idtipo int

set @idtipo = 0

--declare @idAgenda int
declare @localPaciente varchar
declare @agendaWeb bit
declare @idAgendaPrincipal int
declare @idPRestadorMedico int
declare @paciente varchar(100) 
declare @idPrestadorMedicoEspecialidade int
declare @Data datetime
declare @local varchar(20)
declare @horaAgenda varchar(5)
declare @numeroAgenda int
declare @procedimento varchar(200)
declare @consulta bit
declare @exame bit

declare @horaEspecialidadeInicio varchar(5)
declare @horaEspecialidadeFim varchar(5)




select @idAgenda = a.idAgenda, @agendaWeb = a.agendaWeb,  @localpaciente = a.LocalPaciente ,
@idPrestadorMedicoEspecialidade = a.idPrestadorMedicoEspecialidade,
@idPRestadorMedico = a.idPrestadorMedico,
@Data = cast(a.DataHoraMarcada as DATE),
@local = s.local, @paciente = a.paciente,
@numeroAgenda =  case when ISNULL(pm.EscalaAgenda,0) = 0 and ISNULL(pme.EscalaAgendaEspecialidade,0) = 0 then isnull(a.Numero,0) else 0 end,
@horaAgenda = CONVERT(varchar(5), a.datahoramarcada, 114),
@procedimento =a.Procedimento,
@consulta = 
		case 
		when a.Procedimento <> REPLACE(a.Procedimento, 'CONSULTA', '') then 1 -- se achou a palavra consulta é 1
		when ptn.ptnconsulta = 1 then 1 
		else 0 
		end,
@exame = case 
		when a.Procedimento <> REPLACE(a.Procedimento, 'CONSULTA', '') then 0 -- se achou a palavra consulta é 0.
		when ptn.ptnconsulta = 0 then 1 
		else 0 
		end,
@horaEspecialidadeInicio =
case 
	when datepart(dw, a.datahoramarcada) = 1 then pme.DomingoHoraInicio 
	when datepart(dw, a.datahoramarcada) = 2 then pme.SegundaHoraInicio 
	when datepart(dw, a.datahoramarcada) = 3 then pme.TercaHoraInicio 
	when datepart(dw, a.datahoramarcada) = 4 then pme.QuartaHoraInicio 
	when datepart(dw, a.datahoramarcada) = 5 then pme.QuintaHoraInicio 
	when datepart(dw, a.datahoramarcada) = 6 then pme.SextaHoraInicio 
	when datepart(dw, a.datahoramarcada) = 7 then pme.SabadoHoraInicio 
	else '' 
end,

@horaEspecialidadeFim =
case 
	when datepart(dw, a.datahoramarcada) = 1 then pme.DomingoHoraFim
	when datepart(dw, a.datahoramarcada) = 2 then pme.SegundaHoraFim
	when datepart(dw, a.datahoramarcada) = 3 then pme.TercaHoraFim
	when datepart(dw, a.datahoramarcada) = 4 then pme.QuartaHoraFim
	when datepart(dw, a.datahoramarcada) = 5 then pme.QuintaHoraFim
	when datepart(dw, a.datahoramarcada) = 6 then pme.SextaHoraFim
	when datepart(dw, a.datahoramarcada) = 7 then pme.SabadoHoraFim
	else '' 
	end



from cad_agenda a
join Cad_PrestadorMedicoEspecialidade pme on pme.idPrestadorMedicoEspecialidade = a.idPrestadorMedicoEspecialidade
join Cad_PrestadorMedico pm on pm.idPrestadorMedico = pme.idPrestadorMedico
left join Tab_ProcedimentoTussNomenclatura ptn on ptn.idProcedimentoTussNomenclatura = a.idProcedimentoTussNomenclatura
left join Cad_Sala s on s.idSala = a.idSala
where a.idagenda = @idagenda

set @idAgendaPrincipal = (
			select MIN(idAgenda) from Cad_Agenda  a
			left join Cad_Sala sala on sala.idSala = a.idSala
			where cast(a.DataHoraMarcada as DATe) = @Data
			and a.Paciente = @paciente
			and a.idPrestadorMedico = @idPRestadorMedico
			and a.idPrestadorMedicoEspecialidade = @idPrestadorMedicoEspecialidade
			and a.Desativado = 0)
			
print @idagendaprincipal
print @idagenda
print @paciente



set @idtipo = 0

select @idtipo = t.idtipo
from Zap_Tipo t 
where 
t.Desativado =0 
and t.MensagemAgendamento =1
and 
	(t.MensagemQuandoConsulta = @Consulta or t.MensagemQuandoExame = @Exame
	or ( t.MensagemQuandoConsulta = 0 and t.MensagemQuandoExame = 0)
	)
and t.idPrestadorMedico = @idPRestadorMedico
and 
(
	(t.HoraInicioAgenda <= @horaAgenda 
	and t.HoraFimAgenda >= @horaagenda
	and @numeroAgenda = 0)
	or 
	( t.NumeroInicioAgenda <= @numeroAgenda 
	and t.NumeroFimAgenda >= @numeroAgenda
	and @numeroAgenda > 0)
)
and 
(
		( t.Domingo = 1 and datepart(dw, getdate()) = 1 )
		or ( t.Segunda = 1 and datepart(dw, getdate()) = 2 )
		or ( t.terca = 1 and datepart(dw, getdate()) = 3 )
		or ( t.quarta = 1 and datepart(dw, getdate()) = 4 )
		or ( t.quinta = 1 and datepart(dw, getdate()) = 5 )
		or ( t.sexta = 1 and datepart(dw, getdate()) = 6)
		or ( t.sabado = 1 and datepart(dw, getdate()) = 7 )
)
		

print 'idtipo tentativa 1'
print @idtipo

if @idtipo = 0 begin
select @idtipo = t.idtipo
from Zap_Tipo t 
where 
	t.Desativado =0 
	and t.MensagemAgendamento =1
	and 
	(t.MensagemQuandoConsulta = @Consulta or t.MensagemQuandoExame = @Exame
	or ( t.MensagemQuandoConsulta = 0 and t.MensagemQuandoExame = 0)
	)
	and t.idPrestadorMedico = @idPRestadorMedico
	and 
	(
		( t.Domingo = 1 and datepart(dw, getdate()) = 1 )
		or ( t.Segunda = 1 and datepart(dw, getdate()) = 2 )
		or ( t.terca = 1 and datepart(dw, getdate()) = 3 )
		or ( t.quarta = 1 and datepart(dw, getdate()) = 4 )
		or ( t.quinta = 1 and datepart(dw, getdate()) = 5 )
		or ( t.sexta = 1 and datepart(dw, getdate()) = 6)
		or ( t.sabado = 1 and datepart(dw, getdate()) = 7 )
	)
		

end

print '@idtipo tentativa 2'
print @idtipo

if @idtipo = 0  begin
	set @idtipo = 1
end

print '@idtipo'
print @idtipo

if @idAgendaPrincipal = @idAgenda begin

if exists(
select a.idagenda
from cad_agenda a
join zap_tipo t on t.idtipo = @idTipo
join cad_empresa emp on emp.idempresa = 1
join cad_prestadorMedicoEspecialidade PME on PME.idprestadormedicoEspecialidade = a.idPrestadormedicoEspecialidade
join Cad_PrestadorMedico PM on PM.idPrestadorMedico = PME.idPrestadorMedico
join CAD_ANScbos cbos on cbos.idcbos = PME.idCBOS
where a.idagenda = @idAgenda
and @idtipo > 0
and len(dbo.SomenteNumeros( a.telefoneCelular)) >= 9
and cast(a.DataHoraMarcada as date) > cast(getdate() as date)
and a.idMensagemAgendamento is null

) BEGIN

insert into sms_mensagem
(idtipo, mensagem, idusuario, datahora, telefone, idagenda, whatsapp, prioridade, prioridadenivel)

select 
t.idtipo, 
replace(
replace(
replace(
replace(
replace(
replace(
replace(
replace(
replace(
cast(t.mensagem as varchar(max)), '[NOME]', a.Paciente),
'[PACIENTE]', a.paciente),
'[DATA_AGENDADA]', convert(varchar(10), a.DataHoraMarcada, 103)),
'[HORA_AGENDADA]', 
case when convert(varchar(5), a.DataHoraMarcada, 114) = '00:00' then
'' else convert(varchar(5), a.DataHoraMarcada, 114) end ),
'[ESPECIALIDADE]', cbos.EspecialidadeCbos),
'[MEDICO]', pm.PrestadorMedico),
'[HORA_INICIO_AGENDA]', @horaEspecialidadeInicio),
'[HORA_FIM_AGENDA]', @horaEspecialidadeFim),
'com o Dr(a). AGENDA EXAMES.', 'para a realização de exame(s).')
as Mensagem,
0 as idusuario, 
getdate(), 
case when LEN(dbo.somentenumeros(a.telefoneCelular)) = 9 then 	'21' else '' end + dbo.somentenumeros(a.telefoneCelular), 
--'21992606606',
a.idagenda, 1, 0, 999
from cad_agenda a
join zap_tipo t on t.idtipo = @idTipo
join cad_empresa emp on emp.idempresa = 1
join cad_prestadorMedicoEspecialidade PME on PME.idprestadormedicoEspecialidade = a.idPrestadormedicoEspecialidade
join Cad_PrestadorMedico PM on PM.idPrestadorMedico = PME.idPrestadorMedico
join CAD_ANScbos cbos on cbos.idcbos = PME.idCBOS
left join Cad_Sala sala on sala.idSala = a.idSala
where a.idagenda = @idAgenda
and len(dbo.somentenumeros(a.telefoneCelular)) >= 9
and cast(a.DataHoraMarcada as date) > cast(getdate() as date)
and @idtipo > 0
and a.idMensagemAgendamento is null

print 'vai fazer update'
update cad_Agenda
set idmensagemAgendamento = @@IDENTITY
where idAgenda = @idagenda

END
end
end




GO

ALTER proc [dbo].[ZAP_Agendamento_Lembrete] @idAgenda integer
as begin
-- essa procedure vai criar na climesa uma mensagem whatsapp para cada agendamento feito pelo site ou sistema.


--declare @idtipo int

--set @idtipo = 0

--declare @idAgenda int
declare @localPaciente varchar
declare @agendaWeb bit


declare @idAgendaPrincipal int
declare @idPRestadorMedico int
declare @paciente varchar(100) 
declare @idPrestadorMedicoEspecialidade int
declare @Data datetime
declare @local varchar(20)

select @idAgenda = a.idAgenda, @agendaWeb = a.agendaWeb,  @localpaciente = a.LocalPaciente ,
@idPrestadorMedicoEspecialidade = a.idPrestadorMedicoEspecialidade,
@idPRestadorMedico = a.idPrestadorMedico,
@Data = cast(a.DataHoraMarcada as DATE),
@local = s.local, @paciente = a.paciente
from cad_agenda a
left join Cad_Sala s on s.idSala = a.idSala
where a.idagenda = @idagenda

--set @idtipo = 2 --LEMBRETE AGENDAMENTO



print 'select'

set @idAgendaPrincipal = (
			select MIN(idAgenda) from Cad_Agenda  a
			left join Cad_Sala sala on sala.idSala = a.idSala
			where cast(a.DataHoraMarcada as DATe) = @Data
			and a.Paciente = @paciente
			and a.idPrestadorMedico = @idPRestadorMedico
			and a.idPrestadorMedicoEspecialidade = @idPrestadorMedicoEspecialidade
			and a.Desativado = 0
			 )
			
print @idagendaprincipal
print @idagenda
print @paciente

	
if @idAgendaPrincipal = @idAgenda begin
insert into sms_mensagem
(idtipo, mensagem, idusuario, datahora, telefone, idagenda, whatsapp, prioridade, prioridadenivel)

select 
--isnull(tipoOrdemChegada.idtipo, tipoAgendado.idTipo),
tipoAgendado.idTipo,
replace(
replace(
replace(
replace(
replace(
replace(
replace(
cast(tipoAgendado.Mensagem as varchar(max)), '[NOME]', a.Paciente), 
'[PACIENTE]', a.paciente),
'[DATA_AGENDADA]', convert(varchar(10), a.DataHoraMarcada, 103)),
'[HORA_AGENDADA]', 
case when convert(varchar(5), a.DataHoraMarcada, 114) = '00:00' then
'' else convert(varchar(5), a.DataHoraMarcada, 114) end ),
'[ESPECIALIDADE]', cbos.EspecialidadeCbos),


	
'[MEDICO]', pm.PrestadorMedico),
'com o Dr(a). AGENDA EXAMES.', 'para a realização de exame(s).')

as Mensagem,

case when sala.Local= 'HOSPITAL' then 1
when sala.Local = 'PREDIO' then 2
else 0 end as idusuario, 
getdate(), 
-- original
case when LEN(dbo.somentenumeros(a.telefoneCelular)) = 9 then 	'21' else ''  end + dbo.somentenumeros(a.telefoneCelular), 
--'21992606606',
a.idagenda, 1, 0, 999
from cad_agenda a
join cad_empresa emp on emp.idempresa = 1
join cad_prestadorMedicoEspecialidade PME on PME.idprestadormedicoEspecialidade = a.idPrestadormedicoEspecialidade
join Cad_PrestadorMedico PM on PM.idPrestadorMedico = PME.idPrestadorMedico
left join Cad_Sala sala on sala.idSala = a.idSala
join CAD_ANScbos cbos on cbos.idcbos = PME.idCBOS
--left join zap_tipo tipoOrdemChegada on tipoOrdemChegada.idTipo = 3 
	--and tipoOrdemChegada.idPrestadorMedico = pm.idPrestadorMedico
left join zap_tipo tipoAgendado on tipoAgendado.idtipo = 2 
	and tipoAgendado.idPrestadorMedico is null
	

where a.idagenda = @idAgenda

update cad_Agenda
set idMensagemLembrete = @@IDENTITY
where idAgenda = @idagenda


end

end







GO

ALTER proc [dbo].[ZAP_Agendamento_Lembrete48] @idAgenda integer
as begin
-- essa procedure vai criar na climesa uma mensagem whatsapp para cada agendamento feito pelo site ou sistema.


declare @idtipo int

set @idtipo = 0

--declare @idAgenda int
declare @localPaciente varchar
declare @agendaWeb bit

select @idAgenda = idAgenda, @agendaWeb = agendaWeb,  @localpaciente = LocalPaciente 
from cad_agenda 
where idagenda = @idagenda

if (@localPaciente = '0') begin -- PRESENCIAL
	set @idtipo = 3
end

if (@localpaciente = '1' ) BEGIN -- ONLINE
	set @idtipo = 19
end




print 'select'

insert into sms_mensagem
(idtipo, mensagem, idusuario, datahora, telefone, idagenda, whatsapp, prioridade, prioridadenivel)

select 
t.idtipo, 

replace(
replace(
replace(
replace(
replace(
replace(
cast(t.mensagem as varchar(max)), '[NOME]', a.Paciente),
'[PACIENTE]', a.paciente),
'[DATA_AGENDADA]', convert(varchar(10), a.DataHoraMarcada, 103)),
'[HORA_AGENDADA]', convert(varchar(5), a.DataHoraMarcada, 114)),
'[ESPECIALIDADE]', cbos.EspecialidadeCbos),
'[MEDICO]', pm.PrestadorMedico) as Mensagem,



0 as idusuario, 
getdate(), 
--dbo.somentenumeros( a.TelefoneCelular), 

case when LEN(dbo.somentenumeros(a.telefoneCelular)) = 9 then
	'21' else '' 
end
+
dbo.somentenumeros(a.telefoneCelular), 


--'21992606606',
a.idagenda, 1, 0, 999
from cad_agenda a
join zap_tipo t on t.idtipo = @idTipo
join cad_empresa emp on emp.idempresa = 1
join cad_prestadorMedicoEspecialidade PME on PME.idprestadormedicoEspecialidade = a.idPrestadormedicoEspecialidade
join Cad_PrestadorMedico PM on PM.idPrestadorMedico = PME.idPrestadorMedico
join CAD_ANScbos cbos on cbos.idcbos = PME.idCBOS
where a.idagenda = @idAgenda
and @idtipo > 0
and a.idagendaPai is null

update cad_Agenda
set idMensagemLembrete48 = @@IDENTITY
where idAgenda = @idagenda


end
GO

ALTER proc [dbo].[ZAP_Agendamento_PosAtendimento] @idAgenda integer
as begin
-- essa procedure vai criar na climesa uma mensagem whatsapp para cada agendamento feito pelo site ou sistema.


declare @idtipo int

set @idtipo = 3

--declare @idAgenda int
declare @localPaciente varchar
declare @agendaWeb bit
declare @idAgendaPrincipal int
declare @idPRestadorMedico int
declare @paciente varchar(100) 
declare @idPrestadorMedicoEspecialidade int
declare @Data datetime
declare @local varchar(20)

select @idAgenda = a.idAgenda, @agendaWeb = a.agendaWeb,  @localpaciente = a.LocalPaciente ,
@idPrestadorMedicoEspecialidade = a.idPrestadorMedicoEspecialidade,
@idPRestadorMedico = a.idPrestadorMedico,
@Data = cast(a.DataHoraMarcada as DATE),
@local = s.local, @paciente = a.paciente
from cad_agenda a
left join Cad_Sala s on s.idSala = a.idSala
where a.idagenda = @idagenda

set @idAgendaPrincipal = (
			select MIN(idAgenda) from Cad_Agenda  a
			left join Cad_Sala sala on sala.idSala = a.idSala
			where cast(a.DataHoraMarcada as DATe) = @Data
			and a.Paciente = @paciente
			and a.idPrestadorMedico = @idPRestadorMedico
			and a.idPrestadorMedicoEspecialidade = @idPrestadorMedicoEspecialidade
			and a.Desativado = 0)
			
print '@idagendaprincipal'
print @idagendaprincipal
print '@idagenda'
print @idagenda
print '@paciente'
print @paciente

set @idtipo = 3

print 'antes do if'
if @idAgendaPrincipal = @idAgenda begin
print 'entrou no if'
insert into sms_mensagem
(idtipo, mensagem, idusuario, datahora, telefone, idagenda, whatsapp, prioridade, prioridadenivel)

select 
t.idtipo, 

replace(
replace(
replace(
replace(
cast(t.mensagem as varchar(max)), '[NOME]', a.Paciente),
'[PACIENTE]', a.paciente),
'[DATA_AGENDADA]', convert(varchar(10), a.DataHoraMarcada, 103)),
'[HORA_AGENDADA]', 
case when convert(varchar(5), a.DataHoraMarcada, 114) = '00:00' then
'' else convert(varchar(5), a.DataHoraMarcada, 114) end 
)
 as Mensagem,



0 as idusuario, 
getdate(), 
case when LEN(dbo.somentenumeros(a.telefoneCelular)) = 9 then '21' else ''  end + dbo.somentenumeros(a.telefoneCelular),  
--'21992606606',
a.idagenda, 1, 0, 999
from cad_agenda a
join zap_tipo t on t.idTipo = 3
join cad_empresa emp on emp.idempresa = 1
where a.idagenda = @idAgenda



update cad_Agenda
set idMensagemPosAtendimento = @@IDENTITY
where idAgenda = @idagenda


end

end





GO

ALTER proc [dbo].[zap_respostaTOcad_agenda]
as begin
--26/06/2023
DECLARE @IDRESPOSTA INT
SELECT @IDRESPOSTA  = MAX(IDRESPOSTA) FROM ZAP_RESPOSTA

--SE existe o registro que não foi confirmado e nem desativado então preciso da resposta
if exists(select m.idmensagem
	from sms_mensagem m
	join cad_agenda a on a.idagenda = m.idagenda --and isnull(a.confirmado,0) = 0
	join Zap_resposta r  on r.telefone = m.Telefone and r.datahora > m.datahoraenvio
		AND r.idresposta <= @IDRESPOSTA and r.codigoResposta in ( '1', '2', '3')
	where
	idusuario = 0
	and cast(m.datahoraEnvio as date) >= cast(getdate() -4 as date)
	and isnull(a.confirmado,0)= 0 and A.desativado=0) begin
	--FIM se existe o registro que não foi confirmado e nem desativado então preciso da resposta

	print 'etapa 1'
	update a
	set a.confirmado = 1,
	a.observacao =
		isnull(a.Observacao + '.     ', '')
		+ 'CONFIRMAÇÃO DE AGENDA - RESPOSTA DO CLIENTE VIA WHATSAPP ----> ' + upper(r.Resposta),

	a.RespostaConfirmacao =
		isnull(a.RespostaConfirmacao + '.     ', '')
		+ 'CONFIRMAÇÃO DE AGENDA - RESPOSTA DO CLIENTE VIA WHATSAPP ----> ' + upper(r.Resposta)

	from sms_mensagem m
	join cad_agenda a on a.idagenda = m.idagenda and isnull(a.confirmado,0) = 0
	join Zap_resposta r  on r.telefone = m.Telefone and r.datahora > m.datahoraenvio
		AND r.idresposta <= @IDRESPOSTA and r.codigoResposta = '1'

	where
	idusuario = 0
	and cast(m.datahoraEnvio as date) >= cast(getdate() -4 as date)

	insert into sms_mensagem
	(idtipo, Mensagem, idusuario, datahora, telefone, WhatsApp, prioridade, PrioridadeNivel )
	select 0 as idtipo, 'Obrigado pela confirmação.', 0, getdate(), r.telefone, 1, 0, 1  from zap_resposta r 
	left join Sms_Mensagem m on m.Telefone = r.Telefone and cast(m.DataHora as date) = CAST(GETDATE() as date) 
	and cast(m.mensagem as varchar(250))= 'Obrigado pela confirmação.'
	where r.idresposta <= @IDRESPOSTA
	and r.codigoResposta = '1'
	AND m.idMensagem is null



	--REMARCAR 2
	update a
	set a.desativado=1, a.DataHoraCancelamento = getdate(), idusuariocancelamento = 1,
	a.observacao =
		isnull(a.Observacao + '.     ', '')
		+ 'REMARCAR - RESPOSTA DO CLIENTE VIA WHATSAPP ----> ' + upper(r.Resposta),

	a.RespostaConfirmacao =
		isnull(a.RespostaConfirmacao + '.     ', '')
		+ 'REMARCAR - RESPOSTA DO CLIENTE VIA WHATSAPP ----> ' + upper(r.Resposta)

	from sms_mensagem m
	join cad_agenda a on a.idagenda = m.idagenda --and isnull(a.confirmado,0) = 0
	join Zap_resposta r  on r.telefone = m.Telefone and r.datahora > m.datahoraenvio
		AND r.idresposta <= @IDRESPOSTA and r.codigoResposta = '2'
	where
	idusuario = 0
	and cast(m.datahoraEnvio as date) >= cast(getdate() -4 as date)
	--REMARCAR 2
	insert into sms_mensagem
	(idtipo, Mensagem, idusuario, datahora, telefone, WhatsApp, prioridade, PrioridadeNivel )
	select 0 as idtipo, 
	'Puxa que pena, neste caso preciso que entre em contato com o WhatsAPP em um dos números: 2133358396 ou 2133354365, para efetuar a sua remarcação!',
	0, getdate(), r.telefone, 1, 0, 1  from zap_resposta r
	left join Sms_Mensagem m on m.Telefone = r.Telefone and cast(m.DataHora as date) = CAST(GETDATE() as date) 
	and cast(m.mensagem as varchar(250)) =
	'Puxa que pena, neste caso preciso que entre em contato com o WhatsAPP em um dos números: 2133358396 ou 2133354365, para efetuar a sua remarcação!'
	where r.idresposta <= @IDRESPOSTA
	and r.codigoResposta = '2'
	and m.idmensagem is null



	--CANCELAMENTO 3
	update a
	set a.desativado=1, a.DataHoraCancelamento = getdate(), idusuariocancelamento = 1,
	a.observacao =
		isnull(a.Observacao + '.     ', '')
		+ 'CANCELAR - RESPOSTA DO CLIENTE VIA WHATSAPP ----> ' + upper(r.Resposta),

	a.RespostaConfirmacao =
		isnull(a.RespostaConfirmacao + '.     ', '')
		+ 'CANCELAR - RESPOSTA DO CLIENTE VIA WHATSAPP ----> ' + upper(r.Resposta)

	from sms_mensagem m
	join cad_agenda a on a.idagenda = m.idagenda --and isnull(a.confirmado,0) = 0
	join Zap_resposta r  on r.telefone = m.Telefone and r.datahora > m.datahoraenvio
		AND r.idresposta <= @IDRESPOSTA and r.codigoResposta = '3'
	where
	idusuario = 0
	and cast(m.datahoraEnvio as date) >= cast(getdate() -4 as date)

	--CANCELAMENTO 3
	insert into sms_mensagem
	(idtipo, Mensagem, idusuario, datahora, telefone, WhatsApp, prioridade, PrioridadeNivel )
	select 0 as idtipo, 
	'Puxa que pena, seu cancelamento foi recebido. Entendemos que emprevistos acontecem, não gostaria de estar efetuando uma remarcação?', 
	0, getdate(), r.telefone, 1, 0, 1  from zap_resposta r
	left join Sms_Mensagem m on m.Telefone = r.Telefone and cast(m.DataHora as date) = CAST(GETDATE() as date) 
	and cast(m.mensagem as varchar(250))= 
	'Puxa que pena, seu cancelamento foi recebido. Entendemos que emprevistos acontecem, não gostaria de estar efetuando uma remarcação?'
	where r.idresposta <= @IDRESPOSTA
	and r.codigoResposta = '3'
	and m.idmensagem is null

end


delete Zap_resposta where idresposta = @IDRESPOSTA

end

GO

