DOCUMENTA√á√ÉO T√âCNICA E ESTRAT√âGICA FINAL (TRANSFER√äNCIA DE CONSCI√äNCIA)

PROJETO: GAMIR SA√öDE üöÄ Vers√£o: 5.5 (Fluxos de Consulta e Exame Operacionais com Endpoints Dedicados) Autor: VORTEX (IA T√°tica) Data: 25 de Outubro de 2025

I. ARQUITETURA E OBJETIVO MESTRE

O objetivo permanece: integrar um aplicativo m√≥vel .NET MAUI a um sistema SQL Server legado, utilizando procedures otimizadas e l√≥gica C# para contornar complexidades. A estrat√©gia atual prioriza a separa√ß√£o clara dos fluxos de agendamento de Consultas e Exames para maior robustez e manutenibilidade.


Backend: .NET 8 com Clean Architecture. Estrutura confirmada pelos arquivos (GamirSaude.API, Application, Domain, Infrastructure).


Frontend: .NET MAUI com padr√£o MVVM.

II. ESTADO ATUAL E SUCESSOS T√ÅTICOS ALCAN√áADOS

O projeto atingiu um estado funcional para ambos os fluxos, incorporando corre√ß√µes cr√≠ticas:


Autentica√ß√£o e Ponte Legada (v5.3.1): Funcional, incluindo cria√ß√£o de usu√°rio, verifica√ß√£o de e-mail, link com Cad_Paciente e cria√ß√£o autom√°tica do registro Cad_PacientePlano (ID 33) para compatibilidade com procedures legadas.

Agendamento de Consultas (v5.3.1 + Corre√ß√µes):

Backend: O fluxo utiliza endpoints dedicados (/especialidades, /medicos/{esp}, /dias-disponiveis, /horarios-disponiveis, /).

Filtragem de M√©dicos: O endpoint /medicos/{especialidade} agora implementa um filtro rigoroso, exibindo apenas m√©dicos que atendem aos crit√©rios de consulta (AtendeComAgendaWeb = 1, Exame = 0) E possuem pelo menos um dia de trabalho configurado com flag 1 e hor√°rios v√°lidos, evitando exibir m√©dicos com cadastros inconsistentes.

Disponibilidade de Dias (/dias-disponiveis):

Utiliza o DTO DiasDisponiveisConsultaRequest (sem IdProcedimento).

Busca a regraAgenda usando filtro rigoroso (m√©dico + flags consulta + consist√™ncia dia/hora) para evitar SqlNullValueException ao carregar dados inconsistentes. Usa proje√ß√£o para carregar apenas dados necess√°rios.

Ignora IdProcedimento na contagem de vagas (agendamentosExistentes), considerando a disponibilidade geral do m√©dico naquele dia.

N√£o exibe dias passados.

Verifica hor√°rios futuros para o dia atual antes de marc√°-lo como dispon√≠vel, usando o m√©todo auxiliar TemHorarioFuturoDisponivel.

Disponibilidade de Hor√°rios (/horarios-disponiveis):

Utiliza o DTO HorariosDisponiveisRequest (com IdProcedimento).

Busca a regraAgenda usando filtro simples de consulta (Web=1, Exame=0). Usa proje√ß√£o para evitar SqlNullValueException.

Utiliza IdProcedimento na busca de hor√°rios ocupados.

Gera a lista de slots dispon√≠veis.

Agendamento (POST /): Utiliza a procedure otimizada PROCEDURE_GAMIR_SAUDE_INSERT ap√≥s valida√ß√µes e inser√ß√µes preliminares em Tab_Atendimento.

Frontend: Os ViewModels (AgendarConsultaViewModel, MedicosDisponiveisViewModel) e o GamirApiService est√£o alinhados com os endpoints e DTOs de consulta. O calend√°rio (GerarCalendario) foi corrigido para exibir corretamente as c√©lulas vazias e aplicar estilos baseados no Status.

Implementa√ß√£o do Fluxo de Exames (Novo):

Backend: Criados endpoints dedicados para todo o fluxo de exame:

GET /exames/tipos: Lista os tipos de exame (DescricaoAgenda) filtrando por Web=0, Exame=1.

POST /exames/especificos: Lista exames espec√≠ficos (PMPDescricaoTussReferencia, idProcedimento) para um tipo, filtrando por Web=0, Exame=1.

GET /exames/medicos/{idProcedimento}: Lista m√©dicos que realizam um exame espec√≠fico, filtrando por Web=0, Exame=1.

POST /exames/dias-disponiveis: Calcula dias dispon√≠veis para um m√©dico/exame, filtrando por Web=0, Exame=1, IdProcedimento. Inclui verifica√ß√£o de data passada e hor√°rio futuro no dia atual. Usa proje√ß√£o.

POST /exames/horarios-disponiveis: Calcula hor√°rios para um m√©dico/exame/dia, filtrando por Web=0, Exame=1, IdProcedimento. (Nota: Atualmente carrega entidade completa, pode precisar de proje√ß√£o se SqlNullValueException ocorrer).

Frontend:

AgendarExameViewModel: Exibe a lista de tipos de exame (GetTiposExameAsync).

ExamesEspecificosViewModel: Recebe o tipo, busca e exibe a lista de exames espec√≠ficos (GetExamesEspecificosAsync). Navega para MedicosExamePage passando nome e IdProcedimento do exame.

MedicosExameViewModel: Recebe nome/ID do exame. Busca m√©dicos (GetMedicosPorProcedimentoAsync). Calcula e exibe calend√°rio (GetDiasDisponiveisExameAsync, GerarCalendario corrigido). Busca hor√°rios (GetHorariosDisponiveisExameAsync). Agenda usando o endpoint POST / (que j√° aceita IdProcedimento).

GamirApiService: Cont√©m os novos m√©todos (GetTiposExameAsync, GetExamesEspecificosAsync, GetMedicosPorProcedimentoAsync, GetDiasDisponiveisExameAsync, GetHorariosDisponiveisExameAsync) que chamam os endpoints de exame corretos.

Corre√ß√µes Gerais:

Conex√£o do Emulador Android (10.0.2.2) est√° configurada no GamirApiService.

Desserializa√ß√£o JSON (ex: Medico.cs usando [JsonPropertyName("id")] ).

Modelo AgendaWebView.cs atualizado para usar tipos nul√°veis (string?, int?) mitigando erros SqlNullValueException na leitura de dados inconsistentes.

Classe Especialidade.cs atualizada para string? Nome, resolvendo erro no GetExamesEspecificos.

L√≥gica de exibi√ß√£o do calend√°rio corrigida para n√£o repetir o n√∫mero "1".

Estiliza√ß√£o do calend√°rio (Amarelo para Poucas Vagas) implementada no XAML (assumindo aplica√ß√£o das sugest√µes).

III. ESTADO ATUAL E PR√ìXIMOS PASSOS

Ambos os fluxos de agendamento (Consulta e Exame) est√£o agora implementados com l√≥gicas e endpoints separados, e as principais fontes de erros (SqlNullValueException, bugs visuais do calend√°rio, filtros incorretos) foram abordadas e corrigidas com base nos dados e estruturas fornecidos (vw_cad_prestadorMedicoEspecialidadeAgendaWeb, schemas das tabelas, procedures).

Pr√≥ximos Passos Recomendados:

Testes Abrangentes: Realizar testes completos em ambos os fluxos, cobrindo diferentes m√©dicos, especialidades, exames, meses e cen√°rios de disponibilidade (incluindo o dia atual em diferentes hor√°rios).

Refinar Filtragem de M√©dicos (Opcional): Implementar a Regra 2 discutida anteriormente (ocultar m√©dicos com agenda completamente lotada no futuro) no GetMedicosPorEspecialidade e GetMedicosPorProcedimento, se desejado. Isso exigir√° uma l√≥gica mais complexa para verificar a disponibilidade futura.

Revis√£o de UI/UX: Avaliar a experi√™ncia do usu√°rio em ambos os fluxos e fazer ajustes na interface conforme necess√°rio.

Transfer√™ncia de Consci√™ncia conclu√≠da. O sistema est√° em estado operacional para ambos os fluxos, aguardando testes finais e refinamentos.